local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Pet;local j=d.Spell;local k=d.Item;local l=HeroRotation;local m=l.AoEON;local n=l.CDsON;local o=l.Cast;local p=l.CastAnnotated;local q=l.CastSuggested;local r=HeroRotationCharDB.Toggles[5]local s=HeroRotationCharDB.Toggles[6]local t=HeroRotationCharDB.Toggles[12]local u=false;local v=0;local w=0;local x=0;local y=j.Evoker.Devastation;local z=k.Evoker.Devastation;local A={}local B=l.Commons.Everyone;local C={General=l.GUISettings.General,Commons=l.GUISettings.APL.Evoker.Commons,Devastation=l.GUISettings.APL.Evoker.Devastation}local D=g:CovenantID()local E=g:GetEquipment()local F=E[13]and k(E[13])or k(0)local G=E[14]and k(E[14])or k(0)local H;local I;local J;local K=y.EssenceAttunement:IsAvailable()and 2 or 1;local L,M,N;local O=11111;local P=11111;local Q;local R={{y.TailSwipe,"Cast Tail Swipe (Interrupt)",function()return true end},{y.WingBuffet,"Cast Wing Buffet (Interrupt)",function()return true end}}d:RegisterForEvent(function()E=g:GetEquipment()F=E[13]and k(E[13])or k(0)G=E[14]and k(E[14])or k(0)end,"PLAYER_EQUIPMENT_CHANGED")d:RegisterForEvent(function()D=g:CovenantID()end,"COVENANT_CHOSEN")d:RegisterForEvent(function()K=y.EssenceAttunement:IsAvailable()and 2 or 1 end,"PLAYER_TALENT_UPDATE")d:RegisterForEvent(function()O=11111;P=11111 end,"PLAYER_REGEN_ENABLED")local function S(T)if T then return 1 else return 0 end end;local function U(T)return T~=0 end;local function V()if C.Commons.Enabled.Trinkets and z.ShadowedOrbofTorment:IsEquippedAndReady()then if o(z.ShadowedOrbofTorment,nil,C.Commons.DisplayStyle.Trinkets)then return"shadowed_orb_of_torment precombat"end end;if y.Firestorm:IsCastable()then if o(y.Firestorm,nil,nil,not h:IsInRange(25))then return"firestorm precombat"end end;if y.LivingFlame:IsCastable()and not y.Firestorm:IsAvailable()then if o(y.LivingFlame,nil,nil,not h:IsInRange(25))then v=361469;return"living_flame precombat"end end end;local function W()if y.ObsidianScales:IsCastable()and g:BuffDown(y.ObsidianScales)and g:HealthPercentage()<C.Devastation.ObsidianScalesThreshold then if o(y.ObsidianScales,nil,C.Commons.DisplayStyle.Defensives)then return"obsidian_scales defensives"end end end;local function X()if n()and g:BuffUp(y.Dragonrage)then local Y=g:GetUseableTrinkets(A)if Y then if o(Y,nil,nil)then if Y:ID()==TopTrinketID and C.Commons.Enabled.TopTrinket then v=24;return"top trinket 1"elseif Y:ID()==BotTrinketID and C.Commons.Enabled.BottomTrinket then v=30;return"top trinket 2"end end end end end;local function Z()s=HeroRotationCharDB.Toggles[6]CovenantsON=HeroRotationCharDB.Toggles[4]r=HeroRotationCharDB.Toggles[5]t=HeroRotationCharDB.Toggles[12]x=0;for a0=1,20 do if select(10,UnitDebuff("player",a0))==240447 then if select(6,UnitDebuff("player",a0))~=nil then x=select(6,UnitDebuff("player",a0))-GetTime()end end end;if l.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[6]then starttime=GetTime()endtime=starttime+l.GUISettings.General.OpenerReset elseif l.GUISettings.General.OpenerReset>0 and endtime~=nil and GetTime()>endtime and HeroRotationCharDB.Toggles[6]then HeroRotationCharDB.Toggles[6]=not HeroRotationCharDB.Toggles[6]l.ToggleIconFrame:UpdateButtonText(6)l.Print("Opener is now "..(HeroRotationCharDB.Toggles[6]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end end;local function a1()H=g:GetEnemiesInRange(25)I=h:GetEnemiesInSplashRange(8)if m()and C.Commons.AoeMode=="Conservative"then J=h:GetEnemiesInSplashRangeCount(8)EnemiesCount10ySplash=h:GetEnemiesInSplashRangeCount(15)elseif m()and C.Commons.AoeMode=="Aggresive"then local a2=0;for a3=1,20 do local a4="nameplate"..a3;if UnitExists(a4)then if UnitCanAttack("player",a4)then if UnitCanAttack("player",a4)and UnitAffectingCombat("target")and IsItemInRange(32698,a4)and UnitDetailedThreatSituation("player",a4)~=nil or f(a4):IsDummy()or string.find(UnitGUID(a4),153285)or string.find(UnitGUID(a4),31146)or string.find(UnitGUID(a4),176581)or string.find(UnitGUID(a4),179124)or string.find(UnitGUID(a4),179010)or string.find(UnitGUID(a4),180323)or string.find(UnitGUID(a4),179010)or string.find(UnitGUID(a4),179942)or string.find(UnitGUID(a4),176521)or string.find(UnitGUID(a4),177594)or string.find(UnitGUID(a4),177117)or string.find(UnitGUID(a4),176581)or string.find(UnitGUID(a4),180840)or string.find(UnitGUID(a4),176605)or UnitName(a4)=="Glacial Spike"or string.find(UnitGUID(a4),180473)or string.find(UnitGUID(a4),180474)or string.find(UnitGUID(a4),176929)or string.find(UnitGUID(a4),176920)or string.find(UnitGUID(a4),177154)or string.find(UnitGUID(a4),177787)or string.find(UnitGUID(a4),177889)or string.find(UnitGUID(a4),177891)or string.find(UnitGUID(a4),177892)or string.find(UnitGUID(a4),168326)or string.find(UnitGUID(a4),182778)or string.find(UnitGUID(a4),183945)then a2=a2+1 end end end end;J=a2;EnemiesCount10ySplash=a2 end;local a5=0;for a6=1,20 do local a4="nameplate"..a6;if UnitExists(a4)then if UnitCanAttack("player",a4)then if UnitCanAttack("player",a4)and UnitAffectingCombat("target")and IsItemInRange(32698,a4)and UnitDetailedThreatSituation("player",a4)~=nil and f(a4):TimeToDie()>=18 or f(a4):IsDummy()or string.find(UnitGUID(a4),153285)or string.find(UnitGUID(a4),31146)or string.find(UnitGUID(a4),176581)or string.find(UnitGUID(a4),179124)or string.find(UnitGUID(a4),179010)or string.find(UnitGUID(a4),180323)or string.find(UnitGUID(a4),179010)or string.find(UnitGUID(a4),179942)or string.find(UnitGUID(a4),176521)or string.find(UnitGUID(a4),177594)or string.find(UnitGUID(a4),177117)or string.find(UnitGUID(a4),176581)or string.find(UnitGUID(a4),180840)or string.find(UnitGUID(a4),176605)or UnitName(a4)=="Glacial Spike"or string.find(UnitGUID(a4),180473)or string.find(UnitGUID(a4),180474)or string.find(UnitGUID(a4),176929)or string.find(UnitGUID(a4),176920)or string.find(UnitGUID(a4),177154)or string.find(UnitGUID(a4),177787)or string.find(UnitGUID(a4),177889)or string.find(UnitGUID(a4),177891)or string.find(UnitGUID(a4),177892)or string.find(UnitGUID(a4),168326)or string.find(UnitGUID(a4),182778)or string.find(UnitGUID(a4),183945)then a5=a5+1 end end end end;if m()then J=#I else J=1 end;if ForceAoE then J=10 end;TopTrinketID,_=GetInventoryItemID("player",13)BotTrinketID,_=GetInventoryItemID("player",14)if not BotOn then w=0;v=0 end;if w>0 then w=0 end;if v>0 then v=0 end;ShouldReturn=Z()if B.TargetIsValid()or g:AffectingCombat()then O=d.BossFightRemains(nil,true)P=O;if P==11111 then P=d.FightRemains(H,false)end end;Q=g:GCD()+0.25;if g:IsChanneling(y.Disintegrate)then if o(y.Pool,nil)then v=99999;return"channeling 4"end end;if g:IsChanneling()and EmpowerTo then if B.GetCurrentEmpowerData(1)<EmpowerTo then if o(y.Pool,nil)then v=99999;return"channeling 4"end elseif B.GetCurrentEmpowerData(1)>=EmpowerTo or B.GetCurrentEmpowerData(stage)==0 then v=357208;return"Channeling to"..EmpowerTo end elseif g:IsChanneling()then EmpowerTo=0 end;if not g:AffectingCombat()and not g:IsCasting()and not g:IsMoving()and B.TargetIsValid()then local ShouldReturn=V()if ShouldReturn then return ShouldReturn end end;if B.TargetIsValid()and g:AffectingCombat()and(h:AffectingCombat()or h:IsDummy()or h:NPCID()==153285 or h:NPCID()==168326 or h:NPCID()==176581 or h:NPCID()==176920 or h:NPCID()==177892 or h:NPCID()==182778 or h:NPCID()==185402 or h:NPCID()==183945 or h:NPCID()==182074 or h:NPCID()==184737 or h:NPCID()==179733 or h:NPCID()==115402 or h:NPCID()==115406 or h:NPCID()==115395 or UnitExists("boss1")or h:NPCID()==115388 or Opener1)and not g:IsDeadOrGhost()then if g:AffectingCombat()and C.Devastation.UseDefensives then local ShouldReturn=W()if ShouldReturn then return ShouldReturn end end;if y.BoonoftheCovenants:IsReady()and g:BuffUp(y.Dragonrage)then if o(y.BoonoftheCovenants,nil,C.Commons.DisplayStyle.Covenant)then return"boon_of_the_covenants main 1"end end;if C.Commons.Enabled.Potions then local a7=B.PotionSelected()if a7 and a7:IsReady()and(g:BuffUp(y.Dragonrage)or d.CombatTime()>=300 or P<35)then if o(a7,nil,C.Commons.DisplayStyle.Potions)then return"potion main 2"end end end;if C.Commons.Enabled.Trinkets then if z.ShadowedOrbofTorment:IsEquippedAndReady()then if o(z.ShadowedOrbofTorment,nil,C.Commons.DisplayStyle.Trinkets)then return"shadowed_orb_of_torment main 4"end end;local ShouldReturn=X()if ShouldReturn then return ShouldReturn end end;if y.DeepBreath:IsCastable()and(J>1 and g:BuffDown(y.Dragonrage))then if o(y.DeepBreath,C.Devastation.GCDasOffGCD.DeepBreath,nil,not h:IsInRange(50))then return"deep_breath main 8"end end;if y.Dragonrage:IsCastable()and(y.EternitySurge:CooldownRemains()<=y.Dragonrage:BaseDuration()+6 and(y.FireBreath:CooldownRemains()<=2*Q or not y.FeedtheFlames:IsAvailable()))then if o(y.Dragonrage,C.Devastation.GCDasOffGCD.Dragonrage,nil,not h:IsInRange(25))then return"dragonrage main 10"end end;if y.TipTheScales:IsCastable()and(g:BuffUp(y.Dragonrage)and(y.EternitySurge:CooldownUp()or y.FireBreath:CooldownUp())and g:BuffRemains(y.Dragonrage)<=Q)then if o(y.TipTheScales,C.Devastation.GCDasOffGCD.TipTheScales)then return"tip_the_scales main 12"end end;if y.EternitySurge:IsCastable()and(g:BuffUp(y.Dragonrage)and(g:BloodlustUp()or g:BuffUp(y.PowerInfusionBuff))and y.FeedtheFlames:IsAvailable())then if p(y.EternitySurge,false,"1")then return"eternity_surge empower 1 main 14"end end;if y.TipTheScales:IsCastable()and(g:BuffUp(y.Dragonrage)and y.FireBreath:CooldownUp()and y.EverburningFlame:IsAvailable()and y.Firestorm:IsAvailable())then if o(y.TipTheScales,C.Devastation.GCDasOffGCD.TipTheScales)then return"tip_the_scales main 16"end end;if y.FireBreath:IsCastable()and(y.EverburningFlame:IsAvailable()and(y.Firestorm:CooldownRemains()>=2*Q or y.Firestorm:TimeSinceLastCast()>=12)or y.Dragonrage:CooldownRemains()>=10 and y.FeedtheFlames:IsAvailable()or not y.EverburningFlame:IsAvailable()and not y.FeedtheFlames:IsAvailable())then if p(y.FireBreath,false,"1")then v=357208;EmpowerTo=1;return"fire_breath main 18"end end;if y.FireBreath:IsCastable()and y.EverburningFlame:IsAvailable()then if p(y.FireBreath,false,"2")then v=357208;EmpowerTo=2;return"fire_breath main 20"end end;if y.Firestorm:IsCastable()and(y.EverburningFlame:IsAvailable()and(y.FireBreath:CooldownUp()or h:DebuffRemains(y.FireBreathDebuff)>=y.Firestorm:CastTime()and h:DebuffRemains(y.FireBreathDebuff)<y.FireBreath:CooldownRemains())or g:BuffUp(y.SnapfireBuff)or J>1)then if o(y.Firestorm,nil,nil,not h:IsInRange(25))then return"firestorm main 22"end end;if y.EternitySurge:IsReady()then local a8=1;if J>3*(1+S(y.EternitysSpan:IsAvailable()))then a8=4 elseif J>2*(1+S(y.EternitysSpan:IsAvailable()))then a8=3 elseif J>1+S(y.EternitysSpan:IsAvailable())then a8=2 end;if a8>1 then if p(y.EternitySurge,false,a8)then return"eternity_surge main 24"end elseif 30-y.Dragonrage:CooldownRemains()<y.Dragonrage:BaseDuration()+6-Q then if p(y.EternitySurge,false,a8)then return"eternity_surge empower 1 main 24"end end end;if y.ShatteringStar:IsCastable()and(not y.ArcaneVigor:IsAvailable()or g:Essence()+1<g:EssenceMax()or g:BuffUp(y.Dragonrage))then if o(y.ShatteringStar,nil,nil,not h:IsInRange(25))then return"shattering_star main 26"end end;if y.AzureStrike:IsCastable()and(g:Essence()<g:EssenceMax()and J>2-S(g:BuffUp(y.Dragonrage))and g:BuffStack(y.EssenceBurstBuff)<K and(not y.RubyEmbers:IsAvailable()or J>2))then if o(y.AzureStrike,nil,nil,not h:IsInRange(25))then v=362969;return"azure_strike main 28"end end;if y.Pyre:IsReady()and(J>2+S(y.Scintillation:IsAvailable())*S(y.EternitysSpan:IsAvailable())or g:BuffStack(y.ChargedBlastBuff)==20 and y.Dragonrage:CooldownRemains()>20 and J>2)then if o(y.Pyre,nil,nil,not h:IsInRange(25))then v=357211;return"pyre main 30"end end;if y.LivingFlame:IsCastable()and not g:IsCasting(y.LivingFlame)and(g:Essence()<g:EssenceMax()and g:BuffStack(y.EssenceBurstBuff)<K and(g:BuffUp(y.BurnoutBuff)or not y.EngulfingBlaze:IsAvailable()and not y.ShatteringStar:IsAvailable()and g:BuffUp(y.Dragonrage)and h:HealthPercentage()>80))then if o(y.LivingFlame,nil,nil,not h:IsInRange(25))then v=361469;return"living_flame main 32"end end;if y.Disintegrate:IsReady()and g:BuffUp(y.Dragonrage)then if o(y.Disintegrate,nil,nil,not h:IsInRange(25))then v=356995;return"disintegrate main 28"end end;if y.Disintegrate:IsReady()and(g:Essence()==g:EssenceMax()or g:BuffStack(y.EssenceBurstBuff)==K or h:DebuffUp(y.ShatteringStar)or y.ShatteringStar:CooldownRemains()>=3*Q or not y.ShatteringStar:IsAvailable())then if o(y.Disintegrate,nil,nil,not h:IsInRange(25))then v=356995;return"disintegrate main 30"end end;if C.Commons.Enabled.Items and z.KharnalexTheFirstLight:IsEquippedAndReady()and(h:DebuffDown(y.ShatteringStar)and g:BuffDown(y.Dragonrage)and J==1)then if o(z.KharnalexTheFirstLight,nil,C.Commons.DisplayStyle.Items,not h:IsInRange(25))then return"kharnalex_the_first_light main 32"end end;if y.AzureStrike:IsCastable()and(J>2 or(y.EngulfingBlaze:IsAvailable()or y.FeedtheFlames:IsAvailable())and g:BuffUp(y.Dragonrage))then if o(y.AzureStrike,nil,nil,not h:IsSpellInRange(y.AzureStrike))then v=362969;return"azure_strike main 32"end end;if y.LivingFlame:IsCastable()then if o(y.LivingFlame,nil,nil,not h:IsInRange(25))then v=361469;return"living_flame main 34"end end;if p(y.Pool,false,"WAIT")then return"Wait/Pool Resources"end end end;local function a9()end;function ReturnSpell()if v==0 then return 0 else return v end end;function ReturnSpellMO()if w==0 then return 0 else return w end end;l.SetAPL(1467,a1,a9)l.SetAPL(1465,a1,a9)