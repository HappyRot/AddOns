local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=d.Unit;local f=e.Player;local g=e.Target;local h=d.Spell;local i=d.Item;local j=HeroRotation;local k=j.Cast;local l=j.AoEON;local m=j.CDsON;local n=h.Warrior.Protection;local o=i.Warrior.Protection;local p={}local q;local r;local s;local t=f:HasLegendaryEquipped(193)local u=j.Commons.Everyone;local v={General=j.GUISettings.General,Commons=j.GUISettings.APL.Warrior.Commons,Protection=j.GUISettings.APL.Warrior.Protection}local w={{n.IntimidatingShout,"Cast Intimidating Shout (Interrupt)",function()return true end}}d:RegisterForEvent(function()t=f:HasLegendaryEquipped(193)end,"PLAYER_EQUIPMENT_CHANGED")local function x(y)if y then return 1 else return 0 end end;local function z(y)return y~=0 end;local function A()return f:IsTankingAoE(16)or f:IsTanking(g)end;local function B()if f:BuffUp(n.IgnorePain)then local C=f:AttackPowerDamageMod()*3.5*(1+f:VersatilityDmgPct()/100)local D,D,D,D,D,D,D,D,D,D,D,D,D,D,D,E=f:AuraInfo(n.IgnorePain,nil,true)return E<0.5*math.floor(C*1.3)else return true end end;local function F()return A()and n.ShieldBlock:IsReady()and((f:BuffDown(n.ShieldBlockBuff)or f:BuffRemains(n.ShieldBlockBuff)<=1.5*f:GCD())and f:BuffDown(n.LastStandBuff)and f:Rage()>=30)end;local function G(H)local I=80;local J=false;if f:Rage()>=40 and n.IgnorePain:IsReady()and not F()then J=f:Rage()+H>=I or J end;if f:Rage()>=40 and n.DemoralizingShout:IsReady()and not F()then J=true end;if J then if k(n.IgnorePain,nil,v.Protection.DisplayStyle.Defensive)then return"rage capped"end end end;local function K()if g:IsInMeleeRange(12)then if n.ThunderClap:IsCastable()then if k(n.ThunderClap)then return"thunder_clap precombat"end end else if n.Charge:IsCastable()then if k(n.Charge,nil,nil,not g:IsSpellInRange(n.Charge))then return"charge precombat"end end end end;local function L()if F()then if k(n.ShieldBlock,nil,v.Protection.DisplayStyle.Defensive)then return"shield_block defensive"end end;if n.LastStand:IsCastable()and(f:BuffDown(n.ShieldBlockBuff)and n.ShieldBlock:Recharge()>1)then if k(n.LastStand,nil,v.Protection.DisplayStyle.Defensive)then return"last_stand defensive"end end;if f:HealthPercentage()<v.Commons.VictoryRushHP then if n.VictoryRush:IsCastable()and n.VictoryRush:IsUsable()then if k(n.VictoryRush)then return"victory_rush defensive"end end;if n.ImpendingVictory:IsReady()and n.ImpendingVictory:IsUsable()then if k(n.ImpendingVictory)then return"impending_victory defensive"end end end end;local function M()if n.Ravager:IsCastable()then G(10)if k(n.Ravager,nil,nil,not g:IsSpellInRange(n.Ravager))then return"ravager aoe 2"end end;if n.DragonRoar:IsCastable()then G(20)if k(n.DragonRoar,v.Protection.GCDasOffGCD.DragonRoar,nil,not g:IsInMeleeRange(12))then return"dragon_roar aoe 4"end end;if n.ThunderClap:IsCastable()then G(5)if k(n.ThunderClap,nil,nil,not g:IsInMeleeRange(12))then return"thunder_clap aoe 6"end end;if n.Revenge:IsReady()and not F()then if k(n.Revenge,nil,nil,not q)then return"revenge aoe 8"end end;if n.ShieldSlam:IsCastable()then G(15)if k(n.ShieldSlam,nil,nil,not q)then return"shield_slam aoe 10"end end end;local function N()if n.Ravager:IsCastable()then if k(n.Ravager,nil,nil,not g:IsSpellInRange(n.Ravager))then return"ravager generic 2"end end;if n.DragonRoar:IsCastable()then G(20)if k(n.DragonRoar,v.Protection.GCDasOffGCD.DragonRoar,nil,not g:IsInMeleeRange(12))then return"dragon_roar generic 4"end end;if n.ShieldSlam:IsCastable()and f:BuffUp(n.ShieldBlockBuff)then G(15)if k(n.ShieldSlam,nil,nil,not q)then return"shield_slam generic 6"end end;if n.ThunderClap:IsCastable()and((s>1 or not n.ShieldSlam:CooldownUp())and n.UnstoppableForce:IsAvailable()and f:BuffUp(n.AvatarBuff))then G(5)if k(n.ThunderClap,nil,nil,not g:IsInMeleeRange(12))then return"thunder_clap generic 8"end end;if n.ShieldSlam:IsCastable()then G(15)if k(n.ShieldSlam,nil,nil,not q)then return"shield_slam generic 10"end end;if n.Condemn:IsCastable()and n.Condemn:IsUsable()then if k(n.Condemn,nil,v.Commons.DisplayStyle.Covenant,not q)then return"condemn generic 12"end end;if n.Execute:IsCastable()and n.Execute:IsUsable()then if k(n.Execute,nil,nil,not q)then return"execute generic 14"end end;if n.Revenge:IsReady()and f:Rage()>=70 then if k(n.Revenge,nil,nil,not q)then return"revenge generic 16"end end;if n.ThunderClap:IsCastable()then G(5)if k(n.ThunderClap,nil,nil,not g:IsInMeleeRange(12))then return"thunder_clap generic 18"end end;if n.Revenge:IsReady()and not F()then if k(n.Revenge,nil,nil,not q)then return"revenge generic 20"end end;if n.Devastate:IsCastable()then if k(n.Devastate,nil,nil,not q)then return"devastate generic 22"end end;if n.StormBolt:IsCastable()then if k(n.StormBolt,nil,nil,not g:IsSpellInRange(n.StormBolt))then return"storm_bolt generic 24"end end end;local function O()if l()then r=f:GetEnemiesInMeleeRange(8)s=#r else s=1 end;q=g:IsInMeleeRange(5)if u.TargetIsValid()then if not f:AffectingCombat()then local P=K()if P then return P end end;if A()then local P=L()if P then return P end end;local P=u.Interrupt(5,n.Pummel,v.Commons.OffGCDasOffGCD.Pummel,w)if P then return P end;if n.Charge:IsCastable()and not q then if k(n.Charge,nil,v.Commons.DisplayStyle.Charge,not g:IsSpellInRange(n.Charge))then return"charge main 2"end end;if v.Commons.Enabled.Trinkets and(n.Avatar:CooldownRemains()<=f:GCD()or f:BuffUp(n.AvatarBuff))then local Q=f:GetUseableTrinkets(p)if Q then if k(Q,nil,v.Commons.DisplayStyle.Trinkets)then return"Generic use_items for "..Q:Name()end end end;if m()then if n.BloodFury:IsCastable()then if k(n.BloodFury,v.Commons.OffGCDasOffGCD.Racials)then return"blood_fury racial"end end;if n.Berserking:IsCastable()then if k(n.Berserking,v.Commons.OffGCDasOffGCD.Racials)then return"berserking racial"end end;if n.ArcaneTorrent:IsCastable()then if k(n.ArcaneTorrent,v.Commons.OffGCDasOffGCD.Racials,nil,8)then return"arcane_torrent racial"end end;if n.LightsJudgment:IsCastable()then if k(n.LightsJudgment,v.Commons.OffGCDasOffGCD.Racials,nil,40)then return"lights_judgment racial"end end;if n.Fireblood:IsCastable()then if k(n.Fireblood,v.Commons.OffGCDasOffGCD.Racials)then return"fireblood racial"end end;if n.AncestralCall:IsCastable()then if k(n.AncestralCall,v.Commons.OffGCDasOffGCD.Racials)then return"ancestral_call racial"end end;if n.BagofTricks:IsCastable()then if k(n.BagofTricks,v.Commons.OffGCDasOffGCD.Racials,nil,40)then return"bag_of_tricks racial"end end end;if o.PotionofPhantomFire:IsReady()and v.Commons.Enabled.Potions and(f:BuffUp(n.AvatarBuff)or g:TimeToDie()<25)then if k(o.PotionofPhantomFire,nil,v.Commons.DisplayStyle.Potions)then return"potion main 4"end end;if n.Charge:IsCastable()and(f:Rage()<60 and f:BuffDown(n.RevengeBuff)and t)then if k(n.Charge,nil,v.Commons.DisplayStyle.Charge,not g:IsSpellInRange(n.Charge))then return"charge for reprisal"end end;if n.DemoralizingShout:IsCastable()and n.BoomingVoice:IsAvailable()then if n.BoomingVoice:IsAvailable()then G(40)end;if k(n.DemoralizingShout,v.Protection.GCDasOffGCD.DemoralizingShout,not g:IsInRange(10))then return"demoralizing_shout main 8"end end;if m()then if n.Avatar:IsCastable()and f:BuffDown(n.AvatarBuff)then G(20)if k(n.Avatar,v.Protection.GCDasOffGCD.Avatar)then return"avatar main 10"end end;if n.AncientAftershock:IsCastable()then if k(n.AncientAftershock,nil,v.Commons.DisplayStyle.Covenant,not q)then return"ancient_aftershock main 12"end end;if n.SpearofBastion:IsCastable()then if k(n.SpearofBastion,nil,v.Commons.DisplayStyle.Covenant,not g:IsSpellInRange(n.SpearofBastion))then return"spear_of_bastion main 14"end end;if n.ConquerorsBanner:IsCastable()then if k(n.ConquerorsBanner,nil,v.Commons.DisplayStyle.Covenant)then return"conquerors_banner main 16"end end end;if s>=3 then return M()end;if true then local P=N()if P then return P end end;if j.CastAnnotated(n.Pool,false,"WAIT")then return"Wait/Pool Resources"end end end;local function R()j.Print("Protection Warrior rotation is currently a work in progress.")end;j.SetAPL(73,O,R)