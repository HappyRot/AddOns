local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Pet;local j=d.Spell;local k=d.Item;local l=HeroRotation;local m=l.AoEON;local n=l.CDsON;local o=l.Cast;local p=l.CastSuggested;local q=l.Commons.Everyone.num;local r=l.Commons.Everyone.bool;local s=math.min;local t=j.Priest.Shadow;local u=k.Priest.Shadow;local v=0;local w=0;local x=HeroRotationCharDB.Toggles[4]local y=HeroRotationCharDB.Toggles[5]local z=not HeroRotationCharDB.Toggles[15]local A=HeroRotationCharDB.Toggles[12]local B=HeroRotationCharDB.Toggles[61]local C=HeroRotationCharDB.Toggles[174]local D=HeroRotationCharDB.Toggles[62]local function q(E)if E then return 1 else return 0 end end;local function r(E)return E~=0 end;local F={}local G,H,I;local J,K;local L=l.Commons.Everyone;local M={General=l.GUISettings.General,Commons=l.GUISettings.APL.Priest.Commons,Shadow=l.GUISettings.APL.Priest.Shadow}local N=M.Shadow.AutoShadowCrash;local O=11111;local P=11111;local Q=false;local R=false;local S=0;local T=false;local U=false;local V=false;local W=false;local X=false;local Y=false;local Z=t.Mindbender:IsAvailable()and t.Mindbender or t.Shadowfiend;local _=false;local a0=0;local a1=false;local a2=nil;local a3;local a4;local a5=g:GetEquipment()local a6=a5[13]and k(a5[13])or k(0)local a7=a5[14]and k(a5[14])or k(0)local a8=GetInventoryItemID("player",13)local a9=GetInventoryItemID("player",14)d:RegisterForEvent(function()O=11111;P=11111;Q=false;R=false;VarMindSearCutoff=2;VarPoolAmount=60;S=0;T=false;U=false;V=false;W=false;X=false;Y=false;_=false;a0=0;a1=false;a2=nil end,"PLAYER_REGEN_ENABLED")d:RegisterForEvent(function()Z=t.Mindbender:IsAvailable()and t.Mindbender or t.Shadowfiend end,"SPELLS_CHANGED","LEARNED_SPELL_IN_TAB")d:RegisterForEvent(function()t.ShadowCrash:RegisterInFlightEffect(205386)t.ShadowCrash:RegisterInFlight()end,"LEARNED_SPELL_IN_TAB")t.ShadowCrash:RegisterInFlightEffect(205386)t.ShadowCrash:RegisterInFlight()local function aa()local ab=1;if g:BuffUp(t.DarkAscensionBuff)then ab=ab*1.25 end;if g:BuffUp(t.DarkEvangelismBuff)then ab=ab*(1+0.01*g:BuffStack(t.DarkEvangelismBuff))end;if g:BuffUp(t.DevouredFearBuff)or g:BuffUp(t.DevouredPrideBuff)then ab=ab*1.05 end;if t.DistortedReality:IsAvailable()then ab=ab*1.2 end;if g:BuffUp(t.MindDevourerBuff)then ab=ab*1.2 end;if t.Voidtouched:IsAvailable()then ab=ab*1.06 end;return ab end;t.DevouringPlague:RegisterPMultiplier(t.DevouringPlagueDebuff,aa)local function ac(ad,ae)if ae then return ad:DebuffUp(t.ShadowWordPainDebuff)and ad:DebuffUp(t.VampiricTouchDebuff)and ad:DebuffUp(t.DevouringPlagueDebuff)else return ad:DebuffUp(t.ShadowWordPainDebuff)and ad:DebuffUp(t.VampiricTouchDebuff)end end;local function af(ag,ah)if not ag then return nil end;local ai=0;local aj=nil;for ak,al in pairs(ag)do local am=al:TimeToDie()if ah then if am*q(al:DebuffRefreshable(t.VampiricTouchDebuff))>ai then ai=am;aj=al end else if am>ai then ai=am;aj=al end end end;return aj end;local function an(ao)return ao:DebuffRemains(t.ShadowWordPainDebuff)end;local function ap(ao)return ao:TimeToDie()end;local function aq(ao)return ao:DebuffRemains(t.VampiricTouchDebuff)end;local function ar(ao)if ao:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or V or not t.WhisperingShadows:IsAvailable())and(ao:TimeToDie()>=12 or ao:IsDummy())and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==f("mouseover"):GUID()and M.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif ao:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or V or not t.WhisperingShadows:IsAvailable())and(ao:TimeToDie()>=12 or ao:IsDummy())and not t.Misery:IsAvailable()and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and M.Shadow.TargetSwap=="AutoSwap"and ao:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif ao:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or V or not t.WhisperingShadows:IsAvailable())and(ao:TimeToDie()>=12 or ao:IsDummy())and not t.Misery:IsAvailable()and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==h:GUID()then v=34914;return true elseif ao:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or V or not t.WhisperingShadows:IsAvailable())and(ao:TimeToDie()>=12 or ao:IsDummy())and not t.Misery:IsAvailable()and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)then return true end end;local function as(ao)return not t.DistortedReality:IsAvailable()or K==1 or ao:DebuffRemains(t.DevouringPlagueDebuff)<=a4 end;local function at(ao)return ao:DebuffRemains(t.DevouringPlagueDebuff)<=a4 or not t.DistortedReality:IsAvailable()end;local function au(ao)return ao:DebuffRemains(t.DevouringPlagueDebuff)>t.MindBlast:ExecuteTime()and t.MindBlast:FullRechargeTime()<=a4+t.MindBlast:ExecuteTime()or a0<=t.MindBlast:ExecuteTime()+a4 end;local function av(ao)return ac(ao,true)and ao:DebuffRemains(t.DevouringPlagueDebuff)>=t.Mindgames:CastTime()end;local function aw(ao)return ao:DebuffRefreshable(t.VampiricTouchDebuff)or ao:DebuffRemains(t.VampiricTouchDebuff)<=ao:TimeToDie()and g:BuffDown(t.VoidformBuff)end;local function ax(ao)return ao:HealthPercentage()<20 and(Z:CooldownRemains()>=10 or not t.InescapableTorment:IsAvailable())or _ and t.InescapableTorment:IsAvailable()or g:BuffUp(t.DeathspeakerBuff)end;local function ay(ao)return ao:HealthPercentage()<20 or g:BuffUp(t.DeathspeakerBuff)end;local function az(ao)return ao:HealthPercentage()<20 end;local function aA(ao)return ao:DebuffUp(t.DevouringPlagueDebuff)and a0<=2 and _ and t.InescapableTorment:IsAvailable()and K<=7 end;local function an(ao)return ao:DebuffRemains(t.ShadowWordPainDebuff)end;local function aB(ao)return ac(ao)and ao:DebuffRemains(t.DevouringPlagueDebuff)>=2 end;local function aC(ao)if(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==f("mouseover"):GUID()and M.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and M.Shadow.TargetSwap=="AutoSwap"and ao:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==h:GUID()then v=34914;return true elseif(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)then return true end end;local function aD(ao)if(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==f("mouseover"):GUID()and M.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and M.Shadow.TargetSwap=="AutoSwap"and ao:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==h:GUID()then v=34914;return true elseif(ao:DebuffRefreshable(t.VampiricTouchDebuff)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)then return true end end;local function aE(ao)if(ac(ao,false)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==f("mouseover"):GUID()and M.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif(ac(ao,false)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and M.Shadow.TargetSwap=="AutoSwap"and ao:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif(ac(ao,false)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)and ao:GUID()==h:GUID()then v=34914;return true elseif(ac(ao,false)and(ao:TimeToDie()>18 or ao:IsDummy()or ao:NPCID()==153285)and(ao:DebuffUp(t.VampiricTouchDebuff)or not U)and S>0 or t.Misery:IsAvailable()and ao:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=ao:DebuffRemains(t.VampiricTouchDebuff)or ao:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(ao:AffectingCombat()or ao:IsDummy()or ao:NPCID()==153285 or ao:NPCID()==168326)then return true end end;local function aF()if t.Mindbender:IsAvailable()then v=200174 else v=34433 end end;local function aG()if g:BuffUp(t.MindFlayInsanityBuff)then v=407466 else v=15407 end end;local function aH()if UnitGUID("focus")==nil then v=10060 else v=100606 end end;local function aI()a2=h:GUID()if t.ArcaneTorrent:IsCastable()and n()then if o(t.ArcaneTorrent,nil,nil,not h:IsSpellInRange(t.ArcaneTorrent))then w=11111;return"arcane_torrent precombat 6"end end;local aJ=g:IsInParty()and g:IsInDungeonArea()and not g:IsInRaidArea()if t.ShadowCrash:IsCastable()and N and not aJ then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then return"shadow_crash precombat 8"end end;if t.VampiricTouch:IsCastable()and(not t.ShadowCrash:IsAvailable()or t.ShadowCrash:CooldownDown()and not t.ShadowCrash:InFlight()or aJ)then if o(t.VampiricTouch,nil,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch precombat 10"end end;if t.ShadowWordPain:IsCastable()and not t.Misery:IsAvailable()then if o(t.ShadowWordPain,nil,nil,not h:IsSpellInRange(t.ShadowWordPain))then v=589;return"shadow_word_pain precombat 12"end end end;local function aK()Q=ac(h,false)or t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable()R=ac(h,true)X=t.VoidEruption:CooldownRemains()<=g:GCD()*3 and t.VoidEruption:IsAvailable()or t.DarkAscension:CooldownUp()and t.DarkAscension:IsAvailable()or t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=4 and g:BuffDown(t.VoidformBuff)end;local function aL()S=s(K,12)T=false;local aj=af(I,true)if aj and aj:TimeToDie()>=18 then T=true end;U=t.VampiricTouchDebuff:AuraActiveCount()+8*q(t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable())>=S or not T;if V and t.WhisperingShadows:IsAvailable()then V=S-t.VampiricTouchDebuff:AuraActiveCount()<4 end;W=t.VampiricTouchDebuff:AuraActiveCount()+8*q(not V)>=S or not T end;local function aM()if g:BuffUp(t.VoidformBuff)or g:BuffUp(t.PowerInfusionBuff)or g:BuffUp(t.DarkAscensionBuff)or P<20 then local aN=g:GetUseableTrinkets(F)if aN then if o(aN,nil,nil)then if aN:ID()==a8 and M.Commons.Enabled.TopTrinket then v=24;return"top trinket 1"elseif aN:ID()==a9 and M.Commons.Enabled.BottomTrinket then v=30;return"top trinket 2"end end end end end;local function aO()if t.ShadowCrash:IsCastable()and N and not Y and h:DebuffDown(t.VampiricTouchDebuff)then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then return"shadow_crash opener 2"end end;if Z:IsCastable()then if o(Z,nil)then aF()return"mindbender opener 4"end end;if t.DarkAscension:IsCastable()then if o(t.DarkAscension,nil)then v=391109;return"dark_ascension opener 6"end end;if t.VoidEruption:IsAvailable()then if t.ShadowWordDeath:IsCastable()and t.InescapableTorment:IsAvailable()and g:PrevGCDP(1,t.MindBlast)and t.ShadowWordDeath:TimeSinceLastCast()>20 then if o(t.ShadowWordDeath,nil,nil,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death opener 8"end end;if t.MindBlast:IsCastable()then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast opener 10"end end;if t.VoidEruption:IsCastable()then if o(t.VoidEruption,nil)then v=228260;return"void_eruption opener 12"end end end;if t.PowerInfusion:IsCastable()and M.Shadow.SelfPI and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscension))then if o(t.PowerInfusion,nil)then aH()return"power_infusion opener 14"end end;if M.Commons.Enabled.TopTrinket or M.Commons.Enabled.BottomTrinket then local ShouldReturn=aM()if ShouldReturn then return ShouldReturn end end;if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt opener 16"end end;if t.DevouringPlague:IsReady()then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague opener 18"end end;if t.MindBlast:IsCastable()then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast opener 20"end end;if t.MindSpike:IsCastable()then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then v=73510;return"mind_spike opener 22"end end;if t.MindFlay:IsCastable()then if o(t.MindFlay,nil,nil,not h:IsSpellInRange(t.MindFlay))then v=15407;return"mind_flay opener 24"end end end;local function aP()if t.VampiricTouch:IsCastable()and g:BuffUp(t.UnfurlingDarknessBuff)then if L.CastTargetIf(t.VampiricTouch,H,"min",aq,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch filler 2"end end;if t.ShadowWordDeath:IsReady()then if L.CastCycle(t.ShadowWordDeath,H,ay,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=136149;return"shadow_word_death filler 4"end end;if t.MindSpikeInsanity:IsReady()then if o(t.MindSpikeInsanity,nil,nil,not h:IsSpellInRange(t.MindSpikeInsanity))then v=407466;return"mind_spike_insanity filler 6"end end;if t.MindFlay:IsCastable()and g:BuffUp(t.MindFlayInsanityBuff)then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then v=15407;return"mind_flay filler 8"end end;if t.Mindgames:IsReady()then if o(t.Mindgames,nil,nil,not h:IsInRange(40))then v=323673;return"mindgames filler 10"end end;if t.ShadowWordDeath:IsReady()and(t.InescapableTorment:IsAvailable()and _)then if L.CastTargetIf(t.ShadowWordDeath,H,"min",ap,nil,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=589;return"shadow_word_death filler 12"end end;if t.Halo:IsReady()then if o(t.Halo,nil,nil,not h:IsInRange(30))then v=120644;return"halo filler 14"end end;if t.DevouringPlague:IsReady()and g:BuffUp(t.VoidformBuff)then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague filler 16"end end;if t.MindSpike:IsCastable()then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then v=73510;return"mind_spike filler 18"end end;if a3:IsCastable()then if o(a3,nil,nil,not h:IsSpellInRange(a3))then aG()return"mind_flay filler 20"end end;if t.ShadowCrash:IsCastable()and N then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then return"shadow_crash filler 22"end end;if t.ShadowWordDeath:IsReady()then if L.CastCycle(t.ShadowWordDeath,H,az,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=136149;return"shadow_word_death filler 24"end end;if t.ShadowWordDeath:IsReady()and g:IsMoving()then if o(t.ShadowWordDeath,nil,nil,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death movement filler 26"end end;if t.ShadowWordPain:IsReady()and g:IsMoving()then if L.CastTargetIf(t.ShadowWordPain,H,"min",an,nil,not h:IsSpellInRange(t.ShadowWordPain))then v=589;return"shadow_word_pain filler 28"end end end;local function aQ()if M.Commons.Enabled.Potions and z and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.PowerInfusionBuff)or g:BuffUp(t.DarkAscensionBuff)and P<=t.PowerInfusion:CooldownRemains()+15 or O<=30)then local aR=L.PotionSelected()if aR and aR:IsReady()then if o(aR,nil,nil)then v=50;return"potion cds 2"end end end;if t.Fireblood:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or P<=8)then if o(t.Fireblood,nil)then v=265221;return"fireblood cds 4"end end;if t.Berserking:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or P<=12)then if o(t.Berserking,nil)then v=26297;return"berserking cds 6"end end;if t.BloodFury:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or P<=15)then if o(t.BloodFury,nil)then v=33697;return"blood_fury cds 8"end end;if t.AncestralCall:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or P<=15)then if o(t.AncestralCall,nil)then v=274738;return"ancestral_call cds 10"end end;if t.PowerInfusion:IsCastable()and M.Shadow.SelfPI and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscension))then if o(t.PowerInfusion,nil)then aH()return"power_infusion cds 12"end end;if t.VoidEruption:IsCastable()and(Z:CooldownDown()and(_ and Z:CooldownRemains()>=4 or not t.Mindbender:IsAvailable()or K>2 and not t.InescapableTorment:IsAvailable())and(t.MindBlast:Charges()==0 or d.CombatTime()>15))then if o(t.VoidEruption,nil)then v=228260;return"void_eruption cds 14"end end;if t.DarkAscension:IsCastable()and not g:IsCasting(t.DarkAscension)and(_ and Z:CooldownRemains()>=4 or not t.Mindbender:IsAvailable()and Z:CooldownDown()or K>2 and not t.InescapableTorment:IsAvailable())then if o(t.DarkAscension,nil)then v=391109;return"dark_ascension cds 16"end end;if M.Commons.Enabled.TopTrinket or M.Commons.Enabled.BottomTrinket then local ShouldReturn=aM()if ShouldReturn then return ShouldReturn end end end;local function aS()aK()if n()and(P<30 or h:TimeToDie()>15 and(not V or K>2))then local ShouldReturn=aQ()if ShouldReturn then return ShouldReturn end end;if Z:IsCastable()and(Q and(P<30 or h:TimeToDie()>15)and(not t.DarkAscension:IsAvailable()or t.DarkAscension:CooldownRemains()<a4 or P<15))then if o(Z,nil)then aF()return"mindbender main 2"end end;if t.MindBlast:IsCastable()and(_ and t.InescapableTorment:IsAvailable()and a0>t.MindBlast:ExecuteTime()and K<=7)then if L.CastCycle(t.MindBlast,H,au,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast main 4"end end;if t.ShadowWordDeath:IsReady()then if L.CastCycle(t.ShadowWordDeath,H,aA,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death main 5"end end;if t.VoidBolt:IsCastable()and Q then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt main 6"end end;if t.DevouringPlague:IsReady()and P<=t.DevouringPlagueDebuff:BaseDuration()+4 then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague main "end end;if t.DevouringPlague:IsReady()and(g:InsanityDeficit()<=20 or g:BuffUp(t.VoidformBuff)and t.VoidBolt:CooldownRemains()>g:BuffRemains(t.VoidformBuff)and t.VoidBolt:CooldownRemains()<=g:BuffRemains(t.VoidformBuff)+2 or g:BuffUp(t.MindDevourerBuff)and g:PMultiplier(t.DevouringPlague)<1.2)then if L.CastCycle(t.DevouringPlague,H,as,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague main 8"end end;if t.ShadowCrash:IsCastable()and N and not Y and(not V and h:DebuffRefreshable(t.VampiricTouchDebuff))then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then return"shadow_crash main 10"end end;if t.VampiricTouch:IsCastable()then if L.CastTargetIf(t.VampiricTouch,H,"min",aq,ar,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch main 12"end end;if t.MindSpikeInsanity:IsReady()and(Q and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(t.MindSpikeInsanity,nil,nil,not h:IsInRange(40))then v=407466;return"mind_spike_insanity main 22"end end;if a3:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and Q and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(a3,nil,nil,not h:IsSpellInRange(a3))then aG()return"mind_flay main 24"end end;if t.MindBlast:IsCastable()and(Q and(g:BuffDown(t.MindDevourerBuff)or t.VoidEruption:CooldownUp()and t.VoidEruption:IsAvailable()))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast main 26"end end;if t.VoidTorrent:IsCastable()and not V then if L.CastCycle(t.VoidTorrent,H,aB,not h:IsSpellInRange(t.VoidTorrent),nil)then v=263165;return"void_torrent main 28"end end;if g:IsChanneling(t.VoidTorrent)then if o(t.Pool)then v=999910;return"channeling Void Torrent"end end;local ShouldReturn=aP()if ShouldReturn then return ShouldReturn end end;local function aT()if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt pl_torrent 2"end end;if t.VampiricTouch:IsCastable()and(h:DebuffRemains(t.VampiricTouchDebuff)<=6 and t.VoidTorrent:CooldownRemains()<g:GCD()*2)then if o(t.VampiricTouch,nil,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch pl_torrent 4"end end;if t.DevouringPlague:IsReady()and(h:DebuffRemains(t.DevouringPlagueDebuff)<=4 and t.VoidTorrent:CooldownRemains()<g:GCD()*2)then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague pl_torrent 6"end end;if t.MindBlast:IsCastable()and not g:PrevGCD(1,t.MindBlast)then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast pl_torrent 8"end end;if t.VoidTorrent:IsCastable()and(ac(h,false)or g:BuffUp(t.VoidformBuff))then if o(t.VoidTorrent,nil,nil,not h:IsSpellInRange(t.VoidTorrent))then v=263165;return"void_torrent pl_torrent 10"end end;if g:IsChanneling(t.VoidTorrent)then if o(t.Pool)then v=999910;return"channeling Void Torrent"end end end;local function aU()aL()if t.VampiricTouch:IsCastable()and(S>0 and not W and not t.ShadowCrash:InFlight()or not t.WhisperingShadows:IsAvailable())then if L.CastCycle(t.VampiricTouch,H,aC,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch aoe 2"end end;if t.ShadowCrash:IsCastable()and N and not V then if L.CastCycle(t.ShadowCrash,H,aw,not h:IsInRange(40),nil)then v=205385;return"shadow_crash aoe 4"end end;if n()and(P<30 or h:TimeToDie()>15 and(not V or K>2))then local ShouldReturn=aQ()if ShouldReturn then return ShouldReturn end end;if Z:IsCastable()and((h:DebuffUp(t.ShadowWordPainDebuff)and U or t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable())and(P<30 or h:TimeToDie()>15)and(not t.DarkAscension:IsAvailable()or t.DarkAscension:CooldownRemains()<a4 or P<15))then if o(Z,nil)then aF()return"mindbender aoe 6"end end;if t.MindBlast:IsCastable()and((t.MindBlast:FullRechargeTime()<=a4+t.MindBlast:CastTime()or a0<=t.MindBlast:CastTime()+a4)and _ and t.InescapableTorment:IsAvailable()and a0>t.MindBlast:CastTime()and K<=7 and g:BuffDown(t.MindDevourerBuff))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast aoe 8"end end;if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt aoe 10"end end;if t.DevouringPlague:IsReady()and(not X or g:InsanityDeficit()<=20 or g:BuffUp(t.VoidformBuff)and t.VoidBolt:CooldownRemains()>g:BuffRemains(t.VoidformBuff)and t.VoidBolt:CooldownRemains()<=g:BuffRemains(t.VoidformBuff)+2)then if L.CastCycle(t.DevouringPlague,H,at,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague aoe 12"end end;if t.VampiricTouch:IsCastable()and(S>0 and not t.ShadowCrash:InFlight()or not t.WhisperingShadows:IsAvailable())then if L.CastCycle(t.VampiricTouch,H,aD,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch aoe 14"end end;if t.MindSpikeInsanity:IsReady()and(Q and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(t.MindSpikeInsanity,nil,nil,not h:IsInRange(40))then v=407466;return"mind_spike_insanity aoe 18"end end;if a3:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and Q and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(a3,nil,nil,not h:IsSpellInRange(a3))then aG()return"mind_flay aoe 20"end end;if t.MindBlast:IsCastable()and(U and(g:BuffDown(t.MindDevourerBuff)or t.VoidEruption:CooldownUp()and t.VoidEruption:IsAvailable()))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast aoe 22"end end;if t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=3 and(not V or K/(t.VampiricTouchDebuff:AuraActiveCount()+K)<1.5)and(g:Insanity()>=50 or h:DebuffUp(t.DevouringPlagueDebuff)or g:BuffUp(t.DarkReveriesBuff)or g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscensionBuff))then local ShouldReturn=aT()if ShouldReturn then return ShouldReturn end end;if t.VoidTorrent:IsCastable()and not t.PsychicLink:IsAvailable()then if L.CastCycle(t.VoidTorrent,H,aE,not h:IsSpellInRange(t.VoidTorrent),nil)then v=263165;return"void_torrent aoe 26"end end;if g:IsChanneling(t.VoidTorrent)then if o(t.Pool)then v=999910;return"channeling Void Torrent"end end;if a3:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and t.IdolOfCthun:IsAvailable())then if o(a3,nil,nil,not h:IsSpellInRange(a3))then aG()return"mind_flay aoe 28"end end;local ShouldReturn=aP()if ShouldReturn then return ShouldReturn end end;local function aV()x=HeroRotationCharDB.Toggles[4]y=HeroRotationCharDB.Toggles[5]z=not HeroRotationCharDB.Toggles[15]A=HeroRotationCharDB.Toggles[12]B=HeroRotationCharDB.Toggles[61]C=HeroRotationCharDB.Toggles[174]D=HeroRotationCharDB.Toggles[62]end;local function aW()if not BotOn then w=0;v=0 end;if ShouldReturn then return ShouldReturn end;if w>0 then w=0 end;if v>0 then v=0 end;ShouldReturn=aV()if l.QueuedCast()then v=l.QueuedCast()return"Custom Queue "..j(v):ID()end;if B and t.MassDispell:IsUsableP()and t.MassDispell:CooldownRemains(BypassRecovery)<=0 then if l.Cast(t.MassDispell,nil,nil,nil)then v=327830;return"queue RingOfPeace"end elseif(not t.MassDispell:IsUsableP()or t.MassDispell:CooldownRemains(BypassRecovery)>0)and B then HeroRotationCharDB.Toggles[61]=not HeroRotationCharDB.Toggles[61]l.Print("Mass Dispel Queue is now "..(HeroRotationCharDB.Toggles[61]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if D and j(9484):IsUsableP()and j(9484):CooldownRemains(BypassRecovery)<=0 then if f("mouseover"):GUID()~=nil and f("mouseover"):IsInRange(30)then w=19484;return"queue Shackle MO"end elseif(not j(9484):IsUsableP()or j(9484):CooldownRemains()>0 or g:PrevGCD(1,j(9484)))and D then HeroRotationCharDB.Toggles[62]=not HeroRotationCharDB.Toggles[62]l.Print("Shackle Undead Queue is now "..(HeroRotationCharDB.Toggles[62]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if C and t.ShadowCrash:IsUsableP()and t.ShadowCrash:CooldownRemains(BypassRecovery)<=0 then if l.Cast(t.ShadowCrash,nil,nil,nil)then v=205385;return"queue ShadowCrash"end elseif(not t.ShadowCrash:IsUsableP()or t.ShadowCrash:CooldownRemains(BypassRecovery)>0)and C then HeroRotationCharDB.Toggles[174]=not HeroRotationCharDB.Toggles[174]l.Print("Shadow Crash Queue is now "..(HeroRotationCharDB.Toggles[174]and"|cff00ff00on|r."or"|cffff0000off|r."))end;local aX=g:AffectingCombat()and 180 or 900;local aY=g:BuffRemains(j(21562))if j(21562):IsAvailable()then BattleShoutRemains=g:BuffRemains(j(21562))if aY<aX then if o(t.PowerWordFortitude,nil)then v=21562;return"PowerWordFortitude refresh"end end end;if t.Shadowform:IsCastable()and not g:BuffUp(t.Shadowform)then if o(t.Shadowform,nil)then v=232698;return"shadowform precombat 4"end end;if t.PowerWordShield:IsCastable()and g:DebuffDown(t.WeakenedSoul)and not g:IsChanneling()and not g:IsCasting()and(M.Shadow.PWS=="Moving"and g:IsMoving()or M.Shadow.PWS=="Always"or M.Shadow.PWS=="OOC Moving"and g:IsMoving()and not g:AffectingCombat())then if o(t.PowerWordShield,nil)then v=17;return"PW:S Settings"end end;G=g:GetEnemiesInRange(30)H=g:GetEnemiesInRange(40)I=h:GetEnemiesInSplashRange(10)if m()then J=#G;K=h:GetEnemiesInSplashRangeCount(10)else J=1;K=1 end;if L.TargetIsValid()or g:AffectingCombat()then O=d.BossFightRemains()P=O;if P==11111 then P=d.FightRemains(I,false)end;_=Z:TimeSinceLastCast()<=15;a0=15-Z:TimeSinceLastCast()if a0<0 then a0=0 end;a3=g:BuffUp(t.MindFlayInsanityBuff)and t.MindFlayInsanity or t.MindFlay;a4=g:GCD()+0.25 end;if g:AffectingCombat()or y then if L.TargetIsValid()then if not g:AffectingCombat()then local ShouldReturn=aI()if ShouldReturn then return ShouldReturn end end;if t.Dispersion:IsCastable()and g:HealthPercentage()<M.Shadow.DispersionHP then if o(t.Dispersion,nil)then v=47585;return"dispersion low_hp"end end;if t.DesperatePrayer:IsCastable()and g:HealthPercentage()<M.Shadow.DesperatePrayerHP then if o(t.DesperatePrayer,nil)then v=19236;return"DesperatePrayer low_hp"end end;if g:HealthPercentage()<M.Commons.HealthstoneHP and u.Healthstone:IsReady()and u.Healthstone:CooldownRemains()<=0 then if l.Cast(u.Healthstone,nil)then v=40;return"Healthstone HP"end end;if g:HealthPercentage()<M.Commons.HealPotHP and u.CosmicHealPot:IsReady()and u.CosmicHealPot:CooldownRemains()<=0 then if l.Cast(u.CosmicHealPot,nil)then v=45;return"CosmicHealPot HP"end end;if g:HealthPercentage()<M.Commons.HealPotHP and u.HealPot:IsReady()and u.HealPot:CooldownRemains()<=0 then if l.Cast(u.HealPot,nil)then v=41;return"HealPot HP"end end;if ShouldReturn then return ShouldReturn end;V=false;Y=M.Shadow.PreferVTWhenSTinDungeon and K==1 and g:IsInDungeonArea()and g:IsInParty()and not g:IsInRaidArea()X=t.VoidEruption:CooldownRemains()<=g:GCD()*3 and t.VoidEruption:IsAvailable()or t.DarkAscension:CooldownUp()and t.DarkAscension:IsAvailable()or t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=4 and g:BuffDown(t.VoidformBuff)if a2==nil then a2=h:GUID()end;if a1==false and M.Shadow.UseOpener and h:GUID()==a2 and not ac(h,true)then local ShouldReturn=aO()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for Opener()"end else a1=true end;if K>2 or J>3 and g:AffectingCombat()then local ShouldReturn=aU()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for AoE()"end end;if true then local ShouldReturn=aS()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for Main()"end end end end end;local function aZ()t.VampiricTouchDebuff:RegisterAuraTracking()if HeroRotationCharDB.Toggles[5]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]l.ToggleIconFrame:UpdateButtonText(5)end;l.Print("Shadow Priest rotation is currently a work in progress, but has been updated for patch 10.1.5.")end;function ReturnSpell()if v==0 then return 0 else return v end end;function ReturnSpellMOShadow()if w==0 then return 0 else return w end end;l.SetAPL(258,aW,aZ)