local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Pet;local j=d.Spell;local k=d.Item;local l=HeroRotation;local m=l.AoEON;local n=l.CDsON;local o=l.Cast;local p=l.CastSuggested;local q=l.Commons.Everyone.num;local r=l.Commons.Everyone.bool;local s=math.min;local t=j.Priest.Shadow;local u=k.Priest.Shadow;local v=0;local w=0;local x=HeroRotationCharDB.Toggles[4]local y=HeroRotationCharDB.Toggles[5]local z=not HeroRotationCharDB.Toggles[15]local A=HeroRotationCharDB.Toggles[12]local B=HeroRotationCharDB.Toggles[61]local C=HeroRotationCharDB.Toggles[62]local function q(D)if D then return 1 else return 0 end end;local function r(D)return D~=0 end;local E={}local F,G,H;local I,J;local K=l.Commons.Everyone;local L={General=l.GUISettings.General,Commons=l.GUISettings.APL.Priest.Commons,Shadow=l.GUISettings.APL.Priest.Shadow}local M=11111;local N=11111;local O=false;local P=false;local Q=0;local R=false;local S=false;local T=false;local U=false;local V=false;local W=false;local X=t.Mindbender:IsAvailable()and t.Mindbender or t.Shadowfiend;local Y=false;local Z=0;local _=false;local a0=nil;local a1;local a2;local a3=g:GetEquipment()local a4=a3[13]and k(a3[13])or k(0)local a5=a3[14]and k(a3[14])or k(0)local a6=GetInventoryItemID("player",13)local a7=GetInventoryItemID("player",14)d:RegisterForEvent(function()M=11111;N=11111;O=false;P=false;VarMindSearCutoff=2;VarPoolAmount=60;Q=0;R=false;S=false;T=false;U=false;V=false;W=false;Y=false;Z=0;_=false;a0=nil end,"PLAYER_REGEN_ENABLED")d:RegisterForEvent(function()X=t.Mindbender:IsAvailable()and t.Mindbender or t.Shadowfiend end,"SPELLS_CHANGED","LEARNED_SPELL_IN_TAB")d:RegisterForEvent(function()t.ShadowCrash:RegisterInFlightEffect(205386)t.ShadowCrash:RegisterInFlight()end,"LEARNED_SPELL_IN_TAB")t.ShadowCrash:RegisterInFlightEffect(205386)t.ShadowCrash:RegisterInFlight()local function a8()local a9=1;if g:BuffUp(t.DarkAscensionBuff)then a9=a9*1.25 end;if g:BuffUp(t.DarkEvangelismBuff)then a9=a9*(1+0.01*g:BuffStack(t.DarkEvangelismBuff))end;if g:BuffUp(t.DevouredFearBuff)or g:BuffUp(t.DevouredPrideBuff)then a9=a9*1.05 end;if t.DistortedReality:IsAvailable()then a9=a9*1.2 end;if g:BuffUp(t.MindDevourerBuff)then a9=a9*1.2 end;if t.Voidtouched:IsAvailable()then a9=a9*1.06 end;return a9 end;t.DevouringPlague:RegisterPMultiplier(t.DevouringPlagueDebuff,a8)local function aa(ab,ac)if ac then return ab:DebuffUp(t.ShadowWordPainDebuff)and ab:DebuffUp(t.VampiricTouchDebuff)and ab:DebuffUp(t.DevouringPlagueDebuff)else return ab:DebuffUp(t.ShadowWordPainDebuff)and ab:DebuffUp(t.VampiricTouchDebuff)end end;local function ad(ae,af)if not ae then return nil end;local ag=0;local ah=nil;for ai,aj in pairs(ae)do local ak=aj:TimeToDie()if af then if ak*q(aj:DebuffRefreshable(t.VampiricTouchDebuff))>ag then ag=ak;ah=aj end else if ak>ag then ag=ak;ah=aj end end end;return ah end;local function al(am)return am:DebuffRemains(t.ShadowWordPainDebuff)end;local function an(am)return am:TimeToDie()end;local function ao(am)return am:DebuffRemains(t.VampiricTouchDebuff)end;local function ap(am)if am:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or T or not t.WhisperingShadows:IsAvailable())and(am:TimeToDie()>=12 or am:IsDummy())and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==f("mouseover"):GUID()and L.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif am:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or T or not t.WhisperingShadows:IsAvailable())and(am:TimeToDie()>=12 or am:IsDummy())and not t.Misery:IsAvailable()and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and L.Shadow.TargetSwap=="AutoSwap"and am:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif am:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or T or not t.WhisperingShadows:IsAvailable())and(am:TimeToDie()>=12 or am:IsDummy())and not t.Misery:IsAvailable()and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==h:GUID()then v=34914;return true elseif am:DebuffRefreshable(t.VampiricTouchDebuff)and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or T or not t.WhisperingShadows:IsAvailable())and(am:TimeToDie()>=12 or am:IsDummy())and not t.Misery:IsAvailable()and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)then return true end end;local function aq(am)return not t.DistortedReality:IsAvailable()or J==1 or am:DebuffRemains(t.DevouringPlagueDebuff)<=a2 end;local function ar(am)return am:DebuffRemains(t.DevouringPlagueDebuff)<=a2 or not t.DistortedReality:IsAvailable()end;local function as(am)return am:DebuffRemains(t.DevouringPlagueDebuff)>t.MindBlast:ExecuteTime()and t.MindBlast:FullRechargeTime()<=a2+t.MindBlast:ExecuteTime()or Z<=t.MindBlast:ExecuteTime()+a2 end;local function at(am)return aa(am,true)and am:DebuffRemains(t.DevouringPlagueDebuff)>=t.Mindgames:CastTime()end;local function au(am)return am:DebuffRefreshable(t.VampiricTouchDebuff)or am:DebuffRemains(t.VampiricTouchDebuff)<=am:TimeToDie()and g:BuffDown(t.VoidformBuff)end;local function av(am)return am:HealthPercentage()<20 and(X:CooldownRemains()>=10 or not t.InescapableTorment:IsAvailable())or Y and t.InescapableTorment:IsAvailable()or g:BuffUp(t.DeathspeakerBuff)end;local function aw(am)return am:HealthPercentage()<20 or g:BuffUp(t.DeathspeakerBuff)end;local function ax(am)return am:HealthPercentage()<20 end;local function ay(am)return am:DebuffUp(t.DevouringPlagueDebuff)and Z<=2 and Y and t.InescapableTorment:IsAvailable()and J<=7 end;local function al(am)return am:DebuffRemains(t.ShadowWordPainDebuff)end;local function az(am)return aa(am)and am:DebuffRemains(t.DevouringPlagueDebuff)>=2 end;local function aA(am)if(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==f("mouseover"):GUID()and L.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and L.Shadow.TargetSwap=="AutoSwap"and am:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==h:GUID()then v=34914;return true elseif(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)then return true end end;local function aB(am)if(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==f("mouseover"):GUID()and L.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and L.Shadow.TargetSwap=="AutoSwap"and am:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==h:GUID()then v=34914;return true elseif(am:DebuffRefreshable(t.VampiricTouchDebuff)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)then return true end end;local function aC(am)if(aa(am,false)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==f("mouseover"):GUID()and L.Shadow.TargetSwap=="Mouseover"then w=134914;return true elseif(aa(am,false)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and L.Shadow.TargetSwap=="AutoSwap"and am:GUID()~=h:GUID()and not A then w=999;if w==999 then starttime=GetTime()endtime=starttime+0.25 elseif w>0 and endtime~=nil and GetTime()>endtime then w=0 end;return true elseif(aa(am,false)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)and am:GUID()==h:GUID()then v=34914;return true elseif(aa(am,false)and(am:TimeToDie()>18 or am:IsDummy()or am:NPCID()==153285)and(am:DebuffUp(t.VampiricTouchDebuff)or not S)and Q>0 or t.Misery:IsAvailable()and am:DebuffRefreshable(t.ShadowWordPainDebuff))and(t.ShadowCrash:CooldownRemains()>=am:DebuffRemains(t.VampiricTouchDebuff)or am:DebuffDown(t.VampiricTouchDebuff))and t.ShadowCrash:TimeSinceLastCast()>1 and(am:AffectingCombat()or am:IsDummy()or am:NPCID()==153285 or am:NPCID()==168326)then return true end end;local function aD()if t.Mindbender:IsAvailable()then v=200174 else v=34433 end end;local function aE()if g:BuffUp(t.MindFlayInsanityBuff)then v=407466 else v=15407 end end;local function aF()if UnitGUID("focus")==nil then v=10060 else v=100606 end end;local function aG()a0=h:GUID()if t.ArcaneTorrent:IsCastable()and n()then if o(t.ArcaneTorrent,nil,nil,not h:IsSpellInRange(t.ArcaneTorrent))then w=11111;return"arcane_torrent precombat 6"end end;local aH=g:IsInParty()and g:IsInDungeonArea()and not g:IsInRaidArea()if t.ShadowCrash:IsCastable()and not aH then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash precombat 8"end end;if t.VampiricTouch:IsCastable()and(not t.ShadowCrash:IsAvailable()or t.ShadowCrash:CooldownDown()and not t.ShadowCrash:InFlight()or aH)then if o(t.VampiricTouch,nil,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch precombat 10"end end;if t.ShadowWordPain:IsCastable()and not t.Misery:IsAvailable()then if o(t.ShadowWordPain,nil,nil,not h:IsSpellInRange(t.ShadowWordPain))then v=589;return"shadow_word_pain precombat 12"end end end;local function aI()O=aa(h,false)or t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable()P=aa(h,true)V=t.VoidEruption:CooldownRemains()<=g:GCD()*3 and t.VoidEruption:IsAvailable()or t.DarkAscension:CooldownUp()and t.DarkAscension:IsAvailable()or t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=4 and g:BuffDown(t.VoidformBuff)end;local function aJ()Q=s(J,12)R=false;local ah=ad(H,true)if ah and ah:TimeToDie()>=18 then R=true end;S=t.VampiricTouchDebuff:AuraActiveCount()+8*q(t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable())>=Q or not R;if T and t.WhisperingShadows:IsAvailable()then T=Q-t.VampiricTouchDebuff:AuraActiveCount()<4 end;U=t.VampiricTouchDebuff:AuraActiveCount()+8*q(not T)>=Q or not R end;local function aK()if g:BuffUp(t.VoidformBuff)or g:BuffUp(t.PowerInfusionBuff)or g:BuffUp(t.DarkAscensionBuff)or N<20 then local aL=g:GetUseableTrinkets(E)if aL then if o(aL,nil,nil)then if aL:ID()==a6 and L.Commons.Enabled.TopTrinket then v=24;return"top trinket 1"elseif aL:ID()==a7 and L.Commons.Enabled.BottomTrinket then v=30;return"top trinket 2"end end end end end;local function aM()if t.ShadowCrash:IsCastable()and not W and h:DebuffDown(t.VampiricTouchDebuff)then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash opener 2"end end;if X:IsCastable()then if o(X,nil)then aD()return"mindbender opener 4"end end;if t.DarkAscension:IsCastable()then if o(t.DarkAscension,nil)then v=391109;return"dark_ascension opener 6"end end;if t.VoidEruption:IsAvailable()then if t.ShadowWordDeath:IsCastable()and t.InescapableTorment:IsAvailable()and g:PrevGCDP(1,t.MindBlast)and t.ShadowWordDeath:TimeSinceLastCast()>20 then if o(t.ShadowWordDeath,nil,nil,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death opener 8"end end;if t.MindBlast:IsCastable()then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast opener 10"end end;if t.VoidEruption:IsCastable()then if o(t.VoidEruption,nil)then v=228260;return"void_eruption opener 12"end end end;if t.PowerInfusion:IsCastable()and L.Shadow.SelfPI and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscension))then if o(t.PowerInfusion,nil)then aF()return"power_infusion opener 14"end end;if L.Commons.Enabled.TopTrinket or L.Commons.Enabled.BottomTrinket then local ShouldReturn=aK()if ShouldReturn then return ShouldReturn end end;if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt opener 16"end end;if t.DevouringPlague:IsReady()then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague opener 18"end end;if t.MindBlast:IsCastable()then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast opener 20"end end;if t.MindSpike:IsCastable()then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then return"mind_spike opener 22"end end;if t.MindFlay:IsCastable()then if o(t.MindFlay,nil,nil,not h:IsSpellInRange(t.MindFlay))then v=15407;return"mind_flay opener 24"end end end;local function aN()if t.VampiricTouch:IsCastable()and g:BuffUp(t.UnfurlingDarknessBuff)then if K.CastTargetIf(t.VampiricTouch,G,"min",ao,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch filler 2"end end;if t.ShadowWordDeath:IsReady()then if K.CastCycle(t.ShadowWordDeath,G,aw,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=136149;return"shadow_word_death filler 4"end end;if t.MindSpikeInsanity:IsReady()then if o(t.MindSpikeInsanity,nil,nil,not h:IsSpellInRange(t.MindSpikeInsanity))then v=407466;return"mind_spike_insanity filler 6"end end;if t.MindFlay:IsCastable()and g:BuffUp(t.MindFlayInsanityBuff)then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then v=15407;return"mind_flay filler 8"end end;if t.Mindgames:IsReady()then if o(t.Mindgames,nil,nil,not h:IsInRange(40))then v=323673;return"mindgames filler 10"end end;if t.ShadowWordDeath:IsReady()and(t.InescapableTorment:IsAvailable()and Y)then if K.CastTargetIf(t.ShadowWordDeath,G,"min",an,nil,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=589;return"shadow_word_death filler 12"end end;if t.Halo:IsReady()then if o(t.Halo,nil,nil,not h:IsInRange(30))then v=120644;return"halo filler 14"end end;if t.DevouringPlague:IsReady()and g:BuffUp(t.VoidformBuff)then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague filler 16"end end;if t.MindSpike:IsCastable()then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then v=73510;return"mind_spike filler 18"end end;if a1:IsCastable()then if o(a1,nil,nil,not h:IsSpellInRange(a1))then aE()return"mind_flay filler 20"end end;if t.ShadowCrash:IsCastable()then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash filler 22"end end;if t.ShadowWordDeath:IsReady()then if K.CastCycle(t.ShadowWordDeath,G,ax,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=136149;return"shadow_word_death filler 24"end end;if t.ShadowWordDeath:IsReady()and g:IsMoving()then if o(t.ShadowWordDeath,nil,nil,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death movement filler 26"end end;if t.ShadowWordPain:IsReady()and g:IsMoving()then if K.CastTargetIf(t.ShadowWordPain,G,"min",al,nil,not h:IsSpellInRange(t.ShadowWordPain))then v=589;return"shadow_word_pain filler 28"end end end;local function aO()if L.Commons.Enabled.Potions and z and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.PowerInfusionBuff)or g:BuffUp(t.DarkAscensionBuff)and N<=t.PowerInfusion:CooldownRemains()+15 or M<=30)then local aP=K.PotionSelected()if aP and aP:IsReady()then if o(aP,nil,nil)then v=50;return"potion cds 2"end end end;if t.Fireblood:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or N<=8)then if o(t.Fireblood,nil)then v=265221;return"fireblood cds 4"end end;if t.Berserking:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or N<=12)then if o(t.Berserking,nil)then v=26297;return"berserking cds 6"end end;if t.BloodFury:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or N<=15)then if o(t.BloodFury,nil)then v=33697;return"blood_fury cds 8"end end;if t.AncestralCall:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or N<=15)then if o(t.AncestralCall,nil)then v=274738;return"ancestral_call cds 10"end end;if t.PowerInfusion:IsCastable()and L.Shadow.SelfPI and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscension))then if o(t.PowerInfusion,nil)then aF()return"power_infusion cds 12"end end;if t.VoidEruption:IsCastable()and(X:CooldownDown()and(Y and X:CooldownRemains()>=4 or not t.Mindbender:IsAvailable()or J>2 and not t.InescapableTorment:IsAvailable())and(t.MindBlast:Charges()==0 or d.CombatTime()>15))then if o(t.VoidEruption,nil)then v=228260;return"void_eruption cds 14"end end;if t.DarkAscension:IsCastable()and not g:IsCasting(t.DarkAscension)and(Y and X:CooldownRemains()>=4 or not t.Mindbender:IsAvailable()and X:CooldownDown()or J>2 and not t.InescapableTorment:IsAvailable())then if o(t.DarkAscension,nil)then v=391109;return"dark_ascension cds 16"end end;if L.Commons.Enabled.TopTrinket or L.Commons.Enabled.BottomTrinket then local ShouldReturn=aK()if ShouldReturn then return ShouldReturn end end end;local function aQ()aI()if n()and(N<30 or h:TimeToDie()>15 and(not T or J>2))then local ShouldReturn=aO()if ShouldReturn then return ShouldReturn end end;if X:IsCastable()and(O and(N<30 or h:TimeToDie()>15)and(not t.DarkAscension:IsAvailable()or t.DarkAscension:CooldownRemains()<a2 or N<15))then if o(X,nil)then aD()return"mindbender main 2"end end;if t.MindBlast:IsCastable()and(Y and t.InescapableTorment:IsAvailable()and Z>t.MindBlast:ExecuteTime()and J<=7)then if K.CastCycle(t.MindBlast,G,as,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast main 4"end end;if t.ShadowWordDeath:IsReady()then if K.CastCycle(t.ShadowWordDeath,G,ay,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death main 5"end end;if t.VoidBolt:IsCastable()and O then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt main 6"end end;if t.DevouringPlague:IsReady()and N<=t.DevouringPlagueDebuff:BaseDuration()+4 then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague main "end end;if t.DevouringPlague:IsReady()and(g:InsanityDeficit()<=20 or g:BuffUp(t.VoidformBuff)and t.VoidBolt:CooldownRemains()>g:BuffRemains(t.VoidformBuff)and t.VoidBolt:CooldownRemains()<=g:BuffRemains(t.VoidformBuff)+2 or g:BuffUp(t.MindDevourerBuff)and g:PMultiplier(t.DevouringPlague)<1.2)then if K.CastCycle(t.DevouringPlague,G,aq,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague main 8"end end;if t.ShadowCrash:IsCastable()and not W and(not T and h:DebuffRefreshable(t.VampiricTouchDebuff))then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash main 10"end end;if t.VampiricTouch:IsCastable()then if K.CastTargetIf(t.VampiricTouch,G,"min",ao,ap,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch main 12"end end;if t.MindSpikeInsanity:IsReady()and(O and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(t.MindSpikeInsanity,nil,nil,not h:IsInRange(40))then v=407466;return"mind_spike_insanity main 22"end end;if a1:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and O and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(a1,nil,nil,not h:IsSpellInRange(a1))then aE()return"mind_flay main 24"end end;if t.MindBlast:IsCastable()and(O and(g:BuffDown(t.MindDevourerBuff)or t.VoidEruption:CooldownUp()and t.VoidEruption:IsAvailable()))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast main 26"end end;if t.VoidTorrent:IsCastable()and not T then if K.CastCycle(t.VoidTorrent,G,az,not h:IsSpellInRange(t.VoidTorrent),nil)then v=263165;return"void_torrent main 28"end end;local ShouldReturn=aN()if ShouldReturn then return ShouldReturn end end;local function aR()if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt pl_torrent 2"end end;if t.VampiricTouch:IsCastable()and(h:DebuffRemains(t.VampiricTouchDebuff)<=6 and t.VoidTorrent:CooldownRemains()<g:GCD()*2)then if o(t.VampiricTouch,nil,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch pl_torrent 4"end end;if t.DevouringPlague:IsReady()and(h:DebuffRemains(t.DevouringPlagueDebuff)<=4 and t.VoidTorrent:CooldownRemains()<g:GCD()*2)then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague pl_torrent 6"end end;if t.MindBlast:IsCastable()and not g:PrevGCD(1,t.MindBlast)then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast pl_torrent 8"end end;if t.VoidTorrent:IsCastable()and(aa(h,false)or g:BuffUp(t.VoidformBuff))then if o(t.VoidTorrent,nil,nil,not h:IsSpellInRange(t.VoidTorrent))then v=263165;return"void_torrent pl_torrent 10"end end end;local function aS()aJ()if t.VampiricTouch:IsCastable()and(Q>0 and not U and not t.ShadowCrash:InFlight()or not t.WhisperingShadows:IsAvailable())then if K.CastCycle(t.VampiricTouch,G,aA,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch aoe 2"end end;if t.ShadowCrash:IsCastable()and not T then if K.CastCycle(t.ShadowCrash,G,au,not h:IsInRange(40),nil)then v=205385;return"shadow_crash aoe 4"end end;if n()and(N<30 or h:TimeToDie()>15 and(not T or J>2))then local ShouldReturn=aO()if ShouldReturn then return ShouldReturn end end;if X:IsCastable()and((h:DebuffUp(t.ShadowWordPainDebuff)and S or t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable())and(N<30 or h:TimeToDie()>15)and(not t.DarkAscension:IsAvailable()or t.DarkAscension:CooldownRemains()<a2 or N<15))then if o(X,nil)then aD()return"mindbender aoe 6"end end;if t.MindBlast:IsCastable()and((t.MindBlast:FullRechargeTime()<=a2+t.MindBlast:CastTime()or Z<=t.MindBlast:CastTime()+a2)and Y and t.InescapableTorment:IsAvailable()and Z>t.MindBlast:CastTime()and J<=7 and g:BuffDown(t.MindDevourerBuff))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast aoe 8"end end;if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt aoe 10"end end;if t.DevouringPlague:IsReady()and(not V or g:InsanityDeficit()<=20 or g:BuffUp(t.VoidformBuff)and t.VoidBolt:CooldownRemains()>g:BuffRemains(t.VoidformBuff)and t.VoidBolt:CooldownRemains()<=g:BuffRemains(t.VoidformBuff)+2)then if K.CastCycle(t.DevouringPlague,G,ar,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague aoe 12"end end;if t.VampiricTouch:IsCastable()and(Q>0 and not t.ShadowCrash:InFlight()or not t.WhisperingShadows:IsAvailable())then if K.CastCycle(t.VampiricTouch,G,aB,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch aoe 14"end end;if t.MindSpikeInsanity:IsReady()and(O and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(t.MindSpikeInsanity,nil,nil,not h:IsInRange(40))then v=407466;return"mind_spike_insanity aoe 18"end end;if a1:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and O and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(a1,nil,nil,not h:IsSpellInRange(a1))then aE()return"mind_flay aoe 20"end end;if t.MindBlast:IsCastable()and(S and(g:BuffDown(t.MindDevourerBuff)or t.VoidEruption:CooldownUp()and t.VoidEruption:IsAvailable()))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast aoe 22"end end;if t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=3 and(not T or J/(t.VampiricTouchDebuff:AuraActiveCount()+J)<1.5)and(g:Insanity()>=50 or h:DebuffUp(t.DevouringPlagueDebuff)or g:BuffUp(t.DarkReveriesBuff)or g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscensionBuff))then local ShouldReturn=aR()if ShouldReturn then return ShouldReturn end end;if t.VoidTorrent:IsCastable()and not t.PsychicLink:IsAvailable()then if K.CastCycle(t.VoidTorrent,G,aC,not h:IsSpellInRange(t.VoidTorrent),nil)then v=263165;return"void_torrent aoe 26"end end;if a1:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and t.IdolOfCthun:IsAvailable())then if o(a1,nil,nil,not h:IsSpellInRange(a1))then aE()return"mind_flay aoe 28"end end;local ShouldReturn=aN()if ShouldReturn then return ShouldReturn end end;local function aT()x=HeroRotationCharDB.Toggles[4]y=HeroRotationCharDB.Toggles[5]z=not HeroRotationCharDB.Toggles[15]A=HeroRotationCharDB.Toggles[12]B=HeroRotationCharDB.Toggles[61]C=HeroRotationCharDB.Toggles[62]end;local function aU()if not BotOn then w=0;v=0 end;if ShouldReturn then return ShouldReturn end;if w>0 then w=0 end;if v>0 then v=0 end;ShouldReturn=aT()if l.QueuedCast()then v=l.QueuedCast()return"Custom Queue "..j(v):ID()end;if B and t.MassDispell:IsUsableP()and t.MassDispell:CooldownRemains(BypassRecovery)<=0 then if l.Cast(t.MassDispell,nil,nil,nil)then v=327830;return"queue RingOfPeace"end elseif(not t.MassDispell:IsUsableP()or t.MassDispell:CooldownRemains(BypassRecovery)>0)and B then HeroRotationCharDB.Toggles[61]=not HeroRotationCharDB.Toggles[61]l.Print("Mass Dispel Queue is now "..(HeroRotationCharDB.Toggles[61]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if C and j(9484):IsUsableP()and j(9484):CooldownRemains(BypassRecovery)<=0 then if f("mouseover"):GUID()~=nil and f("mouseover"):IsInRange(30)then w=19484;return"queue Shackle MO"end elseif(not j(9484):IsUsableP()or j(9484):CooldownRemains()>0 or g:PrevGCD(1,j(9484)))and C then HeroRotationCharDB.Toggles[62]=not HeroRotationCharDB.Toggles[62]l.Print("Shackle Undead Queue is now "..(HeroRotationCharDB.Toggles[62]and"|cff00ff00on|r."or"|cffff0000off|r."))end;local aV=g:AffectingCombat()and 180 or 900;local aW=g:BuffRemains(j(21562))if j(21562):IsAvailable()then BattleShoutRemains=g:BuffRemains(j(21562))if aW<aV then if o(t.PowerWordFortitude,nil)then v=21562;return"PowerWordFortitude refresh"end end end;if t.Shadowform:IsCastable()and not g:BuffUp(t.Shadowform)then if o(t.Shadowform,nil)then v=232698;return"shadowform precombat 4"end end;if t.PowerWordShield:IsCastable()and g:DebuffDown(t.WeakenedSoul)and not g:IsChanneling()and not g:IsCasting()and(L.Shadow.PWS=="Moving"and g:IsMoving()or L.Shadow.PWS=="Always"or L.Shadow.PWS=="OOC Moving"and g:IsMoving()and not g:AffectingCombat())then if o(t.PowerWordShield,nil)then v=17;return"PW:S Settings"end end;F=g:GetEnemiesInRange(30)G=g:GetEnemiesInRange(40)H=h:GetEnemiesInSplashRange(10)if m()then I=#F;J=h:GetEnemiesInSplashRangeCount(10)else I=1;J=1 end;if K.TargetIsValid()or g:AffectingCombat()then M=d.BossFightRemains()N=M;if N==11111 then N=d.FightRemains(H,false)end;Y=X:TimeSinceLastCast()<=15;Z=15-X:TimeSinceLastCast()if Z<0 then Z=0 end;a1=g:BuffUp(t.MindFlayInsanityBuff)and t.MindFlayInsanity or t.MindFlay;a2=g:GCD()+0.25 end;if g:AffectingCombat()or y then if K.TargetIsValid()then if not g:AffectingCombat()then local ShouldReturn=aG()if ShouldReturn then return ShouldReturn end end;if t.Dispersion:IsCastable()and g:HealthPercentage()<L.Shadow.DispersionHP then if o(t.Dispersion,nil)then v=47585;return"dispersion low_hp"end end;if t.DesperatePrayer:IsCastable()and g:HealthPercentage()<L.Shadow.DesperatePrayerHP then if o(t.DesperatePrayer,nil)then v=19236;return"DesperatePrayer low_hp"end end;if g:HealthPercentage()<L.Commons.HealthstoneHP and u.Healthstone:IsReady()and u.Healthstone:CooldownRemains()<=0 then if l.Cast(u.Healthstone,nil)then v=40;return"Healthstone HP"end end;if g:HealthPercentage()<L.Commons.HealPotHP and u.CosmicHealPot:IsReady()and u.CosmicHealPot:CooldownRemains()<=0 then if l.Cast(u.CosmicHealPot,nil)then v=45;return"CosmicHealPot HP"end end;if g:HealthPercentage()<L.Commons.HealPotHP and u.HealPot:IsReady()and u.HealPot:CooldownRemains()<=0 then if l.Cast(u.HealPot,nil)then v=41;return"HealPot HP"end end;if ShouldReturn then return ShouldReturn end;T=false;W=L.Shadow.PreferVTWhenSTinDungeon and J==1 and g:IsInDungeonArea()and g:IsInParty()and not g:IsInRaidArea()V=t.VoidEruption:CooldownRemains()<=g:GCD()*3 and t.VoidEruption:IsAvailable()or t.DarkAscension:CooldownUp()and t.DarkAscension:IsAvailable()or t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=4 and g:BuffDown(t.VoidformBuff)if a0==nil then a0=h:GUID()end;if _==false and L.Shadow.UseOpener and h:GUID()==a0 and not aa(h,true)then local ShouldReturn=aM()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for Opener()"end else _=true end;if J>2 or I>3 and g:AffectingCombat()then local ShouldReturn=aS()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for AoE()"end end;if true then local ShouldReturn=aQ()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for Main()"end end end end end;local function aX()t.VampiricTouchDebuff:RegisterAuraTracking()if HeroRotationCharDB.Toggles[5]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]l.ToggleIconFrame:UpdateButtonText(5)end;l.Print("Shadow Priest rotation is currently a work in progress, but has been updated for patch 10.1.5.")end;function ReturnSpell()if v==0 then return 0 else return v end end;function ReturnSpellMOShadow()if w==0 then return 0 else return w end end;l.SetAPL(258,aU,aX)