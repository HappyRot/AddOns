local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Pet;local j=d.Spell;local k=d.Item;local l=HeroRotation;local m=l.AoEON;local n=l.CDsON;local o=l.Cast;local p=l.CastSuggested;local q=l.Commons.Everyone.num;local r=l.Commons.Everyone.bool;local s=math.min;local t=j.Priest.Shadow;local u=k.Priest.Shadow;local v=0;local w=0;local x=HeroRotationCharDB.Toggles[4]local y=HeroRotationCharDB.Toggles[5]local function q(z)if z then return 1 else return 0 end end;local function r(z)return z~=0 end;local A={u.BeacontotheBeyond:ID(),u.DesperateInvokersCodex:ID(),u.DMDDance:ID(),u.DMDDanceBox:ID(),u.DMDInferno:ID(),u.DMDInfernoBox:ID(),u.DMDRime:ID(),u.DMDRimeBox:ID(),u.EruptingSpearFragment:ID(),u.VoidmendersShadowgem:ID()}local B,C,D;local E,F;local G=l.Commons.Everyone;local H={General=l.GUISettings.General,Commons=l.GUISettings.APL.Priest.Commons,Shadow=l.GUISettings.APL.Priest.Shadow}local I=11111;local J=11111;local K=false;local L=false;local M=0;local N=false;local O=false;local P=false;local Q=false;local R=false;local S=false;local T=t.Mindbender:IsAvailable()and t.Mindbender or t.Shadowfiend;local U=false;local V=0;local W=false;local X=nil;local Y;local Z;d:RegisterForEvent(function()I=11111;J=11111;K=false;L=false;VarMindSearCutoff=2;VarPoolAmount=60;M=0;N=false;O=false;P=false;Q=false;R=false;S=false;U=false;V=0;W=false;X=nil end,"PLAYER_REGEN_ENABLED")d:RegisterForEvent(function()T=t.Mindbender:IsAvailable()and t.Mindbender or t.Shadowfiend end,"SPELLS_CHANGED","LEARNED_SPELL_IN_TAB")d:RegisterForEvent(function()t.ShadowCrash:RegisterInFlightEffect(205386)t.ShadowCrash:RegisterInFlight()end,"LEARNED_SPELL_IN_TAB")t.ShadowCrash:RegisterInFlightEffect(205386)t.ShadowCrash:RegisterInFlight()local function _()local a0=1;if g:BuffUp(t.DarkAscensionBuff)then a0=a0*1.25 end;if g:BuffUp(t.DarkEvangelismBuff)then a0=a0*(1+0.01*g:BuffStack(t.DarkEvangelismBuff))end;if g:BuffUp(t.DevouredFearBuff)or g:BuffUp(t.DevouredPrideBuff)then a0=a0*1.05 end;if t.DistortedReality:IsAvailable()then a0=a0*1.2 end;if g:BuffUp(t.MindDevourerBuff)then a0=a0*1.2 end;if t.Voidtouched:IsAvailable()then a0=a0*1.06 end;return a0 end;t.DevouringPlague:RegisterPMultiplier(t.DevouringPlagueDebuff,_)local function a1(a2,a3)if a3 then return a2:DebuffUp(t.ShadowWordPainDebuff)and a2:DebuffUp(t.VampiricTouchDebuff)and a2:DebuffUp(t.DevouringPlagueDebuff)else return a2:DebuffUp(t.ShadowWordPainDebuff)and a2:DebuffUp(t.VampiricTouchDebuff)end end;local function a4(a5,a6)if not a5 then return nil end;local a7=0;local a8=nil;for a9,aa in pairs(a5)do local ab=aa:TimeToDie()if a6 then if ab*q(aa:DebuffRefreshable(t.VampiricTouchDebuff))>a7 then a7=ab;a8=aa end else if ab>a7 then a7=ab;a8=aa end end end;return a8 end;local function ac(ad)return ad:DebuffRemains(t.ShadowWordPainDebuff)end;local function ae(ad)return ad:TimeToDie()end;local function af(ad)return ad:DebuffRemains(t.VampiricTouchDebuff)end;local function ag(ad)return ad:DebuffRefreshable(t.VampiricTouchDebuff)and ad:TimeToDie()>=12 and(t.ShadowCrash:CooldownRemains()>=ad:DebuffRemains(t.VampiricTouchDebuff)and not t.ShadowCrash:InFlight()or P or not t.WhisperingShadows:IsAvailable())end;local function ah(ad)return not t.DistortedReality:IsAvailable()or F==1 or ad:DebuffRemains(t.DevouringPlagueDebuff)<=Z end;local function ai(ad)return ad:DebuffRemains(t.DevouringPlagueDebuff)<=Z or not t.DistortedReality:IsAvailable()end;local function aj(ad)return ad:DebuffRemains(t.DevouringPlagueDebuff)>t.MindBlast:ExecuteTime()and t.MindBlast:FullRechargeTime()<=Z+t.MindBlast:ExecuteTime()or V<=t.MindBlast:ExecuteTime()+Z end;local function ak(ad)return a1(ad,true)and ad:DebuffRemains(t.DevouringPlagueDebuff)>=t.Mindgames:CastTime()end;local function al(ad)return ad:DebuffRefreshable(t.VampiricTouchDebuff)or ad:DebuffRemains(t.VampiricTouchDebuff)<=ad:TimeToDie()and g:BuffDown(t.VoidformBuff)end;local function am(ad)return ad:HealthPercentage()<20 and(T:CooldownRemains()>=10 or not t.InescapableTorment:IsAvailable())or U and t.InescapableTorment:IsAvailable()or g:BuffUp(t.DeathspeakerBuff)end;local function an(ad)return ad:HealthPercentage()<20 or g:BuffUp(t.DeathspeakerBuff)end;local function ao(ad)return ad:HealthPercentage()<20 end;local function ap(ad)return ad:DebuffUp(t.DevouringPlagueDebuff)and V<=2 and U and t.InescapableTorment:IsAvailable()and F<=7 end;local function ac(ad)return ad:DebuffRemains(t.ShadowWordPainDebuff)end;local function aq(ad)return a1(ad)and ad:DebuffRemains(t.DevouringPlagueDebuff)>=2 end;local function ar(ad)return ad:DebuffRefreshable(t.VampiricTouchDebuff)and ad:TimeToDie()>=18 and(ad:DebuffUp(t.VampiricTouchDebuff)or not O)end;local function as(ad)if t.ShadowCrash:CooldownRemains()>=ad:DebuffRemains(t.VampiricTouchDebuff)or P then return ad:DebuffRefreshable(t.VampiricTouchDebuff)and ad:TimeToDie()>=18 and(ad:DebuffUp(t.VampiricTouchDebuff)or not O)end;return nil end;local function at(ad)return a1(ad,false)end;local function au()if t.Mindbender:IsAvailable()then v=200174 else v=34433 end end;local function av()if g:BuffUp(t.MindFlayInsanityBuff)then v=407466 else v=15407 end end;local function aw()X=h:GUID()if t.ArcaneTorrent:IsCastable()and n()then if o(t.ArcaneTorrent,nil,nil,not h:IsSpellInRange(t.ArcaneTorrent))then w=11111;return"arcane_torrent precombat 6"end end;local ax=g:IsInParty()and g:IsInDungeonArea()and not g:IsInRaidArea()if t.ShadowCrash:IsCastable()and not ax then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash precombat 8"end end;if t.VampiricTouch:IsCastable()and(not t.ShadowCrash:IsAvailable()or t.ShadowCrash:CooldownDown()and not t.ShadowCrash:InFlight()or ax)then if o(t.VampiricTouch,nil,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch precombat 10"end end;if t.ShadowWordPain:IsCastable()and not t.Misery:IsAvailable()then if o(t.ShadowWordPain,nil,nil,not h:IsSpellInRange(t.ShadowWordPain))then v=589;return"shadow_word_pain precombat 12"end end end;local function ay()K=a1(h,false)or t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable()L=a1(h,true)R=t.VoidEruption:CooldownRemains()<=g:GCD()*3 and t.VoidEruption:IsAvailable()or t.DarkAscension:CooldownUp()and t.DarkAscension:IsAvailable()or t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=4 and g:BuffDown(t.VoidformBuff)end;local function az()M=s(F,12)N=false;local a8=a4(D,true)if a8 and a8:TimeToDie()>=18 then N=true end;O=t.VampiricTouchDebuff:AuraActiveCount()+8*q(t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable())>=M or not N;if P and t.WhisperingShadows:IsAvailable()then P=M-t.VampiricTouchDebuff:AuraActiveCount()<4 end;Q=t.VampiricTouchDebuff:AuraActiveCount()+8*q(not P)>=M or not N end;local function aA()if g:BuffUp(t.VoidformBuff)or g:BuffUp(t.PowerInfusionBuff)or g:BuffUp(t.DarkAscensionBuff)or J<20 then local aB=g:GetUseableTrinkets(A)if aB then if o(aB,nil,nil)then if aB:ID()==TopTrinketID and H.Commons.Enabled.TopTrinket then v=24;return"top trinket 1"elseif aB:ID()==BotTrinketID and H.Commons.Enabled.BottomTrinket then v=30;return"top trinket 2"end end end end end;local function aC()if t.ShadowCrash:IsCastable()and not S and h:DebuffDown(t.VampiricTouchDebuff)then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash opener 2"end end;if T:IsCastable()then if o(T,nil)then au()return"mindbender opener 4"end end;if t.DarkAscension:IsCastable()then if o(t.DarkAscension,nil)then v=391109;return"dark_ascension opener 6"end end;if t.VoidEruption:IsAvailable()then if t.ShadowWordDeath:IsCastable()and t.InescapableTorment:IsAvailable()and g:PrevGCDP(1,t.MindBlast)and t.ShadowWordDeath:TimeSinceLastCast()>20 then if o(t.ShadowWordDeath,nil,nil,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death opener 8"end end;if t.MindBlast:IsCastable()then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast opener 10"end end;if t.VoidEruption:IsCastable()then if o(t.VoidEruption,nil)then v=228260;return"void_eruption opener 12"end end end;if t.PowerInfusion:IsCastable()and H.Shadow.SelfPI and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscension))then if o(t.PowerInfusion,nil)then v=10060;return"power_infusion opener 14"end end;if H.Commons.Enabled.Trinkets or H.Commons.Enabled.Items then local ShouldReturn=aA()if ShouldReturn then return ShouldReturn end end;if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt opener 16"end end;if t.DevouringPlague:IsReady()then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague opener 18"end end;if t.MindBlast:IsCastable()then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast opener 20"end end;if t.MindSpike:IsCastable()then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then return"mind_spike opener 22"end end;if t.MindFlay:IsCastable()then if o(t.MindFlay,nil,nil,not h:IsSpellInRange(t.MindFlay))then v=15407;return"mind_flay opener 24"end end end;local function aD()if t.VampiricTouch:IsCastable()and g:BuffUp(t.UnfurlingDarknessBuff)then if G.CastTargetIf(t.VampiricTouch,C,"min",af,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch filler 2"end end;if t.ShadowWordDeath:IsReady()then if G.CastCycle(t.ShadowWordDeath,C,an,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=136149;return"shadow_word_death filler 4"end end;if t.MindSpikeInsanity:IsReady()then if o(t.MindSpikeInsanity,nil,nil,not h:IsSpellInRange(t.MindSpikeInsanity))then v=407466;return"mind_spike_insanity filler 6"end end;if t.MindFlay:IsCastable()and g:BuffUp(t.MindFlayInsanityBuff)then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then v=15407;return"mind_flay filler 8"end end;if t.Mindgames:IsReady()then if o(t.Mindgames,nil,nil,not h:IsInRange(40))then v=323673;return"mindgames filler 10"end end;if t.ShadowWordDeath:IsReady()and(t.InescapableTorment:IsAvailable()and U)then if G.CastTargetIf(t.ShadowWordDeath,C,"min",ae,nil,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=589;return"shadow_word_death filler 12"end end;if t.Halo:IsReady()then if o(t.Halo,H.Shadow.GCDasOffGCD.Halo,nil,not h:IsInRange(30))then v=120644;return"halo filler 14"end end;if t.DevouringPlague:IsReady()and g:BuffUp(t.VoidformBuff)then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague filler 16"end end;if t.MindSpike:IsCastable()then if o(t.MindSpike,nil,nil,not h:IsSpellInRange(t.MindSpike))then v=73510;return"mind_spike filler 18"end end;if Y:IsCastable()then if o(Y,nil,nil,not h:IsSpellInRange(Y))then av()return"mind_flay filler 20"end end;if t.ShadowCrash:IsCastable()then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash filler 22"end end;if t.ShadowWordDeath:IsReady()then if G.CastCycle(t.ShadowWordDeath,C,ao,not h:IsSpellInRange(t.ShadowWordDeath),nil)then v=136149;return"shadow_word_death filler 24"end end;if t.ShadowWordDeath:IsReady()and g:IsMoving()then if o(t.ShadowWordDeath,nil,nil,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death movement filler 26"end end;if t.ShadowWordPain:IsReady()and g:IsMoving()then if G.CastTargetIf(t.ShadowWordPain,C,"min",ac,nil,not h:IsSpellInRange(t.ShadowWordPain))then v=589;return"shadow_word_pain filler 28"end end end;local function aE()if H.Commons.Enabled.Potions and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.PowerInfusionBuff)or g:BuffUp(t.DarkAscensionBuff)and J<=t.PowerInfusion:CooldownRemains()+15 or I<=30)then local aF=G.PotionSelected()if aF and aF:IsReady()then if o(aF,nil,nil)then v=50;return"potion cds 2"end end end;if t.Fireblood:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or J<=8)then if o(t.Fireblood,nil)then v=265221;return"fireblood cds 4"end end;if t.Berserking:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or J<=12)then if o(t.Berserking,nil)then v=26297;return"berserking cds 6"end end;if t.BloodFury:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or J<=15)then if o(t.BloodFury,nil)then v=33697;return"blood_fury cds 8"end end;if t.AncestralCall:IsCastable()and(g:BuffUp(t.PowerInfusionBuff)or J<=15)then if o(t.AncestralCall,nil)then v=274738;return"ancestral_call cds 10"end end;if t.PowerInfusion:IsCastable()and H.Shadow.SelfPI and(g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscension))then if o(t.PowerInfusion,nil)then v=10060;return"power_infusion cds 12"end end;if t.VoidEruption:IsCastable()and(T:CooldownDown()and(U and T:CooldownRemains()>=4 or not t.Mindbender:IsAvailable()or F>2 and not t.InescapableTorment:IsAvailable())and(t.MindBlast:Charges()==0 or d.CombatTime()>15))then if o(t.VoidEruption,nil)then v=228260;return"void_eruption cds 14"end end;if t.DarkAscension:IsCastable()and not g:IsCasting(t.DarkAscension)and(U and T:CooldownRemains()>=4 or not t.Mindbender:IsAvailable()and T:CooldownDown()or F>2 and not t.InescapableTorment:IsAvailable())then if o(t.DarkAscension,nil)then v=391109;return"dark_ascension cds 16"end end;if H.Commons.Enabled.Trinkets or H.Commons.Enabled.Items then local ShouldReturn=aA()if ShouldReturn then return ShouldReturn end end end;local function aG()ay()if n()and(J<30 or h:TimeToDie()>15 and(not P or F>2))then local ShouldReturn=aE()if ShouldReturn then return ShouldReturn end end;if T:IsCastable()and(K and(J<30 or h:TimeToDie()>15)and(not t.DarkAscension:IsAvailable()or t.DarkAscension:CooldownRemains()<Z or J<15))then if o(T,nil)then au()return"mindbender main 2"end end;if t.MindBlast:IsCastable()and(U and t.InescapableTorment:IsAvailable()and V>t.MindBlast:ExecuteTime()and F<=7)then if G.CastCycle(t.MindBlast,C,aj,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast main 4"end end;if t.ShadowWordDeath:IsReady()then if G.CastCycle(t.ShadowWordDeath,C,ap,not h:IsSpellInRange(t.ShadowWordDeath))then v=136149;return"shadow_word_death main 5"end end;if t.VoidBolt:IsCastable()and K then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt main 6"end end;if t.DevouringPlague:IsReady()and J<=t.DevouringPlagueDebuff:BaseDuration()+4 then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague main "end end;if t.DevouringPlague:IsReady()and(g:InsanityDeficit()<=20 or g:BuffUp(t.VoidformBuff)and t.VoidBolt:CooldownRemains()>g:BuffRemains(t.VoidformBuff)and t.VoidBolt:CooldownRemains()<=g:BuffRemains(t.VoidformBuff)+2 or g:BuffUp(t.MindDevourerBuff)and g:PMultiplier(t.DevouringPlague)<1.2)then if G.CastCycle(t.DevouringPlague,C,ah,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague main 8"end end;if t.ShadowCrash:IsCastable()and not S and(not P and h:DebuffRefreshable(t.VampiricTouchDebuff))then if o(t.ShadowCrash,nil,nil,not h:IsInRange(40))then v=205385;return"shadow_crash main 10"end end;if t.VampiricTouch:IsCastable()then if G.CastTargetIf(t.VampiricTouch,C,"min",af,ag,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch main 12"end end;if t.MindSpikeInsanity:IsReady()and(K and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(t.MindSpikeInsanity,nil,nil,not h:IsInRange(40))then v=407466;return"mind_spike_insanity main 22"end end;if Y:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and K and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(Y,nil,nil,not h:IsSpellInRange(Y))then av()return"mind_flay main 24"end end;if t.MindBlast:IsCastable()and(K and(g:BuffDown(t.MindDevourerBuff)or t.VoidEruption:CooldownUp()and t.VoidEruption:IsAvailable()))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast main 26"end end;if t.VoidTorrent:IsCastable()and not P then if G.CastCycle(t.VoidTorrent,C,aq,not h:IsSpellInRange(t.VoidTorrent),H.Shadow.GCDasOffGCD.VoidTorrent)then v=263165;return"void_torrent main 28"end end;local ShouldReturn=aD()if ShouldReturn then return ShouldReturn end end;local function aH()if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt pl_torrent 2"end end;if t.VampiricTouch:IsCastable()and(h:DebuffRemains(t.VampiricTouchDebuff)<=6 and t.VoidTorrent:CooldownRemains()<g:GCD()*2)then if o(t.VampiricTouch,nil,nil,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch pl_torrent 4"end end;if t.DevouringPlague:IsReady()and(h:DebuffRemains(t.DevouringPlagueDebuff)<=4 and t.VoidTorrent:CooldownRemains()<g:GCD()*2)then if o(t.DevouringPlague,nil,nil,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague pl_torrent 6"end end;if t.MindBlast:IsCastable()and not g:PrevGCD(1,t.MindBlast)then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast pl_torrent 8"end end;if t.VoidTorrent:IsCastable()and(a1(h,false)or g:BuffUp(t.VoidformBuff))then if o(t.VoidTorrent,H.Shadow.GCDasOffGCD.VoidTorrent,nil,not h:IsSpellInRange(t.VoidTorrent))then v=263165;return"void_torrent pl_torrent 10"end end end;local function aI()az()if t.VampiricTouch:IsCastable()and(M>0 and not Q and not t.ShadowCrash:InFlight()or not t.WhisperingShadows:IsAvailable())then if G.CastCycle(t.VampiricTouch,C,ar,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch aoe 2"end end;if t.ShadowCrash:IsCastable()and not P then if G.CastCycle(t.ShadowCrash,C,al,not h:IsInRange(40),nil)then v=205385;return"shadow_crash aoe 4"end end;if n()and(J<30 or h:TimeToDie()>15 and(not P or F>2))then local ShouldReturn=aE()if ShouldReturn then return ShouldReturn end end;if T:IsCastable()and((h:DebuffUp(t.ShadowWordPainDebuff)and O or t.ShadowCrash:InFlight()and t.WhisperingShadows:IsAvailable())and(J<30 or h:TimeToDie()>15)and(not t.DarkAscension:IsAvailable()or t.DarkAscension:CooldownRemains()<Z or J<15))then if o(T,nil)then au()return"mindbender aoe 6"end end;if t.MindBlast:IsCastable()and((t.MindBlast:FullRechargeTime()<=Z+t.MindBlast:CastTime()or V<=t.MindBlast:CastTime()+Z)and U and t.InescapableTorment:IsAvailable()and V>t.MindBlast:CastTime()and F<=7 and g:BuffDown(t.MindDevourerBuff))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast aoe 8"end end;if t.VoidBolt:IsCastable()then if o(t.VoidBolt,nil,nil,not h:IsInRange(40))then v=214771;return"void_bolt aoe 10"end end;if t.DevouringPlague:IsReady()and(not R or g:InsanityDeficit()<=20 or g:BuffUp(t.VoidformBuff)and t.VoidBolt:CooldownRemains()>g:BuffRemains(t.VoidformBuff)and t.VoidBolt:CooldownRemains()<=g:BuffRemains(t.VoidformBuff)+2)then if G.CastCycle(t.DevouringPlague,C,ai,not h:IsSpellInRange(t.DevouringPlague))then v=335467;return"devouring_plague aoe 12"end end;if t.VampiricTouch:IsCastable()and(M>0 and not t.ShadowCrash:InFlight()or not t.WhisperingShadows:IsAvailable())then if G.CastCycle(t.VampiricTouch,C,as,not h:IsSpellInRange(t.VampiricTouch))then v=34914;return"vampiric_touch aoe 14"end end;if t.MindSpikeInsanity:IsReady()and(K and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(t.MindSpikeInsanity,nil,nil,not h:IsInRange(40))then v=407466;return"mind_spike_insanity aoe 18"end end;if Y:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and K and t.MindBlast:FullRechargeTime()>=g:GCD()*3 and t.IdolOfCthun:IsAvailable()and(t.VoidTorrent:CooldownDown()or not t.VoidTorrent:IsAvailable()))then if o(Y,nil,nil,not h:IsSpellInRange(Y))then av()return"mind_flay aoe 20"end end;if t.MindBlast:IsCastable()and(O and(g:BuffDown(t.MindDevourerBuff)or t.VoidEruption:CooldownUp()and t.VoidEruption:IsAvailable()))then if o(t.MindBlast,nil,nil,not h:IsSpellInRange(t.MindBlast))then v=8092;return"mind_blast aoe 22"end end;if t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=3 and(not P or F/(t.VampiricTouchDebuff:AuraActiveCount()+F)<1.5)and(g:Insanity()>=50 or h:DebuffUp(t.DevouringPlagueDebuff)or g:BuffUp(t.DarkReveriesBuff)or g:BuffUp(t.VoidformBuff)or g:BuffUp(t.DarkAscensionBuff))then local ShouldReturn=aH()if ShouldReturn then return ShouldReturn end end;if t.VoidTorrent:IsCastable()and not t.PsychicLink:IsAvailable()then if G.CastCycle(t.VoidTorrent,C,at,not h:IsSpellInRange(t.VoidTorrent),H.Shadow.GCDasOffGCD.VoidTorrent)then v=263165;return"void_torrent aoe 26"end end;if Y:IsCastable()and(g:BuffUp(t.MindFlayInsanityBuff)and t.IdolOfCthun:IsAvailable())then if o(Y,nil,nil,not h:IsSpellInRange(Y))then av()return"mind_flay aoe 28"end end;local ShouldReturn=aD()if ShouldReturn then return ShouldReturn end end;local function aJ()if not BotOn then w=0;v=0 end;if ShouldReturn then return ShouldReturn end;if w>0 then w=0 end;if v>0 then v=0 end;local aK=g:AffectingCombat()and 180 or 900;local aL=g:BuffRemains(j(21562))if j(21562):IsAvailable()then BattleShoutRemains=g:BuffRemains(j(21562))if aL<aK then if o(t.PowerWordFortitude,nil)then v=21562;return"PowerWordFortitude refresh"end end end;if t.Shadowform:IsCastable()and not g:BuffUp(t.Shadowform)then if o(t.Shadowform,nil)then v=232698;return"shadowform precombat 4"end end;B=g:GetEnemiesInRange(30)C=g:GetEnemiesInRange(40)D=h:GetEnemiesInSplashRange(10)if m()then E=#B;F=h:GetEnemiesInSplashRangeCount(10)else E=1;F=1 end;if G.TargetIsValid()or g:AffectingCombat()then I=d.BossFightRemains()J=I;if J==11111 then J=d.FightRemains(D,false)end;U=T:TimeSinceLastCast()<=15;V=15-T:TimeSinceLastCast()if V<0 then V=0 end;Y=g:BuffUp(t.MindFlayInsanityBuff)and t.MindFlayInsanity or t.MindFlay;Z=g:GCD()+0.25 end;if g:AffectingCombat()or y then if G.TargetIsValid()then if not g:AffectingCombat()then local ShouldReturn=aw()if ShouldReturn then return ShouldReturn end end;if t.Dispersion:IsCastable()and g:HealthPercentage()<H.Shadow.DispersionHP then if o(t.Dispersion,H.Shadow.OffGCDasOffGCD.Dispersion)then return"dispersion low_hp"end end;local ShouldReturn=G.Interrupt(30,t.Silence,H.Commons.OffGCDasOffGCD.Silence,false)if ShouldReturn then return ShouldReturn end;P=false;S=H.Shadow.PreferVTWhenSTinDungeon and F==1 and g:IsInDungeonArea()and g:IsInParty()and not g:IsInRaidArea()R=t.VoidEruption:CooldownRemains()<=g:GCD()*3 and t.VoidEruption:IsAvailable()or t.DarkAscension:CooldownUp()and t.DarkAscension:IsAvailable()or t.VoidTorrent:IsAvailable()and t.PsychicLink:IsAvailable()and t.VoidTorrent:CooldownRemains()<=4 and g:BuffDown(t.VoidformBuff)if X==nil then X=h:GUID()end;if W==false and H.Shadow.UseOpener and h:GUID()==X and not a1(h,true)then local ShouldReturn=aC()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for Opener()"end else W=true end;if F>2 or E>3 and g:AffectingCombat()then local ShouldReturn=aI()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for AoE()"end end;if true then local ShouldReturn=aG()if ShouldReturn then return ShouldReturn end;if l.CastAnnotated(t.Pool,false,"WAIT")then return"Pool for Main()"end end end end end;local function aM()t.VampiricTouchDebuff:RegisterAuraTracking()if HeroRotationCharDB.Toggles[5]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]l.ToggleIconFrame:UpdateButtonText(5)end;l.Print("Shadow Priest rotation is currently a work in progress, but has been updated for patch 10.1.5.")end;function ReturnSpell()if v==0 then return 0 else return v end end;function ReturnSpellMOShadow()if w==0 then return 0 else return w end end;l.SetAPL(258,aJ,aM)