local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Boss;local j=f.Pet;local k=d.Spell;local l=d.Item;local m=HeroRotation;local n=m.Cast;local o=m.CDsON;local p=m.AoEON;local q=HeroRotationCharDB.Toggles[4]local r=HeroRotationCharDB.Toggles[5]local s=HeroRotationCharDB.Toggles[6]local t=HeroRotationCharDB.Toggles[10]local u=HeroRotationCharDB.Toggles[11]local v=HeroRotationCharDB.Toggles[12]local w=HeroRotationCharDB.Toggles[13]local x=HeroRotationCharDB.Toggles[14]local y=HeroRotationCharDB.Toggles[15]local z=HeroRotationCharDB.Toggles[16]local A=nil;local B=nil;local C=false;local D=false;local E=false;local F=false;local G=false;local H=false;local I=0;local J=table.insert;local K=k.DeathKnight.Unholy;local L=l.DeathKnight.Unholy;local M={L.DarkmoonDeckVoracity:ID(),L.DreadfireVessel:ID(),L.InscrutableQuantumDevice:ID(),L.MacabreSheetMusic:ID()}local N=g:GetEquipment()local O=l(0)local P=l(0)local Q,R=GetInventoryItemID("player",13)local S,R=GetInventoryItemID("player",14)if N[13]then O=l(N[13])end;if N[14]then P=l(N[14])end;local T;local U;local V=m.Commons.Everyone;local W={General=m.GUISettings.General,Commons=m.GUISettings.APL.DeathKnight.Commons,Unholy=m.GUISettings.APL.DeathKnight.Unholy}local X;local Y;local Z;local _;local a0;local a1;local a2;local a3;local a4,a5;local a6;local a7;local a8;local a9,aa;local ab,ac;local ad;local ae=g:HasLegendaryEquipped(30)local af=g:HasLegendaryEquipped(31)local ag=g:HasLegendaryEquipped(45)local ah={{K.Asphyxiate,"Cast Asphyxiate (Interrupt)",function()return true end}}local ai=0;local aj=0;d:RegisterForEvent(function()N=g:GetEquipment()O=l(0)P=l(0)if N[13]then O=l(N[13])end;if N[14]then P=l(N[14])end;ae=g:HasLegendaryEquipped(30)af=g:HasLegendaryEquipped(31)ag=g:HasLegendaryEquipped(45)end,"PLAYER_EQUIPMENT_CHANGED")local function ak(al)if al then return 1 else return 0 end end;local function am(al)return al~=0 end;local function an()return W.General.SoloMode and(g:HealthPercentage()<W.Commons.UseDeathStrikeHP or g:HealthPercentage()<W.Commons.UseDarkSuccorHP and g:BuffUp(K.DeathStrikeBuff))end;local function ao(ap)local aq=0;for R,ar in pairs(ap)do if ar:DebuffDown(K.VirulentPlagueDebuff)then aq=aq+1 end end;return aq end;local function as(ap)local at={}for au in pairs(ap)do if not f:IsInBossList(ap[au]["UnitNPCID"])then J(at,ap[au])end end;return d.FightRemains(at)end;local function av(aw)return aw:DebuffStack(K.FesteringWoundDebuff)end;local function ax(aw)if aa>=2 and aw:DebuffStack(K.FesteringWoundDebuff)>=4 and g:BuffDown(K.DeathAndDecayBuff)and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=151;return true elseif aa>=2 and aw:DebuffStack(K.FesteringWoundDebuff)>=4 and g:BuffDown(K.DeathAndDecayBuff)and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif aa>=2 and aw:DebuffStack(K.FesteringWoundDebuff)>=4 and g:BuffDown(K.DeathAndDecayBuff)and aw:GUID()==h:GUID()then ai=15;return true elseif aa>=2 and h:DebuffStack(K.FesteringWoundDebuff)>=4 and g:BuffDown(K.DeathAndDecayBuff)then return true end end;local function ay(aw)if aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<3 and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=61;return true elseif aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<3 and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<3 and aw:GUID()==h:GUID()then ai=6;return true elseif aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<3 then return true end end;local function az(aw)if g:RuneTimeToX(4)<a3:CooldownRemains()and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=61;return true elseif g:RuneTimeToX(4)<a3:CooldownRemains()and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif g:RuneTimeToX(4)<a3:CooldownRemains()and aw:GUID()==h:GUID()then ai=6;return true elseif g:RuneTimeToX(4)<a3:CooldownRemains()then return true end end;local function aA(aw)if(aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<5 or aw:DebuffStack(K.FesteringWoundDebuff)<1)and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=61;return true elseif(aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<5 or aw:DebuffStack(K.FesteringWoundDebuff)<1)and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif(aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<5 or aw:DebuffStack(K.FesteringWoundDebuff)<1)and aw:GUID()==h:GUID()then ai=6;return true elseif aw:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<5 or aw:DebuffStack(K.FesteringWoundDebuff)<1 then return true end end;local function aB(aw)if K.Apocalypse:CooldownRemains()>5 and aw:DebuffStack(K.FesteringWoundDebuff)<1 and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=61;return true elseif K.Apocalypse:CooldownRemains()>5 and aw:DebuffStack(K.FesteringWoundDebuff)<1 and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif K.Apocalypse:CooldownRemains()>5 and aw:DebuffStack(K.FesteringWoundDebuff)<1 and aw:GUID()==h:GUID()then ai=6;return true elseif K.Apocalypse:CooldownRemains()>5 and aw:DebuffStack(K.FesteringWoundDebuff)<1 then return true end end;local function aC(aw)if aa>=2 and aw:DebuffStack(K.FesteringWoundDebuff)<2 and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=171;return true elseif aa>=2 and aw:DebuffStack(K.FesteringWoundDebuff)<2 and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif aa>=2 and aw:DebuffStack(K.FesteringWoundDebuff)<2 and aw:GUID()==h:GUID()then ai=17;return true elseif aa>=2 and aw:DebuffStack(K.FesteringWoundDebuff)<2 then return true end end;local function aD(aw)if(K.Apocalypse:CooldownRemains()>5 and aw:DebuffUp(K.FesteringWoundDebuff)or aw:DebuffStack(K.FesteringWoundDebuff)>4)and(d.FilteredFightRemains(a9,"<",a3:CooldownRemains()+10)or d.FilteredFightRemains(a9,">",K.Apocalypse:CooldownRemains()))and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=71;return true elseif(K.Apocalypse:CooldownRemains()>5 and aw:DebuffUp(K.FesteringWoundDebuff)or aw:DebuffStack(K.FesteringWoundDebuff)>4)and(d.FilteredFightRemains(a9,"<",a3:CooldownRemains()+10)or d.FilteredFightRemains(a9,">",K.Apocalypse:CooldownRemains()))and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif(K.Apocalypse:CooldownRemains()>5 and aw:DebuffUp(K.FesteringWoundDebuff)or aw:DebuffStack(K.FesteringWoundDebuff)>4)and(d.FilteredFightRemains(a9,"<",a3:CooldownRemains()+10)or d.FilteredFightRemains(a9,">",K.Apocalypse:CooldownRemains()))and aw:GUID()==h:GUID()then ai=7;return true elseif(K.Apocalypse:CooldownRemains()>5 and aw:DebuffUp(K.FesteringWoundDebuff)or aw:DebuffStack(K.FesteringWoundDebuff)>4)and(d.FilteredFightRemains(a9,"<",a3:CooldownRemains()+10)or d.FilteredFightRemains(a9,">",K.Apocalypse:CooldownRemains()))then return true end end;local function aE(aw)if aw:DebuffDown(K.FesteringWoundDebuff)and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=61;return true elseif aw:DebuffDown(K.FesteringWoundDebuff)and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif aw:DebuffDown(K.FesteringWoundDebuff)and aw:GUID()==h:GUID()then ai=6;return true elseif aw:DebuffDown(K.FesteringWoundDebuff)then return true end end;local function aF(aw)if(aw:TimeToX(35)<5 or aw:HealthPercentage()<35)and aw:TimeToDie()>5 and aw:GUID()==f("mouseover"):GUID()and W.Unholy.TargetSwap=="Mouseover"then aj=111;return true elseif(aw:TimeToX(35)<5 or aw:HealthPercentage()<35)and aw:TimeToDie()>5 and W.Unholy.TargetSwap=="AutoSwap"and aw:GUID()~=h:GUID()and not v then aj=999;return true elseif(aw:TimeToX(35)<5 or aw:HealthPercentage()<35)and aw:TimeToDie()>5 and aw:GUID()==h:GUID()then ai=11;return true elseif(aw:TimeToX(35)<5 or aw:HealthPercentage()<35)and aw:TimeToDie()>5 then return true end end;local function aG()if K.RaiseDead:IsCastable()then if W.Unholy.RaiseDeadCastLeft then if m.CastLeft(K.RaiseDead)then ai=1;return"raise_dead precombat 2 left"end else if n(K.RaiseDead,nil,nil)then ai=1;return"raise_dead precombat 2 displaystyle"end end end;if K.ArmyoftheDead:IsReady()and E and not t and not W.Unholy.DisableAotD and not K.SummonGargoyle:IsAvailable()then if n(K.ArmyoftheDead,nil,nil)then ai=400;return"army_of_the_dead precombat 4"end end;a8=K.ArmyoftheDamned:IsAvailable()and K.ConvocationOfTheDead:ConduitRank()>=9;if K.FesteringStrike:IsReady()and h:IsSpellInRange(K.FesteringStrike)then if n(K.FesteringStrike)then ai=6;return"festering_strike precombat 6"end end;if K.Outbreak:IsReady()then if n(K.Outbreak,nil,nil,not h:IsSpellInRange(K.Outbreak))then ai=8;return"outbreak precombat 8"end end end;local function aH()if a3:IsReady()and not g:IsMoving()and(K.FesteringWoundDebuff:AuraActiveCount()==aa or K.FesteringWoundDebuff:AuraActiveCount()>=5 or not K.BurstingSores:IsAvailable()or ac>1 and as(ab)<=11 or d.FilteredFightRemains(a9,"<=",11))then if a3==K.DeathsDue then if n(a3,nil,nil)then ai=2;return"any_dnd aoe_setup 2"end else if n(a3,nil)then ai=2;return"any_dnd aoe_setup 4"end end end;if K.DeathCoil:IsReady()and(not X and(j:BuffUp(K.DarkTransformation)and ag and aa<=3 or aa==2))then if n(K.DeathCoil,nil,nil,not h:IsSpellInRange(K.DeathCoil))then ai=10;return"death_coil aoe_setup 10"end end;if K.Epidemic:IsReady()and not X then if n(K.Epidemic,W.Unholy.GCDasOffGCD.Epidemic,nil,not h:IsInRange(30))then ai=12;return"epidemic aoe_setup 12"end end;if K.FesteringStrike:IsReady()then if h:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<3 then if n(K.FesteringStrike,nil,nil,not h:IsSpellInRange(K.FesteringStrike))then ai=6;return"festering_strike aoe_setup 14"end end;if V.CastTargetIf(K.FesteringStrike,a9,"max",av,ay)then return"festering_strike aoe_setup 14"end end;if K.FesteringStrike:IsReady()then if V.CastCycle(K.FesteringStrike,a9,aE)then return"festering_strike aoe_setup 16"end end;if K.FesteringStrike:IsReady()then if h:DebuffStack(K.FesteringWoundDebuff)<=3 and K.Apocalypse:CooldownRemains()<3 then if n(K.FesteringStrike,nil,nil,not h:IsSpellInRange(K.FesteringStrike))then ai=6;return"festering_strike aoe_setup 16"end end;if V.CastTargetIf(K.FesteringStrike,a9,"min",av,az)then return"festering_strike aoe_setup 16"end end end;local function aI()if K.ClawingShadows:IsReady()and ac<=5 then if n(K.ClawingShadows,nil,nil,not h:IsSpellInRange(K.ClawingShadows))then ai=5;return"clawing_shadows aoe_burst 2"end end;if K.ClawingShadows:IsReady()and(ac==6 and K.FesteringWoundDebuff:AuraActiveCount()>=3)then if n(K.ClawingShadows,nil,nil,not h:IsSpellInRange(K.ClawingShadows))then ai=5;return"clawing_shadows aoe_burst 4"end end;if a2:IsReady()and(K.BurstingSores:IsAvailable()and(K.FesteringWoundDebuff:AuraActiveCount()==aa or K.FesteringWoundDebuff:AuraActiveCount()>=3)or K.BurstingSores:IsAvailable()and K.ClawingShadows:IsAvailable()and K.FesteringWoundDebuff:AuraActiveCount()>=1)then if n(a2,nil,nil,not h:IsSpellInRange(a2))then ai=7;return"wound_spender aoe_burst 6"end end;if K.DeathCoil:IsReady()and((g:BuffUp(K.SuddenDoomBuff)or not X)and(j:BuffUp(K.DarkTransformation)and ag and aa<=3 or aa==2))then if n(K.DeathCoil,nil,nil,not h:IsSpellInRange(K.DeathCoil))then ai=10;return"death_coil aoe_burst 8"end end;if K.Epidemic:IsReady()and(g:RunicPowerDeficit()<10+K.FesteringWoundDebuff:AuraActiveCount()*3 and K.FesteringWoundDebuff:AuraActiveCount()<6 and not X or g:BuffUp(K.SwarmingMistBuff))then if n(K.Epidemic,W.Unholy.GCDasOffGCD.Epidemic,nil,not h:IsInRange(30))then ai=12;return"epidemic aoe_burst 10"end end;if K.Epidemic:IsReady()and(g:RunicPowerDeficit()<25 and K.FesteringWoundDebuff:AuraActiveCount()>5 and not X)then if n(K.Epidemic,W.Unholy.GCDasOffGCD.Epidemic,nil,not h:IsInRange(30))then ai=12;return"epidemic aoe_burst 12"end end;if K.Epidemic:IsReady()and(K.FesteringWoundDebuff:AuraActiveCount()==0 and not X or ac>1 and as(ab)<5)then if n(K.Epidemic,W.Unholy.GCDasOffGCD.Epidemic,nil,not h:IsInRange(30))then ai=12;return"epidemic aoe_burst 14"end end;if a2:IsReady()then if n(a2,nil,nil,not h:IsSpellInRange(a2))then ai=7;return"wound_spender aoe_burst 16"end end;if K.Epidemic:IsReady()and not X then if n(K.Epidemic,W.Unholy.GCDasOffGCD.Epidemic,nil,not h:IsInRange(30))then ai=12;return"epidemic aoe_burst 18"end end end;local function aJ()if K.DeathCoil:IsReady()and((not X or g:BuffUp(K.SuddenDoomBuff))and(j:BuffUp(K.DarkTransformation)and ag and aa<=3 or aa==2))then if n(K.DeathCoil,nil,nil,not h:IsSpellInRange(K.DeathCoil))then ai=10;return"death_coil aoe_generic 2"end end;if K.Epidemic:IsReady()and(g:BuffUp(K.SuddenDoomBuff)or not X)then if n(K.Epidemic,W.Unholy.GCDasOffGCD.Epidemic,nil,not h:IsInRange(30))then ai=12;return"epidemic aoe_generic 4"end end;if a2:IsReady()then if V.CastTargetIf(a2,a9,"max",av,aD)then ai=7;return"wound_spender aoe_generic 6"end end;if K.FesteringStrike:IsReady()then if h:DebuffStack(K.FesteringWoundDebuff)<=3 and(K.Apocalypse:CooldownRemains()<5 and D)or h:DebuffStack(K.FesteringWoundDebuff)<1 then if n(K.FesteringStrike,nil,nil,not h:IsSpellInRange(K.FesteringStrike))then ai=6;return"festering_strike aoe_generic 8"end end;if V.CastTargetIf(K.FesteringStrike,a9,"max",av,aA)then ai=6;return"festering_strike aoe_generic 8"end end;if K.FesteringStrike:IsReady()then if(K.Apocalypse:CooldownRemains()>5 or not D)and h:DebuffStack(K.FesteringWoundDebuff)<1 then if n(K.FesteringStrike,nil,nil,not h:IsSpellInRange(K.FesteringStrike))then ai=6;return"festering_strike aoe_generic 10"end end;if V.CastTargetIf(K.FesteringStrike,a9,"min",av,aB)then ai=6;return"festering_strike aoe_generic 10"end end end;local function aK()if L.PotionofSpectralStrength:IsReady()and o()and W.Commons.Enabled.Potions and y and(_ or a0 and K.SummonGargoyle:TimeSinceLastCast()>=9 or d.FilteredFightRemains(a9,"<",26))then if n(L.PotionofSpectralStrength,nil)then ai=9;return"potion cooldowns 2"end end;if K.ArmyoftheDead:IsReady()and E and not t and not W.Unholy.DisableAotD and(K.UnholyBlight:CooldownRemains()<7 and F and(K.DarkTransformation:CooldownRemains()<7 and C)and K.UnholyBlight:IsAvailable()and(K.Apocalypse:CooldownRemains()<7 and D and a8 or not a8)or not K.UnholyBlight:IsAvailable()or d.FilteredFightRemains(a9,"<",35))then if n(K.ArmyoftheDead,nil,nil)then ai=400;return"army_of_the_dead cooldowns 4"end end;if K.SoulReaper:IsReady()and aa<=3 then if(h:TimeToX(35)<5 or h:HealthPercentage()<35)and h:TimeToDie()>5 then if n(K.SoulReaper,nil,nil,not h:IsSpellInRange(K.SoulReaper))then ai=11;return"soul_reaper cooldowns 5"end else if V.CastCycle(K.SoulReaper,a9,aF)then ai=11;return"soul_reaper cooldowns 6"end end end;if K.UnholyBlight:IsReady()and F and(Z and(K.Apocalypse:CooldownRemains()<5 and D or(K.Apocalypse:CooldownRemains()>10 or not D))and(K.DarkTransformation:CooldownRemains()<g:GCD()and C or j:BuffUp(K.DarkTransformation)))then if n(K.UnholyBlight,nil,nil,not h:IsInRange(8))then ai=13;return"unholy_blight cooldowns 8"end end;if K.UnholyBlight:IsReady()and F and(aa>=2 or d.FilteredFightRemains(a9,"<",21))then if n(K.UnholyBlight,nil,nil,not h:IsInRange(8))then ai=13;return"unholy_blight cooldowns 10"end end;if K.DarkTransformation:IsCastable()and C and(Z and(h:DebuffUp(K.UnholyBlightDebuff)or not K.UnholyBlight:IsAvailable()))then if n(K.DarkTransformation,W.Unholy.GCDasOffGCD.DarkTransformation)then ai=14;return"dark_transformation cooldowns 12"end end;if K.DarkTransformation:IsCastable()and C and(aa>=2 and(h:DebuffUp(K.UnholyBlightDebuff)or not K.UnholyBlight:IsAvailable())or d.FilteredFightRemains(a9,"<",21))then if n(K.DarkTransformation,W.Unholy.GCDasOffGCD.DarkTransformation)then ai=14;return"dark_transformation cooldowns 14"end end;if K.Apocalypse:IsCastable()and D and K.Apocalypse:IsUsable()and((aa==1 or not p())and h:DebuffStack(K.FesteringWoundDebuff)>=4 and(not a8 or a8 and(K.UnholyBlight:CooldownRemains()>10 or not F or(K.DarkTransformation:CooldownRemains()>10 or not C)and not K.UnholyBlight:IsAvailable())))then if n(K.Apocalypse,nil,nil,not h:IsSpellInRange(K.Apocalypse))then ai=15;return"apocalypse cooldowns 16"end end;if K.Apocalypse:IsCastable()and D and K.Apocalypse:IsUsable()then if aa>=2 and h:DebuffStack(K.FesteringWoundDebuff)>=4 and g:BuffDown(K.DeathAndDecayBuff)then if n(K.Apocalypse,nil,nil,not h:IsSpellInRange(K.Apocalypse))then ai=15;return"apocalypse cooldowns 18"end end;if V.CastTargetIf(K.Apocalypse,a9,"max",av,ax,not h:IsSpellInRange(K.Apocalypse),W.Unholy.GCDasOffGCD.Apocalypse)then ai=15;return"apocalypse cooldowns 18"end end;if K.SummonGargoyle:IsCastable()and(g:RunicPowerDeficit()<14 and(K.UnholyBlight:CooldownRemains()<13 and F)and(K.DarkTransformation:CooldownRemains()<13 and C))then if n(K.SummonGargoyle,W.Unholy.GCDasOffGCD.SummonGargoyle,nil,not h:IsInRange(30))then ai=16;return"summon_gargoyle cooldowns 20"end end;if K.UnholyAssault:IsCastable()and Z and h:DebuffStack(K.FesteringWoundDebuff)<2 and(a1 or j:BuffUp(K.DarkTransformation)and(K.Apocalypse:CooldownRemains()>10 or not D))then if n(K.UnholyAssault,W.Unholy.GCDasOffGCD.UnholyAssault)then ai=17;return"unholy_assault cooldowns 22"end end;if K.UnholyAssault:IsCastable()then if V.CastTargetIf(K.UnholyAssault,a9,"min",av,aC)then ai=17;return"unholy_assault cooldowns 24"end end;if K.RaiseDead:IsCastable()then if W.Unholy.RaiseDeadCastLeft then if m.CastLeft(K.RaiseDead)then ai=1;return"raise_dead cooldowns 26 left"end else if n(K.RaiseDead,nil,nil)then ai=1;return"raise_dead cooldowns 26 displaystyle"end end end;if K.SacrificialPact:IsReady()and not j:DebuffUp(k(111673))and not u and G and(aa>=2 and j:BuffDown(K.DarkTransformation)and(K.DarkTransformation:CooldownRemains()>5 or not C)or d.FilteredFightRemains(a9,"<",g:GCD()))then if n(K.SacrificialPact,nil,nil,not h:IsInRange(8))then ai=18;return"sacrificial_pact cooldowns 28"end end end;local function aL()if K.SwarmingMist:IsReady()and q and(Z and g:RunicPowerDeficit()>16 and(not K.Apocalypse:CooldownUp()or not D or not K.ArmyoftheDamned:IsAvailable()and(not K.DarkTransformation:CooldownUp()or not C))or d.FilteredFightRemains(a9,"<",11))then if n(K.SwarmingMist,nil,nil,not h:IsInRange(10))then ai=19;return"swarming_mist covenants 2"end end;if K.SwarmingMist:IsReady()and q and(not K.Apocalypse:CooldownUp()or not D)and(aa>=2 and aa<=5 and g:RunicPowerDeficit()>10+aa*6 or aa>5 and g:RunicPowerDeficit()>40)then if n(K.SwarmingMist,nil,nil,not h:IsInRange(10))then ai=19;return"swarming_mist covenants 4"end end;if K.AbominationLimb:IsCastable()and q and(Z and not K.LeadByExample:SoulbindEnabled()and(not K.Apocalypse:CooldownUp()or not D)or not K.ArmyoftheDamned:IsAvailable()and(not K.DarkTransformation:CooldownUp()or not C)and g:RuneTimeToX(4)>g:BuffRemains(K.RunicCorruptionBuff)or d.FilteredFightRemains(a9,"<",21))then if n(K.AbominationLimb,nil,nil)then ai=20;return"abomination_limb covenants 6"end end;if K.AbominationLimb:IsCastable()and q and(Z and K.LeadByExample:SoulbindEnabled()and(h:DebuffRemains(K.UnholyBlightDebuff)>11 or not K.UnholyBlight:IsAvailable()and(not K.DarkTransformation:CooldownUp()or not C)))then if n(K.AbominationLimb,nil,nil)then ai=20;return"abomination_limb covenants 8"end end;if K.AbominationLimb:IsCastable()and q and(aa>=2 and g:RuneTimeToX(4)>g:BuffRemains(K.RunicCorruptionBuff))then if n(K.AbominationLimb,nil,nil)then ai=20;return"abomination_limb covenants 10"end end;if K.AbominationLimb:IsCastable()and q then if n(K.AbominationLimb,nil,nil)then ai=20;return"abomination_limb covenants 101"end end;if K.ShackleTheUnworthy:IsCastable()and q and(Z and(K.Apocalypse:CooldownRemains()>10 or not D or not K.ArmyoftheDamned:IsAvailable()and(not K.DarkTransformation:CooldownUp()or not C))or d.FilteredFightRemains(a9,"<",15))then if n(K.ShackleTheUnworthy,nil,nil,not h:IsSpellInRange(K.ShackleTheUnworthy))then ai=21;return"shackle_the_unworthy covenants 12"end end;if K.ShackleTheUnworthy:IsCastable()and q and(aa>=2 and(g:BuffUp(K.DeathAndDecayBuff)or ac>1 and as(ab)<=14))then if n(K.ShackleTheUnworthy,nil,nil,not h:IsSpellInRange(K.ShackleTheUnworthy))then ai=21;return"shackle_the_unworthy covenants 14"end end end;local function aM()if K.ArcaneTorrent:IsCastable()and(g:RunicPowerDeficit()>65 and(a0 or not K.SummonGargoyle:IsAvailable())and g:Rune()<=1)then if n(K.ArcaneTorrent,nil,nil,not h:IsInRange(8))then ai=22;return"arcane_torrent main 2"end end;if K.BloodFury:IsCastable()and(_ or a0 and 35-K.Gargoyle:TimeSinceLastCast()<=K.BloodFury:BaseDuration()or d.FilteredFightRemains(a9,"<=",K.BloodFury:BaseDuration()))then if n(K.BloodFury,nil)then ai=23;return"blood_fury main 4"end end;if K.Berserking:IsCastable()and(_ or a0 and 35-K.Gargoyle:TimeSinceLastCast()<=K.Berserking:BaseDuration()or d.FilteredFightRemains(a9,"<=",K.Berserking:BaseDuration()))then if n(K.Berserking,nil)then ai=24;return"berserking main 6"end end;if K.LightsJudgment:IsCastable()and g:BuffUp(K.UnholyStrengthBuff)then if n(K.LightsJudgment,nil,nil,not h:IsSpellInRange(K.LightsJudgment))then ai=25;return"lights_judgment main 8"end end;if K.AncestralCall:IsCastable()and(_ or a0 and K.Gargoyle:TimeSinceLastCast()>=20 or d.FilteredFightRemains(a9,"<=",15))then if n(K.AncestralCall,nil)then ai=26;return"ancestral_call main 10"end end;if K.ArcanePulse:IsCastable()and(aa>=2 or g:Rune()<=1 and g:RunicPowerDeficit()>=60)then if n(K.ArcanePulse,nil,nil,not h:IsInRange(8))then ai=27;return"arcane_pulse main 12"end end;if K.Fireblood:IsCastable()and(_ or a0 and 35-K.Gargoyle:TimeSinceLastCast()<=K.Fireblood:BaseDuration()or d.FilteredFightRemains(a9,"<=",K.Fireblood:BaseDuration()))then if n(K.Fireblood,nil)then ai=28;return"fireblood main 14"end end;if K.BagofTricks:IsCastable()and(aa==1 and(g:BuffUp(K.UnholyStrengthBuff)or d.FilteredFightRemains(a9,"<",5)))then if n(K.BagofTricks,nil,nil,not h:IsSpellInRange(K.BagofTricks))then ai=29;return"bag_of_tricks main 16"end end end;local function aN()if K.DeathCoil:IsReady()and(not X and(g:BuffUp(K.SuddenDoomBuff)or g:RunicPowerDeficit()<=13)or a0 and g:Rune()<=3 or d.FilteredFightRemains(a9,"<",10)and h:DebuffDown(K.FesteringWoundDebuff))then if n(K.DeathCoil,nil,nil,not h:IsSpellInRange(K.DeathCoil))then ai=10;return"death_coil generic 4"end end;if a3:IsReady()and not g:IsMoving()and((K.Defile:IsAvailable()or g:Covenant()=="Night Fae"or af)and(not Y or d.FilteredFightRemains(a9,"<",5)))then if a3==K.DeathsDue then if n(a3,nil,nil)then ai=2;return"any_dnd generic 6"end else if n(a3,nil)then ai=2;return"any_dnd generic 8"end end end;if a2:IsReady()and(VarMajorProcsActive and h:DebuffStack(K.FesteringWoundDebuff)>=1 and(K.Apocalypse:CooldownRemains()>5 or not D)and not Y)then if n(a2,nil,nil,not h:IsSpellInRange(a2))then ai=7;return"wound_spender generic 10"end end;if a2:IsReady()and(h:DebuffStack(K.FesteringWoundDebuff)>3 and not Y or h:DebuffUp(K.FesteringWoundDebuff)and d.FilteredFightRemains(a9,"<",h:DebuffStack(K.FesteringWoundDebuff)*g:GCD()))then if n(a2,nil,nil,not h:IsSpellInRange(a2))then ai=7;return"wound_spender generic 12"end end;if K.DeathCoil:IsReady()and(g:RunicPowerDeficit()<=20 and not X)then if n(K.DeathCoil,nil,nil,not h:IsSpellInRange(K.DeathCoil))then ai=10;return"death_coil generic 14"end end;if K.FesteringStrike:IsReady()and(h:DebuffStack(K.FesteringWoundDebuff)<4 and not Y)then if n(K.FesteringStrike,nil,nil,not h:IsInMeleeRange(5))then ai=6;return"festering_strike generic 16"end end;if K.DeathCoil:IsReady()and not X then if n(K.DeathCoil,nil,nil,not h:IsSpellInRange(K.DeathCoil))then ai=10;return"death_coil generic 18"end end;if a2:IsReady()and(h:DebuffStack(K.FesteringWoundDebuff)>=1 and g:Rune()<2 and not Y and(K.Apocalypse:CooldownRemains()>5 or not D))then if n(a2,nil,nil,not h:IsSpellInRange(a2))then ai=7;return"wound_spender generic 20"end end end;local function aO()if L.InscrutableQuantumDevice:IsEquippedAndReady()and((K.UnholyBlight:CooldownRemains()>20 or not F or(K.DarkTransformation:CooldownRemains()>20 or not C))and(aa>=2 or K.ArmyoftheDead:TimeSinceLastCast()<=30 or a1 and(K.UnholyAssault:IsAvailable()or W.Unholy.DisableAotD)or a0)or d.FilteredFightRemains(a9,"<",21)or h:TimeToX(20)<5)then if n(L.InscrutableQuantumDevice,nil,nil)then if L.InscrutableQuantumDevice:ID()==Q and W.Commons.Enabled.TopTrinket==true then ai=30;return"top trinket 1"elseif L.InscrutableQuantumDevice:ID()==S and W.Commons.Enabled.BottomTrinket then ai=31;return"top trinket 2"end end end;if L.MacabreSheetMusic:IsEquippedAndReady()and(K.Apocalypse:CooldownRemains()<5 and(not L.InscrutableQuantumDevice:IsEquipped()or L.InscrutableQuantumDevice:CooldownRemains()>0)or d.FilteredFightRemains(a9,"<",21))then if n(L.MacabreSheetMusic,nil,nil)then if L.MacabreSheetMusic:ID()==Q and W.Commons.Enabled.TopTrinket then ai=30;return"top trinket 1"elseif L.MacabreSheetMusic:ID()==S and W.Commons.Enabled.BottomTrinket then ai=31;return"top trinket 2"end end end;if L.DreadfireVessel:IsEquippedAndReady()and(not K.Apocalypse:CooldownUp()and(not L.InscrutableQuantumDevice:IsEquipped()or L.InscrutableQuantumDevice:CooldownRemains()>0)or d.FilteredFightRemains(a9,"<",3))then if n(L.DreadfireVessel,nil,nil,not h:IsInRange(50))then if L.DreadfireVessel:ID()==Q and W.Commons.Enabled.TopTrinket then ai=30;return"top trinket 1"elseif L.DreadfireVessel:ID()==S and W.Commons.Enabled.BottomTrinket then ai=31;return"top trinket 2"end end end;if L.DarkmoonDeckVoracity:IsEquippedAndReady()and(not K.Apocalypse:CooldownUp()and(not L.InscrutableQuantumDevice:IsEquipped()or L.InscrutableQuantumDevice:CooldownRemains()>0)or d.FilteredFightRemains(a9,"<",21))then if n(L.DarkmoonDeckVoracity,nil,nil)then if L.DarkmoonDeckVoracity:ID()==Q and W.Commons.Enabled.TopTrinket then ai=30;return"top trinket 1"elseif L.DarkmoonDeckVoracity:ID()==S and W.Commons.Enabled.BottomTrinket then ai=31;return"top trinket 2"end end end;if(not K.Apocalypse:CooldownUp()or j:BuffUp(K.DarkTransformation))and(not L.InscrutableQuantumDevice:IsEquipped()or L.InscrutableQuantumDevice:CooldownRemains()>0)then local aP=g:GetUseableTrinkets(M)if aP then if n(aP,nil,nil)then if aP:ID()==Q and W.Commons.Enabled.TopTrinket then ai=30;return"top trinket 1"elseif aP:ID()==S and W.Commons.Enabled.BottomTrinket then ai=31;return"top trinket 2"end end end end end;local function aQ()s=HeroRotationCharDB.Toggles[6]q=HeroRotationCharDB.Toggles[4]r=HeroRotationCharDB.Toggles[5]t=HeroRotationCharDB.Toggles[10]u=HeroRotationCharDB.Toggles[11]v=HeroRotationCharDB.Toggles[12]w=HeroRotationCharDB.Toggles[13]x=HeroRotationCharDB.Toggles[14]y=HeroRotationCharDB.Toggles[15]z=HeroRotationCharDB.Toggles[16]E=false;C=false;D=false;F=false;G=false;if W.Unholy.IncludedCooldowns.ArmyoftheDead and o()or W.Unholy.IncludedSmallCooldowns.ArmyoftheDead and(o()or r)or not W.Unholy.IncludedSmallCooldowns.ArmyoftheDead and not W.Unholy.IncludedCooldowns.ArmyoftheDead then E=true end;if W.Unholy.IncludedCooldowns.DarkTransformation and o()or W.Unholy.IncludedSmallCooldowns.DarkTransformation and(o()or r)or not W.Unholy.IncludedSmallCooldowns.DarkTransformation and not W.Unholy.IncludedCooldowns.DarkTransformation then C=true end;if W.Unholy.IncludedCooldowns.Apocalypse and o()or W.Unholy.IncludedSmallCooldowns.Apocalypse and(o()or r)or not W.Unholy.IncludedSmallCooldowns.Apocalypse and not W.Unholy.IncludedCooldowns.Apocalypse then D=true end;if W.Unholy.IncludedCooldowns.UnholyBlight and o()or W.Unholy.IncludedSmallCooldowns.UnholyBlight and(o()or r)or not W.Unholy.IncludedSmallCooldowns.UnholyBlight and not W.Unholy.IncludedCooldowns.UnholyBlight then F=true end;if W.Unholy.IncludedCooldowns.SacrificialPact and o()or W.Unholy.IncludedSmallCooldowns.SacrificialPact and(o()or r)or not W.Unholy.IncludedSmallCooldowns.SacrificialPact and not W.Unholy.IncludedCooldowns.SacrificialPact then G=true end end;local function aR()U=not an()a9=g:GetEnemiesInMeleeRange(8)ab=h:GetEnemiesInSplashRange(10)Q,R=GetInventoryItemID("player",13)S,R=GetInventoryItemID("player",14)if p()then aa=#a9;ac=#ab else aa=1;ac=1 end;ad=ao(ab)a0=K.SummonGargoyle:TimeSinceLastCast()<=35;a1=K.Apocalypse:TimeSinceLastCast()<=15;a2=K.ClawingShadows:IsAvailable()and K.ClawingShadows or K.ScourgeStrike;a3=K.DeathAndDecay;if K.DeathsDue:IsAvailable()then a3=K.DeathsDue end;if K.Defile:IsAvailable()then a3=K.Defile end;if not BotOn then aj=0;ai=0 end;if aj>0 then aj=0 end;if ai>0 then ai=0 end;T=aQ()if m.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[6]then A=GetTime()B=A+m.GUISettings.General.OpenerReset elseif m.GUISettings.General.OpenerReset>0 and B~=nil and GetTime()>B and HeroRotationCharDB.Toggles[6]then HeroRotationCharDB.Toggles[6]=not HeroRotationCharDB.Toggles[6]m.ToggleIconFrame:UpdateButtonText(6)m.Print("Opener is now "..(HeroRotationCharDB.Toggles[6]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end;if w and K.AntiMagicZone:IsUsableP()and g:AffectingCombat()and K.AntiMagicZone:CooldownRemains(BypassRecovery)<=0 then if n(K.AntiMagicZone,nil,nil,nil)then ai=38;return"queue AMZ"end elseif(not K.AntiMagicZone:IsUsableP()or K.AntiMagicZone:CooldownRemains()>0 or not g:AffectingCombat())and w then HeroRotationCharDB.Toggles[13]=not HeroRotationCharDB.Toggles[13]m.Print("Anti-Magic Zone Queue is now "..(HeroRotationCharDB.Toggles[13]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if x and K.DeathGrip:IsUsableP()and K.DeathGrip:CooldownRemains(BypassRecovery)<=0 and V.TargetIsValid()and f("mouseover"):GUID()~=nil then if n(K.DeathGrip,nil,nil,nil)then aj=72;return"queue DeathGrip MO"end elseif x and K.DeathGrip:IsUsableP()and K.DeathGrip:CooldownRemains(BypassRecovery)<=0 and V.TargetIsValid()then if n(K.DeathGrip,nil,nil,nil)then ai=39;return"queue DeathGrip"end elseif(not K.DeathGrip:IsUsableP()or K.DeathGrip:CooldownRemains()>0 or not V.TargetIsValid())and x then HeroRotationCharDB.Toggles[14]=not HeroRotationCharDB.Toggles[14]m.Print("Death Grip Queue is now "..(HeroRotationCharDB.Toggles[14]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if z and K.Asphyxiate:IsUsableP()and K.Asphyxiate:CooldownRemains(BypassRecovery)<=0 and f("mouseover"):GUID()~=nil then if n(K.Asphyxiate,nil,nil,nil)then aj=471;return"queue Asphyxiate MO"end elseif z and K.Asphyxiate:IsUsableP()and K.Asphyxiate:CooldownRemains(BypassRecovery)<=0 and V.TargetIsValid()then if n(K.Asphyxiate,nil,nil,nil)then ai=47;return"queue Asphyxiate"end elseif(not K.Asphyxiate:IsUsableP()or K.Asphyxiate:CooldownRemains()>0)and z then HeroRotationCharDB.Toggles[16]=not HeroRotationCharDB.Toggles[16]m.Print("Asphyxiate Queue is now "..(HeroRotationCharDB.Toggles[16]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if g:IsChanneling(k(324631))then if n(K.PoolResources,nil,nil,nil)then aj=36;return"Raise Ally MO"end end;if K.RaiseDead:IsCastable()then if W.Unholy.RaiseDeadCastLeft then if m.CastLeft(K.RaiseDead)then ai=1;return"raise_dead precombat 2 left"end else if n(K.RaiseDead,nil,nil)then ai=1;return"raise_dead precombat 2 displaystyle"end end end;if V.TargetIsValid()then if not g:AffectingCombat()and s then H=false;local T=aG()if T then return T end end end;if V.TargetIsValid()and g:AffectingCombat()then if W.Commons.UseDefensives then if g:HealthPercentage()<W.Commons.HealthstoneHP and L.Healthstone:IsReady()and L.Healthstone:CooldownRemains()<=0 then if n(L.Healthstone,nil)then ai=40;return"Healthstone HP"end end;if g:HealthPercentage()<W.Commons.HealPotHP and L.HealPot:IsReady()and L.HealPot:CooldownRemains()<=0 then if n(L.HealPot,nil)then ai=41;return"HealPot HP"end end;if g:HealthPercentage()<W.Commons.UseDarkSuccorHP and K.DeathStrike:IsReady()and g:BuffUp(K.DeathStrikeBuff)then if n(K.DeathStrike)then ai=42;return"DeathStrike Dark Succor HP"end end;if g:HealthPercentage()<W.Commons.UseDeathStrikeHP and K.DeathStrike:IsReady()then if n(K.DeathStrike)then ai=42;return"DeathStrike HP"end end;if g:HealthPercentage()<W.Commons.IceboundFortitudeHP and K.IceboundFortitude:IsReady()then if n(K.IceboundFortitude)then ai=43;return"Icebound Fortitude HP"end end;if g:HealthPercentage()<W.Commons.LichborneHP and K.Lichborne:IsReady()then if n(K.Lichborne)then ai=44;return"Lichborne HP"end end;if g:HealthPercentage()<W.Commons.AntiMagicShellHP and K.AntiMagicShell:IsReady()then if n(K.AntiMagicShell)then ai=45;return"Anti-Magic Shell HP"end end;if g:HealthPercentage()<W.Commons.DeathPactHP and K.DeathPact:IsReady()then if n(K.DeathPact)then ai=46;return"Death Pact HP"end end end;local T=V.Interrupt(15,K.MindFreeze,nil,ah)if T then return T end;if K.DeathStrike:IsReady()and not U then if n(K.DeathStrike)then ai=35;return"death_strike low hp or proc"end end;X=K.SummonGargoyle:IsAvailable()and K.SummonGargoyle:CooldownRemains()<5 and(K.UnholyBlight:IsAvailable()and(K.UnholyBlight:CooldownRemains()<13 and F)and(K.DarkTransformation:CooldownRemains()<13 and C)or not K.UnholyBlight:IsAvailable())Y=K.SoulReaper:IsAvailable()and g:Rune()<2 and h:TimeToX(35)<5 and d.FilteredFightRemains(a9,">",5)Z=aa==1 or not p()_=(K.SummonGargoyle:IsAvailable()and not a0 and not K.SummonGargoyle:CooldownUp()or not K.SummonGargoyle:IsAvailable())and(g:BuffUp(K.UnholyAssault)or K.ArmyoftheDamned:IsAvailable()and a1 or g:BuffUp(K.DarkTransformation))VarMajorProcsActive=g:Covenant()=="Night Fae"and g:BuffUp(K.DeathAndDecayBuff)and g:BuffStack(K.DeathsDueBuff)<4 or g:BuffUp(K.MarrowedGemstoneEnhancement)or g:BuffUp(K.ThrillSeeker)or g:BuffUp(K.FrenziedMonstrosity)or g:BuffUp(K.LeadByExample)if K.Outbreak:IsReady()and(ad>0 and aa==0)then if n(K.Outbreak,nil,nil,not h:IsSpellInRange(K.Outbreak))then ai=8;return"outbreak out_of_range"end end;if K.Epidemic:IsReady()and p()and K.VirulentPlagueDebuff:AuraActiveCount()>1 and(not X and aa==0)then if n(K.Epidemic,nil,nil,not h:IsInRange(30))then ai=12;return"epidemic out_of_range"end end;if K.DeathCoil:IsReady()and K.VirulentPlagueDebuff:AuraActiveCount()<2 and(not X and aa==0)then if n(K.DeathCoil,nil,nil,not h:IsSpellInRange(K.DeathCoil))then ai=10;return"death_coil out_of_range"end end;if K.Outbreak:IsReady()and(h:DebuffRefreshable(K.VirulentPlagueDebuff)and(not K.UnholyBlight:IsAvailable()or K.UnholyBlight:IsAvailable()and not K.UnholyBlight:CooldownUp()or not F))then if n(K.Outbreak,nil,nil,not h:IsSpellInRange(K.Outbreak))then ai=8;return"outbreak main 18"end end;if K.Outbreak:IsReady()and((h:DebuffRefreshable(K.VirulentPlagueDebuff)or ad>0)and aa>=2 and(not K.UnholyBlight:IsAvailable()or K.UnholyBlight:IsAvailable()and not K.UnholyBlight:CooldownUp()or not F))then if n(K.Outbreak,nil,nil,not h:IsSpellInRange(K.Outbreak))then ai=8;return"outbreak main 20"end end;if K.Outbreak:IsReady()and(ae and(h:DebuffRefreshable(K.FrostFeverDebuff)or h:DebuffRefreshable(K.BloodPlagueDebuff)))then if n(K.Outbreak,nil,nil,not h:IsSpellInRange(K.Outbreak))then ai=8;return"outbreak main 22"end end;if a2:IsReady()and(g:Covenant()=="Night Fae"and g:BuffRemains(K.DeathAndDecayBuff)<g:GCD()*1.5 and g:BuffUp(K.DeathAndDecayBuff))then if n(a2,nil,nil,not h:IsSpellInRange(a2))then ai=7;return"wound_spender main 24"end end;if(W.Commons.Enabled.TopTrinket or W.Commons.Enabled.BottomTrinket)and o()then local T=aO()if T then return T end end;if true then local T=aL()if T then return T end end;if o()then local T=aM()if T then return T end end;if o()or not o()then local T=aK()if T then return T end end;if p()then if aa>=2 and a3:CooldownRemains()<10 and g:BuffDown(K.DeathAndDecayBuff)then local T=aH()if T then return T end end;if aa>=2 and g:BuffUp(K.DeathAndDecayBuff)then local T=aI()if T then return T end end;if aa>=2 and g:BuffDown(K.DeathAndDecayBuff)then local T=aJ()if T then return T end end end;if aa==1 then local T=aN()if T then return T end end;if true then if n(K.PoolResources)then ai=36;return"pool_resources"end end end end;local function aS()K.VirulentPlagueDebuff:RegisterAuraTracking()K.FesteringWoundDebuff:RegisterAuraTracking()end;function ReturnSpell()if ai==0 then return 0 else return ai end end;function ReturnSpellMO()if aj==0 then return 0 else return aj end end;m.SetAPL(252,aR,aS)