local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Boss;local j=f.Pet;local k=d.Spell;local l=d.Item;local m=HeroRotation;local n=m.Cast;local o=m.CDsON;local p=m.AoEON;local q=HeroRotationCharDB.Toggles[4]local r=HeroRotationCharDB.Toggles[5]local s=HeroRotationCharDB.Toggles[10]local t=HeroRotationCharDB.Toggles[11]local u=HeroRotationCharDB.Toggles[12]local v=HeroRotationCharDB.Toggles[13]local w=HeroRotationCharDB.Toggles[14]local x=not HeroRotationCharDB.Toggles[15]local y=HeroRotationCharDB.Toggles[16]local z=HeroRotationCharDB.Toggles[17]local A=HeroRotationCharDB.Toggles[18]local function B(C)if C then return 1 else return 0 end end;local function D(C)return C~=0 end;local E=table.insert;local GetTime=GetTime;local F=0;local G=0;local H=HeroRotationCharDB.Toggles[3]local I=k.DeathKnight.Unholy;local J=l.DeathKnight.Unholy;local K={}local L=g:GetEquipment()local M=L[13]and l(L[13])or l(0)local N=L[14]and l(L[14])or l(0)local O;local P;local Q=m.Commons.Everyone;local R={General=m.GUISettings.General,Commons=m.GUISettings.APL.DeathKnight.Commons,Commons2=m.GUISettings.APL.DeathKnight.Commons2,Unholy=m.GUISettings.APL.DeathKnight.Unholy}local s=R.Unholy.DisableAotD;local S;local T;local U;local V;local W;local X;local Y;local Z,a0;local a1,a2;local a3,a4;local a5=I.ClawingShadows:IsAvailable()and I.ClawingShadows or I.ScourgeStrike;local a6=I.Defile:IsAvailable()and I.Defile or I.DeathAndDecay;local a7;local a8=11111;local a9=11111;local aa=d.GhoulTable;local ab,ac;local ad,ae;local af;local ag={{I.Asphyxiate,"Cast Asphyxiate (Interrupt)",function()return true end}}d:RegisterForEvent(function()L=g:GetEquipment()M=L[13]and l(L[13])or l(0)N=L[14]and l(L[14])or l(0)end,"PLAYER_EQUIPMENT_CHANGED")d:RegisterForEvent(function()a8=11111;a9=11111 end,"PLAYER_REGEN_ENABLED")d:RegisterForEvent(function()a5=I.ClawingShadows:IsAvailable()and I.ClawingShadows or I.ScourgeStrike;a6=I.Defile:IsAvailable()and I.Defile or I.DeathAndDecay end,"SPELLS_CHANGED","LEARNED_SPELL_IN_TAB")local function ah()if I.ClawingShadows:IsAvailable()then F=207311 else F=55090 end end;local function ai()return g:HealthPercentage()<R.Commons.UseDeathStrikeHP or g:HealthPercentage()<R.Commons.UseDarkSuccorHP and g:BuffUp(I.DeathStrikeBuff)end;local function aj(ak)local al=0;for _,am in pairs(ak)do if am:DebuffDown(I.VirulentPlagueDebuff)then al=al+1 end end;return al end;local function an(ak)local ao={}for ap in pairs(ak)do if not f:IsInBossList(ak[ap]["UnitNPCID"])then E(ao,ak[ap])end end;return d.FightRemains(ao)end;local function aq(ar)return ar:DebuffStack(I.FesteringWoundDebuff)end;local function as(ar)return ar:DebuffRemains(I.SoulReaper)end;local function at(ar)return I.BurstingSores:IsAvailable()and ar:DebuffUp(I.FesteringWoundDebuff)and(g:BuffDown(I.DeathAndDecayBuff)and I.DeathAndDecay:CooldownDown()and g:Rune()<3 or g:BuffUp(I.DeathAndDecayBuff)and g:Rune()==0)or not I.BurstingSores:IsAvailable()and ar:DebuffStack(I.FesteringWoundDebuff)>=4 or g:HasTier(31,2)and ar:DebuffUp(I.FesteringWoundDebuff)end;local function au(ar)return ar:DebuffStack(I.FesteringWoundDebuff)>=4 end;local function av(ar)return ar:DebuffStack(I.FesteringWoundDebuff)<4 end;local function aw(ar)if ar:DebuffStack(I.FesteringWoundDebuff)<4 and ar:GUID()==f("mouseover"):GUID()and R.Unholy.TargetSwap=="Mouseover"then G=185948;return true elseif ar:DebuffStack(I.FesteringWoundDebuff)<4 and R.Unholy.TargetSwap=="AutoSwap"and ar:GUID()~=h:GUID()and not u then G=999;return true elseif ar:DebuffStack(I.FesteringWoundDebuff)<4 and ar:GUID()==h:GUID()then F=85948;return true elseif ar:DebuffStack(I.FesteringWoundDebuff)<4 then return true end end;local function ax(ar)return(ar:TimeToX(35)<5 or ar:HealthPercentage()<=35)and ar:TimeToDie()>ar:DebuffRemains(I.SoulReaper)+5 end;local function ay(ar)if(ar:DebuffStack(I.FesteringWoundDebuff)<=2 or j:BuffUp(I.DarkTransformation))and ar:GUID()==f("mouseover"):GUID()and R.Unholy.TargetSwap=="Mouseover"then G=1207289;return true elseif(ar:DebuffStack(I.FesteringWoundDebuff)<=2 or j:BuffUp(I.DarkTransformation))and R.Unholy.TargetSwap=="AutoSwap"and ar:GUID()~=h:GUID()and not u then G=999;return true elseif(ar:DebuffStack(I.FesteringWoundDebuff)<=2 or j:BuffUp(I.DarkTransformation))and ar:GUID()==h:GUID()then F=207289;return true elseif ar:DebuffStack(I.FesteringWoundDebuff)<=2 or j:BuffUp(I.DarkTransformation)then return true end end;local function az(ar)return ar:DebuffStack(I.FesteringWoundDebuff)>=4 and a6:CooldownRemains()<3 end;local function aA(ar)return ar:DebuffStack(I.FesteringWoundDebuff)>=1 end;local function aB(ar)return ar:TimeToDie()>ar:DebuffRemains(I.VirulentPlagueDebuff)and(ar:DebuffRefreshable(I.VirulentPlagueDebuff)or I.Superstrain:IsAvailable()and(ar:DebuffRefreshable(I.FrostFeverDebuff)or ar:DebuffRefreshable(I.BloodPlagueDebuff)))and(not I.UnholyBlight:IsAvailable()or I.UnholyBlight:IsAvailable()and I.UnholyBlight:CooldownRemains()>15/(B(I.Superstrain:IsAvailable())*3+B(I.Plaguebringer:IsAvailable())*2+B(I.EbonFever:IsAvailable())*2))end;local function aC()if I.RaiseDead:IsCastable()then if n(I.RaiseDead,nil,nil)then F=46584;return"raise_dead precombat 2 displaystyle"end end;if I.ArmyoftheDead:IsReady()and not s then if n(I.ArmyoftheDead,nil,nil)then F=42650;return"army_of_the_dead precombat 4"end end;if I.Outbreak:IsReady()then if n(I.Outbreak,nil,nil,not h:IsSpellInRange(I.Outbreak))then F=77575;return"outbreak precombat 6"end end;if I.FesteringStrike:IsReady()then if n(I.FesteringStrike,nil,nil,not h:IsInMeleeRange(5))then F=85948;return"festering_strike precombat 8"end end end;local function aD()if I.Epidemic:IsReady()and(not W or a9<10)then if n(I.Epidemic,nil,nil,not h:IsInRange(30))then F=207317;return"epidemic aoe 2"end end;if a5:IsReady()and V then if Q.CastTargetIf(a5,ab,"max",aq,nil,not h:IsSpellInRange(a5))then ah()return"wound_spender aoe 4"end end;if I.FesteringStrike:IsReady()and not V then if Q.CastTargetIf(I.FesteringStrike,ab,"max",aq,nil,not h:IsInMeleeRange(5))then F=85948;return"festering_strike aoe 6"end end;if I.DeathCoil:IsReady()and(not W and not I.Epidemic:IsAvailable())then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil aoe 8"end end end;local function aE()if I.Epidemic:IsReady()and((not I.BurstingSores:IsAvailable()or g:Rune()<1 or I.BurstingSores:IsAvailable()and a7==0)and not W and(ac>=6 or g:RunicPowerDeficit()<30 or g:BuffStack(I.FestermightBuff)==20))then if n(I.Epidemic,nil,nil,not h:IsInRange(30))then F=207317;return"epidemic aoe_burst 2"end end;if a5:IsReady()then if Q.CastTargetIf(a5,ab,"max",aq,aA,not h:IsSpellInRange(a5))then ah()return"wound_spender aoe_burst 4"end end;if I.Epidemic:IsReady()and(not W or a9<10)then if n(I.Epidemic,nil,nil,not h:IsInRange(30))then F=207317;return"epidemic aoe_burst 6"end end;if I.DeathCoil:IsReady()and(not W and not I.Epidemic:IsAvailable())then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil aoe_burst 8"end end;if a5:IsReady()then if n(a5,nil,nil,not h:IsSpellInRange(a5))then ah()return"wound_spender aoe_burst 10"end end end;local function aF()if I.VileContagion:IsReady()and a6:CooldownRemains()<3 then if Q.CastTargetIf(I.VileContagion,ab,"max",aq,az,not h:IsSpellInRange(I.VileContagion))then F=390279;return"vile_contagion aoe_cooldowns 2"end end;if I.SummonGargoyle:IsReady()then if n(I.SummonGargoyle,nil)then F=49206;return"summon_gargoyle aoe_cooldowns 4"end end;if I.AbominationLimb:IsCastable()and(g:Rune()<2 or a7>10 or not I.Festermight:IsAvailable()or g:BuffUp(I.FestermightBuff)and g:BuffRemains(I.FestermightBuff)<12)then if n(I.AbominationLimb,nil,nil,not h:IsInRange(20))then F=315443;return"abomination_limb aoe_cooldowns 6"end end;if I.Apocalypse:IsReady()then if Q.CastTargetIf(I.Apocalypse,ab,"min",aq,at,not h:IsInMeleeRange(5))then F=275699;return"apocalypse aoe_cooldowns 8"end end;if I.UnholyAssault:IsCastable()then if Q.CastTargetIf(I.UnholyAssault,ab,"min",aq,ay,not h:IsInMeleeRange(5),nil)then F=207289;return"unholy_assault aoe_cooldowns 10"end end;if I.RaiseDead:IsCastable()then if n(I.RaiseDead,nil,nil)then F=46584;return"raise_dead aoe_cooldowns 12 displaystyle"end end;if I.DarkTransformation:IsCastable()and(a6:CooldownRemains()<10 and I.InfectedClaws:IsAvailable()and(I.FesteringWoundDebuff:AuraActiveCount()<ae or not I.VileContagion:IsAvailable())or not I.InfectedClaws:IsAvailable())then if n(I.DarkTransformation,nil)then F=63560;return"dark_transformation aoe_cooldowns 14"end end;if I.EmpowerRuneWeapon:IsCastable()and j:BuffUp(I.DarkTransformation)then if n(I.EmpowerRuneWeapon,nil)then F=47568;return"empower_rune_weapon aoe_cooldowns 16"end end;if I.SacrificialPact:IsReady()and(j:BuffDown(I.DarkTransformation)and I.DarkTransformation:CooldownRemains()>6 or a9<g:GCD())then if n(I.SacrificialPact,nil)then F=237574;return"sacrificial_pact aoe_cooldowns 18"end end end;local function aG()if a6:IsReady()and(not I.BurstingSores:IsAvailable()or I.FesteringWoundDebuff:AuraActiveCount()==ae or I.FesteringWoundDebuff:AuraActiveCount()>=8)then if n(a6,nil)then F=43265;return"any_dnd aoe_setup 2"end end;if I.FesteringStrike:IsReady()and(I.FesteringWoundDebuff:AuraActiveCount()<ae and I.BurstingSores:IsAvailable())then if Q.CastTargetIf(I.FesteringStrike,ab,"min",aq,nil,not h:IsInMeleeRange(5))then F=85948;return"festering_strike aoe_setup 4"end end;if I.Epidemic:IsReady()and(not W or a9<10)then if n(I.Epidemic,nil,nil,not h:IsInRange(30))then F=207317;return"epidemic aoe_setup 6"end end;if I.FesteringStrike:IsReady()and I.FesteringWoundDebuff:AuraActiveCount()<ae then if Q.CastTargetIf(I.FesteringStrike,ab,"min",aq,nil,not h:IsInMeleeRange(5))then F=85948;return"festering_strike aoe_setup 8"end end;if I.FesteringStrike:IsReady()and I.Apocalypse:CooldownRemains()<T then if Q.CastTargetIf(I.FesteringStrike,ab,"max",aq,av,not h:IsInMeleeRange(5))then F=85948;return"festering_strike aoe_setup 10"end end;if I.DeathCoil:IsReady()and(not W and not I.Epidemic:IsAvailable())then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil aoe_setup 12"end end end;local function aH()if I.SummonGargoyle:IsCastable()and(g:BuffUp(I.CommanderoftheDeadBuff)or not I.CommanderoftheDead:IsAvailable())then if n(I.SummonGargoyle,nil)then F=49206;return"summon_gargoyle cooldowns 2"end end;if I.RaiseDead:IsCastable()then if n(I.RaiseDead,nil,nil)then F=46584;return"raise_dead cooldowns 4 displaystyle"end end;if I.DarkTransformation:IsCastable()and I.Apocalypse:CooldownRemains()<5 then if n(I.DarkTransformation,nil)then F=63560;return"dark_transformation cooldowns 6"end end;if I.Apocalypse:IsReady()and X then if Q.CastTargetIf(I.Apocalypse,ab,"max",aq,au,not h:IsInMeleeRange(5),nil)then F=275699;return"apocalypse cooldowns 8"end end;if I.EmpowerRuneWeapon:IsCastable()and(X and(a3 and a4<=23 or not I.SummonGargoyle:IsAvailable()and I.ArmyoftheDamned:IsAvailable()and a1 and Z or not I.SummonGargoyle:IsAvailable()and not I.ArmyoftheDamned:IsAvailable()and j:BuffUp(I.DarkTransformation)or not I.SummonGargoyle:IsAvailable()and j:BuffUp(I.DarkTransformation))or a9<=21)then if n(I.EmpowerRuneWeapon,nil)then F=47568;return"empower_rune_weapon cooldowns 10"end end;if I.AbominationLimb:IsCastable()and(g:Rune()<3 and X)then if n(I.AbominationLimb,nil)then F=315443;return"abomination_limb cooldowns 12"end end;if I.UnholyAssault:IsReady()and X then if Q.CastTargetIf(I.UnholyAssault,ab,"min",aq,nil,not h:IsInMeleeRange(5),nil)then F=207289;return"unholy_assault cooldowns 14"end end;if I.SoulReaper:IsReady()and(ac==1 and(h:TimeToX(35)<5 or h:HealthPercentage()<=35)and h:TimeToDie()>5)then if n(I.SoulReaper,nil,nil,not h:IsSpellInRange(I.SoulReaper))then F=343294;return"soul_reaper cooldowns 16"end end;if I.SoulReaper:IsReady()and ac>=2 then if Q.CastTargetIf(I.SoulReaper,ab,"min",as,ax,not h:IsSpellInRange(I.SoulReaper))then F=343294;return"soul_reaper cooldowns 18"end end end;local function aI()if I.Apocalypse:IsReady()and(a7>=4 and(g:BuffUp(I.CommanderoftheDeadBuff)and a4<23 or not I.CommanderoftheDead:IsAvailable()))then if n(I.Apocalypse,nil,nil,not h:IsInMeleeRange(5))then F=275699;return"apocalypse garg_setup 2"end end;if I.ArmyoftheDead:IsReady()and not s and(I.CommanderoftheDead:IsAvailable()and(I.DarkTransformation:CooldownRemains()<3 or g:BuffUp(I.CommanderoftheDeadBuff))or not I.CommanderoftheDead:IsAvailable()and I.UnholyAssault:IsAvailable()and I.UnholyAssault:CooldownRemains()<10 or not I.UnholyAssault:IsAvailable()and not I.CommanderoftheDead:IsAvailable())then if n(I.ArmyoftheDead,nil,nil)then F=42650;return"army_of_the_dead garg_setup 4"end end;if I.SoulReaper:IsReady()and(ac==1 and(h:TimeToX(35)<5 or h:HealthPercentage()<=35)and h:TimeToDie()>5)then if n(I.SoulReaper,nil,nil,not h:IsInMeleeRange(5))then F=343294;return"soul_reaper garg_setup 6"end end;if I.SummonGargoyle:IsCastable()and o()and(g:BuffUp(I.CommanderoftheDeadBuff)or not I.CommanderoftheDead:IsAvailable()and g:RunicPower()>=40)then if n(I.SummonGargoyle,nil)then F=49206;return"summon_gargoyle garg_setup 8"end end;if o()and(a3 and a4<=23)then if I.EmpowerRuneWeapon:IsCastable()then if n(I.EmpowerRuneWeapon,nil)then F=47568;return"empower_rune_weapon garg_setup 10"end end;if I.UnholyAssault:IsCastable()then if n(I.UnholyAssault,nil,nil,not h:IsInMeleeRange(5))then F=207289;return"unholy_assault garg_setup 12"end end end;if R.Commons.Enabled.Potions then local aJ=Q.PotionSelected()if aJ then if aJ:IsReady()and(30>=a4 and a3 or(not I.SummonGargoyle:IsAvailable()or I.SummonGargoyle:CooldownRemains()>60 or I.SummonGargoyle:CooldownUp())and(j:BuffUp(I.DarkTransformation)and 30>=j:BuffRemains(I.DarkTransformation)or a1 and a2<=30 or Z and a0<=30))then if n(aJ,nil,R.Commons.DisplayStyle.Potions)then F=50;return"potion garg_setup 14"end end end end;if I.DarkTransformation:IsCastable()and(I.CommanderoftheDead:IsAvailable()and g:RunicPower()>40 or not I.CommanderoftheDead:IsAvailable())then if n(I.DarkTransformation,nil)then F=63560;return"dark_transformation garg_setup 16"end end;if a6:IsReady()and(g:BuffDown(I.DeathAndDecayBuff)and a7>0)then if n(a6,nil)then F=43265;return"any_dnd garg_setup 18"end end;if I.FesteringStrike:IsReady()and(a7==0 or not I.Apocalypse:IsAvailable()or g:RunicPower()<40 and not a3)then if n(I.FesteringStrike,nil,nil,not h:IsInMeleeRange(5))then F=85948;return"festering_strike garg_setup 20"end end;if I.DeathCoil:IsReady()and g:Rune()<=1 then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil garg_setup 22"end end end;local function aK()if R.Commons.Enabled.Potions then local aJ=Q.PotionSelected()if aJ then if aJ:IsReady()and(30>=a4 and a3 or(not I.SummonGargoyle:IsAvailable()or I.SummonGargoyle:CooldownRemains()>60 or I.SummonGargoyle:CooldownUp())and(j:BuffUp(I.DarkTransformation)and 30>=j:BuffRemains(I.DarkTransformation)or a1 and a2<=30 or Z and a0<=30)or a9<=30)then if n(aJ,nil,R.Commons.DisplayStyle.Potions)then F=50;return"potion high_prio_actions 2"end end end end;if I.ArmyoftheDead:IsReady()and not s and(I.SummonGargoyle:IsAvailable()and I.SummonGargoyle:CooldownRemains()<2 or not I.SummonGargoyle:IsAvailable()or a9<35)then if n(I.ArmyoftheDead,nil,nil)then F=42650;return"army_of_the_dead high_prio_actions 4"end end;if I.DeathCoil:IsReady()and((ac<=3 or not I.Epidemic:IsAvailable())and(a3 and I.CommanderoftheDead:IsAvailable()and g:BuffUp(I.CommanderoftheDeadBuff)and I.Apocalypse:CooldownRemains()<5 and g:BuffRemains(I.CommanderoftheDeadBuff)>27 or h:DebuffUp(I.DeathRotDebuff)and h:DebuffRemains(I.DeathRotDebuff)<g:GCD()))then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil high_prio_actions 6"end end;if I.Epidemic:IsReady()and(ae>=4 and(I.CommanderoftheDead:IsAvailable()and g:BuffUp(I.CommanderoftheDeadBuff)and I.Apocalypse:CooldownRemains()<5 or h:DebuffUp(I.DeathRotDebuff)and h:DebuffRemains(I.DeathRotDebuff)<g:GCD()))then if n(I.Epidemic,nil,nil,not h:IsInRange(30))then F=207317;return"epidemic high_prio_actions 8"end end;if a5:IsReady()and((I.Apocalypse:CooldownRemains()>T+3 or ac>=3)and I.Plaguebringer:IsAvailable()and(I.Superstrain:IsAvailable()or I.UnholyBlight:IsAvailable())and g:BuffRemains(I.PlaguebringerBuff)<g:GCD())then if n(a5,nil,nil,not h:IsSpellInRange(a5))then ah()return"wound_spender high_prio_actions 10"end end;if I.UnholyBlight:IsReady()and(X and((not I.Apocalypse:IsAvailable()or I.Apocalypse:CooldownDown())and I.Morbidity:IsAvailable()or not I.Morbidity:IsAvailable())or Y or a9<21)then if n(I.UnholyBlight,nil,nil,not h:IsInRange(8))then F=115989;return"unholy_blight high_prio_actions 12"end end;if I.Outbreak:IsReady()then if Q.CastCycle(I.Outbreak,ab,aB,not h:IsSpellInRange(I.Outbreak))then F=77575;return"outbreak high_prio_actions 14"end end end;local function aL()if I.ArcaneTorrent:IsCastable()and(g:RunicPowerDeficit()>20 and(I.SummonGargoyle:CooldownRemains()<g:GCD()or not I.SummonGargoyle:IsAvailable()or a3 and g:Rune()<2 and a7<1))then if n(I.ArcaneTorrent,nil,nil,not h:IsInRange(8))then F=28730;return"arcane_torrent racials 2"end end;if I.BloodFury:IsCastable()and(I.BloodFury:BaseDuration()+3>=a4 and a3 or(not I.SummonGargoyle:IsAvailable()or I.SummonGargoyle:CooldownRemains()>60)and(a1 and a2<=I.BloodFury:BaseDuration()+3 or Z and a0<=I.BloodFury:BaseDuration()+3 or ac>=2 and g:BuffUp(I.DeathAndDecayBuff))or a9<=I.BloodFury:BaseDuration()+3)then if n(I.BloodFury,nil)then F=20572;return"blood_fury racials 4"end end;if I.Berserking:IsCastable()and(I.Berserking:BaseDuration()+3>=a4 and a3 or(not I.SummonGargoyle:IsAvailable()or I.SummonGargoyle:CooldownRemains()>60)and(a1 and a2<=I.Berserking:BaseDuration()+3 or Z and a0<=I.Berserking:BaseDuration()+3 or ac>=2 and g:BuffUp(I.DeathAndDecayBuff))or a9<=I.Berserking:BaseDuration()+3)then if n(I.Berserking,nil)then F=26297;return"berserking racials 6"end end;if I.LightsJudgment:IsCastable()and(g:BuffUp(I.UnholyStrengthBuff)and(not I.Festermight:IsAvailable()or g:BuffRemains(I.FestermightBuff)<h:TimeToDie()or g:BuffRemains(I.UnholyStrengthBuff)<h:TimeToDie()))then if n(I.LightsJudgment,nil,nil,not h:IsSpellInRange(I.LightsJudgment))then F=255647;return"lights_judgment racials 8"end end;if I.AncestralCall:IsCastable()and(18>=a4 and a3 or(not I.SummonGargoyle:IsAvailable()or I.SummonGargoyle:CooldownRemains()>60)and(a1 and a2<=18 or Z and a0<=18 or ac>=2 and g:BuffUp(I.DeathAndDecayBuff))or a9<=18)then if n(I.AncestralCall,nil)then F=274738;return"ancestral_call racials 10"end end;if I.ArcanePulse:IsCastable()and(ac>=2 or g:Rune()<=1 and g:RunicPowerDeficit()>=60)then if n(I.ArcanePulse,nil,nil,not h:IsInRange(8))then F=260364;return"arcane_pulse racials 12"end end;if I.Fireblood:IsCastable()and(I.Fireblood:BaseDuration()+3>=a4 and a3 or(not I.SummonGargoyle:IsAvailable()or I.SummonGargoyle:CooldownRemains()>60)and(a1 and a2<=I.Fireblood:BaseDuration()+3 or Z and a0<=I.Fireblood:BaseDuration()+3 or ac>=2 and g:BuffUp(I.DeathAndDecayBuff))or a9<=I.Fireblood:BaseDuration()+3)then if n(I.Fireblood,nil)then F=265221;return"fireblood racials 14"end end;if I.BagofTricks:IsCastable()and(ac==1 and(g:BuffUp(I.UnholyStrengthBuff)or d.FilteredFightRemains(ab,"<",5)))then if n(I.BagofTricks,nil,nil,not h:IsSpellInRange(I.BagofTricks))then F=312411;return"bag_of_tricks racials 16"end end end;local function aM()if I.DeathCoil:IsReady()and(not VarEpidemicPriority and(not W and VarSpendRP or a9<10))then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil st 2"end end;if I.Epidemic:IsReady()and(VarEpidemicPriority and(not W and VarSpendRP or a9<10))then if n(I.Epidemic,nil,nil,not h:IsInRange(30))then F=207317;return"epidemic st 4"end end;if a6:IsReady()and(g:BuffDown(I.DeathAndDecayBuff)and(ac>=2 or I.UnholyGround:IsAvailable()and(Z and a0>=13 or a3 and a4>8 or a1 and a2>8 or not V and a7>=4)or I.Defile:IsAvailable()and(a3 or Z or a1 or j:BuffUp(I.DarkTransformation)))and(I.FesteringWoundDebuff:AuraActiveCount()==ac or ac==1))then if n(a6,nil)then F=43265;return"any_dnd st 6"end end;if a5:IsReady()and(V or ac>=2 and g:BuffUp(I.DeathAndDecayBuff))then if n(a5,nil,nil,not h:IsSpellInRange(a5))then ah()return"wound_spender st 8"end end;if I.FesteringStrike:IsReady()and not V then if Q.CastTargetIf(I.FesteringStrike,ab,"min",aq,aw,not h:IsInMeleeRange(5))then F=85948;return"festering_strike st 10"end end;if I.DeathCoil:IsReady()then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil st 12"end end;if a5:IsReady()and not V then if Q.CastTargetIf(a5,ab,"max",aq,aw,not h:IsSpellInRange(a5))then ah()return"wound_spender st 14"end end end;local function aN()local aO=g:GetUseableTrinkets(K)if aO and o()and(I.Apocalypse:CooldownDown()or j:BuffUp(I.DarkTransformation))then if aO then if m.Cast(aO,nil,nil)then if aO:ID()==GetInventoryItemID("player",13)and R.Commons.Enabled.TopTrinket then F=30;return"Generic use_items for "..aO:Name()elseif aO:ID()==GetInventoryItemID("player",14)and R.Commons.Enabled.BottomTrinket then F=31;return"Generic use_items for "..aO:Name()end end end end end;local function aP()VarEpidemicPriority=I.ImprovedDeathCoil:IsAvailable()and not I.CoilofDevastation:IsAvailable()and ac>=3 or I.CoilofDevastation:IsAvailable()and ac>=4 or not I.ImprovedDeathCoil:IsAvailable()and ac>=2;S=ac>=3 or I.SummonGargoyle:CooldownRemains()>1 and(I.Apocalypse:CooldownRemains()>1 or not I.Apocalypse:IsAvailable())or not I.SummonGargoyle:IsAvailable()or d.CombatTime()>20;T=I.Apocalypse:CooldownRemains()<10 and a7<=4 and I.UnholyAssault:CooldownRemains()>10 and 7 or 2;if not a3 and I.Festermight:IsAvailable()and g:BuffUp(I.FestermightBuff)and g:BuffRemains(I.FestermightBuff)/(5*g:GCD())>=1 then U=a7>=1 else U=a7>=3-B(I.InfectedClaws:IsAvailable())end;V=(I.Apocalypse:CooldownRemains()>T or not I.Apocalypse:IsAvailable())and(U or a7>=1 and I.UnholyAssault:CooldownRemains()<20 and I.UnholyAssault:IsAvailable()and X or h:DebuffUp(I.RottenTouchDebuff)and a7>=1 or a7>4 or g:HasTier(31,4)and(aa:ApocMagusActive()or aa:ArmyMagusActive())and a7>=1)or a9<5 and a7>=1;W=I.VileContagion:IsAvailable()and I.VileContagion:CooldownRemains()<3 and g:RunicPower()<60 and not X;X=ac==1 or not p()Y=ac>=2 and p()VarSpendRP=(not I.RottenTouch:IsAvailable()or I.RottenTouch:IsAvailable()and h:DebuffDown(I.RottenTouchDebuff)or g:RunicPowerDeficit()<20)and(not g:HasTier(31,4)or g:HasTier(31,4)and not(aa:ApocMagusActive()or aa:ArmyMagusActive())or g:RunicPowerDeficit()<20 or g:Rune()<3)and(I.ImprovedDeathCoil:IsAvailable()and(ac==2 or I.CoilofDevastation:IsAvailable())or g:Rune()<3 or a3 or g:BuffUp(I.SuddenDoomBuff)or I.Apocalypse:CooldownRemains()<10 and a7>3 or not V and a7>=4)end;local function aQ()P=ai()ab=g:GetEnemiesInMeleeRange(8)ad=g:GetEnemiesInMeleeRange(10)TopTrinketID,_=GetInventoryItemID("player",13)BotTrinketID,_=GetInventoryItemID("player",14)if p()then ac=#ab;ae=#ab else ac=1;ae=1 end;af=aj(ad)Z=I.Apocalypse:TimeSinceLastCast()<=15;a0=Z and 15-I.Apocalypse:TimeSinceLastCast()or 0;a1=I.ArmyoftheDead:TimeSinceLastCast()<=30;a2=a2 and 30-I.ArmyoftheDead:TimeSinceLastCast()or 0;if Q.TargetIsValid()or g:AffectingCombat()then if IsInRaid()and UnitExists("boss1")then a8=d.BossFightRemains(nil,true)a9=a8;if a9==11111 then a9=d.FightRemains(Enemies10yd,false)end end end;r=HeroRotationCharDB.Toggles[5]q=HeroRotationCharDB.Toggles[4]s=HeroRotationCharDB.Toggles[10]t=HeroRotationCharDB.Toggles[11]u=HeroRotationCharDB.Toggles[12]v=HeroRotationCharDB.Toggles[13]w=HeroRotationCharDB.Toggles[14]x=not HeroRotationCharDB.Toggles[15]y=HeroRotationCharDB.Toggles[16]z=HeroRotationCharDB.Toggles[17]A=HeroRotationCharDB.Toggles[18]if not H then G=0;F=0 end;if G>0 then G=0 end;if F>0 then F=0 end end;local function aR()ab=g:GetEnemiesInMeleeRange(5)if not H then G=0;F=0 end;if G>0 then G=0 end;if F>0 then F=0 end;O=aQ()if m.QueuedCast()then F=m.QueuedCast()return"Custom Queue "..k(F):ID()end;if m.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[5]then starttime=GetTime()endtime=starttime+m.GUISettings.General.OpenerReset elseif m.GUISettings.General.OpenerReset>0 and endtime~=nil and GetTime()>endtime and HeroRotationCharDB.Toggles[5]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]m.ToggleIconFrame:UpdateButtonText(5)m.Print("Opener is now "..(HeroRotationCharDB.Toggles[5]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end;if v and I.AntiMagicZone:IsUsableP()and g:AffectingCombat()and I.AntiMagicZone:CooldownRemains(BypassRecovery)<=0 then if n(I.AntiMagicZone,nil,nil,nil)then F=145629;return"queue AMZ"end elseif(not I.AntiMagicZone:IsUsableP()or I.AntiMagicZone:CooldownRemains()>0 or not g:AffectingCombat())and v then HeroRotationCharDB.Toggles[13]=not HeroRotationCharDB.Toggles[13]m.Print("Anti-Magic Zone Queue is now "..(HeroRotationCharDB.Toggles[13]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if w and I.DeathGrip:IsUsableP()and I.DeathGrip:CooldownRemains(BypassRecovery)<=0 and Q.TargetIsValid()and f("mouseover"):GUID()~=nil then if n(I.DeathGrip,nil,nil,nil)then G=149576;return"queue DeathGrip MO"end elseif w and I.DeathGrip:IsUsableP()and I.DeathGrip:CooldownRemains(BypassRecovery)<=0 and Q.TargetIsValid()then if n(I.DeathGrip,nil,nil,nil)then F=49576;return"queue DeathGrip"end elseif(not I.DeathGrip:IsUsableP()or I.DeathGrip:CooldownRemains()>0 or not Q.TargetIsValid())and w then HeroRotationCharDB.Toggles[14]=not HeroRotationCharDB.Toggles[14]m.Print("Death Grip Queue is now "..(HeroRotationCharDB.Toggles[14]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if y and I.Asphyxiate:IsUsableP()and I.Asphyxiate:CooldownRemains(BypassRecovery)<=0 and f("mouseover"):GUID()~=nil then if n(I.Asphyxiate,nil,nil,nil)then G=1221562;return"queue Asphyxiate MO"end elseif y and I.Asphyxiate:IsUsableP()and I.Asphyxiate:CooldownRemains(BypassRecovery)<=0 and Q.TargetIsValid()then if n(I.Asphyxiate,nil,nil,nil)then F=221562;return"queue Asphyxiate"end elseif(not I.Asphyxiate:IsUsableP()or I.Asphyxiate:CooldownRemains()>0)and y then HeroRotationCharDB.Toggles[16]=not HeroRotationCharDB.Toggles[16]m.Print("Asphyxiate Queue is now "..(HeroRotationCharDB.Toggles[16]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if g:IsChanneling(k(324631))then if n(I.PoolResources,nil,nil,nil)then G=161999;return"Raise Ally MO"end end;if I.RaiseDead:IsCastable()then if n(I.RaiseDead,nil,nil)then F=46584;return"raise_dead precombat 2 displaystyle"end end;ab=g:GetEnemiesInMeleeRange(8)ad=h:GetEnemiesInSplashRange(10)if p()then ac=#ab;ae=h:GetEnemiesInSplashRangeCount(10)else ac=1;ae=1 end;if Q.TargetIsValid()or g:AffectingCombat()then a8=d.BossFightRemains()a9=a8;if a9==11111 then a9=d.FightRemains(ab,false)end;af=aj(ad)Z=I.Apocalypse:TimeSinceLastCast()<=15;a0=Z and 15-I.Apocalypse:TimeSinceLastCast()or 0;a1=I.ArmyoftheDead:TimeSinceLastCast()<=30;a2=a1 and 30-I.ArmyoftheDead:TimeSinceLastCast()or 0;a3=aa:gargactive()a4=aa:gargremains()a7=h:DebuffStack(I.FesteringWoundDebuff)end;if Q.TargetIsValid()and g:AffectingCombat()then if not g:AffectingCombat()then local O=aC()if O then return O end end;if I.DeathStrike:IsReady()and g:HealthPercentage()<R.Commons.UseDeathStrikeHP then if n(I.DeathStrike)then F=49998;return"death_strike low hp or proc"end end;if ac==0 then if I.Outbreak:IsReady()and af>0 then if n(I.Outbreak,nil,nil,not h:IsSpellInRange(I.Outbreak))then F=77575;return"outbreak out_of_range"end end;if I.Epidemic:IsReady()and p()and I.VirulentPlagueDebuff:AuraActiveCount()>1 and not W then if n(I.Epidemic,nil,nil,not h:IsInRange(30))then F=207317;return"epidemic out_of_range"end end;if I.DeathCoil:IsReady()and I.VirulentPlagueDebuff:AuraActiveCount()<2 and not W then if n(I.DeathCoil,nil,nil,not h:IsSpellInRange(I.DeathCoil))then F=47541;return"death_coil out_of_range"end end end;aP()local O=aK()if O then return O end;if R.Commons.Enabled.Trinkets or R.Commons.Enabled.Items then local O=aN()if O then return O end end;if o()and not S then local O=aI()if O then return O end;if m.CastAnnotated(I.Pool,false,"WAIT")then return"Pool for GargSetup()"end end;if o()and X then local O=aH()if O then return O end end;if p()and o()and Y then local O=aF()if O then return O end end;if o()then local O=aL()if O then return O end end;if p()then if Y and a6:CooldownRemains()<10 and g:BuffDown(I.DeathAndDecayBuff)then local O=aG()if O then return O end end;if ac>=4 and g:BuffUp(I.DeathAndDecayBuff)then local O=aE()if O then return O end end;if ac>=4 and(a6:CooldownRemains()>10 and g:BuffDown(I.DeathAndDecayBuff)or not Y)then local O=aD()if O then return O end end end;if ac<=3 then local O=aM()if O then return O end end;if n(I.Pool)then return"pool_resources"end end end;function ReturnSpell()if F==0 then return 0 else return F end end;function ReturnSpellMO()if G==0 then return 0 else return G end end;local function aS()I.VirulentPlagueDebuff:RegisterAuraTracking()I.FesteringWoundDebuff:RegisterAuraTracking()m.Print("Unholy DK rotation is currently a work in progress, but has been updated for patch 10.1.5.",s)end;m.SetAPL(252,aR,aS)