local a=HeroLib;local b=HeroCache;local c=a.Unit;local d=c.Player;local e=c.Pet;local f=c.Target;local g=a.Spell;local h=a.Item;local i=HeroRotation;local j=g.Mage.Arcane;local k=g.Mage.Fire;local l=g.Mage.Frost;local m=math.min;local n={General=i.GUISettings.General,Commons=i.GUISettings.APL.Mage.Commons,Frost=i.GUISettings.APL.Mage.Frost,Fire=i.GUISettings.APL.Mage.Fire,Arcane=i.GUISettings.APL.Mage.Arcane}local function o(p)if p then return 1 else return 0 end end;local function q(p)return p~=0 end;local r;r=a.AddCoreOverride("Player.AffectingCombat",function(self)return j.ArcaneBlast:InFlight()or r(self)end,62)a.AddCoreOverride("Spell.IsCastable",function(self,s,t,u,v,w)if self:CastTime()>0 and d:IsMoving()and n.Arcane.MovingRotation then return false end;local x=true;if t then local y=v or f;x=y:IsInRange(t,u)end;local z=self:IsLearned()and self:CooldownRemains(s,w or"Auto")==0 and x and d:Mana()>=self:Cost()if self==j.PresenceofMind then return z and d:BuffDown(j.PresenceofMind)elseif self==j.RadiantSpark then return z and not d:IsCasting(self)elseif self==j.ShiftingPower then return z and not d:IsCasting(self)elseif self==j.TouchoftheMagi then return z and not d:IsCasting(self)elseif self==j.ConjureManaGem then local A=h.Mage.Arcane.ManaGem;local B=A:CooldownRemains()return z and not d:IsCasting(self)and not(A:IsReady()or B>0)elseif self==j.ArcaneSurge then return self:IsLearned()and self:CooldownUp()and x else return z end end,62)local C;C=a.AddCoreOverride("Player.BuffStack",function(self,g,D,w)local z=C(self,g,D,w)if g==k.PyroclasmBuff and self:IsCasting(k.Pyroblast)then return 0 else return z end end,63)local E;E=a.AddCoreOverride("Player.BuffRemains",function(self,g,D,w)local z=E(self,g,D,w)if g==k.PyroclasmBuff and self:IsCasting(k.Pyroblast)then return 0 end;return z end,63)a.AddCoreOverride("Spell.IsReady",function(self,t,u,v,s,w)local z=self:IsCastable()and self:IsUsableP()local F=true;if self:CastTime()>0 and d:IsMoving()and n.Fire.MovingRotation then if self==k.Scorch or self==k.Pyroblast and d:BuffUp(k.HotStreakBuff)or self==k.Flamestrike and d:BuffUp(k.HotStreakBuff)then F=true else return false end else return z end end,63)a.AddCoreOverride("Spell.IsCastable",function(self,s,t,u,v,w)if self:CastTime()>0 and d:IsMoving()and n.Arcane.MovingRotation then return false end;local x=true;if t then local y=v or f;x=y:IsInRange(t,u)end;local z=self:IsLearned()and self:CooldownRemains(s,w or"Auto")==0 and x;if self==k.RadiantSpark then return z and not d:IsCasting(self)elseif self==k.ShiftingPower then return z and not d:IsCasting(self)else return z end end,63)local G;G=a.AddCoreOverride("Player.AffectingCombat",function(self)return G(self)or d:IsCasting(k.Pyroblast)or d:IsCasting(k.Fireball)end,63)a.AddCoreOverride("Spell.InFlightRemains",function(self)return self:TravelTime()-self:TimeSinceLastCast()end,63)local H;H=a.AddCoreOverride("Spell.IsCastable",function(self,s,t,u,v,w)local F=true;if self:CastTime()>0 and d:IsMoving()and n.Frost.MovingRotation then if self==l.Blizzard and d:BuffUp(l.FreezingRain)then F=true else return false end end;local x=true;if t then local y=v or f;x=y:IsInRange(t,u)end;if self==l.GlacialSpike then return self:IsLearned()and x and F and not d:IsCasting(self)and(d:BuffUp(l.GlacialSpikeBuff)or d:BuffStack(l.IciclesBuff)==5)else local z=H(self,s,t,u,v,w)if self==l.MirrorsofTorment then return z and not d:IsCasting(self)elseif self==l.RadiantSpark then return z and not d:IsCasting(self)elseif self==l.ShiftingPower then return z and not d:IsCasting(self)elseif self==l.Deathborne then return z and not d:IsCasting(self)else return z end end end,64)local I;I=a.AddCoreOverride("Spell.CooldownRemains",function(self,s,w)if self==l.Blizzard and d:IsCasting(self)then return 8 else return I(self,s,w)end end,64)local J;J=a.AddCoreOverride("Player.BuffStackP",function(self,g,D,w)local z=d:BuffStack(g)if g==l.IciclesBuff then local K=z;if self:IsCasting(l.GlacialSpike)then return 0 end;if not l.GlacialSpike:IsAvailable()and l.IceLance:TimeSinceLastCast()<2*d:SpellHaste()then K=0 end;return m(K+(self:IsCasting(l.Frostbolt)and 1 or 0),5)elseif g==l.GlacialSpikeBuff then return self:IsCasting(l.GlacialSpike)and 0 or z elseif g==l.WintersReachBuff then return self:IsCasting(l.Flurry)and 0 or z elseif g==l.FingersofFrostBuff then if l.IceLance:InFlight()then if z==0 then return 0 else return z-1 end else return z end else return z end end,64)local L;L=a.AddCoreOverride("Player.BuffUpP",function(self,g,D,w)local z=d:BuffUp(g)if g==l.FingersofFrostBuff then if l.IceLance:InFlight()then return d:BuffStack(g)>=1 else return z end else return z end end,64)local M;M=a.AddCoreOverride("Player.BuffDownP",function(self,g,D,w)local z=d:BuffDown(g)if g==l.FingersofFrostBuff then if l.IceLance:InFlight()then return d:BuffStack(g)==0 else return z end else return z end end,64)local N;N=a.AddCoreOverride("Target.DebuffStack",function(self,g,D,w)local z=N(self,g,D,w)if g==l.WintersChillDebuff then if l.Flurry:InFlight()then return 2 elseif l.IceLance:InFlight()then if z==0 then return 0 else return z-1 end else return z end else return z end end,64)local O;O=a.AddCoreOverride("Target.DebuffRemains",function(self,g,D,w)local z=O(self,g,D,w)if g==l.WintersChillDebuff then return l.Flurry:InFlight()and 6 or z else return z end end,64)local P;P=a.AddCoreOverride("Player.AffectingCombat",function(self)return l.Frostbolt:InFlight()or P(self)end,64)