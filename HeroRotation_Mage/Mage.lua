local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Pet;local j=d.Spell;local k=d.MultiSpell;local l=d.Item;local m=d.Utils.MergeTableByKey;local n=HeroRotation;local GetTime=GetTime;n.Commons.Mage={}local o=n.GUISettings.APL.Mage.Commons;local p=n.Commons.Mage;if not j.Mage then j.Mage={}end;j.Mage.Commons={AncestralCall=j(274738),BagofTricks=j(312411),Berserking=j(26297),BerserkingBuff=j(26297),BloodFury=j(20572),BloodFuryBuff=j(20572),Fireblood=j(265221),LightsJudgment=j(255647),AlterTime=j(108978),ArcaneExplosion=j(1449),ArcaneIntellect=j(1459),ArcaneIntellectBuff=j(1459),Blink=k(1953,212653),Counterspell=j(2139),Frostbolt=j(116),FrostNova=j(122),IceBlock=j(45438),Invisibility=j(66),MirrorImage=j(55342),RemoveCurse=j(475),SlowFall=j(130),SpellSteal=j(30449),TimeWarp=j(80353),FocusMagic=j(321358),RingOfFrost=j(113724),RuneofPower=j(116011),RuneofPowerBuff=j(116014),Deathborne=j(324220),DeathborneBuff=j(324220),DoorofShadows=j(300728),Fleshcraft=j(324631),MirrorsofTorment=j(314793),RadiantSpark=j(307443),RadiantSparkDebuff=j(307443),RadiantSparkVulnerability=j(307454),ShiftingPower=j(314791),Soulshape=j(310143),CombatMeditation=j(328266),EffusiveAnimaAccelerator=j(352188),FieldOfBlossoms=j(319191),GroveInvigoration=j(322721),WastelandPropriety=j(333251),ArcaneProdigy=j(336873),IcyPropulsion=j(336522),IreOfTheAscended=j(337058),PustuleEruption=j(351094),ShiveringCore=j(336472),SiphonedMalice=j(337090),VolatileSolvent=j(323074),DisciplinaryCommandBuff=j(327371),ExpandedPotentialBuff=j(327495),ScarsofFraternalStrifeBuff4=j(368638),SoulIgnitionBuff=j(345211),TomeofMonstruousConstructionsBuff=j(357163)}j.Mage.Arcane=m(j.Mage.Commons,{AncestralCall=j(274738),BagofTricks=j(312411),Berserking=j(26297),BerserkingBuff=j(26297),BloodFury=j(20572),BloodFuryBuff=j(20572),Fireblood=j(265221),LightsJudgment=j(255647),ArcaneBarrage=j(44425),ArcaneBlast=j(30451),ArcaneMissiles=j(5143),ArcaneExplosion=j(1449),ArcaneIntellect=j(1459),ArcanePower=j(12042),Blink=k(1953,212653),ClearcastingBuff=j(263725),Counterspell=j(2139),Evocation=j(12051),FireBlast=j(319836),MirrorImage=j(55342),PresenceofMind=j(205025),TouchoftheMagi=j(321507),Frostbolt=j(116),ConjureManaHem=j(759),FrostNova=j(122),TimeWarp=j(80353),AlterTime=j(108978),SpellSteal=j(30449),RemoveCurse=j(475),Invisibility=j(66),SlowFall=j(130),IceBlock=j(45438),PrismaticBarrier=j(235450),GreaterInvisibility=j(110959),Amplification=j(236628),RuleofThrees=j(264354),RuleofThreesBuff=j(264774),ArcaneFamiliar=j(205022),ArcaneFamiliarBuff=j(210126),Slipstream=j(236457),RuneofPower=j(116011),RuneofPowerBuff=j(116014),Resonance=j(205028),ArcaneEcho=j(342231),NetherTempest=j(114923),ArcaneOrb=j(153626),Supernova=j(157980),Overpowered=j(155147),Enlightened=j(321387),FocusMagic=j(321358),RingOfFrost=j(113724),RadiantSpark=j(307443),RadiantSparkVulnerability=j(307454),MirrorsofTorment=j(314793),Deathborne=j(324220),Fleshcraft=j(324631),ShiftingPower=j(314791),FieldOfBlossoms=j(319191),ArcaneProdigy=j(336873),VolatileSolvent=j(323074),PustuleEruption=j(351094),ExpandedPotentialBuff=j(327495),SiphonStormBuff=j(332928),DisciplinaryCommandBuff=j(327371),ArcaneHarmonyBuff=j(332777),SoulIgniterBuff=j(345211),TomeofMonstruousConstructionsBuff=j(357163)})j.Mage.Fire=m(j.Mage.Commons,{AncestralCall=j(274738),BagofTricks=j(312411),Berserking=j(26297),BerserkingBuff=j(26297),BloodFury=j(20572),BloodFuryBuff=j(20572),Fireblood=j(265221),LightsJudgment=j(255647),ArcaneIntellect=j(1459),ArcaneIntellectBuff=j(1459),ArcaneExplosion=j(1449),Blink=k(1953,212653),Frostbolt=j(116),TimeWarp=j(80353),MirrorImage=j(55342),Pyroblast=j(11366),Combustion=j(190319),CombustionBuff=j(190319),FireBlast=j(108853),Fireball=j(133),Scorch=j(2948),HeatingUpBuff=j(48107),HotStreakBuff=j(48108),PhoenixFlames=j(257541),DragonsBreath=j(31661),Flamestrike=j(2120),Counterspell=j(2139),FrostNova=j(122),Ignite=j(12654),AlterTime=j(108978),SpellSteal=j(30449),RemoveCurse=j(475),Invisibility=j(66),SlowFall=j(130),IceBlock=j(45438),BlazingBarrier=j(235313),Firestarter=j(205026),SearingTouch=j(269644),RuneofPower=j(116011),RuneofPowerBuff=j(116014),FlameOn=j(205029),AlexstraszasFury=j(235870),FromTheAshes=j(342344),FlamePatch=j(205037),LivingBomb=j(44457),Kindling=j(155148),Pyroclasm=j(269650),PyroclasmBuff=j(269651),Meteor=j(153561),FocusMagic=j(321358),RingOfFrost=j(113724),BlastWave=j(157981),Deathborne=j(324220),DeathborneBuff=j(324220),DoorofShadows=j(300728),Fleshcraft=j(324631),MirrorsofTorment=j(314793),RadiantSpark=j(307443),RadiantSparkDebuff=j(307443),RaidantSparkVulnerability=j(307454),ShiftingPower=j(314791),Soulshape=j(310143),WastelandPropriety=j(333251),SiphonedMalice=j(337090),GroveInvigoration=j(322721),FieldOfBlossoms=j(319191),IreOfTheAscended=j(337058),FlameAccretion=j(337224),InfernalCascade=j(336821),InfernalCascadeBuff=j(336832),FirestormBuff=j(333100),SunKingsBlessingBuff=j(333314),SunKingsBlessingBuffReady=j(333315),GrislyIcicleBuff=j(333393),GrislyIcicleDebuff=j(348007),DisciplinaryCommandBuff=j(327371),SoulIgnitionBuff=j(345211),TomeofMonstruousConstructionsBuff=j(357163),Pool=j(999910)})j.Mage.Frost=m(j.Mage.Commons,{Blizzard=j(190356),BrainFreezeBuff=j(190446),ConeofCold=j(120),FingersofFrostBuff=j(44544),Flurry=j(44614),FrozenOrb=j(84714),FrozenOrb2=j(198149),IceLance=j(30455),IciclesBuff=j(205473),IcyVeins=j(12472),SummonWaterElemental=j(31687),WintersChillDebuff=j(228358),FireBlast=j(319836),Frostbite=j(198121),Freeze=j(33395),TemporalDisplacement=j(80354),SpellSteal=j(30449),RemoveCurse=j(475),IceBarrier=j(11426),IceBlock=j(45438),IceNova=j(157997),IceFloes=j(108839),IncantersFlow=j(1463),IncantersFlowBuff=j(116267),FocusMagic=j(321358),RuneofPower=j(116011),RuneofPowerBuff=j(116014),Ebonbolt=j(257537),FreezingRain=j(270233),FreezingRainBuff=j(270232),SplittingIce=j(56377),CometStorm=j(153595),RayofFrost=j(205021),GlacialSpike=j(199786),GlacialSpikeBuff=j(199844),RingOfFrost=j(113724),CombatMeditation=j(328266),Deathborne=j(324220),DoorofShadows=j(300728),Fleshcraft=j(324631),MirrorsofTorment=j(314793),RadiantSpark=j(307443),RadiantSparkDebuff=j(307443),RaidantSparkVulnerability=j(307454),ShiftingPower=j(314791),Soulshape=j(310143),WastelandPropriety=j(333251),SiphonedMalice=j(337090),GroveInvigoration=j(322721),FieldOfBlossoms=j(319191),IreOfTheAscended=j(337058),FreezingWindsBuff=j(327364),SlickIceBuff=j(327508),ExpandedPotentialBuff=j(327495),DisciplinaryCommandBuff=j(327371),TomeofMonstruousConstructionsBuff=j(357163),Pool=j(999910)})if not l.Mage then l.Mage={}end;l.Mage.Arcane={ManaGem=l(36799),PotionofSpectralIntellect=l(171273),DarkmoonDeckPutrescence=l(173069),DreadfireVessel=l(184030),EmpyrealOrdnance=l(180117),FlameofBattle=l(181501),GlyphofAssimilation=l(184021),InscrutableQuantumDevice=l(179350),MacabreSheetMusic=l(184024),SinfulGladiatorsBadge=l(175921),SoulIgniter=l(184019),SoullettingRuby=l(178809),SunbloodAmethyst=l(178826),WakenersFrond=l(181457),ShadowedOrbofTorment=l(186428),TomeofMonstruousConstructions=l(186422)}l.Mage.Fire={PotionofSpectralIntellect=l(171273),DreadfireVessel=l(184030),EmpyrealOrdnance=l(180117),FlameofBattle=l(181501),GlyphofAssimilation=l(184021),InscrutableQuantumDevice=l(179350),InstructorsDivineBell=l(184842),MacabreSheetMusic=l(184024),SinfulAspirantsBadge=l(175884),SinfulGladiatorsBadge=l(175921),SoulIgniter=l(184019),SunbloodAmethyst=l(178826),WakenersFrond=l(181457),ShadowedOrbofTorment=l(186428),TomeofMonstruousConstructions=l(186422)}l.Mage.Frost={PotionofSpectralIntellect=l(171273),ShadowedOrbofTorment=l(186428),TomeofMonstruousConstructions=l(186422)}p.IFST={CurrStacks=0,CurrStacksTime=0,OldStacks=0,OldStacksTime=0,Direction=0}local q={}q.IncantersFlowBuff=j(116267)d:RegisterForEvent(function()p.IFST.CurrStacks=0;p.IFST.CurrStacksTime=0;p.IFST.OldStacks=0;p.IFST.OldStacksTime=0;p.IFST.Direction=0 end,"PLAYER_REGEN_ENABLED")function p.IFTracker()if d.CombatTime()==0 then return end;local r=p.IFST.CurrStacksTime-p.IFST.OldStacksTime;local s=p.IFST.CurrStacks;local t=p.IFST.CurrStacksTime;local u=p.IFST.OldStacks;if g:BuffUp(q.IncantersFlowBuff)then if g:BuffStack(q.IncantersFlowBuff)~=s or g:BuffStack(q.IncantersFlowBuff)==s and r>1 then p.IFST.OldStacks=s;p.IFST.OldStacksTime=t end;p.IFST.CurrStacks=g:BuffStack(q.IncantersFlowBuff)p.IFST.CurrStacksTime=d.CombatTime()if p.IFST.CurrStacks>p.IFST.OldStacks then if p.IFST.CurrStacks==5 then p.IFST.Direction=0 else p.IFST.Direction=1 end elseif p.IFST.CurrStacks<p.IFST.OldStacks then if p.IFST.CurrStacks==1 then p.IFST.Direction=0 else p.IFST.Direction=-1 end else if p.IFST.CurrStacks==1 then p.IFST.Direction=1 else p.IFST.Direction=-1 end end else p.IFST.OldStacks=0;p.IFST.OldStacksTime=0;p.IFST.CurrStacks=0;p.IFST.CurrStacksTime=0;p.IFST.Direction=0 end end;function p.IFTimeToX(v,w)local x;local y;local z;if p.IFST.Direction==-1 or p.IFST.Direction==0 and p.IFST.CurrStacks==0 then z=10-p.IFST.CurrStacks+1 else z=p.IFST.CurrStacks end;if w=="up"then x=v;y=v elseif w=="down"then x=10-v+1;y=10-v+1 else x=v;y=10-v+1 end;if x==z or y==z then return 0 end;local A=(10+x-z)%10;local B=(10+y-z)%10;return p.IFST.CurrStacksTime-p.IFST.OldStacksTime+math.min(A,B)-1 end;p.DC={Arcane=0,ArcaneTime=0,Fire=0,FireTime=0,Frost=0,FrostTime=0}function p.DCCheck()local C=GetTime()local D=e.Persistent.Player.Spec[1]local q;if D==62 then q=j.Mage.Arcane elseif D==63 then q=j.Mage.Fire elseif D==64 then q=j.Mage.Frost end;local E=p.DC;local F=30-q.DisciplinaryCommandBuff:TimeSinceLastAppliedOnPlayer()if g:BuffDown(q.DisciplinaryCommandBuff)and F<=0 then if E.Arcane==0 then if g:PrevOffGCD(1,q.Counterspell)or g:PrevGCD(1,q.ArcaneExplosion)or g:PrevGCD(1,q.RuneofPower)or g:PrevOffGCD(1,j(212653))or g:PrevOffGCD(1,j(1953))or g:PrevGCD(1,q.ArcaneIntellect)or g:PrevGCD(1,q.AlterTime)or g:PrevGCD(1,q.SpellSteal)or g:PrevGCD(1,q.RemoveCurse)or g:PrevGCD(1,q.MirrorImage)or g:PrevGCD(1,q.Invisibility)or g:PrevGCD(1,q.SlowFall)or g:PrevGCD(1,q.FocusMagic)or g:PrevOffGCD(1,q.TimeWarp)or q.RuneofPower:IsAvailable()and(D==64 and g:PrevOffGCD(1,q.IcyVeins)or D==63 and g:PrevOffGCD(1,q.Combustion)or D==62 and g:PrevOffGCD(1,q.ArcanePower))or D==62 and(g:PrevGCD(1,q.ArcaneBarrage)or g:PrevGCD(1,q.ArcaneBlast)or g:PrevGCD(1,q.ArcaneMissiles)or g:PrevGCD(1,q.ArcaneOrb)or g:PrevOffGCD(1,q.ArcanePower)or g:PrevGCD(1,q.Evocation)or g:PrevGCD(1,q.PresenceofMind)or g:PrevGCD(1,q.GreaterInvisibility)or g:PrevGCD(1,q.PrismaticBarrier)or g:PrevGCD(1,q.TouchoftheMagi)or g:PrevGCD(1,q.ArcaneFamiliar)or g:PrevGCD(1,q.NetherTempest)or g:PrevGCD(1,q.Supernova))then E.Arcane=1;E.ArcaneTime=C end end;if E.Fire==0 then if g:PrevGCD(1,q.FireBlast)or D==63 and(g:PrevOffGCD(1,q.FireBlast)or g:PrevGCD(1,q.Fireball)or g:PrevGCD(1,q.Scorch)or g:PrevGCD(1,q.Pyroblast)or g:PrevGCD(1,q.Flamestrike)or g:PrevGCD(1,q.BlazingBarrier)or g:PrevOffGCD(1,q.Combustion)or g:PrevGCD(1,q.DragonsBreath)or g:PrevGCD(1,q.PhoenixFlames)or g:PrevGCD(1,q.BlastWave)or g:PrevGCD(1,q.LivingBomb)or g:PrevGCD(1,q.Meteor))then E.Fire=1;E.FireTime=C end end;if E.Frost==0 then if g:PrevGCD(1,q.Frostbolt)or g:PrevGCD(1,q.FrostNova)or g:PrevGCD(1,q.IceBlock)or g:PrevGCD(1,q.RingOfFrost)or D==64 and(g:PrevGCD(1,q.IceLance)or g:PrevGCD(1,q.Flurry)or g:PrevGCD(1,q.Blizzard)or g:PrevGCD(1,q.ConeofCold)or g:PrevGCD(1,q.FrozenOrb)or g:PrevGCD(1,q.IceBarrier)or g:PrevOffGCD(1,q.IcyVeins)or g:PrevGCD(1,q.RayofFrost)or g:PrevGCD(1,q.GlacialSpike)or g:PrevGCD(1,q.CometStorm)or g:PrevGCD(1,q.Ebonbolt)or g:PrevOffGCD(1,q.IceFloes)or g:PrevOffGCD(1,q.IceNova)or g:PrevOffGCD(1,q.SummonWaterElemental))then E.Frost=1;E.FrostTime=C end end end;if g:BuffUp(q.DisciplinaryCommandBuff)and(E.Arcane==1 or E.Fire==1 or E.Frost==1)then E.Arcane=0;E.Fire=0;E.Frost=0 end;if E.Arcane==1 and E.ArcaneTime<C-10 then E.Arcane=0 end;if E.Fire==1 and E.FireTime<C-10 then E.Fire=0 end;if E.Frost==1 and E.FrostTime<C-10 then E.Frost=0 end end