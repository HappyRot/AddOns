local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=f.Pet;local j=d.Spell;local k=d.Item;local l=HeroRotation;local m=l.AoEON;local n=l.CDsON;local o=l.Cast;local p=l.CastSuggested;local q=l.CastAnnotated;local r=l.Commons.Everyone.num;local s=l.Commons.Everyone.bool;local t=l.Commons.DemonHunter;local GetTime=GetTime;local u=math.max;local v=math.min;local w=table.insert;local x=j.DemonHunter.Vengeance;local y=k.DemonHunter.Vengeance;local z={}local A=l.Commons.Everyone;local B={General=l.GUISettings.General,Commons=l.GUISettings.APL.DemonHunter.Commons,Vengeance=l.GUISettings.APL.DemonHunter.Vengeance}local C,D,E;local F=x.SoulSigils:IsAvailable()and 4 or 3;local G,H;local I;local J;local K;local L;local M;local N,O,P,Q,R,S;local T=11111;local U=11111;local V,W;local X=0;local Y=0;local Z=not HeroRotationCharDB.Toggles[167]local _=not HeroRotationCharDB.Toggles[168]local a0=not HeroRotationCharDB.Toggles[169]local a1=HeroRotationCharDB.Toggles[72]d:RegisterForEvent(function()T=11111;U=11111 end,"PLAYER_REGEN_ENABLED")d:RegisterForEvent(function()F=x.SoulSigils:IsAvailable()and 4 or 3 end,"SPELLS_CHANGED","LEARNED_SPELL_IN_TAB")local function a2()if x.Felblade:TimeSinceLastCast()<g:GCD()or x.InfernalStrike:TimeSinceLastCast()<g:GCD()then G=true;H=true;return end;G=h:IsInMeleeRange(5)H=G or M>0 end;local function a3(a4)return a4:DebuffRemains(x.FieryBrandDebuff)end;local function a5(a4)return a4:DebuffUp(x.FieryBrandDebuff)end;local function a6(a7)local a8=0;if a7~=nil then for a9,aa in pairs(a7)do if not g:IsTanking(aa)and aa:GUID()~=h:GUID()and aa:AffectingCombat()then a8=a8+1 end end end;return a8 end;local function ab(a4)if not g:IsTanking(a4)and a1 and a4:AffectingCombat()and a4:GUID()==f("mouseover"):GUID()and a4:NPCID()~=118044 then MOshouldcast=1185245;return true elseif not g:IsTanking(a4)and a1 and a4:AffectingCombat()and a4:GUID()==h:GUID()and a4:NPCID()~=118044 then Y=185245;return true elseif not g:IsTanking(a4)and a1 and a4:AffectingCombat()and a4:NPCID()~=118044 then return true end end;local function ac()MOshouldcast=999 end;local function ad()if x.SigilofFlame:IsCastable()then if o(x.SigilofFlame,nil,nil,not h:IsInRange(30))then Y=389810;return"sigil_of_flame precombat 2"end end;if x.Felblade:IsCastable()and not G then if o(x.Felblade,nil,nil,not h:IsInRange(15))then Y=232893;return"felblade precombat 5"end end;if x.ImmolationAura:IsCastable()then if o(x.ImmolationAura)then Y=258920;return"immolation_aura precombat 4"end end;if x.Fracture:IsCastable()and G then if o(x.Fracture)then Y=263642;return"fracture precombat 8"end end;if x.Shear:IsCastable()and G then if o(x.Shear)then Y=203782;return"shear precombat 10"end end end;local function ae()if x.DemonSpikes:IsCastable()and g:BuffDown(x.DemonSpikesBuff)and g:BuffDown(x.MetamorphosisBuff)and(M==1 and g:BuffDown(x.FieryBrandDebuff)or M>1)then if x.DemonSpikes:ChargesFractional()>1.9 then if o(x.DemonSpikes,nil,nil)then Y=203720;return"demon_spikes defensives (Capped)"end elseif I or g:HealthPercentage()<=B.Vengeance.DemonSpikesHealthThreshold then if o(x.DemonSpikes,nil,nil)then Y=203720;return"demon_spikes defensives (Danger)"end end end;if x.Metamorphosis:IsCastable()and g:HealthPercentage()<=B.Vengeance.MetamorphosisHealthThreshold and(g:BuffDown(x.MetamorphosisBuff)or h:TimeToDie()<15)then if o(x.Metamorphosis,nil,nil)then Y=187827;return"metamorphosis defensives"end end;if x.FieryBrand:IsCastable()and(I or g:HealthPercentage()<=B.Vengeance.FieryBrandHealthThreshold)then if o(x.FieryBrand,nil,nil,not h:IsSpellInRange(x.FieryBrand))then Y=204021;return"fiery_brand defensives"end end end;local function af()if x.FieryBrand:IsCastable()and(x.FieryBrandDebuff:AuraActiveCount()==0 and(x.SigilofFlame:CooldownRemains()<=x.FieryBrand:ExecuteTime()+g:GCDRemains()or x.SoulCarver:CooldownRemains()<x.FieryBrand:ExecuteTime()+g:GCDRemains()or x.FelDevastation:CooldownRemains()<x.FieryBrand:ExecuteTime()+g:GCDRemains())or x.DowninFlames:IsAvailable()and x.FieryBrand:FullRechargeTime()<x.FieryBrand:ExecuteTime()+g:GCDRemains())then if o(x.FieryBrand,nil,nil,not h:IsSpellInRange(x.FieryBrand))then Y=204021;return"fiery_brand maintenance 2"end end;if x.SigilofFlame:IsCastable()and(x.AscendingFlame:IsAvailable()or x.SigilofFlameDebuff:AuraActiveCount()==0)then if o(x.SigilofFlame,nil,nil,not h:IsInRange(30))then Y=389810;return"sigil_of_flame maintenance 4"end end;if x.ImmolationAura:IsCastable()then if o(x.ImmolationAura)then Y=258920;return"immolation_aura maintenance 6"end end;if x.BulkExtraction:IsCastable()and(5-C<=M and C<=2)then if o(x.BulkExtraction,nil,nil,not h:IsInMeleeRange(8))then Y=320341;return"bulk_extraction maintenance 8"end end;if VarNoMaintCleave and not S then if q(x.Pool,false,"WAIT")then return"Wait for Spirit Bomb"end end;if x.SpiritBomb:IsReady()and S then if o(x.SpiritBomb,nil,nil,not h:IsInMeleeRange(8))then Y=247454;return"spirit_bomb maintenance 10"end end;if x.Felblade:IsReady()and(g:FuryDeficit()>=40 and M==1 or x.FelDevastation:CooldownRemains()<=x.Felblade:ExecuteTime()+g:GCDRemains()and g:Fury()<50)then if o(x.Felblade,nil,nil,not h:IsSpellInRange(x.Felblade))then Y=232893;return"felblade maintenance 12"end end;if x.Fracture:IsCastable()and(x.FelDevastation:CooldownRemains()<=x.Fracture:ExecuteTime()+g:GCDRemains()and g:Fury()<50)then if o(x.Fracture,nil,nil,not G)then Y=263642;return"fracture maintenance 14"end end;if x.Shear:IsCastable()and(x.FelDevastation:CooldownRemains()<=x.Fracture:ExecuteTime()+g:GCDRemains()and g:Fury()<50)then if o(x.Shear,nil,nil,not G)then Y=203782;return"shear maintenance 16"end end;if g:FuryDeficit()<=30 and M>1 and D>=4 and C<4 then if q(x.Pool,false,"WAIT")then return"Wait for Spirit Bomb"end end;if x.SpiritBomb:IsReady()and(g:FuryDeficit()<=30 and M>1 and C>=4)then if o(x.SpiritBomb,nil,nil,not h:IsInMeleeRange(8))then Y=247454;return"spirit_bomb maintenance 18"end end;if x.SoulCleave:IsReady()and not VarNoMaintCleave and g:FuryDeficit()<=40 then if o(x.SoulCleave,nil,nil,not G)then Y=228477;return"soul_cleave maintenance 20"end end end;local function ag()if x.ImmolationAura:IsCastable()then if o(x.ImmolationAura)then Y=258920;return"immolation_aura fiery_demise 2"end end;if x.SigilofFlame:IsCastable()then if o(x.SigilofFlame,nil,nil,not h:IsInRange(30))then Y=389810;return"sigil_of_flame fiery_demise 4"end end;if x.Felblade:IsReady()and(x.FelDevastation:CooldownRemains()<=x.Felblade:ExecuteTime()+g:GCDRemains()and g:Fury()<50)then if o(x.Felblade,nil,nil,not h:IsSpellInRange(x.Felblade))then Y=232893;return"felblade fiery_demise 6"end end;if x.FelDevastation:IsReady()then if o(x.FelDevastation,nil,nil,not h:IsInMeleeRange(20))then Y=212084;return"fel_devastation fiery_demise 8"end end;if x.SoulCarver:IsCastable()and D<3 then if o(x.SoulCarver,nil,nil,not G)then Y=214743;return"soul_carver fiery_demise 10"end end;if x.TheHunt:IsCastable()then if o(x.TheHunt,nil,nil,not h:IsInRange(50))then Y=323639;return"the_hunt fiery_demise 12"end end;if x.ElysianDecree:IsCastable()and x.ElysianDecree:TimeSinceLastCast()>=1.85 and g:Fury()>=40 then if o(x.ElysianDecree,nil,nil,not h:IsInRange(30))then Y=389815;return"elysian_decree fiery_demise 14"end end;if VarNoMaintCleave and not S then if q(x.Pool,false,"WAIT")then return"Wait for Spirit Bomb"end end;if x.SpiritBomb:IsReady()and S then if o(x.SpiritBomb,nil,nil,not h:IsInMeleeRange(8))then Y=247454;return"spirit_bomb fiery_demise 16"end end end;local function ah()if x.SigilofChains:IsCastable()and x.CycleofBinding:IsAvailable()then if o(x.SigilofChains,nil,nil,not h:IsInRange(30))then return"sigil_of_chains filler 2"end end;if x.SigilofMisery:IsCastable()and x.CycleofBinding:IsAvailable()then if o(x.SigilofMisery,nil,nil,not h:IsInRange(30))then return"sigil_of_misery filler 4"end end;if x.SigilofSilence:IsCastable()and x.CycleofBinding:IsAvailable()then if o(x.SigilofSilence,nil,nil,not h:IsInRange(30))then return"sigil_of_silence filler 6"end end;if x.Felblade:IsReady()then if o(x.Felblade,nil,nil,not h:IsSpellInRange(x.Felblade))then Y=232893;return"felblade filler 8"end end;if x.ThrowGlaive:IsCastable()then if o(x.ThrowGlaive,nil,nil,not h:IsSpellInRange(x.ThrowGlaive))then Y=204157;return"throw_glaive filler 10"end end end;local function ai()if x.TheHunt:IsCastable()then if o(x.TheHunt,nil,nil,not h:IsInRange(50))then Y=323639;return"the_hunt single_target 2"end end;if x.SoulCarver:IsCastable()then if o(x.SoulCarver,nil,nil,not G)then Y=214743;return"soul_carver single_target 4"end end;if x.FelDevastation:IsReady()and(x.CollectiveAnguish:IsAvailable()or x.StoketheFlames:IsAvailable()and x.BurningBlood:IsAvailable())then if o(x.FelDevastation,nil,nil,not h:IsInMeleeRange(20))then Y=212084;return"fel_devastation single_target 6"end end;if x.ElysianDecree:IsCastable()then if o(x.ElysianDecree,nil,nil,not h:IsInRange(30))then Y=389815;return"elysian_decree single_target 8"end end;if x.FelDevastation:IsReady()then if o(x.FelDevastation,nil,nil,not h:IsInMeleeRange(20))then Y=212084;return"fel_devastation single_target 10"end end;if x.SoulCleave:IsReady()and not N then if o(x.SoulCleave,nil,nil,not G)then Y=228477;return"soul_cleave single_target 12"end end;if x.Fracture:IsCastable()then if o(x.Fracture,nil,nil,not G)then Y=263642;return"fracture single_target 14"end end;if x.Shear:IsCastable()then if o(x.Shear,nil,nil,not G)then Y=203782;return"shear single_target 16"end end;local aj=ah()if aj then return aj end end;local function ak()if x.TheHunt:IsCastable()then if o(x.TheHunt,nil,nil,not h:IsInRange(50))then Y=323639;return"the_hunt small_aoe 2"end end;if x.FelDevastation:IsReady()and(x.CollectiveAnguish:IsAvailable()or x.StoketheFlames:IsAvailable()and x.BurningBlood:IsAvailable())then if o(x.FelDevastation,nil,nil,not h:IsInMeleeRange(20))then Y=212084;return"fel_devastation small_aoe 4"end end;if x.ElysianDecree:IsCastable()and x.ElysianDecree:TimeSinceLastCast()>=1.85 and(g:Fury()>=40 and(D<=1 or D>=4))then if o(x.ElysianDecree,nil,nil,not h:IsInRange(30))then Y=389815;return"elysian_decree small_aoe 6"end end;if x.FelDevastation:IsReady()then if o(x.FelDevastation,nil,nil,not h:IsInMeleeRange(20))then Y=212084;return"fel_devastation small_aoe 8"end end;if x.SoulCarver:IsCastable()and D<3 then if o(x.SoulCarver,nil,nil,not G)then Y=214743;return"soul_carver small_aoe 10"end end;if x.SoulCleave:IsReady()and(C<=1 and not N)then if o(x.SoulCleave,nil,nil,not G)then Y=228477;return"soul_cleave small_aoe 14"end end;if x.Fracture:IsCastable()then if o(x.Fracture,nil,nil,not G)then Y=263642;return"fracture small_aoe 16"end end;if x.Shear:IsCastable()then if o(x.Shear,nil,nil,not G)then Y=203782;return"shear small_aoe 18"end end;local aj=ah()if aj then return aj end end;local function al()if x.FelDevastation:IsReady()and(x.CollectiveAnguish:IsAvailable()or x.StoketheFlames:IsAvailable())then if o(x.FelDevastation,nil,nil,not h:IsInMeleeRange(20))then Y=212084;return"fel_devastation big_aoe 2"end end;if x.TheHunt:IsCastable()then if o(x.TheHunt,nil,nil,not h:IsInRange(50))then Y=323639;return"the_hunt big_aoe 4"end end;if x.ElysianDecree:IsCastable()and x.ElysianDecree:TimeSinceLastCast()>=1.85 and(g:Fury()>=40 and(D<=1 or D>=4))then if o(x.ElysianDecree,nil,nil,not h:IsInRange(30))then Y=389815;return"elysian_decree big_aoe 6"end end;if x.FelDevastation:IsReady()then if o(x.FelDevastation,nil,nil,not h:IsInMeleeRange(20))then Y=212084;return"fel_devastation big_aoe 8"end end;if x.SoulCarver:IsCastable()and D<3 then if o(x.SoulCarver,nil,nil,not G)then Y=214743;return"soul_carver big_aoe 10"end end;if D>=4 and C<4 then if q(x.Pool,false,"WAIT")then return"Wait for Spirit Bomb"end end;if x.SpiritBomb:IsReady()and C>=4 then if o(x.SpiritBomb,nil,nil,not h:IsInMeleeRange(8))then Y=247454;return"spirit_bomb big_aoe 12"end end;if x.Fracture:IsCastable()then if o(x.Fracture,nil,nil,not G)then Y=263642;return"fracture big_aoe 14"end end;if x.Shear:IsCastable()then if o(x.Shear,nil,nil,not G)then Y=203782;return"shear big_aoe 16"end end;if x.SoulCleave:IsReady()and not N then if o(x.SoulCleave,nil,nil,not G)then Y=228477;return"soul_cleave big_aoe 18"end end;local aj=ah()if aj then return aj end end;local function am()end;local function an()Z=not HeroRotationCharDB.Toggles[167]_=not HeroRotationCharDB.Toggles[168]a0=not HeroRotationCharDB.Toggles[169]end;local function ao()if not W then MOshouldcast=0;Y=0 end;if MOshouldcast>0 then MOshouldcast=0 end;if Y>0 then Y=0 end;L=g:GetEnemiesInRange(40,x.DarkCommand)K=g:GetEnemiesInMeleeRange(8)if m()then M=#K>0 and#K or 1 else M=1 end;if g:IsChanneling(x.FelDevestation)then if l.CastAnnotated(x.Pool,false,"WAIT")then Y=99999;return"Pool During FelDevestation"end end;an()if A.TargetIsValid()or g:AffectingCombat()then T=d.BossFightRemains()U=T;if U==11111 then U=d.FightRemains(K,false)end;C=t.Souls.AuraSouls;E=t.Souls.IncomingSouls;D=C+E;a2()I=g:ActiveMitigationNeeded()J=g:IsTankingAoE(8)or g:IsTanking(h)end;if A.TargetIsValid()then if not g:AffectingCombat()then local aj=ad()if aj then return aj end end;O=x.FieryBrand:IsAvailable()and x.FieryDemise:IsAvailable()and x.FieryBrandDebuff:AuraActiveCount()>0;P=M==1;Q=M>=2 and M<=5;R=M>=6;N=x.FelDevastation:CooldownRemains()<=x.SoulCleave:ExecuteTime()+g:GCDRemains()and g:Fury()<80 or(E>1 or D>=5)and not P;if O then S=P and C>=5 or Q and C>=4 or R and C>=3 else S=Q and C>=5 or R and C>=4 end;if O then VarNoMaintCleave=P and D>=5 or Q and D>=4 or R and D>=3 else VarNoMaintCleave=Q and D>=5 or R and D>=4 end;local aj=A.Interrupt(10,x.Disrupt,B.Commons.OffGCDasOffGCD.Disrupt,false)if aj then return aj end;if J then local aj=ae()if aj then return aj end end;V=a6(EnemiesMeleeCount)if A.TargetIsValid()then if x.Torment:IsReady()and g:AffectingCombat()and(not g:IsTanking(h)and a1)then if A.CastCycle(x.Torment,L,ab,not h:IsSpellInRange(x.Torment))then return"Torment 4"end end end;if x.Metamorphosis:IsCastable()and g:BuffDown(x.MetamorphosisBuff)then if o(x.Metamorphosis,nil,nil)then Y=187827;return"metamorphosis main 4"end end;if B.Commons.Enabled.Potions then local ap=A.PotionSelected()if ap then if ap:IsReady()and n()and UsePots and(g:BloodlustUp()and l.GUISettings.General.HoldPotforBL or not l.GUISettings.General.HoldPotforBL)then if o(ap,nil)then Y=50;return"potion cooldowns 6"end end end end;if B.Commons.Enabled.Trinkets then local aq=g:GetUseableTrinkets(z,13)if aq then if o(aq,nil,nil)then Y=30;return"trinket1 main 10"end end;local ar=g:GetUseableTrinkets(z,14)if ar then if o(ar,nil,nil)then Y=40;return"trinket2 main 12"end end end;if x.FieryBrand:IsAvailable()and x.FieryDemise:IsAvailable()and x.FieryBrandDebuff:AuraActiveCount()>0 then local aj=ag()if aj then return aj end end;local aj=af()if aj then return aj end;if P then local aj=ai()if aj then return aj end;if q(x.Pool,false,"WAIT")then return"Wait for SingleTarget()"end end;if Q then local aj=ak()if aj then return aj end;if q(x.Pool,false,"WAIT")then return"Wait for SmallAoE()"end end;if R then local aj=al()if aj then return aj end;if q(x.Pool,false,"WAIT")then return"Wait for BigAoE()"end end;if q(x.Pool,false,"WAIT")then return"Wait/Pool Resources"end end end;function ReturnSpellVen()if Y==0 then return 0 else return Y end end;function ReturnSpellVenMO()if MOshouldcast==0 then return 0 else return MOshouldcast end end;local function as()x.FieryBrandDebuff:RegisterAuraTracking()x.SigilofFlameDebuff:RegisterAuraTracking()l.Print("Vengeance Demon Hunter rotation has been updated for patch 10.2.0.")end;l.SetAPL(581,ao,as)