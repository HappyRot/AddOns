local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=d.Spell;local j=d.MultiSpell;local k=d.Item;local l=d.Utils.BoolToInt;local m=HeroRotation;local n=m.AoEON;local o=m.CDsON;local p=HeroRotationCharDB.Toggles[4]local q=HeroRotationCharDB.Toggles[5]local r=HeroRotationCharDB.Toggles[6]local s=HeroRotationCharDB.Toggles[12]local t=HeroRotationCharDB.Toggles[15]local u=HeroRotationCharDB.Toggles[20]local v=HeroRotationCharDB.Toggles[21]local w=HeroRotationCharDB.Toggles[22]local x=HeroRotationCharDB.Toggles[23]local y=HeroRotationCharDB.Toggles[24]local z=HeroRotationCharDB.Toggles[25]local A=HeroRotationCharDB.Toggles[26]local B=HeroRotationCharDB.Toggles[27]local C=HeroRotationCharDB.Toggles[28]local D=HeroRotationCharDB.Toggles[29]local E=HeroRotationCharDB.Toggles[30]local F=HeroRotationCharDB.Toggles[54]local G={228318,178658,333227,334800,334967,324737,326450,334470,326450,320703,320012,324085,333241,331510}local H=nil;local I=nil;local J=false;local K=false;local L=false;local M=false;local N=false;local O=true;local P=0;local Q=0;local R=GetInventoryItemID("player",13)local S=GetInventoryItemID("player",14)local pairs=pairs;local T=table.insert;local U=math.min;local V=math.max;local W=math.abs;local X=m.Commons.Everyone;local Y=m.Commons.Rogue;local Z=i.Rogue.Subtlety;local _=k.Rogue.Subtlety;local a0={_.MistcallerOcarina:ID(),_.CacheOfAcquiredTreasures:ID()}local a1,a2,a3,a4;local a5;local a6=Y.ReturnSpell()local a7=Y.ReturnSpellMO()local a8,a9,aa;local ab,ac;local ad,ae;local af,ag,ah;local ai;local aj=g:HasLegendaryEquipped(129)local ak=g:HasLegendaryEquipped(116)local al=g:HasLegendaryEquipped(127)local am=g:HasLegendaryEquipped(117)local an=g:HasLegendaryEquipped(126)local ao=g:HasLegendaryEquipped(229)or g:HasUnity()and Z.Flagellation:IsAvailable()local ap=g:HasLegendaryEquipped(231)or g:HasUnity()and Z.EchoingReprimand:IsAvailable()local aq=g:HasTier(28,2)d:RegisterForEvent(function()aj=g:HasLegendaryEquipped(129)ak=g:HasLegendaryEquipped(116)al=g:HasLegendaryEquipped(127)am=g:HasLegendaryEquipped(117)an=g:HasLegendaryEquipped(126)ao=g:HasLegendaryEquipped(229)or g:HasUnity()and Z.Flagellation:IsAvailable()ap=g:HasLegendaryEquipped(231)or g:HasUnity()and Z.EchoingReprimand:IsAvailable()aq=g:HasTier(28,2)end,"PLAYER_EQUIPMENT_CHANGED")local function ar(self,as,at,au,av)if at==UnitGUID("player")then local aw,ax,ay,az,aA,aB,aC,aD,aE,aF,aG,av,aH,aI,aJ,aK,aL,aM,aN,aO,aP,aQ,aR,aS=CombatLogGetCurrentEventInfo()if ax=="SWING_DAMAGE"and aw>Q then Q=aw;P=P+1 elseif ax=="SPELL_ENERGIZE"and az==UnitGUID("player")and av==196911 then Q=aw;P=0 end end end;local aT=CreateFrame("Frame")aT:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED")aT:SetScript("OnEvent",ar)Z.Eviscerate:RegisterDamageFormula(function()return g:AttackPowerDamageMod()*af*0.176*1.21*(Z.Nightstalker:IsAvailable()and g:StealthUp(true,false)and 1.12 or 1)*(Z.DeeperStratagem:IsAvailable()and 1.05 or 1)*(Z.DarkShadow:IsAvailable()and g:BuffUp(Z.ShadowDanceBuff)and 1.3 or 1)*(not Z.DarkShadow:IsAvailable()and g:BuffUp(Z.ShadowDanceBuff)and 1.15 or 1)*(g:BuffUp(Z.SymbolsofDeath)and 1.15 or 1)*(g:BuffUp(Z.FinalityEviscerate)and 1.25 or 1)*(1+g:MasteryPct()/100)*(1+g:VersatilityDmgPct()/100)*(h:DebuffUp(Z.FindWeaknessDebuff)and 1.5 or 1)*(h:DebuffUp(Z.SinfulRevelationDebuff)and 1.06 or 1)end)Z.Rupture:RegisterPMultiplier(function()return Z.Nightstalker:IsAvailable()and g:StealthUp(true,false)and 1.12 or 1 end)local aU={General=m.GUISettings.General,Commons=m.GUISettings.APL.Rogue.Commons,Subtlety=m.GUISettings.APL.Rogue.Subtlety}local function aV(aW,EnergyThreshold)if not a8 then a8=aW;a9=EnergyThreshold or 0 end end;local function aX(aW)if not aa then aa=aW end end;local function aY()if aU.Subtlety.BurnShadowDance=="On Bosses not in Dungeons"and g:IsInDungeonArea()then return false elseif aU.Subtlety.BurnShadowDance~="Always"and not h:IsInBossList()then return false else return true end end;local function aZ(ag)af=ag;if ag==2 and g:BuffUp(Z.EchoingReprimand2)or ag==3 and g:BuffUp(Z.EchoingReprimand3)or ag==4 and g:BuffUp(Z.EchoingReprimand4)or ag==5 and g:BuffUp(Z.EchoingReprimand5)then af=7;return 7 else af=ag;return ag end;local a_,b0=UnitAttackSpeed("unit")local b1=(a_+b0)/2;local b2=b1/2;local b3=(4-P)*b2;local b4=(5-P)*b2;if af>ag and ah>2 and g:AffectingCombat()then if ag==2 and not g:BuffUp(Z.EchoingReprimand3)or ag==3 and not g:BuffUp(Z.EchoingReprimand4)or ag==4 and not g:BuffUp(Z.EchoingReprimand5)then local b5=b3;if b5==0 then b5=b4 end;if b5<V(g:EnergyTimeToX(35),g:GCDRemains())+0.5 then af=ag end end end end;local function b6()if a3<2 then return false elseif aU.Commons.UsePriorityRotation=="Always"then return true elseif aU.Commons.UsePriorityRotation=="On Bosses"and h:IsInBossList()then return true elseif aU.Commons.UsePriorityRotation=="Auto"then if g:InstanceDifficulty()==16 and h:NPCID()==138967 then return true elseif h:NPCID()==166969 or h:NPCID()==166971 or h:NPCID()==166970 then return true end end;return false end;local function b7(b8,b9,ba,bb)local bc,bd=nil,ba;local be=h:GUID()for bf,bg in pairs(bb)do if bg:GUID()~=be and X.UnitIsCycleValid(bg,bd,-bg:DebuffRemains(b8))and b9(bg)then bc,bd=bg,bg:TimeToDie()end end;if bc then m.CastLeftNameplate(bc,b8)if bc:GUID()==f("mouseover"):GUID()and aU.Subtlety.TargetSwap=="Mouseover"then if b8==Z.Rupture then a7=11943 elseif b8==Z.SerratedBoneSpike then a7=1328547 end elseif aU.Subtlety.TargetSwap=="AutoSwap"and bc:GUID()~=h:GUID()and not s then a7=9999 end elseif false then bc,bd=nil,ba;for bf,bg in pairs(a2)do if bg:GUID()~=be and X.UnitIsCycleValid(bg,bd,-bg:DebuffRemains(b8))and b9(bg)then bc,bd=bg,bg:TimeToDie()end end;if bc then m.CastLeftNameplate(bc,b8)if bc:GUID()==f("mouseover"):GUID()and aU.Subtlety.TargetSwap=="Mouseover"then if b8==Z.Rupture then a7=11943 elseif b8==Z.SerratedBoneSpike then a7=1328547 end elseif aU.Subtlety.TargetSwap=="AutoSwap"and bc:GUID()~=h:GUID()and not s then a7=9999 end end end end;local function bh(bi)if bi then return 1 else return 0 end end;local function bj(bk)return bk:DebuffRemains(Z.FindWeaknessDebuff)end;local function bl(bk)if not ai and bk:DebuffRemains(Z.FindWeaknessDebuff)<1 and a3<=3 and bk:TimeToDie()>6 and bk:IsInRange(8)and bk:GUID()==f("mouseover"):GUID()and aU.Subtlety.TargetSwap=="Mouseover"then a7=1185438;return true elseif not ai and bk:DebuffRemains(Z.FindWeaknessDebuff)<1 and a3<=3 and bk:TimeToDie()>6 and bk:IsInRange(8)and aU.Subtlety.TargetSwap=="AutoSwap"and bk:GUID()~=h:GUID()and not s then a7=9999;return true elseif not ai and bk:DebuffRemains(Z.FindWeaknessDebuff)<1 and a3<=3 and bk:TimeToDie()>6 and bk:IsInRange(8)and bk:GUID()==h:GUID()then a6=185438;return true elseif not ai and bk:DebuffRemains(Z.FindWeaknessDebuff)<1 and a3<=3 and bk:TimeToDie()>6 and bk:IsInRange(8)then return true end end;local function bm()return 25+bh(Z.Vigor:IsAvailable())*20+bh(Z.MasterofShadows:IsAvailable())*20+bh(Z.ShadowFocus:IsAvailable())*25+bh(Z.Alacrity:IsAvailable())*20+bh(a3>=4)*25 end;local function bn()return Z.ShadowDance:ChargesFractional()>=1.75 end;local function bo()if a3==4 then return ah<=1 elseif ai and a3>=4 then return ah<=1 elseif Z.EchoingReprimand:IsAvailable()then return ah>=3 else return ah>=2+bh(g:BuffUp(Z.ShadowBlades))end end;local function bp()return g:BuffUp(Z.SliceandDice)or a3>=6 end;local function bq()return Z.Premeditation:IsAvailable()and a3<5-bh(Z.SerratedBoneSpike:IsAvailable())and not Z.EchoingReprimand:IsAvailable()end;local function br(bs)return Y.MasterAssassinsMarkRemains()>0 or not Z.Nightstalker:IsAvailable()and Z.DarkShadow:IsAvailable()and bs or a3>=4-l(g:StealthUp(true,true)or bs)*l(Z.ShadowFocus:IsAvailable())end;local function bt()local bs=g:BuffUp(Z.ShadowDanceBuff)or StealthSpell and StealthSpell:ID()==Z.ShadowDance:ID()ag=g:ComboPoints()af=aZ(ag)if Z.SliceandDice:IsCastable(BypassRecovery)then if not bq()and a3<6 and not g:BuffUp(Z.ShadowDanceBuff)and d.FilteredFightRemains(a2,">",g:BuffRemains(Z.SliceandDice))and g:BuffRefreshable(Z.SliceandDice)then if Z.SliceandDice:IsReady(BypassRecovery)and m.Cast(Z.SliceandDice)then a6=5171;return"Cast Slice and Dice (not Premed)"end end;if bq()and Z.ShadowDance:ChargesFractional()<1.75 and g:BuffRemains(Z.SliceandDice)<Z.SymbolsofDeath:CooldownRemains()and(Z.ShadowDance:CooldownRemains()<=0 and g:BuffRemains(Z.SymbolsofDeath)-g:BuffRemains(Z.ShadowDanceBuff)<1.2)then if Z.SliceandDice:IsReady(BypassRecovery)and m.Cast(Z.SliceandDice)then a6=5171;return"Cast Slice and Dice (Premed)"end end end;local bu=br(bs)if(not bu or ai)and Z.Rupture:IsCastable()and not(g:StealthUp(true,true)or bs)then if h:IsInMeleeRange(8)and(h:FilteredTimeToDie(">",12,-h:DebuffRemains(Z.Rupture))or h:TimeToDieIsNotValid())and Y.CanDoTUnit(h,ae)and h:DebuffRefreshable(Z.Rupture,ad)then if Z.Rupture:IsReady(BypassRecovery)and m.Cast(Z.Rupture)then a6=1943;return"Cast Rupture 1"end end end;if Z.SecretTechnique:IsReady(BypassRecovery)then if m.Cast(Z.SecretTechnique)then a6=280719;return"Cast Secret Technique"end end;if not bu and Z.Rupture:IsCastable(BypassRecovery)then if not bu and not ai and a3>=2 then local function bv(bk)return X.CanDoTUnit(bk,ae)and bk:DebuffRefreshable(Z.Rupture,ad)end;b7(Z.Rupture,bv,5+2*af,a4)end;if h:IsInMeleeRange(5)and h:DebuffRemains(Z.Rupture)<Z.SymbolsofDeath:CooldownRemains()+10 and(Z.SymbolsofDeath:CooldownRemains()<=5 or not M)and Y.CanDoTUnit(h,ae)and h:FilteredTimeToDie(">",11+Z.SymbolsofDeath:CooldownRemains(),-h:DebuffRemains(Z.Rupture))then if Z.Rupture:IsReady(BypassRecovery)and m.Cast(Z.Rupture)then a6=1943;return"Cast Rupture 2"end end end;if Z.BlackPowder:IsCastable(BypassRecovery)and not ai and a3>=3 and not u then if Z.BlackPowder:IsReady(BypassRecovery)and m.Cast(Z.BlackPowder)then a6=319175;return"Cast Black Powder"end end;if Z.Eviscerate:IsCastable()and h:IsInMeleeRange(8)then if Z.Eviscerate:IsReady(BypassRecovery)and m.Cast(Z.Eviscerate)then a6=196819;return"Cast Eviscerate"end end end;local function bw()local bx=g:BuffUp(ab)or StealthSpell and StealthSpell:ID()==ab:ID()local VanishBuffCheck=g:BuffUp(ac)or StealthSpell and StealthSpell:ID()==Z.Vanish:ID()local bs=g:BuffUp(Z.ShadowDanceBuff)or StealthSpell and StealthSpell:ID()==Z.ShadowDance:ID()local by=Z.Shadowstrike:IsCastable()or bx or VanishBuffCheck or bs;ag=g:ComboPoints()af=aZ(ag)if by and h:IsInMeleeRange(aU.Subtlety.ShadowStrikeRange)and(bx or VanishBuffCheck)and(a3<4 or ai)and Y.MasterAssassinsMarkRemains()==0 then if m.Cast(Z.Shadowstrike,nil,nil)then a6=185438;return"Cast Shadowstrike (Stealth)"end end;if af>=Y.CPMaxSpend()or af>=5 and g:BuffUp(Z.ShurikenTornado)then return bt()end;if g:BuffUp(Z.ShurikenTornado)and ah<=2 then return bt()end;if a3>=4 and af>=4 then return bt()end;if ah<=1-bh(Z.DeeperStratagem:IsAvailable()and VanishBuffCheck)then return bt()end;if by and h:IsInMeleeRange(aU.Subtlety.ShadowStrikeRange)and not g:StealthUp(true,false)and g:BuffUp(Z.SepsisBuff)and a3<4 then if m.Cast(Z.Shadowstrike,nil,nil)then a6=185438;return"Cast Shadowstrike (Sepsis)"end end;if g:BuffStack(Z.PerforatedVeinsBuff)>=5 and g:BuffRemains(Z.ShadowDanceBuff)>=3 and g:BuffUp(Z.ShadowBlades)and a3<=3 then if m.Cast(Z.Backstab)then a6=53;return"Cast Backstab (Stealth PV)"end end;if Z.Shiv:IsReady()and ak and Z.Nightstalker:IsAvailable()and a3<5 then if m.Cast(Z.Shiv)then a6=5938;return"Cast Shiv (TTB NS)"end end;if Z.Shadowstrike:IsCastable()then if not ai and h:DebuffRemains(Z.FindWeaknessDebuff)<1 and a3<=3 and d.BossFilteredFightRemains("<=",5)then if m.Cast(Z.Shadowstrike)then a6=185438;return"Cast Shadowstrike (Prio Rotation)"end end;if X.CastTargetIf(Z.Shadowstrike,MeleeEnemies8y,"min",bj,bl)then return"Find the Weakness/ShadowStrike 26"end end;if by and h:IsInMeleeRange(aU.Subtlety.ShadowStrikeRange)and ai and(h:DebuffRemains(Z.FindWeaknessDebuff)<1 or Z.Weaponmaster:IsAvailable()and a3<=4)then if m.Cast(Z.Shadowstrike)then a6=185438;return"Cast Shadowstrike (Prio Rotation)"end end;if Z.ShurikenStorm:IsCastable()and af<Y.CPMaxSpend()and a3>=3+bh(g:BuffUp(Z.TheRottenBuff)or al or aq)and(g:BuffUp(Z.SymbolsofDeathCrit)or not g:BuffUp(Z.PremeditationBuff)or a3>=5 and af<Y.CPMaxSpend())then if m.Cast(Z.ShurikenStorm)then a6=197835;return"Cast Shuriken Storm"end end;if by and af<Y.CPMaxSpend()and h:IsInMeleeRange(aU.Subtlety.ShadowStrikeRange)and(h:DebuffRemains(Z.FindWeaknessDebuff)<1 or Z.SymbolsofDeath:CooldownRemains()<18 and M and h:DebuffRemains(Z.FindWeaknessDebuff)<Z.SymbolsofDeath:CooldownRemains())then if m.Cast(Z.Shadowstrike)then a6=185438;return"Cast Shadowstrike (FW Refresh)"end end;if by and af<Y.CPMaxSpend()and h:IsInMeleeRange(aU.Subtlety.ShadowStrikeRange)then if m.Cast(Z.Shadowstrike)then a6=185438;return"Cast Shadowstrike 2"end end end;local function bz()local bA=bw(true,StealthSpell)ag=g:ComboPoints()af=aZ(ag)if StealthSpell==Z.Vanish and(not aU.Subtlety.StealthMacro.Vanish or not bA)and aU.Commons.VanishOffensive and L then if m.Cast(Z.Vanish,nil)then a6=1213;return"Cast Vanish"end;return false elseif StealthSpell==Z.Shadowmeld and(not aU.Subtlety.StealthMacro.Shadowmeld or not bA)then if m.Cast(Z.Shadowmeld,nil)then a6=1214;return"Cast Shadowmeld"end;return false elseif StealthSpell==Z.ShadowDance and(not aU.Subtlety.StealthMacro.ShadowDance or not bA)and K then if m.Cast(Z.ShadowDance,nil)then a6=1212;return"Cast Shadow Dance"end;return false end;local bB={StealthSpell,bA}if EnergyThreshold and g:EnergyPredicted()<EnergyThreshold then return false end;if bB[1]==Z.ShadowDance and bB[2]==Z.DeathfromAbove then a5=m.CastQueue(bB[2],bB[1])if a5 then return"| "..bB[1]:Name()end end;return false end;local function bC()ag=g:ComboPoints()af=aZ(ag)if g:BuffUp(Z.ShurikenTornado)then if Z.ShadowDance:IsCastable()and K and not g:BuffUp(Z.ShadowDanceBuff)and g:BuffRemains(Z.ShurikenTornado)<=3.5 then if m.Cast(Z.ShadowDance)then a6=185313;return"Cast Shadow Dance (during Tornado)"end end;if Z.SymbolsofDeath:IsCastable()and M and g:BuffRemains(Z.ShurikenTornado)<=3.5 then if m.Cast(Z.SymbolsofDeath)then a6=212283;return"Cast Symbols of Death(during Tornado)"end end end;local bD=bp()if h:IsInMeleeRange(8)then if p and Z.Flagellation:IsReady()and bD and not g:StealthUp(false,false)and ag>=5 and(a3<=1 and Z.SymbolsofDeath:CooldownUp()and not Z.ShadowFocus:IsAvailable()or g:BuffUp(Z.SymbolsofDeath))then if m.Cast(Z.Flagellation,nil,nil)then a6=323654;return"Cast Flrgrrlation"end end end;if L and Z.Vanish:IsCastable()and not v and aU.Commons.VanishOffensive and(am and ah<=1-bh(Z.DeeperStratagem:IsAvailable()or aj and af<1))and g:BuffUp(Z.SymbolsofDeath)and g:BuffUp(Z.ShadowDanceBuff)and Y.MasterAssassinsMarkRemains()==0 and g:BuffDown(Z.DeathlyShadowsBuff)then if m.Cast(Z.Vanish,nil,nil)then a6=1856;return"Vanish Macro"end end;if Z.ShurikenTornado:IsCastable()and g:Energy()<60 and not Z.ShadowFocus:IsAvailable()and bD and Z.SymbolsofDeath:CooldownUp()and Z.ShadowDance:Charges()>=1 and N and(not ao or h:DebuffUp(Z.Flagellation)or a3>=1+4*bh(not Z.Nightstalker:IsAvailable()and not Z.DarkShadow:IsAvailable()))and af<=2 and(not g:BuffUp(Z.PremeditationBuff)or a3>4)and(not Z.Flagellation:IsAvailable()or Z.Flagellation:IsAvailable()and not Z.Flagellation:CooldownUp())then if m.CastPooling(Z.ShurikenTornado)then a6=1000;return"Pool for Shuriken Tornado"end end;if Z.ShurikenTornado:IsCastable()and N and g:Energy()>=60 and bD and(Z.SymbolsofDeath:CooldownUp()or not M)and Z.ShadowDance:Charges()>=1 and(not ao or h:DebuffUp(Z.Flagellation)or a3>=1+4*bh(not Z.Nightstalker:IsAvailable()and not Z.DarkShadow:IsAvailable()))and ag<=2 and(not g:BuffUp(Z.PremeditationBuff)or a3>4)and(not Z.Flagellation:IsAvailable()or Z.Flagellation:IsAvailable()and not Z.Flagellation:CooldownUp())then if m.Cast(Z.ShurikenTornado)then a6=277925;return"Cast Shuriken Tornado"end end;if Z.SerratedBoneSpike:IsReady()and g:AffectingCombat()and(bD or d.BossFilteredFightRemains("<=",5)and a3<3)and not g:BuffUp(Z.PremeditationBuff)and not g:BuffUp(Z.ShurikenTornado)then local function bE(bk)return not bk:DebuffUp(Z.SerratedBoneSpikeDebuff)end;if(h:IsInRange(30)and g:AffectingCombat()or h:IsInRange(20))and bE(h)and h:FilteredTimeToDie(">",21)then if m.Cast(Z.SerratedBoneSpike,nil,nil)then a6=328547;return"Cast Serrated Bone Spike (ST)"end end;if m.AoEON()then b7(Z.SerratedBoneSpike,bE,21,a1)end end;if h:IsInMeleeRange(8)then if p and Z.Sepsis:IsReady()and bD and ah>=1 and not h:FilteredTimeToDie("<",16)then if m.Cast(Z.Sepsis,nil,nil)then a6=328305;return"Cast Sepsis"end end;if Z.SymbolsofDeath:IsCastable()and bD and M and(not Z.ShurikenTornado:IsAvailable()or Z.ShadowFocus:IsAvailable()or a3>=2 or Z.ShurikenTornado:CooldownRemains()>2 or N)and(not Z.Flagellation:IsAvailable()or(Z.Flagellation:CooldownRemains()>10 or not p)or Z.Flagellation:CooldownUp()and p and af>=5)then if m.Cast(Z.SymbolsofDeath,nil)then a6=212283;return"Cast Symbols of Death"end end end;if Z.MarkedforDeath:IsCastable()then if h:FilteredTimeToDie("<",ah)then if m.Cast(Z.MarkedforDeath,nil)then a6=137619;return"Cast Marked for Death"end end;if not g:StealthUp(true,true)and ah>=Y.CPMaxSpend()then if O then if m.Cast(Z.MarkedforDeath,nil)then a6=137619;return"Cast Marked for Death"end end end;if a3==1 and ah>=Y.CPMaxSpend()then if m.Cast(Z.MarkedforDeath,nil)then a6=137619;return"Cast Marked for Death"end end end;if m.CDsON()or not m.CDsON()then if Z.ShadowBlades:IsCastable()and bD and ah>=2 and J and(g:BuffUp(Z.SymbolsofDeath)or d.BossFilteredFightRemains("<=",20)or not g:BuffUp(Z.ShadowBlades)and aq)then if m.Cast(Z.ShadowBlades,nil)then a6=121471;return"Cast Shadow Blades"end end;if Z.EchoingReprimand:IsReady()and p and h:IsInMeleeRange(5)and not g:StealthUp(true,true)and bD and ah>=2 and(ai or a3<=4 or ap)then if m.Cast(Z.EchoingReprimand,nil,nil)then a6=323547;return"Cast Echoing Reprimand"end end;if Z.ShurikenTornado:IsReady()and N and not D and(Z.ShadowFocus:IsAvailable()or a3>=2)and bD and(g:BuffUp(Z.SymbolsofDeath)or not M)and af<=2 and(not g:BuffUp(Z.PremeditationBuff)or a3>4)then if m.Cast(Z.ShurikenTornado)then a6=277925;return"Cast Shuriken Tornado (SF)"end end;if Z.ShadowDance:IsCastable()and(aY()or K)and not g:BuffUp(Z.ShadowDanceBuff)and d.BossFilteredFightRemains("<=",8+bh(Z.Subterfuge:IsAvailable()))then a5=bz(Z.ShadowDance)if a5 then return"Shadow Dance Macro (Low TTD) "..a5 end end;if _.PotionofSpectralAgility:IsReady()and o()and aU.Commons.Enabled.Potions and t and(g:BloodlustUp()or d.BossFilteredFightRemains("<",30)or g:BuffUp(Z.SymbolsofDeath)and(g:BuffUp(Z.ShadowBlades)or Z.ShadowBlades:CooldownRemains()<=10 and J))then if m.Cast(_.PotionofSpectralAgility,nil)then a6=500;return"potion cooldowns 2"end end;if g:BuffUp(Z.SymbolsofDeath)then if Z.BloodFury:IsCastable()and aU.Commons.Enabled.Racials then if m.Cast(Z.BloodFury,nil)then a6=20572;return"Cast Blood Fury"end end;if Z.Berserking:IsCastable()and aU.Commons.Enabled.Racials then if m.Cast(Z.Berserking,nil)then a6=26297;return"Cast Berserking"end end;if Z.Fireblood:IsCastable()and aU.Commons.Enabled.Racials then if m.Cast(Z.Fireblood,nil)then a6=265221;return"Cast Fireblood"end end;if Z.AncestralCall:IsCastable()and aU.Commons.Enabled.Racials then if m.Cast(Z.AncestralCall,nil)then a6=274738;return"Cast Ancestral Call"end end end;if aU.Commons.Enabled.TopTrinket or aU.Commons.Enabled.BottomTrinket then local bF=g:GetUseableTrinkets(a0)if _.CacheOfAcquiredTreasures:IsEquippedAndReady()then if g:BuffUp(Z.AcquiredAxe)and a3>1 then if _.CacheOfAcquiredTreasures:ID()==R and aU.Commons.Enabled.TopTrinket then a6=24;return"top trinket Cache Axe for AoE"elseif _.CacheOfAcquiredTreasures:ID()==S and aU.Commons.Enabled.BottomTrinket then a6=30;return"bot trinket Cache Axe for AoE"end elseif g:BuffUp(Z.AcquiredWand)and(a3==1 and h:IsInBossList()or d.BossFilteredFightRemains("<",20))then if _.CacheOfAcquiredTreasures:ID()==R and aU.Commons.Enabled.TopTrinket then a6=24;return"top trinket Cache Wand for ST"elseif _.CacheOfAcquiredTreasures:ID()==S and aU.Commons.Enabled.BottomTrinket then a6=30;return"bot trinket Cache Wand for ST"end end end;local bG=g:BuffUp(Z.SymbolsofDeath)or d.BossFilteredFightRemains("<",20)if bG then if bF then if m.Cast(bF,nil,nil)then if bF:ID()==R and aU.Commons.Enabled.TopTrinket then a6=24;return"Generic use_items for "..bF:Name()elseif bF:ID()==S and aU.Commons.Enabled.BottomTrinket then a6=25;return"Generic use_items for "..bF:Name()end end end end end end end;local function bH()ag=g:ComboPoints()af=aZ(ag)if(m.CDsON()or not m.CDsON())and Z.ShadowDance:TimeSinceLastDisplay()>0.3 and Z.Shadowmeld:TimeSinceLastDisplay()>0.3 then if Z.Vanish:IsCastable()and L and not v and aU.Commons.VanishOffensive and(not bn()or not Z.Nightstalker:IsAvailable()and Z.DarkShadow:IsAvailable())and ah>1 and not am then if m.Cast(Z.Vanish,nil,nil)then a6=1856;return"Vanish Stealth CD"end end;if g:Energy()<40 and Z.Shadowmeld:IsCastable()then if m.CastPooling(Z.Shadowmeld,g:EnergyTimeToX(40))then a6=1000;return"Pool for Shadowmeld"end end;if Z.Shadowmeld:IsCastable()and h:IsInMeleeRange(5)and not g:IsMoving()and g:Energy()>=40 and g:EnergyDeficitPredicted()>=10 and not bn()and ah>1 then if m.Cast(Z.Shadowmeld,nil,nil)then a6=58984;return"Shadowmeld Stealth CD"end end end;if h:IsInMeleeRange(5)and Z.ShadowDance:IsCastable()and K and Z.Vanish:TimeSinceLastDisplay()>0.3 and Z.Shadowmeld:TimeSinceLastDisplay()>0.3 then if aq and Covenant=="Kyrian"and(bo()or bn())or(bo()and(g:BuffRemains(Z.SymbolsofDeath)>=1.2 or bn())or g:BuffUp(Z.ChaosBaneBuff)or a3>=4 and Z.SymbolsofDeath:CooldownRemains()>10)and(g:BuffStack(Z.PerforatedVeinsBuff)<4 or a3>3)then if m.Cast(Z.ShadowDance)then a6=185313;return" Shadow Dance Stealth CD"end end;if aY()and(bo()and d.BossFilteredFightRemains("<",Z.SymbolsofDeath:CooldownRemains())or not M or not Z.EnvelopingShadows:IsAvailable())and K then if m.Cast(Z.ShadowDance)then a6=185313;return" Shadow Dance Stealth CD"end end end end;local function bI()ag=g:ComboPoints()af=aZ(ag)local bJ=not EnergyThreshold or g:EnergyPredicted()>=EnergyThreshold;if Z.Shiv:IsCastable()and ak and not Z.Nightstalker:IsAvailable()and a3<5 then if m.Cast(Z.Shiv)then a6=5938;return"Cast Shiv (TTB)"end end;if Z.ShurikenStorm:IsCastable()and a3>=2 and(not Z.SerratedBoneSpike:IsAvailable()or(Z.SerratedBoneSpike:MaxCharges()-Z.SerratedBoneSpike:ChargesFractional()>=0.25 or a3>4)and g:BuffStack(Z.PerforatedVeinsBuff)<=4 or a3>4)then if m.Cast(Z.ShurikenStorm)then a6=197835;return"Cast Shuriken Storm"end end;if Z.SerratedBoneSpike:IsCastable()and g:AffectingCombat()and g:BuffStack(Z.PerforatedVeinsBuff)<=2 and(Z.SerratedBoneSpike:MaxCharges()-Z.SerratedBoneSpike:ChargesFractional()<=0.25 or(Z.LeadbyExample:SoulbindEnabled()and not g:BuffUp(Z.LeadbyExampleBuff)or Z.KevinsOozeling:SoulbindEnabled()and not h:DebuffUp(Z.KevinsWrathDebuff))and not d.BossFightRemainsIsNotValid())then if bJ and m.Cast(Z.SerratedBoneSpike,nil,nil)then a6=328547;return"Cast Serrated Bone Spike (Capping Filler)"end end;if h:IsInMeleeRange(8)then if Covenant=="Kyrian"and g:Energy()<60 and(ag==2 and g:BuffUp(Z.EchoingReprimand3)or ag==3 and g:BuffUp(Z.EchoingReprimand4)or ag==4 and g:BuffUp(Z.EchoingReprimand5))and(Y.TimeToSht(3)<0.5 or Y.TimeToSht(4)<1.0 or Y.TimeToSht(5)<1.0)then if m.Cast(Z.PoolEnergy)then a6=1000;return"ER Generator Pooling"end end;if Z.Gloomblade:IsCastable()then if bJ and m.Cast(Z.Gloomblade)then a6=200758;return"Cast Gloomblade"end elseif Z.Backstab:IsCastable()then if bJ and m.Cast(Z.Backstab)then a6=53;return"Cast Backstab"end end end end;local bK={{Z.Blind,"Cast Blind (Interrupt)",function()return true end},{Z.KidneyShot,"Cast Kidney Shot (Interrupt)",function()return af>0 end},{Z.CheapShot,"Cast Cheap Shot (Interrupt)",function()return g:StealthUp(true,true)end}}local function bL()r=HeroRotationCharDB.Toggles[6]p=HeroRotationCharDB.Toggles[4]q=HeroRotationCharDB.Toggles[5]s=HeroRotationCharDB.Toggles[12]t=HeroRotationCharDB.Toggles[15]u=HeroRotationCharDB.Toggles[20]v=HeroRotationCharDB.Toggles[21]w=HeroRotationCharDB.Toggles[22]x=HeroRotationCharDB.Toggles[23]y=HeroRotationCharDB.Toggles[24]z=HeroRotationCharDB.Toggles[25]A=HeroRotationCharDB.Toggles[26]B=HeroRotationCharDB.Toggles[27]C=HeroRotationCharDB.Toggles[28]D=HeroRotationCharDB.Toggles[29]E=HeroRotationCharDB.Toggles[30]F=HeroRotationCharDB.Toggles[54]J=false;K=false;L=false;M=false;O=true;N=false;if aU.Subtlety.IncludedCooldowns.ShadowBlades and o()or aU.Subtlety.IncludedSmallCooldowns.ShadowBlades and(o()or q)or not aU.Subtlety.IncludedSmallCooldowns.ShadowBlades and not aU.Subtlety.IncludedCooldowns.ShadowBlades then J=true end;if aU.Subtlety.IncludedCooldowns.ShadowDance and o()or aU.Subtlety.IncludedSmallCooldowns.ShadowDance and(o()or q)or not aU.Subtlety.IncludedSmallCooldowns.ShadowDance and not aU.Subtlety.IncludedCooldowns.ShadowDance then K=true end;if aU.Subtlety.IncludedCooldowns.Vanish and o()or aU.Subtlety.IncludedSmallCooldowns.Vanish and(o()or q)or not aU.Subtlety.IncludedSmallCooldowns.Vanish and not aU.Subtlety.IncludedCooldowns.Vanish then L=true end;if aU.Subtlety.IncludedCooldowns.SymbolsofDeath and o()or aU.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and(o()or q)or not aU.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and not aU.Subtlety.IncludedCooldowns.SymbolsofDeath then M=true end;if aU.Subtlety.IncludedCooldowns.ShurikenTornado and o()or aU.Subtlety.IncludedSmallCooldowns.ShurikenTornado and(o()or q)or not aU.Subtlety.IncludedSmallCooldowns.ShurikenTornado and not aU.Subtlety.IncludedCooldowns.ShurikenTornado then N=true end;if aU.Commons.Enabled.TopTrinket then R=GetInventoryItemID("player",13)else R=1 end;if aU.Commons.Enabled.BottomTrinket then S=GetInventoryItemID("player",14)else S=1 end end;local function bM()if Z.Subterfuge:IsAvailable()then ab=Z.Stealth2;ac=Z.VanishBuff2 else ab=Z.Stealth;ac=Z.VanishBuff end;a8=nil;aa=nil;a9=0;if n()then a1=g:GetEnemiesInRange(30)MeleeEnemies8y=g:GetEnemiesInMeleeRange(8)a2=g:GetEnemiesInMeleeRange(10)a3=#a2;a4=g:GetEnemiesInMeleeRange(5)else a1={}a2={}a3=0;a4={}end;ag=g:ComboPoints()af=aZ(ag)ah=g:ComboPointsDeficit()ai=b6()a5=bL()if a5 then return a5 end;if a7>0 then a7=0 end;if a6>0 then a6=0 end;a6=Y.ReturnSpell()a7=Y.ReturnSpellMO()if m.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[6]then H=GetTime()I=H+m.GUISettings.General.OpenerReset elseif m.GUISettings.General.OpenerReset>0 and I~=nil and GetTime()>I and HeroRotationCharDB.Toggles[6]then HeroRotationCharDB.Toggles[6]=not HeroRotationCharDB.Toggles[6]m.ToggleIconFrame:UpdateButtonText(6)m.Print("Opener is now "..(HeroRotationCharDB.Toggles[6]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end;if w and Z.CheapShot:IsUsableP()and Z.CheapShot:CooldownRemains(BypassRecovery)<=0 and g:StealthUp(true,true)and not g:PrevGCD(1,Z.CheapShot)then if m.Cast(Z.CheapShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(Z.CheapShot)then a7=11833;return"queue Cheap Shot MO"else a6=1833;return"queue Cheap Shot"end end elseif(not Z.CheapShot:IsUsableP()or Z.CheapShot:CooldownRemains()>0 or g:PrevGCD(1,Z.CheapShot))and w then HeroRotationCharDB.Toggles[22]=not HeroRotationCharDB.Toggles[22]m.Print("Cheap Shot Queue is now "..(HeroRotationCharDB.Toggles[22]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if x and Z.KidneyShot:IsUsableP()and Z.KidneyShot:CooldownRemains(BypassRecovery)<=0 then if m.Cast(Z.KidneyShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(Z.KidneyShot)then a7=1408;return"queue Kidney Shot MO"else a6=408;return"queue Kidney Shot"end end elseif g:PrevGCD(1,Z.KidneyShot)and x then HeroRotationCharDB.Toggles[23]=not HeroRotationCharDB.Toggles[23]m.Print("Kidney Shot Queue is now "..(HeroRotationCharDB.Toggles[23]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if y and Z.Blind:IsUsableP()and Z.Blind:CooldownRemains(BypassRecovery)<=0 then if m.Cast(Z.Blind,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(Z.Blind)then a7=12094;return"queue Blind MO"end end elseif(not Z.Blind:IsUsableP()or Z.Blind:CooldownRemains()>0)and y then HeroRotationCharDB.Toggles[24]=not HeroRotationCharDB.Toggles[24]m.Print("Blind Queue is now "..(HeroRotationCharDB.Toggles[24]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if z and Z.Sap:IsUsableP()and Z.Sap:CooldownRemains(BypassRecovery)<=0 then if m.Cast(Z.Sap,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(Z.Sap)then a7=16770;return"queue Sap MO"else a6=6770;return"queue Sap"end end elseif(not Z.Sap:IsUsableP()or Z.Sap:CooldownRemains()>0)and z then HeroRotationCharDB.Toggles[25]=not HeroRotationCharDB.Toggles[25]m.Print("Sap Queue is now "..(HeroRotationCharDB.Toggles[25]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if A and Z.ShurikenTornado:IsUsableP()and Z.ShurikenTornado:CooldownRemains(BypassRecovery)<=0 then if m.Cast(Z.ShurikenTornado,nil,nil,nil)then a6=277925;return"queue Shuriken Tornado"end elseif(not Z.ShurikenTornado:IsUsableP()or Z.ShurikenTornado:CooldownRemains()>0)and A then HeroRotationCharDB.Toggles[26]=not HeroRotationCharDB.Toggles[26]m.Print("Shuriken Tornado Queue is now "..(HeroRotationCharDB.Toggles[26]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if B and Z.Feint:IsUsableP()and Z.Feint:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.Feint,nil,nil,nil)then a6=202;return"queue Shuriken Tornado"end elseif(not Z.Feint:IsUsableP()or Z.Feint:CooldownRemains()>0 or not g:AffectingCombat())and B then HeroRotationCharDB.Toggles[27]=not HeroRotationCharDB.Toggles[27]m.Print("Feint Queue is now "..(HeroRotationCharDB.Toggles[27]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if C and Z.Flagellation:IsUsableP()and Z.Flagellation:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.Flagellation,nil,nil,nil)then a6=323654;return"queue Flagellation Queue"end elseif(not Z.Flagellation:IsUsableP()or Z.Flagellation:CooldownRemains()>0 or not g:AffectingCombat())and C then HeroRotationCharDB.Toggles[28]=not HeroRotationCharDB.Toggles[28]m.Print("Flagellation Queue is now "..(HeroRotationCharDB.Toggles[28]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if E then if Z.ArcaneTorrent:IsAvailable()and Z.ArcaneTorrent:IsUsableP()and Z.ArcaneTorrent:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.ArcaneTorrent,nil,nil,nil)then a6=155145;return"queue ArcaneTorrent Queue"end elseif Z.LightsJudgment:IsAvailable()and Z.LightsJudgment:IsUsableP()and Z.LightsJudgment:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.LightsJudgment,nil,nil,nil)then a6=255647;return"queue ArcaneTorrent Queue"end elseif Z.BagofTricks:IsAvailable()and Z.BagofTricks:IsUsableP()and Z.BagofTricks:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.BagofTricks,nil,nil,nil)then a6=312411;return"queue ArcaneTorrent Queue"end elseif Z.BloodFury:IsAvailable()and Z.BloodFury:IsUsableP()and Z.BloodFury:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.BloodFury,nil,nil,nil)then a6=20572;return"queue ArcaneTorrent Queue"end elseif Z.Berserking:IsAvailable()and Z.Berserking:IsUsableP()and Z.Berserking:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.Berserking,nil,nil,nil)then a6=26297;return"queue ArcaneTorrent Queue"end elseif Z.Fireblood:IsAvailable()and Z.Fireblood:IsUsableP()and Z.Fireblood:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.Fireblood,nil,nil,nil)then a6=265221;return"queue ArcaneTorrent Queue"end elseif Z.AncestralCall:IsAvailable()and Z.AncestralCall:IsUsableP()and Z.AncestralCall:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(Z.AncestralCall,nil,nil,nil)then a6=274738;return"queue ArcaneTorrent Queue"end elseif(Z.ArcaneTorrent:IsAvailable()and(not Z.ArcaneTorrent:IsUsableP()or Z.ArcaneTorrent:CooldownRemains()>0 or not g:AffectingCombat())or Z.LightsJudgment:IsAvailable()and(not Z.LightsJudgment:IsUsableP()or Z.LightsJudgment:CooldownRemains()>0 or not g:AffectingCombat())or Z.BagofTricks:IsAvailable()and(not Z.BagofTricks:IsUsableP()or Z.BagofTricks:CooldownRemains()>0 or not g:AffectingCombat())or Z.BloodFury:IsAvailable()and(not Z.BloodFury:IsUsableP()or Z.BloodFury:CooldownRemains()>0 or not g:AffectingCombat())or Z.Berserking:IsAvailable()and(not Z.Berserking:IsUsableP()or Z.Berserking:CooldownRemains()>0 or not g:AffectingCombat())or Z.Fireblood:IsAvailable()and(not Z.Fireblood:IsUsableP()or Z.Fireblood:CooldownRemains()>0 or not g:AffectingCombat())or Z.AncestralCall:IsAvailable()and(not Z.AncestralCall:IsUsableP()or Z.AncestralCall:CooldownRemains()>0 or not g:AffectingCombat()))and E then HeroRotationCharDB.Toggles[30]=not HeroRotationCharDB.Toggles[30]m.Print("Arcane Torrent Queue is now "..(HeroRotationCharDB.Toggles[30]and"|cff00ff00on|r."or"|cffff0000off|r."))end end;if g:BuffUp(Z.ShurikenTornado)and ag<Y.CPMaxSpend()then local bN=Y.TimeToNextTornado()if bN<=1 or W(g:GCD()-bN)<0.25 then local bO=a3+bh(g:BuffUp(Z.ShadowBlades))ag=U(ag+bO,Y.CPMaxSpend())ah=V(ah-bO,0)af=ag end end;ad=(4+af*4)*0.3;ae=Z.Eviscerate:Damage()*aU.Subtlety.EviscerateDMGOffset;a5=Y.CrimsonVial()if a5 then return a5 end;a5=Y.Feint()if a5 then return a5 end;a5=Y.Evasion()if a5 then return a5 end;if g:HealthPercentage()<aU.Commons.PhialHP and _.PhialofSerenity:IsReady()and _.PhialofSerenity:CooldownRemains()<=0 then if m.Cast(_.PhialofSerenity,nil)then a6=55;return"PhialofSerenity HP"end end;if g:HealthPercentage()<aU.Commons.HealthstoneHP and _.Healthstone:IsReady()and _.Healthstone:CooldownRemains()<=0 then if m.Cast(_.Healthstone,nil)then a6=40;return"Healthstone HP"end end;if g:HealthPercentage()<aU.Commons.HealPotHP and _.HealPot:IsReady()and _.HealPot:CooldownRemains()<=0 then if m.Cast(_.HealPot,nil)then a6=41;return"HealPot HP"end end;if UnitExists("mouseover")and string.find(UnitGUID("mouseover"),120651)then if Z.Backstab:IsCastable()and f("mouseover"):IsInMeleeRange(8)then if m.Cast(Z.Backstab,nil)then a7=153;return"explosive MO SWD"end end;if Z.ShurikenToss:IsCastable()and f("mouseover"):IsInMeleeRange(40)and not f("mouseover"):IsInMeleeRange(8)then if m.Cast(Z.ShurikenToss,nil)then a7=1114014;return"explosive MO SWD"end end end;if UnitExists("target")and string.find(UnitGUID("target"),120651)then if Z.Backstab:IsCastable()and h:IsInMeleeRange(8)then if m.Cast(Z.Backstab,nil)then a6=53;return"explosive  SWD"end end;if Z.ShurikenToss:IsCastable()and h:IsInMeleeRange(40)and not h:IsInMeleeRange(8)then if m.Cast(Z.ShurikenToss,nil)then a6=114014;return"explosive MO SWD"end end end;G={228318,178658,333227,334800,334967,324737,326450,334470,326450,320703,320012,324085,333241,331510,368477,368396,355057,356133}if UnitExists("target")and Z.Shiv:IsReady()and not F then if UnitCanAttack("player","target")and UnitAffectingCombat("target")and UnitIsDead("target")~=true then for bP=0,40 do local bf,bf,bQ,type,bf,bf,bf,bf,bf,bR=UnitBuff("target",bP)for bf,bS in pairs(G)do if bS==bR then if m.Cast(Z.Shiv,nil)then a6=5938;return"Shiv Enrage"end end end end end end;local bT=g:AffectingCombat()and 180 or 900;local bU;if i(8679):IsAvailable()and aU.Commons.LethalPoison=="Wound Poison"then bU=g:BuffRemains(i(8679))if bU<bT and not g:IsCasting(i(8679))then if m.Cast(i(8679))then a6=203;return"Wound Poison Refresh"end end elseif i(2823):IsAvailable()and aU.Commons.LethalPoison=="Deadly Poison"then bU=g:BuffRemains(i(2823))if bU<bT and not g:IsCasting(i(2823))then if m.Cast(i(2823))then a6=204;return"Deadly Poison Refresh"end end elseif i(315584):IsAvailable()and aU.Commons.LethalPoison=="Instant Poison"then bU=g:BuffRemains(i(315584))if bU<bT and not g:IsCasting(i(315584))then if m.Cast(i(315584))then a6=205;return"Instant Poison Refresh"end end end;bU=g:BuffRemains(i(3408))if i(3408):IsAvailable()and aU.Commons.NonLethalPoison=="Crippling Poison"then if bU<bT and not g:IsCasting(i(3408))then if m.Cast(i(3408))then a6=206;return"Crippling Poison Refresh"end end elseif i(5761):IsAvailable()and aU.Commons.NonLethalPoison=="Numbing Poison"then bU=g:BuffRemains(i(5761))if bU<bT and not g:IsCasting(NumbingPoison)then if m.Cast(i(5761))then a6=204;return"Numbing Poison Refresh"end end end;if g:IsChanneling(i(324631))then if m.Cast(Z.PoolEnergy,nil,nil,nil)then a6=99999;return"channeling Fleashcraft"end end;if not g:AffectingCombat()and not g:IsDeadOrGhost()then if not g:BuffUp(Z.ShadowDanceBuff)and not g:BuffUp(ac)then a5=Y.Stealth(ab)if a5 then return a5 end end end;Y.MfDSniping(Z.MarkedforDeath)if X.TargetIsValid()and(g:AffectingCombat()and not h:DebuffUp(Z.Sap)or r or(g:BuffUp(ac)or StealthSpell and StealthSpell:ID()==Z.Vanish:ID()))then local bV,bW,bf=GetSpellCooldown(57934)if aU.Commons.AutoToT and g:AffectingCombat()then if bV+bW-GetTime()<=0 and Z.TricksoftheTrade:IsAvailable()and Z.TricksoftheTrade:CooldownRemains(BypassRecovery)<=0 and UnitExists("focus")and(UnitInParty("focus")or UnitInRaid("focus"))and IsItemInRange(32698,"focus")then if m.Cast(Z.TricksoftheTrade)then a6=157934;return"ToT Focus"end end end;a5=bC()if a5 then return"CDs: "..a5 end;if g:BuffUp(Z.ShurikenTornado)and ag<Y.CPMaxSpend()then local bN=Y.TimeToNextTornado()if bN<=1 or W(g:GCD()-bN)<0.25 then local bO=a3+bh(g:BuffUp(Z.ShadowBlades))ag=U(ag+bO,Y.CPMaxSpend())ah=V(ah-bO,0)af=ag end end;if g:StealthUp(true,true)or VanishBuffCheck then a5=bw()if a5 then return"Stealthed Rotation: "..a5 end end;if g:BuffUp(Z.ShurikenTornado)and ag<Y.CPMaxSpend()then local bN=Y.TimeToNextTornado()if bN<=1 or W(g:GCD()-bN)<0.25 then local bO=a3+bh(g:BuffUp(Z.ShadowBlades))ag=U(ag+bO,Y.CPMaxSpend())ah=V(ah-bO,0)af=ag end end;if Z.SliceandDice:IsCastable()and a3<6 and d.FilteredFightRemains(a2,">",6)and g:BuffRemains(Z.SliceandDice)<g:GCD()and ag>=4-2*l(d.CombatTime()<5)then if Z.SliceandDice:IsReady()and m.Cast(Z.SliceandDice)then a6=5171;return"Cast Slice and Dice (Low Duration)"end end;local ai=b6()if ai then a5=bH()if a5 then return"Stealth CDs: (Priority Rotation)"..a5 end end;if g:BuffUp(Z.ShurikenTornado)and ag<Y.CPMaxSpend()then local bN=Y.TimeToNextTornado()if bN<=1 or W(g:GCD()-bN)<0.25 then local bO=a3+bh(g:BuffUp(Z.ShadowBlades))ag=U(ag+bO,Y.CPMaxSpend())ah=V(ah-bO,0)af=ag end end;if g:EnergyDeficitPredicted()<=bm()then a5=bH()if a5 then return"Stealth CDs: "..a5 end end;if g:BuffUp(Z.ShurikenTornado)and ag<Y.CPMaxSpend()then local bN=Y.TimeToNextTornado()if bN<=1 or W(g:GCD()-bN)<0.25 then local bO=a3+bh(g:BuffUp(Z.ShadowBlades))ag=U(ag+bO,Y.CPMaxSpend())ah=V(ah-bO,0)af=ag end end;if af>=Y.CPMaxSpend()or af>=5 and a3>=5 and g:BuffUp(Z.ShurikenTornado)or(ah<=1 or d.BossFilteredFightRemains("<",1)and af>=3 or g:BuffUp(Z.SymbolsofDeathCrit)and af>=4)or a3>=4 and af>=4 then a5=bt()if a5 then return"Finish: "..a5 end end;if g:BuffUp(Z.ShurikenTornado)and ag<Y.CPMaxSpend()then local bN=Y.TimeToNextTornado()if bN<=1 or W(g:GCD()-bN)<0.25 then local bO=a3+bh(g:BuffUp(Z.ShadowBlades))ag=U(ag+bO,Y.CPMaxSpend())ah=V(ah-bO,0)af=ag end end;if g:EnergyDeficitPredicted()<=bm()and(af<Y.CPMaxSpend()and g:BuffDown(Z.ShurikenTornado)or af<4 and g:BuffUp(Z.ShurikenTornado))then a5=bI()if a5 then return"Build: "..a5 end end;if g:BuffUp(Z.ShurikenTornado)and ag<Y.CPMaxSpend()then local bN=Y.TimeToNextTornado()if bN<=1 or W(g:GCD()-bN)<0.25 then local bO=a3+bh(g:BuffUp(Z.ShadowBlades))ag=U(ag+bO,Y.CPMaxSpend())ah=V(ah-bO,0)af=ag end end;if m.CDsON()then if Z.ArcaneTorrent:IsReady()and h:IsInMeleeRange(5)and g:EnergyDeficitPredicted()>15+g:EnergyRegen()and aU.Commons.Enabled.Racials then if m.Cast(Z.ArcaneTorrent,nil)then a6=155145;return"Cast Arcane Torrent"end end;if Z.ArcanePulse:IsReady()and h:IsInMeleeRange(5)then if m.Cast(Z.ArcanePulse,nil)then a6=260364;return"Cast Arcane Pulse"end end;if Z.LightsJudgment:IsReady()and aU.Commons.Enabled.Racials then if m.Cast(Z.LightsJudgment,nil)then a6=255647;return"Cast Lights Judgment"end end;if Z.BagofTricks:IsReady()and aU.Commons.Enabled.Racials then if m.Cast(Z.BagofTricks,nil)then a6=312411;return"Cast Bag of Tricks"end end end;if false and h:IsInMeleeRange(5)then if type(a8)=="table"and#a8>1 then if m.CastQueuePooling(g:EnergyTimeToX(a9),unpack(a8))then a6=1000;return"Macro pool towards "..a8[1]:Name().." at "..a9 end elseif a8:IsCastable()then a9=V(a9,a8:Cost())if m.CastPooling(a8,g:EnergyTimeToX(a9))then a6=1000;return"Pool towards: "..a8:Name().." at "..a9 end end end;if m.Cast(Z.PoolEnergy)then a6=1000;return"Stealthed Pooling"end end end;local function bX()end;function ReturnSpell()if a6==0 then return 0 else return a6 end end;function ReturnSpellMO()if a7==0 then return 0 else return a7 end end;m.SetAPL(261,bM,bX)