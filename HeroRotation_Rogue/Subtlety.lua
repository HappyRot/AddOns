local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=d.Spell;local j=d.MultiSpell;local k=d.Item;local l=d.Utils.BoolToInt;local m=HeroRotation;local n=m.AoEON;local o=m.CDsON;local p=m.Cast;local q=m.CastLeftNameplate;local r=m.CastPooling;local s=m.CastQueue;local t=m.CastQueuePooling;local u=HeroRotationCharDB.Toggles[4]local v=HeroRotationCharDB.Toggles[5]local w=HeroRotationCharDB.Toggles[12]local x=not HeroRotationCharDB.Toggles[15]local y=HeroRotationCharDB.Toggles[20]local z=HeroRotationCharDB.Toggles[21]local A=HeroRotationCharDB.Toggles[22]local B=HeroRotationCharDB.Toggles[23]local C=HeroRotationCharDB.Toggles[24]local D=HeroRotationCharDB.Toggles[25]local E=HeroRotationCharDB.Toggles[26]local F=HeroRotationCharDB.Toggles[27]local G=HeroRotationCharDB.Toggles[28]local H=HeroRotationCharDB.Toggles[29]local I=HeroRotationCharDB.Toggles[30]local J=HeroRotationCharDB.Toggles[54]local K=HeroRotationCharDB.Toggles[171]local L=HeroRotationCharDB.Toggles[172]local M={324736,228318,178658,333227,334800,334967,324737,326450,334470,320703,320012,324085,333241,331510,344739,368477,368396,355057,356133,342139,353706,355782,327155,359668,321220,158337}local N=nil;local O=nil;local P=0;local Q=0;local pairs=pairs;local R=table.insert;local S=math.min;local T=math.max;local U=math.abs;local V=m.Commons.Everyone;local W=m.Commons.Rogue;local X=i.Rogue.Subtlety;local Y=k.Rogue.Subtlety;local Z={Y.ManicGrieftorch:ID(),Y.BeaconToTheBeyond:ID(),Y.Mirror:ID()}local _={General=m.GUISettings.General,Commons=m.GUISettings.APL.Rogue.Commons,Subtlety=m.GUISettings.APL.Rogue.Subtlety}local a0=g:GetEquipment()local a1=a0[13]and k(a0[13])or k(0)local a2=a0[14]and k(a0[14])or k(0)local a3=GetInventoryItemID("player",13)local a4=GetInventoryItemID("player",14)d:RegisterForEvent(function()a0=g:GetEquipment()a1=a0[13]and k(a0[13])or k(0)a2=a0[14]and k(a0[14])or k(0)end,"PLAYER_EQUIPMENT_CHANGED")local a5,a6,a7,a8;local a9,aa,ab,ac;local ad;local ae,af,ag;local ah,ai;local aj,ak,al,am;local an;local ao=W.ReturnSpell()local ap=W.ReturnSpellMO()X.Eviscerate:RegisterDamageFormula(function()return g:AttackPowerDamageMod()*aj*0.176*1.21*(X.Nightstalker:IsAvailable()and g:StealthUp(true,false)and 1.08 or 1)*(X.DeeperStratagem:IsAvailable()and 1.05 or 1)*(X.DarkShadow:IsAvailable()and g:BuffUp(X.ShadowDanceBuff)and 1.3 or 1)*(g:BuffUp(X.SymbolsofDeath)and 1.1 or 1)*(g:BuffUp(X.FinalityEviscerateBuff)and 1.3 or 1)*(1+g:MasteryPct()/100)*(1+g:VersatilityDmgPct()/100)*(h:DebuffUp(X.FindWeaknessDebuff)and 1.5 or 1)end)local _={General=m.GUISettings.General,Commons=m.GUISettings.APL.Rogue.Commons,Commons2=m.GUISettings.APL.Rogue.Commons2,Subtlety=m.GUISettings.APL.Rogue.Subtlety}local function aq(ar,as)if not ae then ae=ar;af=as or 0 end end;local function at(ar)if not ag then ag=ar end end;local function au()if _.Subtlety.BurnShadowDance=="On Bosses not in Dungeons"and g:IsInDungeonArea()then return false elseif _.Subtlety.BurnShadowDance~="Always"and not h:IsInBossList()then return false else return true end end;local function av()if ab<2 then return false elseif _.Commons.UsePriorityRotation=="Always"then return true elseif _.Commons.UsePriorityRotation=="On Bosses"and h:IsInBossList()then return true elseif _.Commons.UsePriorityRotation=="Auto"then if g:InstanceDifficulty()==16 and h:NPCID()==138967 then return true elseif h:NPCID()==166969 or h:NPCID()==166971 or h:NPCID()==166970 then return true elseif h:NPCID()==183463 or h:NPCID()==183671 then return true end end;return false end;local function aw(ax,ay,az,aA)local aB,aC=nil,az;local aD=h:GUID()for aE,aF in pairs(aA)do if aF:GUID()~=aD and V.UnitIsCycleValid(aF,aC,-aF:DebuffRemains(ax))and ay(aF)then aB,aC=aF,aF:TimeToDie()end end;if aB then m.CastLeftNameplate(aB,ax)if aB:GUID()==f("mouseover"):GUID()and _.Subtlety.TargetSwap=="Mouseover"then if ax==X.Rupture then ap=11943 elseif ax==X.SerratedBoneSpike then ap=1328547 end elseif _.Subtlety.TargetSwap=="AutoSwap"and aB:GUID()~=h:GUID()and not w then ap=9999 end elseif false then aB,aC=nil,az;for aE,aF in pairs(aa)do if aF:GUID()~=aD and V.UnitIsCycleValid(aF,aC,-aF:DebuffRemains(ax))and ay(aF)then aB,aC=aF,aF:TimeToDie()end end;if aB then m.CastLeftNameplate(aB,ax)if aB:GUID()==f("mouseover"):GUID()and _.Subtlety.TargetSwap=="Mouseover"then if ax==X.Rupture then ap=11943 elseif ax==X.SerratedBoneSpike then ap=1328547 end elseif _.Subtlety.TargetSwap=="AutoSwap"and aB:GUID()~=h:GUID()and not w then ap=9999 end end end end;local function aG(aH)if aH then return 1 else return 0 end end;local function aI()return 20+X.Vigor:TalentRank()*25+aG(X.ThistleTea:IsAvailable())*20+aG(X.Shadowcraft:IsAvailable())*20 end;local function aJ()return X.ShadowDance:ChargesFractional()>=0.75+l(X.ShadowDanceTalent:IsAvailable())end;local function aK()return al>=3 end;local function aL()return g:BuffUp(X.SliceandDice)or ab>=W.CPMaxSpend()end;local function aM()return X.Premeditation:IsAvailable()and ab<5 end;local function aN(aO)return g:BuffUp(X.ThistleTea)and ab==1 or aO and(ab==1 or h:DebuffUp(X.Rupture)and ab>=2)end;local function aP()return(not g:BuffUp(X.TheRotten)or not g:HasTier(30,2))and(not X.ColdBlood:IsAvailable()or X.ColdBlood:CooldownRemains()<4 or X.ColdBlood:CooldownRemains()>10)end;local function aQ(i)return g:BuffUp(X.ShadowDanceBuff)and i:TimeSinceLastCast()<X.ShadowDance:TimeSinceLastCast()end;local function aR()return(aQ(X.Shadowstrike)or aQ(X.ShurikenStorm))and(aQ(X.Eviscerate)or aQ(X.BlackPowder)or aQ(X.Rupture))or not X.DanseMacabre:IsAvailable()end;local function aS()return not Y.WitherbarksBranch:IsEquipped()and not Y.AshesoftheEmbersoul:IsEquipped()or not Y.WitherbarksBranch:IsEquipped()and Y.WitherbarksBranch:CooldownRemains()<=8 or Y.WitherbarksBranch:IsEquipped()and Y.WitherbarksBranch:CooldownRemains()<=8 or Y.BandolierOfTwistedBlades:IsEquipped()or X.InvigoratingShadowdust:IsAvailable()end;local function aT(aU)return aU:DebuffRemains(X.FindWeaknessDebuff)end;local function aV(aU)return aU:TimeToDie()end;local function aW(aU)return aU:DebuffRemains(X.Rupture)end;local function aX(aU)if(aU:DebuffRemains(X.FindWeaknessDebuff)<1 or X.SymbolsofDeath:CooldownRemains()<18 and aU:DebuffRemains(X.FindWeaknessDebuff)<X.SymbolsofDeath:CooldownRemains())and aU:GUID()==f("mouseover"):GUID()and _.Subtlety.TargetSwap=="Mouseover"then ap=1185438;return true elseif(aU:DebuffRemains(X.FindWeaknessDebuff)<1 or X.SymbolsofDeath:CooldownRemains()<18 and aU:DebuffRemains(X.FindWeaknessDebuff)<X.SymbolsofDeath:CooldownRemains())and _.Subtlety.TargetSwap=="AutoSwap"and aU:GUID()~=h:GUID()and not w then ap=9999;return true elseif(aU:DebuffRemains(X.FindWeaknessDebuff)<1 or X.SymbolsofDeath:CooldownRemains()<18 and aU:DebuffRemains(X.FindWeaknessDebuff)<X.SymbolsofDeath:CooldownRemains())and aU:GUID()==h:GUID()then ao=185438;return true elseif aU:DebuffRemains(X.FindWeaknessDebuff)<1 or X.SymbolsofDeath:CooldownRemains()<18 and aU:DebuffRemains(X.FindWeaknessDebuff)<X.SymbolsofDeath:CooldownRemains()then return true end end;local function aY(aU)if aU:IsInRange(8)and aU:TimeToDie()>10 and aU:GUID()==f("mouseover"):GUID()and _.Subtlety.TargetSwap=="Mouseover"then ap=1323654;return true elseif aU:IsInRange(8)and aU:TimeToDie()>10 and _.Subtlety.TargetSwap=="AutoSwap"and aU:GUID()~=h:GUID()and not w then ap=9999;return true elseif aU:IsInRange(8)and aU:TimeToDie()>10 and aU:GUID()==h:GUID()then ao=323654;return true elseif aU:IsInRange(8)and aU:TimeToDie()>10 then return true end end;local function aZ(aU)if(aU:FilteredTimeToDie("<",al)or not g:StealthUp(true,true)and g:ComboPointsDeficit()>=W.CPMaxSpend())and aU:GUID()==f("mouseover"):GUID()and _.Subtlety.TargetSwap=="Mouseover"then ap=1137619;return true elseif(aU:FilteredTimeToDie("<",al)or not g:StealthUp(true,true)and g:ComboPointsDeficit()>=W.CPMaxSpend())and _.Subtlety.TargetSwap=="AutoSwap"and aU:GUID()~=h:GUID()and not w then ap=9999;return true elseif(aU:FilteredTimeToDie("<",al)or not g:StealthUp(true,true)and g:ComboPointsDeficit()>=W.CPMaxSpend())and aU:GUID()==h:GUID()then ao=137619;return true elseif aU:FilteredTimeToDie("<",al)or not g:StealthUp(true,true)and g:ComboPointsDeficit()>=W.CPMaxSpend()then return true end end;local function a_(aU)if aU:FilteredTimeToDie(">=",2*ak)and aU:DebuffRefreshable(X.Rupture)and aU:GUID()==f("mouseover"):GUID()and _.Subtlety.TargetSwap=="Mouseover"then ap=11943;return true elseif aU:FilteredTimeToDie(">=",2*ak)and aU:DebuffRefreshable(X.Rupture)and _.Subtlety.TargetSwap=="AutoSwap"and aU:GUID()~=h:GUID()and not w then ap=9999;return true elseif aU:FilteredTimeToDie(">=",2*ak)and aU:DebuffRefreshable(X.Rupture)and aU:GUID()==h:GUID()then ao=1943;return true elseif aU:FilteredTimeToDie(">=",2*ak)and aU:DebuffRefreshable(X.Rupture)then return true end end;local function b0()local aO=g:BuffUp(X.ShadowDanceBuff)local b1=g:BuffRemains(X.ShadowDanceBuff)local b2=g:BuffRemains(X.SymbolsofDeath)local b3=ak;local b4=X.ColdBlood:CooldownRemains()local b5=X.SymbolsofDeath:CooldownRemains()local b6=g:BuffUp(X.PremeditationBuff)or StealthSpell and X.Premeditation:IsAvailable()if StealthSpell and StealthSpell:ID()==X.ShadowDance:ID()then aO=true;b1=8+X.ImprovedShadowDance:TalentRank()if X.TheFirstDance:IsAvailable()then b3=S(g:ComboPointsMax(),ak+4)end;if g:HasTier(30,2)then b2=T(b2,6)end end;if StealthSpell and StealthSpell:ID()==X.Vanish:ID()then b4=S(0,X.ColdBlood:CooldownRemains()-15*X.InvigoratingShadowdust:TalentRank())b5=S(0,X.SymbolsofDeath:CooldownRemains()-15*X.InvigoratingShadowdust:TalentRank())end;if X.Rupture:IsCastable()and X.Rupture:IsReady()then if h:DebuffDown(X.Rupture)and h:TimeToDie()>6 then if X.Rupture:IsReady()and m.Cast(X.Rupture)then ao=1943;return"Cast Rupture"end end end;if not g:StealthUp(true,true)and not aM()and ab<6 and not aO and d.BossFilteredFightRemains(">",g:BuffRemains(X.SliceandDice))and g:BuffRemains(X.SliceandDice)<(1+g:ComboPoints())*1.8 then if X.SliceandDice:IsReady()and m.Cast(X.SliceandDice)then ao=5171;return"Cast Slice and Dice Premed"end end;if(not aN(aO)or an)and h:TimeToDie()>6 and h:DebuffRefreshable(X.Rupture,ah)then if X.Rupture:IsReady()and m.Cast(X.Rupture)then ao=1943;return"Cast Rupture"end end;if g:BuffUp(X.FinalityRuptureBuff)and aO and ab<=4 and not aQ(X.Rupture)then if X.Rupture:IsReady()and m.Cast(X.Rupture)then ao=1943;return"Cast Rupture Finality"end end;if y and X.SecretTechnique:IsCastable()and aO and(g:BuffStack(X.DanseMacabreBuff)>=3 or not X.DanseMacabre:IsAvailable())then if X.ColdBlood:IsReady()and g:BuffDown(X.ColdBlood)then if m.Cast(X.ColdBlood)then ao=382245;return"Cast Cold Blood (FunnelAOE)"end end;if not X.ColdBlood:IsAvailable()or X.ColdBlood:IsReady()or g:BuffUp(X.ColdBlood)or X.ColdBlood:CooldownRemains()>b1-2 then if m.Cast(X.SecretTechnique)then ao=280719;return"Cast Secret Technique (FunnelAOE)"end end end;if y and X.Eviscerate:IsCastable()and a7 then if X.Eviscerate:IsReady()and m.Cast(X.Eviscerate)then ao=196819;return"Cast Eviscerate (FunnelAOE)"end end;if u and X.ColdBlood:IsReady()and aR(aO,b6)and X.SecretTechnique:CooldownUp()then if m.Cast(X.ColdBlood)then ao=382245;return"Cast Cold Blood (SecTec)"end end;if X.SecretTechnique:IsReady()then if aR(aO,b6)and(not X.ColdBlood:IsAvailable()or _.Commons.OffGCDasOffGCD.ColdBlood and X.ColdBlood:IsReady()or g:BuffUp(X.ColdBlood)or b4>b1-2 or not X.ImprovedShadowDance:IsAvailable())then if m.Cast(X.SecretTechnique)then ao=280719;return"Cast Secret Technique"end end end;if not aN(aO)and X.Rupture:IsCastable()then if m.AoEON()and not an and ab>=2 then local function b7(aU)return V.CanDoTUnit(aU,ai)and aU:DebuffRefreshable(X.Rupture,ah)end;aw(X.Rupture,b7,2*b3,ac)end;if a7 and h:DebuffRemains(X.Rupture)<b5+10 and b5<=5 and W.CanDoTUnit(h,ai)and h:FilteredTimeToDie(">",5+b5,-h:DebuffRemains(X.Rupture))then if X.Rupture:IsReady()and m.Cast(X.Rupture)then ao=1943;return"Cast Rupture 2"end end end;if X.BlackPowder:IsCastable()and(not an and ab>=3)then if X.BlackPowder:IsReady()and m.Cast(X.BlackPowder)then ao=319175;return"Cast Black Powder"end end;if X.Eviscerate:IsCastable()and a7 then if X.Eviscerate:IsReady()and m.Cast(X.Eviscerate)then ao=196819;return"Cast Eviscerate"end end end;local function b8()local aO=g:BuffUp(X.ShadowDanceBuff)local b1=g:BuffRemains(X.ShadowDanceBuff)local b9=g:BuffUp(X.TheRottenBuff)local ba,bb=ak,al;local b6=g:BuffUp(X.PremeditationBuff)or StealthSpell and X.Premeditation:IsAvailable()local bc=g:BuffUp(W.StealthSpell())or StealthSpell and StealthSpell:ID()==W.StealthSpell():ID()local bd=g:BuffUp(W.VanishBuffSpell())or StealthSpell and StealthSpell:ID()==X.Vanish:ID()if StealthSpell and StealthSpell:ID()==X.ShadowDance:ID()then aO=true;b1=8+X.ImprovedShadowDance:TalentRank()if X.TheRotten:IsAvailable()and g:HasTier(30,2)then b9=true end;if X.TheFirstDance:IsAvailable()then ba=S(g:ComboPointsMax(),ak+4)bb=g:ComboPointsMax()-ba end end;local be=W.EffectiveComboPoints(ba)local bf=X.Shadowstrike:IsCastable()or bc or bd or aO or g:BuffUp(X.SepsisBuff)if bc or bd then bf=bf and h:IsInRange(25)else bf=bf and a7 end;if bf and bc and(ab<4 or an)then if p(X.Shadowstrike)then ao=185438;return"Cast Shadowstrike (Stealth)"end end;if be>=W.CPMaxSpend()then return b0()end;if g:BuffUp(X.ShurikenTornado)and bb<=2 then return b0()end;if al<=1+aG(X.DeeperStratagem:IsAvailable()or X.SecretStratagem:IsAvailable())then return b0()end;if X.Backstab:IsCastable()and not b6 and b1>=3 and g:BuffUp(X.ShadowBlades)and not aQ(X.Backstab)and X.DanseMacabre:IsAvailable()and ab<=3 and not b9 then if m.Cast(X.Backstab)then ao=600;return"Cast Backstab (Stealth)"end end;if X.Gloomblade:IsAvailable()then if not b6 and b1>=3 and g:BuffUp(X.ShadowBlades)and not aQ(X.Gloomblade)and X.DanseMacabre:IsAvailable()and ab<=4 then if m.Cast(X.Gloomblade)then ao=700;return"Cast Gloomblade (Danse)"end end end;if not aQ(X.Shadowstrike)and g:BuffUp(X.ShadowBlades)then if m.Cast(X.Shadowstrike)then ao=185438;return"Cast Shadowstrike (Danse)"end end;if not b6 and ab>=4 then if m.Cast(X.ShurikenStorm)then ao=197835;return"Cast Shuriken Storm"end end;if bf then if p(X.Shadowstrike)then ao=185438;return"Cast Shadowstrike"end end end;local function bg(StealthSpell,as)local bh=b8(true,StealthSpell)if StealthSpell:ID()==X.Vanish:ID()and _.Commons.VanishOffensive then if p(X.Vanish,nil)then ao=1856;return"Cast Vanish"end elseif StealthSpell:ID()==X.Shadowmeld:ID()and _.Commons.Enabled.Racials then if p(X.Shadowmeld,nil)then ao=1000;return"Cast Shadowmeld"end elseif StealthSpell:ID()==X.ShadowDance:ID()then if p(X.ShadowDance,nil)then ao=185313;return"Cast Shadow Dance"end end;if as and g:EnergyPredicted()<as then aq(MacroTable,as)end end;local function bi()if m.CDsON()and X.ColdBlood:IsReady()and not X.SecretTechnique:IsAvailable()and ak>=5 then if m.Cast(X.ColdBlood,nil)then ao=382245;return"Cast Cold Blood"end end;if m.CDsON()and X.Sepsis:IsAvailable()and X.Sepsis:IsReady()then if aL()and h:FilteredTimeToDie(">=",16)and(g:BuffUp(X.PerforatedVeins)or not X.PerforatedVeins:IsAvailable())then if m.Cast(X.Sepsis,nil,nil)then ao=328305;return"Cast Sepsis"end end end;if m.CDsON()and X.Flagellation:IsAvailable()and X.Flagellation:IsReady()then if aL()and aj>=5 and h:TimeToDie()>10 and(aS()and X.ShadowBlades:CooldownRemains()<=3 or d.BossFilteredFightRemains("<=",28)or X.ShadowBlades:CooldownRemains()>=14 and X.InvigoratingShadowdust:IsAvailable()and X.ShadowDance:IsAvailable())and(not X.InvigoratingShadowdust:IsAvailable()or X.Sepsis:IsAvailable()or not X.ShadowDance:IsAvailable()or X.InvigoratingShadowdust:TalentRank()==2 and ab>=2 or X.SymbolsofDeath:CooldownRemains()<=3 or g:BuffRemains(X.SymbolsofDeath)>3)then if m.Cast(X.Flagellation,nil,nil)then ao=323654;return"Cast Flagellation"end end end;if m.CDsON()and X.SymbolsofDeath:IsReady()then if aL()and(not g:BuffUp(X.TheRotten)or not g:HasTier(30,2))and g:BuffRemains(X.SymbolsofDeath)<=3 and(not X.Flagellation:IsAvailable()or X.Flagellation:CooldownRemains()>10 or g:BuffRemains(X.ShadowDance)>=2 and X.InvigoratingShadowdust:IsAvailable()or X.Flagellation:IsReady()and aj>=5 and not X.InvigoratingShadowdust:IsAvailable())then if m.Cast(X.SymbolsofDeath,nil)then ao=212283;return"Cast Symbols of Death"end end end;if m.CDsON()and X.ShadowBlades:IsReady()then if aL()and(aj<=1 or g:HasTier(31,4))and(g:BuffUp(X.Flagellation)or g:BuffUp(X.FlagellationPersistBuff)or not X.Flagellation:IsAvailable())then if m.Cast(X.ShadowBlades,nil)then ao=121471;return"Cast Shadow Blades"end end end;if m.CDsON()and X.EchoingReprimand:IsCastable()and X.EchoingReprimand:IsAvailable()then if aL()and al>=3 then if m.Cast(X.EchoingReprimand,nil,nil)then ao=323547;return"Cast Echoing Reprimand"end end end;if m.CDsON()and X.ShurikenTornado:IsAvailable()and X.ShurikenTornado:IsReady()then if aL()and g:BuffUp(X.SymbolsofDeath)and aj<=2 and not g:BuffUp(X.Premeditation)and(not X.Flagellation:IsAvailable()or X.Flagellation:CooldownRemains()>20)and ab>=3 then if m.Cast(X.ShurikenTornado,nil)then ao=277925;return"Cast Shuriken Tornado"end end end;if m.CDsON()and X.ShurikenTornado:IsAvailable()and X.ShurikenTornado:IsReady()then if aL()and not g:BuffUp(X.ShadowDance)and not g:BuffUp(X.Flagellation)and not g:BuffUp(X.FlagellationPersistBuff)and not g:BuffUp(X.ShadowBlades)and ab<=2 then if m.Cast(X.ShurikenTornado,nil)then ao=277925;return"Cast Shuriken Tornado"end end end;if m.CDsON()and X.ShadowDance:IsAvailable()and au()and X.ShadowDance:IsReady()then if not g:BuffUp(X.ShadowDance)and d.BossFilteredFightRemains("<=",8+3*aG(X.Subterfuge:IsAvailable()))then if m.Cast(X.ShadowDance)then ao=185313;return"Cast Shadow Dance"end end end;if m.CDsON()and X.GoremawsBite:IsAvailable()and X.GoremawsBite:IsReady()then if aL()and al>=3 and(not X.ShadowDance:IsReady()or X.ShadowDance:IsAvailable()and g:BuffUp(X.ShadowDance)and not X.InvigoratingShadowdust:IsAvailable()or ab<4 and not X.InvigoratingShadowdust:IsAvailable()or X.TheRotten:IsAvailable())then if m.Cast(X.GoremawsBite)then ao=426591;return"Cast Goremaw's Bite"end end end;if X.ThistleTea:IsReady()then if(X.SymbolsofDeath:CooldownRemains()>=3 or g:BuffUp(X.SymbolsofDeath))and not g:BuffUp(X.ThistleTea)and(g:EnergyDeficitPredicted()>=100 and(al>=2 or ab>=3)or X.ThistleTea:ChargesFractional()>=2.75-0.15*X.InvigoratingShadowdust:TalentRank()and X.Vanish:IsReady()and g:BuffUp(X.ShadowDance)and h:DebuffUp(X.Rupture)and ab<3)or g:BuffRemains(X.ShadowDance)>=4 and not g:BuffUp(X.ThistleTea)and ab>=3 or not g:BuffUp(X.ThistleTea)and d.BossFilteredFightRemains("<=",6*X.ThistleTea:Charges())then if m.Cast(X.ThistleTea,nil,nil)then ao=381623;return"Thistle Tea"end end end;local bj=g:BuffUp(X.ShadowBlades)or not X.ShadowBlades:IsAvailable()and g:BuffUp(X.SymbolsofDeath)or d.BossFilteredFightRemains("<",20)if X.BloodFury:IsReady()and bj and _.Commons.Enabled.Racials then if m.Cast(X.BloodFury,nil)then ao=20572;return"Cast Blood Fury"end end;if X.Berserking:IsReady()and bj and _.Commons.Enabled.Racials then if m.Cast(X.Berserking,nil)then ao=26297;return"Cast Berserking"end end;if X.Fireblood:IsReady()and bj and _.Commons.Enabled.Racials then if m.Cast(X.Fireblood,nil)then ao=265221;return"Cast Fireblood"end end;if X.AncestralCall:IsReady()and bj and _.Commons.Enabled.Racials then if m.Cast(X.AncestralCall,nil)then ao=274738;return"Cast Ancestral Call"end end;if not g:StealthUp(true,true)or d.BossFilteredFightRemains("<",10)then local bk=g:GetUseableTrinkets(Z)if bk and o()then if m.Cast(bk,nil,nil)then if bk:ID()==GetInventoryItemID("player",13)and _.Commons.Enabled.TopTrinket then ao=24;return"Generic use_items for "..bk:Name()elseif bk:ID()==GetInventoryItemID("player",14)and _.Commons.Enabled.BottomTrinket then ao=25;return"Generic use_items for "..bk:Name()end end end end end;local function bl(as)if m.CDsON()and not(V.IsSoloMode()and g:IsTanking(h))then if X.Vanish:IsCastable()then if(al>1 or g:BuffUp(X.ShadowBlades)and X.InvigoratingShadowdust:IsAvailable())and not aJ()and(X.Flagellation:CooldownRemains()>=60 or not X.Flagellation:IsAvailable()or d.BossFilteredFightRemains("<=",30*X.Vanish:Charges()))and(X.SymbolsofDeath:CooldownRemains()>3 or not g:HasTier(30,2))and(X.SecretTechnique:CooldownRemains()>=10 or not X.SecretTechnique:IsAvailable()or X.Vanish:Charges()>=2 and X.InvigoratingShadowdust:IsAvailable()and(g:BuffUp(X.TheRotten)or not X.TheRotten:IsAvailable()))then ad=bg(X.Vanish,as)if ad then return"Vanish Macro "..ad end end end;if _.Commons.Enabled.Racials and g:Energy()<40 and X.Shadowmeld:IsCastable()then if m.CastPooling(X.Shadowmeld,g:EnergyTimeToX(40))then ao=1000;return"Pool for Shadowmeld"end end;if _.Commons.Enabled.Racials and X.Shadowmeld:IsCastable()and a7 and not g:IsMoving()and g:EnergyPredicted()>=40 and g:EnergyDeficitPredicted()>=10 and not aJ()and al>4 then ad=bg(X.Shadowmeld,as)if ad then return"Shadowmeld Macro "..ad end end end;if a7 and X.ShadowDance:IsCastable()then if(h:DebuffUp(X.Rupture)or X.InvigoratingShadowdust:IsAvailable())and aP()and(not X.TheFirstDance:IsAvailable()or al>=4 or g:BuffUp(X.ShadowBlades))and(aK()and aJ()or(g:BuffUp(X.ShadowBlades)or g:BuffUp(X.SymbolsofDeath)and not X.Sepsis:IsAvailable()or g:BuffRemains(X.SymbolsofDeath)>=4 and not g:HasTier(30,2)or not g:BuffUp(X.SymbolsofDeath)and g:HasTier(30,2))and X.SecretTechnique:CooldownRemains()<10+12*aG(not X.InvigoratingShadowdust:IsAvailable()or g:HasTier(30,2)))then ad=bg(X.ShadowDance,as)if ad then return"ShadowDance Macro 1 "..ad end end end end;local function bm(as)local bn=not as or g:EnergyPredicted()>=as;if m.AoEON()and X.ShurikenStorm:IsCastable()and ab>=2+l(X.Gloomblade:IsAvailable()and g:BuffRemains(X.LingeringShadowBuff)>=6 or g:BuffUp(X.PerforatedVeinsBuff))then if bn and m.Cast(X.ShurikenStorm)then ao=197835;return"Cast Shuriken Storm"end end;if a7 then if X.Gloomblade:IsCastable()then if bn and m.Cast(X.Gloomblade)then ao=200758;return"Cast Gloomblade"end elseif X.Backstab:IsCastable()then if bn and m.Cast(X.Backstab)then ao=53;return"Cast Backstab"end end end end;local function bo()ae=nil;ag=nil;af=0;a5=X.AcrobaticStrikes:IsAvailable()and 8 or 5;a6=X.AcrobaticStrikes:IsAvailable()and 13 or 10;a7=h:IsInMeleeRange(a5)a8=h:IsInMeleeRange(a6)v=HeroRotationCharDB.Toggles[5]u=HeroRotationCharDB.Toggles[4]w=HeroRotationCharDB.Toggles[12]x=not HeroRotationCharDB.Toggles[15]y=HeroRotationCharDB.Toggles[20]z=HeroRotationCharDB.Toggles[21]A=HeroRotationCharDB.Toggles[22]B=HeroRotationCharDB.Toggles[23]C=HeroRotationCharDB.Toggles[24]D=HeroRotationCharDB.Toggles[25]E=HeroRotationCharDB.Toggles[26]F=HeroRotationCharDB.Toggles[27]G=HeroRotationCharDB.Toggles[28]H=HeroRotationCharDB.Toggles[29]I=HeroRotationCharDB.Toggles[30]J=HeroRotationCharDB.Toggles[54]K=HeroRotationCharDB.Toggles[172]L=HeroRotationCharDB.Toggles[173]SBReady=false;SDReady=false;VanishReady=false;SoDReady=false;MfDReady=true;STReady=false;if _.Subtlety.IncludedCooldowns.ShadowBlades and o()or _.Subtlety.IncludedSmallCooldowns.ShadowBlades and(o()or u)or not _.Subtlety.IncludedSmallCooldowns.ShadowBlades and not _.Subtlety.IncludedCooldowns.ShadowBlades then SBReady=true end;if _.Subtlety.IncludedCooldowns.ShadowDance and o()or _.Subtlety.IncludedSmallCooldowns.ShadowDance and(o()or u)or not _.Subtlety.IncludedSmallCooldowns.ShadowDance and not _.Subtlety.IncludedCooldowns.ShadowDance then SDReady=true end;if _.Subtlety.IncludedCooldowns.Vanish and o()or _.Subtlety.IncludedSmallCooldowns.Vanish and(o()or u)or not _.Subtlety.IncludedSmallCooldowns.Vanish and not _.Subtlety.IncludedCooldowns.Vanish then VanishReady=true end;if _.Subtlety.IncludedCooldowns.SymbolsofDeath and o()or _.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and(o()or u)or not _.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and not _.Subtlety.IncludedCooldowns.SymbolsofDeath then SoDReady=true end;if _.Subtlety.IncludedCooldowns.ShurikenTornado and o()or _.Subtlety.IncludedSmallCooldowns.ShurikenTornado and(o()or u)or not _.Subtlety.IncludedSmallCooldowns.ShurikenTornado and not _.Subtlety.IncludedCooldowns.ShurikenTornado then STReady=true end;a3=GetInventoryItemID("player",13)a4=GetInventoryItemID("player",14)SuggestCycleDoTCheck=false end;local function bp()if X.Subterfuge:IsAvailable()then Stealth=X.Stealth2;VanishBuff=X.VanishBuff2 else Stealth=X.Stealth;VanishBuff=X.VanishBuff end;ad=bo()a5=X.AcrobaticStrikes:IsAvailable()and 8 or 5;a6=X.AcrobaticStrikes:IsAvailable()and 13 or 10;a7=h:IsInMeleeRange(a5)a8=h:IsInMeleeRange(a6)if n()then a9=g:GetEnemiesInRange(30)aa=g:GetEnemiesInMeleeRange(a6)ab=#aa;ac=g:GetEnemiesInMeleeRange(a5)else a9={}aa={}ab=1;ac={}end;ak=g:ComboPoints()aj=W.EffectiveComboPoints(ak)al=g:ComboPointsDeficit()an=av()am=g:EnergyMax()-aI()if aj>ak and al>2 and g:AffectingCombat()then if ak==2 and not g:BuffUp(X.EchoingReprimand3)or ak==3 and not g:BuffUp(X.EchoingReprimand4)or ak==4 and not g:BuffUp(X.EchoingReprimand5)then local bq=W.TimeToSht(4)if bq==0 then bq=W.TimeToSht(5)end;if bq<T(g:EnergyTimeToX(35),g:GCDRemains())+0.5 then aj=ak end end end;if g:BuffUp(X.ShurikenTornado,nil,true)and ak<W.CPMaxSpend()then local br=W.TimeToNextTornado()if br<=g:GCDRemains()or U(g:GCDRemains()-br)<0.25 then local bs=ab+aG(g:BuffUp(X.ShadowBlades))ak=S(ak+bs,W.CPMaxSpend())al=T(al-bs,0)if aj<W.CPMaxSpend()then aj=ak end end end;ah=(4+aj*4)*0.3;ai=X.Eviscerate:Damage()*_.Subtlety.EviscerateDMGOffset;if ad then return ad end;if ap>0 then ap=0 end;if ao>0 then ao=0 end;ao=W.ReturnSpell()ap=W.ReturnSpellMO()if m.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[5]then N=GetTime()O=N+m.GUISettings.General.OpenerReset elseif m.GUISettings.General.OpenerReset>0 and O~=nil and GetTime()>O and HeroRotationCharDB.Toggles[6]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]m.ToggleIconFrame:UpdateButtonText(5)m.Print("Opener is now "..(HeroRotationCharDB.Toggles[5]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end;if m.QueuedCast()then ao=m.QueuedCast()return"Custom Queue "..i(ao):ID()end;if A and X.CheapShot:IsUsableP()and X.CheapShot:CooldownRemains()<=0 and g:StealthUp(true,true)and not g:PrevGCD(1,X.CheapShot)then if m.Cast(X.CheapShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.CheapShot)then ap=11833;return"queue Cheap Shot MO"else ao=1833;return"queue Cheap Shot"end end elseif(not X.CheapShot:IsUsableP()or X.CheapShot:CooldownRemains()>0 or g:PrevGCD(1,X.CheapShot))and A then HeroRotationCharDB.Toggles[22]=not HeroRotationCharDB.Toggles[22]m.Print("Cheap Shot Queue is now "..(HeroRotationCharDB.Toggles[22]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if B and X.KidneyShot:IsUsableP()and X.KidneyShot:CooldownRemains()<=0 then if m.Cast(X.KidneyShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.KidneyShot)then ap=1408;return"queue Kidney Shot MO"else ao=408;return"queue Kidney Shot"end end elseif g:PrevGCD(1,X.KidneyShot)and B then HeroRotationCharDB.Toggles[23]=not HeroRotationCharDB.Toggles[23]m.Print("Kidney Shot Queue is now "..(HeroRotationCharDB.Toggles[23]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if C and X.Blind:IsUsableP()and X.Blind:CooldownRemains()<=0 then if m.Cast(X.Blind,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.Blind)then ap=12094;return"queue Blind MO"else ao=2094;return"queue Blind"end end elseif(not X.Blind:IsUsableP()or X.Blind:CooldownRemains()>0)and C then HeroRotationCharDB.Toggles[24]=not HeroRotationCharDB.Toggles[24]m.Print("Blind Queue is now "..(HeroRotationCharDB.Toggles[24]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if D and X.Sap:IsUsableP()and X.Sap:CooldownRemains()<=0 then if m.Cast(X.Sap,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.Sap)then ap=16770;return"queue Sap MO"else ao=6770;return"queue Sap"end end elseif(not X.Sap:IsUsableP()or X.Sap:CooldownRemains()>0)and D then HeroRotationCharDB.Toggles[25]=not HeroRotationCharDB.Toggles[25]m.Print("Sap Queue is now "..(HeroRotationCharDB.Toggles[25]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if E and X.ShurikenTornado:IsUsableP()and X.ShurikenTornado:CooldownRemains()<=0 then if m.Cast(X.ShurikenTornado,nil,nil,nil)then ao=277925;return"queue Shuriken Tornado"end elseif(not X.ShurikenTornado:IsUsableP()or X.ShurikenTornado:CooldownRemains()>0)and E then HeroRotationCharDB.Toggles[26]=not HeroRotationCharDB.Toggles[26]m.Print("Shuriken Tornado Queue is now "..(HeroRotationCharDB.Toggles[26]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if F and X.Feint:IsUsableP()and X.Feint:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.Feint,nil,nil,nil)then ao=202;return"queue Shuriken Tornado"end elseif(not X.Feint:IsUsableP()or X.Feint:CooldownRemains()>0 or not g:AffectingCombat())and F then HeroRotationCharDB.Toggles[27]=not HeroRotationCharDB.Toggles[27]m.Print("Feint Queue is now "..(HeroRotationCharDB.Toggles[27]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if G and X.Flagellation:IsUsableP()and X.Flagellation:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.Flagellation,nil,nil,nil)then ao=323654;return"queue Flagellation Queue"end elseif(not X.Flagellation:IsUsableP()or X.Flagellation:CooldownRemains()>0 or not g:AffectingCombat())and G then HeroRotationCharDB.Toggles[28]=not HeroRotationCharDB.Toggles[28]m.Print("Flagellation Queue is now "..(HeroRotationCharDB.Toggles[28]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if I then if X.ArcaneTorrent:IsAvailable()and X.ArcaneTorrent:IsUsableP()and X.ArcaneTorrent:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.ArcaneTorrent,nil,nil,nil)then ao=155145;return"queue ArcaneTorrent Queue"end elseif X.LightsJudgment:IsAvailable()and X.LightsJudgment:IsUsableP()and X.LightsJudgment:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.LightsJudgment,nil,nil,nil)then ao=255647;return"queue ArcaneTorrent Queue"end elseif X.BagofTricks:IsAvailable()and X.BagofTricks:IsUsableP()and X.BagofTricks:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.BagofTricks,nil,nil,nil)then ao=312411;return"queue ArcaneTorrent Queue"end elseif X.BloodFury:IsAvailable()and X.BloodFury:IsUsableP()and X.BloodFury:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.BloodFury,nil,nil,nil)then ao=20572;return"queue ArcaneTorrent Queue"end elseif X.Berserking:IsAvailable()and X.Berserking:IsUsableP()and X.Berserking:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.Berserking,nil,nil,nil)then ao=26297;return"queue ArcaneTorrent Queue"end elseif X.Fireblood:IsAvailable()and X.Fireblood:IsUsableP()and X.Fireblood:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.Fireblood,nil,nil,nil)then ao=265221;return"queue ArcaneTorrent Queue"end elseif X.AncestralCall:IsAvailable()and X.AncestralCall:IsUsableP()and X.AncestralCall:CooldownRemains()<=0 and g:AffectingCombat()then if m.Cast(X.AncestralCall,nil,nil,nil)then ao=274738;return"queue ArcaneTorrent Queue"end elseif(X.ArcaneTorrent:IsAvailable()and(not X.ArcaneTorrent:IsUsableP()or X.ArcaneTorrent:CooldownRemains()>0 or not g:AffectingCombat())or X.LightsJudgment:IsAvailable()and(not X.LightsJudgment:IsUsableP()or X.LightsJudgment:CooldownRemains()>0 or not g:AffectingCombat())or X.BagofTricks:IsAvailable()and(not X.BagofTricks:IsUsableP()or X.BagofTricks:CooldownRemains()>0 or not g:AffectingCombat())or X.BloodFury:IsAvailable()and(not X.BloodFury:IsUsableP()or X.BloodFury:CooldownRemains()>0 or not g:AffectingCombat())or X.Berserking:IsAvailable()and(not X.Berserking:IsUsableP()or X.Berserking:CooldownRemains()>0 or not g:AffectingCombat())or X.Fireblood:IsAvailable()and(not X.Fireblood:IsUsableP()or X.Fireblood:CooldownRemains()>0 or not g:AffectingCombat())or X.AncestralCall:IsAvailable()and(not X.AncestralCall:IsUsableP()or X.AncestralCall:CooldownRemains()>0 or not g:AffectingCombat()))and I then HeroRotationCharDB.Toggles[30]=not HeroRotationCharDB.Toggles[30]m.Print("Arcane Torrent Queue is now "..(HeroRotationCharDB.Toggles[30]and"|cff00ff00on|r."or"|cffff0000off|r."))end end;ad=W.CrimsonVial()if ad then return ad end;if g:AffectingCombat()and not g:IsDeadOrGhost()then ad=W.Feint()if ad then return ad end;ad=W.Evasion()if ad then return ad end;if g:HealthPercentage()<_.Commons.PhialHP and Y.PhialofSerenity:IsReady()and Y.PhialofSerenity:CooldownRemains()<=0 then if m.Cast(Y.PhialofSerenity,nil)then ao=55;return"PhialofSerenity HP"end end;if g:HealthPercentage()<_.Commons.HealthstoneHP and Y.Healthstone:IsReady()and Y.Healthstone:CooldownRemains()<=0 then if m.Cast(Y.Healthstone,nil)then ao=40;return"Healthstone HP"end end;if g:HealthPercentage()<_.Commons.HealPotHP and Y.CosmicHealPot:IsReady()and Y.CosmicHealPot:CooldownRemains()<=0 then if m.Cast(Y.CosmicHealPot,nil)then ao=45;return"CosmicHealPot HP"end end;if g:HealthPercentage()<_.Commons.HealPotHP and Y.HealPot:IsReady()and not Y.CosmicHealPot:IsReady()and Y.HealPot:CooldownRemains()<=0 then if m.Cast(Y.HealPot,nil)then ao=41;return"HealPot HP"end end end;if UnitExists("mouseover")and string.find(UnitGUID("mouseover"),120651)then if X.Backstab:IsReady()and f("mouseover"):IsInMeleeRange(8)then if m.Cast(X.Backstab,nil)then ap=153;return"explosive MO SWD"end end;if X.ShurikenToss:IsReady()and f("mouseover"):IsInMeleeRange(40)and not f("mouseover"):IsInMeleeRange(8)then if m.Cast(X.ShurikenToss,nil)then ap=1114014;return"explosive MO SWD"end end end;if UnitExists("target")and string.find(UnitGUID("target"),120651)then if X.Backstab:IsReady()and h:IsInMeleeRange(8)then if m.Cast(X.Backstab,nil)then ao=53;return"explosive  SWD"end end;if X.ShurikenToss:IsReady()and h:IsInMeleeRange(40)and not h:IsInMeleeRange(8)then if m.Cast(X.ShurikenToss,nil)then ao=114014;return"explosive MO SWD"end end end;M={324736,228318,178658,333227,334800,334967,324737,326450,334470,320703,320012,324085,333241,331510,344739,368477,368396,355057,356133,342139,353706,355782,327155,359668,321220,158337,38255}if UnitExists("target")and X.Shiv:IsReady()and not J then if UnitCanAttack("player","target")and UnitAffectingCombat("target")and UnitIsDead("target")~=true then for bt=0,40 do local aE,aE,bu,bv,aE,aE,aE,aE,aE,bw=UnitBuff("target",bt)for aE,bx in pairs(M)do if bx==bw then if m.Cast(X.Shiv,nil)then ao=5938;return"Shiv Enrage"end end end end end end;local by=g:AffectingCombat()and 180 or 900;local bz;if i(8679):IsAvailable()and _.Commons.LethalPoison=="Wound Poison"then bz=g:BuffRemains(i(8679))if bz<by and not g:IsCasting(i(8679))then if m.Cast(i(8679))then ao=203;return"Wound Poison Refresh"end end elseif i(2823):IsAvailable()and _.Commons.LethalPoison=="Deadly Poison"then bz=g:BuffRemains(i(2823))if bz<by and not g:IsCasting(i(2823))then if m.Cast(i(2823))then ao=208;return"Deadly Poison Refresh"end end elseif i(315584):IsAvailable()and _.Commons.LethalPoison=="Instant Poison"then bz=g:BuffRemains(i(315584))if bz<by and not g:IsCasting(i(315584))then if m.Cast(i(315584))then ao=205;return"Instant Poison Refresh"end end end;if i(381637):IsAvailable()and _.Commons.NonLethalPoison=="Atrophic Poison"then bz=g:BuffRemains(i(381637))if bz<by and not g:IsCasting(i(381637))then if m.Cast(i(381637))then ao=381637;return"Atropic Poison Refresh"end end elseif i(5761):IsAvailable()and _.Commons.NonLethalPoison=="Numbing Poison"then bz=g:BuffRemains(i(5761))if bz<by and not g:IsCasting(NumbingPoison)then if m.Cast(i(5761))then ao=204;return"Numbing Poison Refresh"end end elseif i(3408):IsAvailable()and _.Commons.NonLethalPoison=="Crippling Poison"then bz=g:BuffRemains(i(3408))if bz<by and not g:IsCasting(NumbingPoison)then if m.Cast(i(3408))then ao=206;return"Crippling Poison Refresh"end end end;if not g:AffectingCombat()and not g:IsDeadOrGhost()then if not g:BuffUp(X.ShadowDanceBuff)and not g:BuffUp(W.VanishBuffSpell())then ad=W.Stealth(W.StealthSpell())if ad then return ad end end;if V.TargetIsValid()and(h:IsSpellInRange(X.Shadowstrike)or a7)and(not g:AffectingCombat()or v)then if m.CDsON()then if X.MarkedforDeath:IsCastable()and g:ComboPointsDeficit()>=W.CPMaxSpend()then if m.Cast(X.MarkedforDeath,nil)then ao=137619;return"Cast Marked for Death OOC"end end end;if g:StealthUp(true,true)and(g:AffectingCombat()or v)then ad=b8()if ad then return ad.." (OOC)"end elseif ak>=5 then if g:AffectingCombat()or v then ad=b0()if ad then return ad.." (OOC)"end end elseif X.Backstab:IsCastable()and v then if m.Cast(X.Backstab)then ao=53;return"Cast Backstab (OOC)"end end end;return end;W.MfDSniping(X.MarkedforDeath)if V.TargetIsValid()and(not h:DebuffUp(X.Sap)or(g:BuffUp(VanishBuff)or StealthSpell and StealthSpell:ID()==X.Vanish:ID()))then if ad then return ad end;ad=bi()if ad then return"CDs: "..ad end;local bA,bB,aE=GetSpellCooldown(57934)if _.Commons.AutoToT and g:AffectingCombat()then if bA+bB-GetTime()<=0 and X.TricksoftheTrade:IsAvailable()and X.TricksoftheTrade:CooldownRemains()<=0 and UnitExists("focus")and(UnitInParty("focus")or UnitInRaid("focus"))and IsItemInRange(32698,"focus")then if m.Cast(X.TricksoftheTrade)then ao=157934;return"ToT Focus"end end end;if X.SliceandDice:IsCastable()and ab<W.CPMaxSpend()and g:BuffRemains(X.SliceandDice)<g:GCD()and d.BossFilteredFightRemains(">",6)and ak>=4 then if X.SliceandDice:IsReady()and m.Cast(X.SliceandDice)then ao=5171;return"Cast Slice and Dice (Low Duration)"end end;if g:EnergyPredicted()>=am and not X.Vigor:IsAvailable()or X.Shadowcraft:IsAvailable()or X.InvigoratingShadowdust:IsAvailable()then ad=bl()if ad then return"Stealth CDs: "..ad end end;if aj>=W.CPMaxSpend()then ad=b0()if ad then return"Finish: "..ad end end;if al<=1 or d.BossFilteredFightRemains("<=",1)and aj>=3 then ad=b0()if ad then return"Finish: "..ad end end;if ab>=4 and aj>=4 then ad=b0()if ad then return"Finish: "..ad end end;if g:EnergyDeficitPredicted()<=aI()then ad=bm()if ad then return"Build: "..ad end end;if m.CDsON()then if X.ArcaneTorrent:IsReady()and h:IsInMeleeRange(8)and _.Commons.Enabled.Racials and g:EnergyDeficitPredicted()>15+g:EnergyRegen()then if m.Cast(X.ArcaneTorrent,nil)then ao=155145;return"Cast Arcane Torrent"end end;if X.ArcanePulse:IsReady()and h:IsInMeleeRange(8)and _.Commons.Enabled.Racials then if m.Cast(X.ArcanePulse,nil)then ao=260364;return"Cast Arcane Pulse"end end;if X.LightsJudgment:IsReady()and h:IsInMeleeRange(8)and _.Commons.Enabled.Racials then if m.Cast(X.LightsJudgment,nil)then ao=255647;return"Cast Lights Judgment"end end;if X.BagofTricks:IsReady()and h:IsInMeleeRange(8)and _.Commons.Enabled.Racials then if m.Cast(X.BagofTricks,nil)then ao=312411;return"Cast Bag of Tricks"end end end;if X.ShurikenToss:IsCastable()and h:IsInRange(30)and not a8 and not g:StealthUp(true,true)and not g:BuffUp(X.Sprint)and g:EnergyDeficitPredicted()<20 and(al>=1 or g:EnergyTimeToMax()<=1.2)then if m.CastPooling(X.ShurikenToss)then ao=114014;return"Cast Shuriken Toss"end end end end;local function bC()if HeroRotationCharDB.Toggles[5]then HeroRotationCharDB.Toggles[5]=not HeroRotationCharDB.Toggles[5]m.ToggleIconFrame:UpdateButtonText(5)end;if HeroRotationCharDB.Toggles[171]then HeroRotationCharDB.Toggles[171]=not HeroRotationCharDB.Toggles[171]end;if HeroRotationCharDB.Toggles[172]then HeroRotationCharDB.Toggles[172]=not HeroRotationCharDB.Toggles[172]end;if HeroRotationCharDB.Toggles[29]then HeroRotationCharDB.Toggles[29]=not HeroRotationCharDB.Toggles[29]end end;function ReturnSpell()if ao==0 then return 0 else return ao end end;function ReturnSpellMO()if ap==0 then return 0 else return ap end end;m.SetAPL(261,bp,bC)