local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=d.Spell;local j=d.MultiSpell;local k=d.Item;local l=d.Utils.BoolToInt;local m=HeroRotation;local n=m.AoEON;local o=m.CDsON;local p=HeroRotationCharDB.Toggles[4]local q=HeroRotationCharDB.Toggles[5]local r=HeroRotationCharDB.Toggles[6]local s=HeroRotationCharDB.Toggles[12]local t=HeroRotationCharDB.Toggles[15]local u=HeroRotationCharDB.Toggles[20]local v=HeroRotationCharDB.Toggles[21]local w=HeroRotationCharDB.Toggles[22]local x=HeroRotationCharDB.Toggles[23]local y=HeroRotationCharDB.Toggles[24]local z=HeroRotationCharDB.Toggles[25]local A=HeroRotationCharDB.Toggles[26]local B=HeroRotationCharDB.Toggles[27]local C=HeroRotationCharDB.Toggles[28]local D=HeroRotationCharDB.Toggles[29]local E=HeroRotationCharDB.Toggles[30]local F=HeroRotationCharDB.Toggles[54]local G={324736,228318,178658,333227,334800,334967,324737,326450,334470,320703,320012,324085,333241,331510,344739,368477,368396,355057,356133,342139,353706,355782,327155,359668}local H=nil;local I=nil;local J=false;local K=false;local L=false;local M=false;local N=false;local O=true;local P=0;local Q=0;local pairs=pairs;local R=table.insert;local S=math.min;local T=math.max;local U=math.abs;local V=m.Commons.Everyone;local W=m.Commons.Rogue;local X=i.Rogue.Subtlety;local Y=k.Rogue.Subtlety;local Z=GetInventoryItemID("player",13)local _=GetInventoryItemID("player",14)local a0,a1,a2,a3;local a4;local a5=W.ReturnSpell()local a6=W.ReturnSpellMO()local a7,a8,a9;local aa,ab;local ac,ad;local ae,af,ag;local ah;local ai=g:HasLegendaryEquipped(129)local aj=g:HasLegendaryEquipped(116)local ak=g:HasLegendaryEquipped(127)local al=g:HasLegendaryEquipped(117)local am=g:HasLegendaryEquipped(126)local an=g:HasLegendaryEquipped(229)or g:HasUnity()and X.Flagellation:IsAvailable()local ao=g:HasLegendaryEquipped(231)or g:HasUnity()and X.EchoingReprimand:IsAvailable()local ap=g:HasTier(28,2)d:RegisterForEvent(function()ai=g:HasLegendaryEquipped(129)aj=g:HasLegendaryEquipped(116)ak=g:HasLegendaryEquipped(127)al=g:HasLegendaryEquipped(117)am=g:HasLegendaryEquipped(126)an=g:HasLegendaryEquipped(229)or g:HasUnity()and X.Flagellation:IsAvailable()ao=g:HasLegendaryEquipped(231)or g:HasUnity()and X.EchoingReprimand:IsAvailable()ap=g:HasTier(28,2)end,"PLAYER_EQUIPMENT_CHANGED")local function aq(self,ar,as,at,au)if as==UnitGUID("player")then local av,aw,ax,ay,az,aA,aB,aC,aD,aE,aF,au,aG,aH,aI,aJ,aK,aL,aM,aN,aO,aP,aQ,aR=CombatLogGetCurrentEventInfo()if aw=="SWING_DAMAGE"and av>Q then Q=av;P=P+1 elseif aw=="SPELL_ENERGIZE"and ay==UnitGUID("player")and au==196911 then Q=av;P=0 end end end;local aS=CreateFrame("Frame")aS:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED")aS:SetScript("OnEvent",aq)X.Eviscerate:RegisterDamageFormula(function()return g:AttackPowerDamageMod()*ae*0.176*1.21*(X.Nightstalker:IsAvailable()and g:StealthUp(true,false)and 1.12 or 1)*(X.DeeperStratagem:IsAvailable()and 1.05 or 1)*(X.DarkShadow:IsAvailable()and g:BuffUp(X.ShadowDanceBuff)and 1.3 or 1)*(not X.DarkShadow:IsAvailable()and g:BuffUp(X.ShadowDanceBuff)and 1.15 or 1)*(g:BuffUp(X.SymbolsofDeath)and 1.15 or 1)*(g:BuffUp(X.FinalityEviscerate)and 1.25 or 1)*(1+g:MasteryPct()/100)*(1+g:VersatilityDmgPct()/100)*(h:DebuffUp(X.FindWeaknessDebuff)and 1.5 or 1)*(h:DebuffUp(X.SinfulRevelationDebuff)and 1.06 or 1)end)X.Rupture:RegisterPMultiplier(function()return X.Nightstalker:IsAvailable()and g:StealthUp(true,false)and 1.12 or 1 end)local aT={General=m.GUISettings.General,Commons=m.GUISettings.APL.Rogue.Commons,Subtlety=m.GUISettings.APL.Rogue.Subtlety}local function aU(aV,EnergyThreshold)if not a7 then a7=aV;a8=EnergyThreshold or 0 end end;local function aW(aV)if not a9 then a9=aV end end;local function aX()if aT.Subtlety.BurnShadowDance=="On Bosses not in Dungeons"and g:IsInDungeonArea()then return false elseif aT.Subtlety.BurnShadowDance~="Always"and not h:IsInBossList()then return false else return true end end;local function aY(af)ae=af;if af==2 and g:BuffUp(X.EchoingReprimand2)or af==3 and g:BuffUp(X.EchoingReprimand3)or af==4 and g:BuffUp(X.EchoingReprimand4)or af==5 and g:BuffUp(X.EchoingReprimand5)then ae=7;return 7 else ae=af;return af end;local aZ,a_=UnitAttackSpeed("unit")local b0=(aZ+a_)/2;local b1=b0/2;local b2=(4-P)*b1;local b3=(5-P)*b1;if ae>af and ag>2 and g:AffectingCombat()then if af==2 and not g:BuffUp(X.EchoingReprimand3)or af==3 and not g:BuffUp(X.EchoingReprimand4)or af==4 and not g:BuffUp(X.EchoingReprimand5)then local b4=b2;if b4==0 then b4=b3 end;if b4<T(g:EnergyTimeToX(35),g:GCDRemains())+0.5 then ae=af end end end end;local function b5()if a2<2 then return false elseif aT.Commons.UsePriorityRotation=="Always"then return true elseif aT.Commons.UsePriorityRotation=="On Bosses"and h:IsInBossList()then return true elseif aT.Commons.UsePriorityRotation=="Auto"then if g:InstanceDifficulty()==16 and h:NPCID()==138967 then return true elseif h:NPCID()==166969 or h:NPCID()==166971 or h:NPCID()==166970 then return true end end;return false end;local function b6(b7,b8,b9,ba)local bb,bc=nil,b9;local bd=h:GUID()for be,bf in pairs(ba)do if bf:GUID()~=bd and V.UnitIsCycleValid(bf,bc,-bf:DebuffRemains(b7))and b8(bf)then bb,bc=bf,bf:TimeToDie()end end;if bb then m.CastLeftNameplate(bb,b7)if bb:GUID()==f("mouseover"):GUID()and aT.Subtlety.TargetSwap=="Mouseover"then if b7==X.Rupture then a6=11943 elseif b7==X.SerratedBoneSpike then a6=1328547 end elseif aT.Subtlety.TargetSwap=="AutoSwap"and bb:GUID()~=h:GUID()and not s then a6=9999 end elseif false then bb,bc=nil,b9;for be,bf in pairs(a1)do if bf:GUID()~=bd and V.UnitIsCycleValid(bf,bc,-bf:DebuffRemains(b7))and b8(bf)then bb,bc=bf,bf:TimeToDie()end end;if bb then m.CastLeftNameplate(bb,b7)if bb:GUID()==f("mouseover"):GUID()and aT.Subtlety.TargetSwap=="Mouseover"then if b7==X.Rupture then a6=11943 elseif b7==X.SerratedBoneSpike then a6=1328547 end elseif aT.Subtlety.TargetSwap=="AutoSwap"and bb:GUID()~=h:GUID()and not s then a6=9999 end end end end;local function bg(bh)if bh then return 1 else return 0 end end;local function bi(bj)return bj:DebuffRemains(X.FindWeaknessDebuff)end;local function bk(bj)if not ah and bj:DebuffRemains(X.FindWeaknessDebuff)<1 and a2<=3 and bj:TimeToDie()>6 and bj:IsInRange(8)and bj:GUID()==f("mouseover"):GUID()and aT.Subtlety.TargetSwap=="Mouseover"then a6=1185438;return true elseif not ah and bj:DebuffRemains(X.FindWeaknessDebuff)<1 and a2<=3 and bj:TimeToDie()>6 and bj:IsInRange(8)and aT.Subtlety.TargetSwap=="AutoSwap"and bj:GUID()~=h:GUID()and not s then a6=9999;return true elseif not ah and bj:DebuffRemains(X.FindWeaknessDebuff)<1 and a2<=3 and bj:TimeToDie()>6 and bj:IsInRange(8)and bj:GUID()==h:GUID()then a5=185438;return true elseif not ah and bj:DebuffRemains(X.FindWeaknessDebuff)<1 and a2<=3 and bj:TimeToDie()>6 and bj:IsInRange(8)then return true end end;local function bl()return 25+bg(X.Vigor:IsAvailable())*20+bg(X.MasterofShadows:IsAvailable())*20+bg(X.ShadowFocus:IsAvailable())*25+bg(X.Alacrity:IsAvailable())*20+bg(a2>=4)*25 end;local function bm()return X.ShadowDance:ChargesFractional()>=1.75 end;local function bn()if a2==4 then return ag<=1 elseif ah and a2>=4 then return ag<=1 elseif X.EchoingReprimand:IsAvailable()then return ag>=3 else return ag>=2+bg(g:BuffUp(X.ShadowBlades))end end;local function bo()return g:BuffUp(X.SliceandDice)or a2>=6 end;local function bp()return X.Premeditation:IsAvailable()and a2<5-bg(X.SerratedBoneSpike:IsAvailable())and not X.EchoingReprimand:IsAvailable()end;local function bq(br)return W.MasterAssassinsMarkRemains()>0 or not X.Nightstalker:IsAvailable()and X.DarkShadow:IsAvailable()and br or a2>=4-l(g:StealthUp(true,true)or br)*l(X.ShadowFocus:IsAvailable())end;local function bs()local br=g:BuffUp(X.ShadowDanceBuff)or StealthSpell and StealthSpell:ID()==X.ShadowDance:ID()af=g:ComboPoints()ae=aY(af)if X.SliceandDice:IsCastable(BypassRecovery)then if not bp()and a2<6 and not g:BuffUp(X.ShadowDanceBuff)and d.FilteredFightRemains(a1,">",g:BuffRemains(X.SliceandDice))and g:BuffRefreshable(X.SliceandDice)then if X.SliceandDice:IsReady(BypassRecovery)and m.Cast(X.SliceandDice)then a5=5171;return"Cast Slice and Dice (not Premed)"end end;if bp()and X.ShadowDance:ChargesFractional()<1.75 and g:BuffRemains(X.SliceandDice)<X.SymbolsofDeath:CooldownRemains()and(X.ShadowDance:CooldownRemains()<=0 and g:BuffRemains(X.SymbolsofDeath)-g:BuffRemains(X.ShadowDanceBuff)<1.2)then if X.SliceandDice:IsReady(BypassRecovery)and m.Cast(X.SliceandDice)then a5=5171;return"Cast Slice and Dice (Premed)"end end end;local bt=bq(br)if(not bt or ah)and X.Rupture:IsCastable()and not(g:StealthUp(true,true)or br)then if h:IsInMeleeRange(8)and(h:FilteredTimeToDie(">",12,-h:DebuffRemains(X.Rupture))or h:TimeToDieIsNotValid())and W.CanDoTUnit(h,ad)and h:DebuffRefreshable(X.Rupture,ac)then if X.Rupture:IsReady(BypassRecovery)and m.Cast(X.Rupture)then a5=1943;return"Cast Rupture 1"end end end;if X.SecretTechnique:IsReady(BypassRecovery)then if m.Cast(X.SecretTechnique)then a5=280719;return"Cast Secret Technique"end end;if not bt and X.Rupture:IsCastable(BypassRecovery)then if not bt and not ah and a2>=2 then local function bu(bj)return V.CanDoTUnit(bj,ad)and bj:DebuffRefreshable(X.Rupture,ac)end;b6(X.Rupture,bu,5+2*ae,a3)end;if h:IsInMeleeRange(5)and h:DebuffRemains(X.Rupture)<X.SymbolsofDeath:CooldownRemains()+10 and(X.SymbolsofDeath:CooldownRemains()<=5 or not M)and W.CanDoTUnit(h,ad)and h:FilteredTimeToDie(">",11+X.SymbolsofDeath:CooldownRemains(),-h:DebuffRemains(X.Rupture))then if X.Rupture:IsReady(BypassRecovery)and m.Cast(X.Rupture)then a5=1943;return"Cast Rupture 2"end end end;if X.BlackPowder:IsCastable(BypassRecovery)and not ah and a2>=3 and not u then if X.BlackPowder:IsReady(BypassRecovery)and m.Cast(X.BlackPowder)then a5=319175;return"Cast Black Powder"end end;if X.Eviscerate:IsCastable()and h:IsInMeleeRange(8)then if X.Eviscerate:IsReady(BypassRecovery)and m.Cast(X.Eviscerate)then a5=196819;return"Cast Eviscerate"end end end;local function bv()local bw=g:BuffUp(aa)or StealthSpell and StealthSpell:ID()==aa:ID()local VanishBuffCheck=g:BuffUp(ab)or StealthSpell and StealthSpell:ID()==X.Vanish:ID()local br=g:BuffUp(X.ShadowDanceBuff)or StealthSpell and StealthSpell:ID()==X.ShadowDance:ID()local bx=X.Shadowstrike:IsCastable()or bw or VanishBuffCheck or br;af=g:ComboPoints()ae=aY(af)if bx and h:IsInMeleeRange(aT.Subtlety.ShadowStrikeRange)and(bw or VanishBuffCheck)and(a2<4 or ah)and W.MasterAssassinsMarkRemains()==0 then if m.Cast(X.Shadowstrike,nil,nil)then a5=185438;return"Cast Shadowstrike (Stealth)"end end;if ae>=W.CPMaxSpend()or ae>=5 and g:BuffUp(X.ShurikenTornado)then return bs()end;if g:BuffUp(X.ShurikenTornado)and ag<=2 then return bs()end;if a2>=4 and ae>=4 then return bs()end;if ag<=1-bg(X.DeeperStratagem:IsAvailable()and VanishBuffCheck)then return bs()end;if bx and h:IsInMeleeRange(aT.Subtlety.ShadowStrikeRange)and not g:StealthUp(true,false)and g:BuffUp(X.SepsisBuff)and a2<4 then if m.Cast(X.Shadowstrike,nil,nil)then a5=185438;return"Cast Shadowstrike (Sepsis)"end end;if g:BuffStack(X.PerforatedVeinsBuff)>=5 and g:BuffRemains(X.ShadowDanceBuff)>=3 and g:BuffUp(X.ShadowBlades)and a2<=3 then if m.Cast(X.Backstab)then a5=53;return"Cast Backstab (Stealth PV)"end end;if X.Shiv:IsReady()and aj and X.Nightstalker:IsAvailable()and a2<5 then if m.Cast(X.Shiv)then a5=5938;return"Cast Shiv (TTB NS)"end end;if X.Shadowstrike:IsCastable()then if not ah and h:DebuffRemains(X.FindWeaknessDebuff)<1 and a2<=3 and d.BossFilteredFightRemains("<=",5)then if m.Cast(X.Shadowstrike)then a5=185438;return"Cast Shadowstrike (Prio Rotation)"end end;if V.CastTargetIf(X.Shadowstrike,MeleeEnemies8y,"min",bi,bk)then return"Find the Weakness/ShadowStrike 26"end end;if bx and h:IsInMeleeRange(aT.Subtlety.ShadowStrikeRange)and ah and(h:DebuffRemains(X.FindWeaknessDebuff)<1 or X.Weaponmaster:IsAvailable()and a2<=4)then if m.Cast(X.Shadowstrike)then a5=185438;return"Cast Shadowstrike (Prio Rotation)"end end;if X.ShurikenStorm:IsCastable()and ae<W.CPMaxSpend()and a2>=3+bg(g:BuffUp(X.TheRottenBuff)or ak or ap)and(g:BuffUp(X.SymbolsofDeathCrit)or not g:BuffUp(X.PremeditationBuff)or a2>=5 and ae<W.CPMaxSpend())then if m.Cast(X.ShurikenStorm)then a5=197835;return"Cast Shuriken Storm"end end;if bx and ae<W.CPMaxSpend()and h:IsInMeleeRange(aT.Subtlety.ShadowStrikeRange)and(h:DebuffRemains(X.FindWeaknessDebuff)<1 or X.SymbolsofDeath:CooldownRemains()<18 and M and h:DebuffRemains(X.FindWeaknessDebuff)<X.SymbolsofDeath:CooldownRemains())then if m.Cast(X.Shadowstrike)then a5=185438;return"Cast Shadowstrike (FW Refresh)"end end;if bx and ae<W.CPMaxSpend()and h:IsInMeleeRange(aT.Subtlety.ShadowStrikeRange)then if m.Cast(X.Shadowstrike)then a5=185438;return"Cast Shadowstrike 2"end end end;local function by()local bz=bv(true,StealthSpell)af=g:ComboPoints()ae=aY(af)if StealthSpell==X.Vanish and(not aT.Subtlety.StealthMacro.Vanish or not bz)and aT.Commons.VanishOffensive and L then if m.Cast(X.Vanish,nil)then a5=1213;return"Cast Vanish"end;return false elseif StealthSpell==X.Shadowmeld and(not aT.Subtlety.StealthMacro.Shadowmeld or not bz)and aT.Commons.Enabled.Racials then if m.Cast(X.Shadowmeld,nil)then a5=1214;return"Cast Shadowmeld"end;return false elseif StealthSpell==X.ShadowDance and(not aT.Subtlety.StealthMacro.ShadowDance or not bz)and K then if m.Cast(X.ShadowDance,nil)then a5=1212;return"Cast Shadow Dance"end;return false end;local bA={StealthSpell,bz}if EnergyThreshold and g:EnergyPredicted()<EnergyThreshold then return false end;if bA[1]==X.ShadowDance and bA[2]==X.DeathfromAbove then a4=m.CastQueue(bA[2],bA[1])if a4 then return"| "..bA[1]:Name()end end;return false end;local function bB()af=g:ComboPoints()ae=aY(af)if g:BuffUp(X.ShurikenTornado)then if X.ShadowDance:IsCastable()and K and not g:BuffUp(X.ShadowDanceBuff)and g:BuffRemains(X.ShurikenTornado)<=3.5 then if m.Cast(X.ShadowDance)then a5=185313;return"Cast Shadow Dance (during Tornado)"end end;if X.SymbolsofDeath:IsCastable()and M and g:BuffRemains(X.ShurikenTornado)<=3.5 then if m.Cast(X.SymbolsofDeath)then a5=212283;return"Cast Symbols of Death(during Tornado)"end end end;local bC=bo()if h:IsInMeleeRange(8)then if p and X.Flagellation:IsReady()and bC and not g:StealthUp(false,false)and af>=5 and(a2<=1 and X.SymbolsofDeath:CooldownUp()and not X.ShadowFocus:IsAvailable()or g:BuffUp(X.SymbolsofDeath))then if m.Cast(X.Flagellation,nil,nil)then a5=323654;return"Cast Flrgrrlation"end end end;if L and X.Vanish:IsCastable()and not v and aT.Commons.VanishOffensive and(al and ag<=1-bg(X.DeeperStratagem:IsAvailable()or ai and ae<1))and g:BuffUp(X.SymbolsofDeath)and g:BuffUp(X.ShadowDanceBuff)and W.MasterAssassinsMarkRemains()==0 and g:BuffDown(X.DeathlyShadowsBuff)then if m.Cast(X.Vanish,nil,nil)then a5=1856;return"Vanish Macro"end end;if X.ShurikenTornado:IsCastable()and N and not D and(g:Energy()<60 and not X.ShadowFocus:IsAvailable()and bC and X.SymbolsofDeath:CooldownUp()and X.ShadowDance:Charges()>=1 and N and(not an or h:DebuffUp(X.Flagellation)or a2>=1+4*bg(not X.Nightstalker:IsAvailable()and not X.DarkShadow:IsAvailable()))and ae<=2 and(not g:BuffUp(X.PremeditationBuff)or a2>4)and(not X.Flagellation:IsAvailable()or X.Flagellation:IsAvailable()and not X.Flagellation:CooldownUp()))then if m.CastPooling(X.ShurikenTornado)then a5=1000;return"Pool for Shuriken Tornado"end end;if X.ShurikenTornado:IsCastable()and N and not D and(g:Energy()>=60 and bC and(X.SymbolsofDeath:CooldownUp()or not M)and X.ShadowDance:Charges()>=1 and(not an or h:DebuffUp(X.Flagellation)or a2>=1+4*bg(not X.Nightstalker:IsAvailable()and not X.DarkShadow:IsAvailable()))and af<=2 and(not g:BuffUp(X.PremeditationBuff)or a2>4)and(not X.Flagellation:IsAvailable()or X.Flagellation:IsAvailable()and not X.Flagellation:CooldownUp()))then if m.Cast(X.ShurikenTornado)then a5=277925;return"Cast Shuriken Tornado"end end;if X.SerratedBoneSpike:IsReady()and g:AffectingCombat()and(bC or d.BossFilteredFightRemains("<=",5)and a2<3)and not g:BuffUp(X.PremeditationBuff)and not g:BuffUp(X.ShurikenTornado)then local function bD(bj)return not bj:DebuffUp(X.SerratedBoneSpikeDebuff)end;if(h:IsInRange(30)and g:AffectingCombat()or h:IsInRange(20))and bD(h)and h:FilteredTimeToDie(">",21)then if m.Cast(X.SerratedBoneSpike,nil,nil)then a5=328547;return"Cast Serrated Bone Spike (ST)"end end;if m.AoEON()then b6(X.SerratedBoneSpike,bD,21,a0)end end;if h:IsInMeleeRange(8)then if p and X.Sepsis:IsReady()and bC and ag>=1 and not h:FilteredTimeToDie("<",16)then if m.Cast(X.Sepsis,nil,nil)then a5=328305;return"Cast Sepsis"end end;if X.SymbolsofDeath:IsCastable()and bC and M and(not X.ShurikenTornado:IsAvailable()or X.ShadowFocus:IsAvailable()or a2>=2 or X.ShurikenTornado:CooldownRemains()>2 or N)and(not X.Flagellation:IsAvailable()or(X.Flagellation:CooldownRemains()>10 or not p)or X.Flagellation:CooldownUp()and p and ae>=5)then if m.Cast(X.SymbolsofDeath,nil)then a5=212283;return"Cast Symbols of Death"end end end;if X.MarkedforDeath:IsCastable()then if h:FilteredTimeToDie("<",ag)then if m.Cast(X.MarkedforDeath,nil)then a5=137619;return"Cast Marked for Death"end end;if not g:StealthUp(true,true)and ag>=W.CPMaxSpend()then if O then if m.Cast(X.MarkedforDeath,nil)then a5=137619;return"Cast Marked for Death"end end end;if a2==1 and ag>=W.CPMaxSpend()then if m.Cast(X.MarkedforDeath,nil)then a5=137619;return"Cast Marked for Death"end end end;if m.CDsON()or not m.CDsON()then if X.ShadowBlades:IsCastable()and bC and ag>=2 and J and(g:BuffUp(X.SymbolsofDeath)or d.BossFilteredFightRemains("<=",20)or not g:BuffUp(X.ShadowBlades)and ap)then if m.Cast(X.ShadowBlades,nil)then a5=121471;return"Cast Shadow Blades"end end;if X.EchoingReprimand:IsReady()and p and h:IsInMeleeRange(5)and not g:StealthUp(true,true)and bC and ag>=2 and(ah or a2<=4 or ao)then if m.Cast(X.EchoingReprimand,nil,nil)then a5=323547;return"Cast Echoing Reprimand"end end;if X.ShurikenTornado:IsReady()and N and not D and((X.ShadowFocus:IsAvailable()or a2>=2)and bC and(g:BuffUp(X.SymbolsofDeath)or not M)and ae<=2 and(not g:BuffUp(X.PremeditationBuff)or a2>4))then if m.Cast(X.ShurikenTornado)then a5=277925;return"Cast Shuriken Tornado (SF)"end end;if X.ShadowDance:IsCastable()and(aX()or K)and not g:BuffUp(X.ShadowDanceBuff)and d.BossFilteredFightRemains("<=",8+bg(X.Subterfuge:IsAvailable()))then a4=by(X.ShadowDance)if a4 then return"Shadow Dance Macro (Low TTD) "..a4 end end;if Y.PotionofSpectralAgility:IsReady()and o()and aT.Commons.Enabled.Potions and t and(g:BloodlustUp()and m.GUISettings.General.HoldPotforBL or(d.BossFilteredFightRemains("<",30)or g:BuffUp(X.SymbolsofDeath)and(g:BuffUp(X.ShadowBlades)or X.ShadowBlades:CooldownRemains()<=10 and J))and not m.GUISettings.General.HoldPotforBL)then if m.Cast(Y.PotionofSpectralAgility,nil)then a5=500;return"potion cooldowns 2"end end;if g:BuffUp(X.SymbolsofDeath)then if X.BloodFury:IsCastable()and aT.Commons.Enabled.Racials then if m.Cast(X.BloodFury,nil)then a5=20572;return"Cast Blood Fury"end end;if X.Berserking:IsCastable()and aT.Commons.Enabled.Racials then if m.Cast(X.Berserking,nil)then a5=26297;return"Cast Berserking"end end;if X.Fireblood:IsCastable()and aT.Commons.Enabled.Racials then if m.Cast(X.Fireblood,nil)then a5=265221;return"Cast Fireblood"end end;if X.AncestralCall:IsCastable()and aT.Commons.Enabled.Racials then if m.Cast(X.AncestralCall,nil)then a5=274738;return"Cast Ancestral Call"end end end;if(aT.Commons.Enabled.TopTrinket or aT.Commons.Enabled.BottomTrinket)and o()then local bE=g:GetUseableTrinkets(OnUseExcludes)if Y.CacheOfAcquiredTreasures:IsEquippedAndReady()then if g:BuffUp(X.AcquiredAxe)and a2>1 then if Y.CacheOfAcquiredTreasures:ID()==Z and aT.Commons.Enabled.TopTrinket then a5=24;return"top trinket Cache Axe for AoE"elseif Y.CacheOfAcquiredTreasures:ID()==_ and aT.Commons.Enabled.BottomTrinket then a5=25;return"bot trinket Cache Axe for AoE"end elseif g:BuffUp(X.AcquiredWand)and(a2==1 and h:IsInBossList()or d.BossFilteredFightRemains("<",20))then if Y.CacheOfAcquiredTreasures:ID()==Z and aT.Commons.Enabled.TopTrinket then a5=24;return"top trinket Cache Wand for ST"elseif Y.CacheOfAcquiredTreasures:ID()==_ and aT.Commons.Enabled.BottomTrinket then a5=25;return"bot trinket Cache Wand for ST"end end end;local bF=g:BuffUp(X.SymbolsofDeath)or d.BossFilteredFightRemains("<",20)if bF then if bE then if m.Cast(bE,nil,nil)then if bE:ID()==Z and aT.Commons.Enabled.TopTrinket then a5=24;return"Generic use_items for "..bE:Name()elseif bE:ID()==_ and aT.Commons.Enabled.BottomTrinket then a5=25;return"Generic use_items for "..bE:Name()end end end end end end end;local function bG()af=g:ComboPoints()ae=aY(af)if(m.CDsON()or not m.CDsON())and X.ShadowDance:TimeSinceLastDisplay()>0.3 and X.Shadowmeld:TimeSinceLastDisplay()>0.3 then if X.Vanish:IsCastable()and L and not v and aT.Commons.VanishOffensive and(not bm()or not X.Nightstalker:IsAvailable()and X.DarkShadow:IsAvailable())and ag>1 and not al then if m.Cast(X.Vanish,nil,nil)then a5=1856;return"Vanish Stealth CD"end end;if g:Energy()<40 and X.Shadowmeld:IsCastable()then if m.CastPooling(X.Shadowmeld,g:EnergyTimeToX(40))then a5=1000;return"Pool for Shadowmeld"end end;if X.Shadowmeld:IsCastable()and h:IsInMeleeRange(5)and not g:IsMoving()and aT.Commons.Enabled.Racials and g:Energy()>=40 and g:EnergyDeficitPredicted()>=10 and not bm()and ag>1 then if m.Cast(X.Shadowmeld,nil,nil)then a5=58984;return"Shadowmeld Stealth CD"end end end;if h:IsInMeleeRange(5)and X.ShadowDance:IsCastable()and K and X.Vanish:TimeSinceLastDisplay()>0.3 and X.Shadowmeld:TimeSinceLastDisplay()>0.3 then if ap and Covenant=="Kyrian"and(bn()or bm())or(bn()and(g:BuffRemains(X.SymbolsofDeath)>=1.2 or bm())or g:BuffUp(X.ChaosBaneBuff)or a2>=4 and X.SymbolsofDeath:CooldownRemains()>10)and(g:BuffStack(X.PerforatedVeinsBuff)<4 or a2>3)then if m.Cast(X.ShadowDance)then a5=185313;return" Shadow Dance Stealth CD"end end;if aX()and(bn()and d.BossFilteredFightRemains("<",X.SymbolsofDeath:CooldownRemains())or not M or not X.EnvelopingShadows:IsAvailable())and K then if m.Cast(X.ShadowDance)then a5=185313;return" Shadow Dance Stealth CD"end end end end;local function bH()af=g:ComboPoints()ae=aY(af)local bI=not EnergyThreshold or g:EnergyPredicted()>=EnergyThreshold;if X.Shiv:IsCastable()and aj and not X.Nightstalker:IsAvailable()and a2<5 then if m.Cast(X.Shiv)then a5=5938;return"Cast Shiv (TTB)"end end;if X.ShurikenStorm:IsCastable()and a2>=2 and(not X.SerratedBoneSpike:IsAvailable()or(X.SerratedBoneSpike:MaxCharges()-X.SerratedBoneSpike:ChargesFractional()>=0.25 or a2>4)and g:BuffStack(X.PerforatedVeinsBuff)<=4 or a2>4)then if m.Cast(X.ShurikenStorm)then a5=197835;return"Cast Shuriken Storm"end end;if X.SerratedBoneSpike:IsCastable()and g:AffectingCombat()and g:BuffStack(X.PerforatedVeinsBuff)<=2 and(X.SerratedBoneSpike:MaxCharges()-X.SerratedBoneSpike:ChargesFractional()<=0.25 or(X.LeadbyExample:SoulbindEnabled()and not g:BuffUp(X.LeadbyExampleBuff)or X.KevinsOozeling:SoulbindEnabled()and not h:DebuffUp(X.KevinsWrathDebuff))and not d.BossFightRemainsIsNotValid())then if bI and m.Cast(X.SerratedBoneSpike,nil,nil)then a5=328547;return"Cast Serrated Bone Spike (Capping Filler)"end end;if h:IsInMeleeRange(8)then if Covenant=="Kyrian"and g:Energy()<60 and(af==2 and g:BuffUp(X.EchoingReprimand3)or af==3 and g:BuffUp(X.EchoingReprimand4)or af==4 and g:BuffUp(X.EchoingReprimand5))and(W.TimeToSht(3)<0.5 or W.TimeToSht(4)<1.0 or W.TimeToSht(5)<1.0)then if m.Cast(X.PoolEnergy)then a5=1000;return"ER Generator Pooling"end end;if X.Gloomblade:IsCastable()then if bI and m.Cast(X.Gloomblade)then a5=200758;return"Cast Gloomblade"end elseif X.Backstab:IsCastable()then if bI and m.Cast(X.Backstab)then a5=53;return"Cast Backstab"end end end end;local bJ={{X.Blind,"Cast Blind (Interrupt)",function()return true end},{X.KidneyShot,"Cast Kidney Shot (Interrupt)",function()return ae>0 end},{X.CheapShot,"Cast Cheap Shot (Interrupt)",function()return g:StealthUp(true,true)end}}local function bK()r=HeroRotationCharDB.Toggles[6]p=HeroRotationCharDB.Toggles[4]q=HeroRotationCharDB.Toggles[5]s=HeroRotationCharDB.Toggles[12]t=HeroRotationCharDB.Toggles[15]u=HeroRotationCharDB.Toggles[20]v=HeroRotationCharDB.Toggles[21]w=HeroRotationCharDB.Toggles[22]x=HeroRotationCharDB.Toggles[23]y=HeroRotationCharDB.Toggles[24]z=HeroRotationCharDB.Toggles[25]A=HeroRotationCharDB.Toggles[26]B=HeroRotationCharDB.Toggles[27]C=HeroRotationCharDB.Toggles[28]D=HeroRotationCharDB.Toggles[29]E=HeroRotationCharDB.Toggles[30]F=HeroRotationCharDB.Toggles[54]J=false;K=false;L=false;M=false;O=true;N=false;if aT.Subtlety.IncludedCooldowns.ShadowBlades and o()or aT.Subtlety.IncludedSmallCooldowns.ShadowBlades and(o()or q)or not aT.Subtlety.IncludedSmallCooldowns.ShadowBlades and not aT.Subtlety.IncludedCooldowns.ShadowBlades then J=true end;if aT.Subtlety.IncludedCooldowns.ShadowDance and o()or aT.Subtlety.IncludedSmallCooldowns.ShadowDance and(o()or q)or not aT.Subtlety.IncludedSmallCooldowns.ShadowDance and not aT.Subtlety.IncludedCooldowns.ShadowDance then K=true end;if aT.Subtlety.IncludedCooldowns.Vanish and o()or aT.Subtlety.IncludedSmallCooldowns.Vanish and(o()or q)or not aT.Subtlety.IncludedSmallCooldowns.Vanish and not aT.Subtlety.IncludedCooldowns.Vanish then L=true end;if aT.Subtlety.IncludedCooldowns.SymbolsofDeath and o()or aT.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and(o()or q)or not aT.Subtlety.IncludedSmallCooldowns.SymbolsofDeath and not aT.Subtlety.IncludedCooldowns.SymbolsofDeath then M=true end;if aT.Subtlety.IncludedCooldowns.ShurikenTornado and o()or aT.Subtlety.IncludedSmallCooldowns.ShurikenTornado and(o()or q)or not aT.Subtlety.IncludedSmallCooldowns.ShurikenTornado and not aT.Subtlety.IncludedCooldowns.ShurikenTornado then N=true end;Z=GetInventoryItemID("player",13)_=GetInventoryItemID("player",14)if not aT.Commons.Enabled.TopTrinket and not aT.Commons.Enabled.BotTrinket then OnUseExcludes={Z,_,Y.MistcallerOcarina:ID(),Y.CacheOfAcquiredTreasures:ID()}elseif not aT.Commons.Enabled.TopTrinket and aT.Commons.Enabled.BotTrinket then OnUseExcludes={Z,Y.MistcallerOcarina:ID(),Y.CacheOfAcquiredTreasures:ID()}elseif not aT.Commons.Enabled.BotTrinket and aT.Commons.Enabled.TopTrinket then OnUseExcludes={_,Y.MistcallerOcarina:ID(),Y.CacheOfAcquiredTreasures:ID()}end end;local function bL()if X.Subterfuge:IsAvailable()then aa=X.Stealth2;ab=X.VanishBuff2 else aa=X.Stealth;ab=X.VanishBuff end;a7=nil;a9=nil;a8=0;if n()then a0=g:GetEnemiesInRange(30)MeleeEnemies8y=g:GetEnemiesInMeleeRange(8)a1=g:GetEnemiesInMeleeRange(10)a2=#a1;a3=g:GetEnemiesInMeleeRange(5)else a0={}a1={}a2=0;a3={}end;af=g:ComboPoints()ae=aY(af)ag=g:ComboPointsDeficit()ah=b5()a4=bK()if a4 then return a4 end;if a6>0 then a6=0 end;if a5>0 then a5=0 end;a5=W.ReturnSpell()a6=W.ReturnSpellMO()if m.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[6]then H=GetTime()I=H+m.GUISettings.General.OpenerReset elseif m.GUISettings.General.OpenerReset>0 and I~=nil and GetTime()>I and HeroRotationCharDB.Toggles[6]then HeroRotationCharDB.Toggles[6]=not HeroRotationCharDB.Toggles[6]m.ToggleIconFrame:UpdateButtonText(6)m.Print("Opener is now "..(HeroRotationCharDB.Toggles[6]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end;if w and X.CheapShot:IsUsableP()and X.CheapShot:CooldownRemains(BypassRecovery)<=0 and g:StealthUp(true,true)and not g:PrevGCD(1,X.CheapShot)then if m.Cast(X.CheapShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.CheapShot)then a6=11833;return"queue Cheap Shot MO"else a5=1833;return"queue Cheap Shot"end end elseif(not X.CheapShot:IsUsableP()or X.CheapShot:CooldownRemains()>0 or g:PrevGCD(1,X.CheapShot))and w then HeroRotationCharDB.Toggles[22]=not HeroRotationCharDB.Toggles[22]m.Print("Cheap Shot Queue is now "..(HeroRotationCharDB.Toggles[22]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if x and X.KidneyShot:IsUsableP()and X.KidneyShot:CooldownRemains(BypassRecovery)<=0 then if m.Cast(X.KidneyShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.KidneyShot)then a6=1408;return"queue Kidney Shot MO"else a5=408;return"queue Kidney Shot"end end elseif g:PrevGCD(1,X.KidneyShot)and x then HeroRotationCharDB.Toggles[23]=not HeroRotationCharDB.Toggles[23]m.Print("Kidney Shot Queue is now "..(HeroRotationCharDB.Toggles[23]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if y and X.Blind:IsUsableP()and X.Blind:CooldownRemains(BypassRecovery)<=0 then if m.Cast(X.Blind,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.Blind)then a6=12094;return"queue Blind MO"end end elseif(not X.Blind:IsUsableP()or X.Blind:CooldownRemains()>0)and y then HeroRotationCharDB.Toggles[24]=not HeroRotationCharDB.Toggles[24]m.Print("Blind Queue is now "..(HeroRotationCharDB.Toggles[24]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if z and X.Sap:IsUsableP()and X.Sap:CooldownRemains(BypassRecovery)<=0 then if m.Cast(X.Sap,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(X.Sap)then a6=16770;return"queue Sap MO"else a5=6770;return"queue Sap"end end elseif(not X.Sap:IsUsableP()or X.Sap:CooldownRemains()>0)and z then HeroRotationCharDB.Toggles[25]=not HeroRotationCharDB.Toggles[25]m.Print("Sap Queue is now "..(HeroRotationCharDB.Toggles[25]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if A and X.ShurikenTornado:IsUsableP()and X.ShurikenTornado:CooldownRemains(BypassRecovery)<=0 then if m.Cast(X.ShurikenTornado,nil,nil,nil)then a5=277925;return"queue Shuriken Tornado"end elseif(not X.ShurikenTornado:IsUsableP()or X.ShurikenTornado:CooldownRemains()>0)and A then HeroRotationCharDB.Toggles[26]=not HeroRotationCharDB.Toggles[26]m.Print("Shuriken Tornado Queue is now "..(HeroRotationCharDB.Toggles[26]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if B and X.Feint:IsUsableP()and X.Feint:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.Feint,nil,nil,nil)then a5=202;return"queue Shuriken Tornado"end elseif(not X.Feint:IsUsableP()or X.Feint:CooldownRemains()>0 or not g:AffectingCombat())and B then HeroRotationCharDB.Toggles[27]=not HeroRotationCharDB.Toggles[27]m.Print("Feint Queue is now "..(HeroRotationCharDB.Toggles[27]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if C and X.Flagellation:IsUsableP()and X.Flagellation:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.Flagellation,nil,nil,nil)then a5=323654;return"queue Flagellation Queue"end elseif(not X.Flagellation:IsUsableP()or X.Flagellation:CooldownRemains()>0 or not g:AffectingCombat())and C then HeroRotationCharDB.Toggles[28]=not HeroRotationCharDB.Toggles[28]m.Print("Flagellation Queue is now "..(HeroRotationCharDB.Toggles[28]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if E then if X.ArcaneTorrent:IsAvailable()and X.ArcaneTorrent:IsUsableP()and X.ArcaneTorrent:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.ArcaneTorrent,nil,nil,nil)then a5=155145;return"queue ArcaneTorrent Queue"end elseif X.LightsJudgment:IsAvailable()and X.LightsJudgment:IsUsableP()and X.LightsJudgment:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.LightsJudgment,nil,nil,nil)then a5=255647;return"queue ArcaneTorrent Queue"end elseif X.BagofTricks:IsAvailable()and X.BagofTricks:IsUsableP()and X.BagofTricks:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.BagofTricks,nil,nil,nil)then a5=312411;return"queue ArcaneTorrent Queue"end elseif X.BloodFury:IsAvailable()and X.BloodFury:IsUsableP()and X.BloodFury:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.BloodFury,nil,nil,nil)then a5=20572;return"queue ArcaneTorrent Queue"end elseif X.Berserking:IsAvailable()and X.Berserking:IsUsableP()and X.Berserking:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.Berserking,nil,nil,nil)then a5=26297;return"queue ArcaneTorrent Queue"end elseif X.Fireblood:IsAvailable()and X.Fireblood:IsUsableP()and X.Fireblood:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.Fireblood,nil,nil,nil)then a5=265221;return"queue ArcaneTorrent Queue"end elseif X.AncestralCall:IsAvailable()and X.AncestralCall:IsUsableP()and X.AncestralCall:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if m.Cast(X.AncestralCall,nil,nil,nil)then a5=274738;return"queue ArcaneTorrent Queue"end elseif(X.ArcaneTorrent:IsAvailable()and(not X.ArcaneTorrent:IsUsableP()or X.ArcaneTorrent:CooldownRemains()>0 or not g:AffectingCombat())or X.LightsJudgment:IsAvailable()and(not X.LightsJudgment:IsUsableP()or X.LightsJudgment:CooldownRemains()>0 or not g:AffectingCombat())or X.BagofTricks:IsAvailable()and(not X.BagofTricks:IsUsableP()or X.BagofTricks:CooldownRemains()>0 or not g:AffectingCombat())or X.BloodFury:IsAvailable()and(not X.BloodFury:IsUsableP()or X.BloodFury:CooldownRemains()>0 or not g:AffectingCombat())or X.Berserking:IsAvailable()and(not X.Berserking:IsUsableP()or X.Berserking:CooldownRemains()>0 or not g:AffectingCombat())or X.Fireblood:IsAvailable()and(not X.Fireblood:IsUsableP()or X.Fireblood:CooldownRemains()>0 or not g:AffectingCombat())or X.AncestralCall:IsAvailable()and(not X.AncestralCall:IsUsableP()or X.AncestralCall:CooldownRemains()>0 or not g:AffectingCombat()))and E then HeroRotationCharDB.Toggles[30]=not HeroRotationCharDB.Toggles[30]m.Print("Arcane Torrent Queue is now "..(HeroRotationCharDB.Toggles[30]and"|cff00ff00on|r."or"|cffff0000off|r."))end end;if g:BuffUp(X.ShurikenTornado)and af<W.CPMaxSpend()then local bM=W.TimeToNextTornado()if bM<=1 or U(g:GCD()-bM)<0.25 then local bN=a2+bg(g:BuffUp(X.ShadowBlades))af=S(af+bN,W.CPMaxSpend())ag=T(ag-bN,0)ae=af end end;ac=(4+ae*4)*0.3;ad=X.Eviscerate:Damage()*aT.Subtlety.EviscerateDMGOffset;a4=W.CrimsonVial()if a4 then return a4 end;a4=W.Feint()if a4 then return a4 end;a4=W.Evasion()if a4 then return a4 end;if g:HealthPercentage()<aT.Commons.PhialHP and Y.PhialofSerenity:IsReady()and Y.PhialofSerenity:CooldownRemains()<=0 then if m.Cast(Y.PhialofSerenity,nil)then a5=55;return"PhialofSerenity HP"end end;if g:HealthPercentage()<aT.Commons.HealthstoneHP and Y.Healthstone:IsReady()and Y.Healthstone:CooldownRemains()<=0 then if m.Cast(Y.Healthstone,nil)then a5=40;return"Healthstone HP"end end;if g:HealthPercentage()<aT.Commons.HealPotHP and Y.CosmicHealPot:IsReady()and Y.CosmicHealPot:CooldownRemains()<=0 then if m.Cast(Y.CosmicHealPot,nil)then a5=45;return"CosmicHealPot HP"end end;if g:HealthPercentage()<aT.Commons.HealPotHP and Y.HealPot:IsReady()and not Y.CosmicHealPot:IsReady()and Y.HealPot:CooldownRemains()<=0 then if m.Cast(Y.HealPot,nil)then a5=41;return"HealPot HP"end end;if UnitExists("mouseover")and string.find(UnitGUID("mouseover"),120651)then if X.Backstab:IsCastable()and f("mouseover"):IsInMeleeRange(8)then if m.Cast(X.Backstab,nil)then a6=153;return"explosive MO SWD"end end;if X.ShurikenToss:IsCastable()and f("mouseover"):IsInMeleeRange(40)and not f("mouseover"):IsInMeleeRange(8)then if m.Cast(X.ShurikenToss,nil)then a6=1114014;return"explosive MO SWD"end end end;if UnitExists("target")and string.find(UnitGUID("target"),120651)then if X.Backstab:IsCastable()and h:IsInMeleeRange(8)then if m.Cast(X.Backstab,nil)then a5=53;return"explosive  SWD"end end;if X.ShurikenToss:IsCastable()and h:IsInMeleeRange(40)and not h:IsInMeleeRange(8)then if m.Cast(X.ShurikenToss,nil)then a5=114014;return"explosive MO SWD"end end end;G={324736,228318,178658,333227,334800,334967,324737,326450,334470,320703,320012,324085,333241,331510,344739,368477,368396,355057,356133,342139,353706,355782,327155,359668}if UnitExists("target")and X.Shiv:IsReady()and not F then if UnitCanAttack("player","target")and UnitAffectingCombat("target")and UnitIsDead("target")~=true then for bO=0,40 do local be,be,bP,type,be,be,be,be,be,bQ=UnitBuff("target",bO)for be,bR in pairs(G)do if bR==bQ then if m.Cast(X.Shiv,nil)then a5=5938;return"Shiv Enrage"end end end end end end;local bS=g:AffectingCombat()and 180 or 900;local bT;if i(8679):IsAvailable()and aT.Commons.LethalPoison=="Wound Poison"then bT=g:BuffRemains(i(8679))if bT<bS and not g:IsCasting(i(8679))then if m.Cast(i(8679))then a5=203;return"Wound Poison Refresh"end end elseif i(2823):IsAvailable()and aT.Commons.LethalPoison=="Deadly Poison"then bT=g:BuffRemains(i(2823))if bT<bS and not g:IsCasting(i(2823))then if m.Cast(i(2823))then a5=204;return"Deadly Poison Refresh"end end elseif i(315584):IsAvailable()and aT.Commons.LethalPoison=="Instant Poison"then bT=g:BuffRemains(i(315584))if bT<bS and not g:IsCasting(i(315584))then if m.Cast(i(315584))then a5=205;return"Instant Poison Refresh"end end end;bT=g:BuffRemains(i(3408))if i(3408):IsAvailable()and aT.Commons.NonLethalPoison=="Crippling Poison"then if bT<bS and not g:IsCasting(i(3408))then if m.Cast(i(3408))then a5=206;return"Crippling Poison Refresh"end end elseif i(5761):IsAvailable()and aT.Commons.NonLethalPoison=="Numbing Poison"then bT=g:BuffRemains(i(5761))if bT<bS and not g:IsCasting(NumbingPoison)then if m.Cast(i(5761))then a5=204;return"Numbing Poison Refresh"end end end;if g:IsChanneling(i(324631))then if m.Cast(X.PoolEnergy,nil,nil,nil)then a5=99999;return"channeling Fleashcraft"end end;if not g:AffectingCombat()and not g:IsDeadOrGhost()then if not g:BuffUp(X.ShadowDanceBuff)and not g:BuffUp(ab)then a4=W.Stealth(aa)if a4 then return a4 end end end;W.MfDSniping(X.MarkedforDeath)if V.TargetIsValid()and(g:AffectingCombat()and not h:DebuffUp(X.Sap)or r or(g:BuffUp(ab)or StealthSpell and StealthSpell:ID()==X.Vanish:ID()))then local bU,bV,be=GetSpellCooldown(57934)if aT.Commons.AutoToT and g:AffectingCombat()then if bU+bV-GetTime()<=0 and X.TricksoftheTrade:IsAvailable()and X.TricksoftheTrade:CooldownRemains(BypassRecovery)<=0 and UnitExists("focus")and(UnitInParty("focus")or UnitInRaid("focus"))and IsItemInRange(32698,"focus")then if m.Cast(X.TricksoftheTrade)then a5=157934;return"ToT Focus"end end end;a4=bB()if a4 then return"CDs: "..a4 end;if g:BuffUp(X.ShurikenTornado)and af<W.CPMaxSpend()then local bM=W.TimeToNextTornado()if bM<=1 or U(g:GCD()-bM)<0.25 then local bN=a2+bg(g:BuffUp(X.ShadowBlades))af=S(af+bN,W.CPMaxSpend())ag=T(ag-bN,0)ae=af end end;if g:StealthUp(true,true)or VanishBuffCheck then a4=bv()if a4 then return"Stealthed Rotation: "..a4 end end;if g:BuffUp(X.ShurikenTornado)and af<W.CPMaxSpend()then local bM=W.TimeToNextTornado()if bM<=1 or U(g:GCD()-bM)<0.25 then local bN=a2+bg(g:BuffUp(X.ShadowBlades))af=S(af+bN,W.CPMaxSpend())ag=T(ag-bN,0)ae=af end end;if X.SliceandDice:IsCastable()and a2<6 and d.FilteredFightRemains(a1,">",6)and g:BuffRemains(X.SliceandDice)<g:GCD()and af>=4-2*l(d.CombatTime()<5)then if X.SliceandDice:IsReady()and m.Cast(X.SliceandDice)then a5=5171;return"Cast Slice and Dice (Low Duration)"end end;local ah=b5()if ah then a4=bG()if a4 then return"Stealth CDs: (Priority Rotation)"..a4 end end;if g:BuffUp(X.ShurikenTornado)and af<W.CPMaxSpend()then local bM=W.TimeToNextTornado()if bM<=1 or U(g:GCD()-bM)<0.25 then local bN=a2+bg(g:BuffUp(X.ShadowBlades))af=S(af+bN,W.CPMaxSpend())ag=T(ag-bN,0)ae=af end end;if g:EnergyDeficitPredicted()<=bl()then a4=bG()if a4 then return"Stealth CDs: "..a4 end end;if g:BuffUp(X.ShurikenTornado)and af<W.CPMaxSpend()then local bM=W.TimeToNextTornado()if bM<=1 or U(g:GCD()-bM)<0.25 then local bN=a2+bg(g:BuffUp(X.ShadowBlades))af=S(af+bN,W.CPMaxSpend())ag=T(ag-bN,0)ae=af end end;if ae>=W.CPMaxSpend()or ae>=5 and a2>=5 and g:BuffUp(X.ShurikenTornado)or(ag<=1 or d.BossFilteredFightRemains("<",1)and ae>=3 or g:BuffUp(X.SymbolsofDeathCrit)and ae>=4)or a2>=4 and ae>=4 then a4=bs()if a4 then return"Finish: "..a4 end end;if g:BuffUp(X.ShurikenTornado)and af<W.CPMaxSpend()then local bM=W.TimeToNextTornado()if bM<=1 or U(g:GCD()-bM)<0.25 then local bN=a2+bg(g:BuffUp(X.ShadowBlades))af=S(af+bN,W.CPMaxSpend())ag=T(ag-bN,0)ae=af end end;if g:EnergyDeficitPredicted()<=bl()and(ae<W.CPMaxSpend()and g:BuffDown(X.ShurikenTornado)or ae<4 and g:BuffUp(X.ShurikenTornado))then a4=bH()if a4 then return"Build: "..a4 end end;if g:BuffUp(X.ShurikenTornado)and af<W.CPMaxSpend()then local bM=W.TimeToNextTornado()if bM<=1 or U(g:GCD()-bM)<0.25 then local bN=a2+bg(g:BuffUp(X.ShadowBlades))af=S(af+bN,W.CPMaxSpend())ag=T(ag-bN,0)ae=af end end;if m.CDsON()then if X.ArcaneTorrent:IsReady()and h:IsInMeleeRange(5)and g:EnergyDeficitPredicted()>15+g:EnergyRegen()and aT.Commons.Enabled.Racials then if m.Cast(X.ArcaneTorrent,nil)then a5=155145;return"Cast Arcane Torrent"end end;if X.ArcanePulse:IsReady()and h:IsInMeleeRange(5)then if m.Cast(X.ArcanePulse,nil)then a5=260364;return"Cast Arcane Pulse"end end;if X.LightsJudgment:IsReady()and aT.Commons.Enabled.Racials then if m.Cast(X.LightsJudgment,nil)then a5=255647;return"Cast Lights Judgment"end end;if X.BagofTricks:IsReady()and aT.Commons.Enabled.Racials then if m.Cast(X.BagofTricks,nil)then a5=312411;return"Cast Bag of Tricks"end end end;if false and h:IsInMeleeRange(5)then if type(a7)=="table"and#a7>1 then if m.CastQueuePooling(g:EnergyTimeToX(a8),unpack(a7))then a5=1000;return"Macro pool towards "..a7[1]:Name().." at "..a8 end elseif a7:IsCastable()then a8=T(a8,a7:Cost())if m.CastPooling(a7,g:EnergyTimeToX(a8))then a5=1000;return"Pool towards: "..a7:Name().." at "..a8 end end end;if m.Cast(X.PoolEnergy)then a5=1000;return"Stealthed Pooling"end end end;local function bW()end;function ReturnSpell()if a5==0 then return 0 else return a5 end end;function ReturnSpellMO()if a6==0 then return 0 else return a6 end end;m.SetAPL(261,bL,bW)