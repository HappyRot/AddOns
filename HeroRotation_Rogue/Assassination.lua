local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=d.Spell;local j=d.MultiSpell;local k=d.Item;local l=d.Utils.num;local m=d.Utils.BoolToInt;local n=d.Utils.IntToBool;local o=d.Utils.ValueIsInArray;local p=HeroRotation;local q=p.AoEON;local r=p.CDsON;local s=p.Cast;local t=p.CastPooling;local u=p.CastLeftNameplate;local v=HeroRotationCharDB.Toggles[4]local w=HeroRotationCharDB.Toggles[5]local x=HeroRotationCharDB.Toggles[12]local y=not HeroRotationCharDB.Toggles[15]local z=HeroRotationCharDB.Toggles[20]local A=HeroRotationCharDB.Toggles[21]local B=HeroRotationCharDB.Toggles[22]local C=HeroRotationCharDB.Toggles[23]local D=HeroRotationCharDB.Toggles[24]local E=HeroRotationCharDB.Toggles[25]local F=HeroRotationCharDB.Toggles[26]local G=HeroRotationCharDB.Toggles[27]local H=HeroRotationCharDB.Toggles[28]local I=HeroRotationCharDB.Toggles[29]local J=HeroRotationCharDB.Toggles[30]local K=HeroRotationCharDB.Toggles[54]local L=math.min;local pairs=pairs;local M=math.floor;local N=math.max;local O=p.Commons.Everyone;local P=p.Commons.Rogue;local Q={General=p.GUISettings.General,Commons=p.GUISettings.APL.Rogue.Commons,Assassination=p.GUISettings.APL.Rogue.Assassination}local R=i.Rogue.Assassination;local S=k.Rogue.Assassination;local T={}local U,V,W=0,TargetInAoERange;local X,Y,Z,_;local a0;local a1,a2=2*g:SpellHaste(),1*g:SpellHaste()local a3,a4;local a5,a6,a7,a8,a9,aa,ab;local ac;local ad,ae,af,ag,ah,ai,aj;local ak=0;local al=P.ReturnSpell()local am=P.ReturnSpellMO()local an=g:GetEquipment()local ao=an[13]and k(an[13])or k(0)local ap=an[14]and k(an[14])or k(0)local function aq()if ao:TrinketHasStatAnyDps()and(not ap:TrinketHasStatAnyDps()or ao:Cooldown()>=ap:Cooldown())then ak=1 elseif ap:TrinketHasStatAnyDps()and(not ao:TrinketHasStatAnyDps()or ap:Cooldown()>ao:Cooldown())then ak=2 else ak=0 end end;aq()d:RegisterForEvent(function()an=g:GetEquipment()ao=an[13]and k(an[13])or k(0)ap=an[14]and k(an[14])or k(0)aq()end,"PLAYER_EQUIPMENT_CHANGED")local function l(ar)if ar then return 1 else return 0 end end;R.Envenom:RegisterDamageFormula(function()return g:AttackPowerDamageMod()*a3*0.22*1.0*(h:DebuffUp(R.ShivDebuff)and 1.3 or 1)*(R.DeeperStratagem:IsAvailable()and 1.05 or 1)*(1+g:MasteryPct()/100)*(1+g:VersatilityDmgPct()/100)end)R.Mutilate:RegisterDamageFormula(function()return(g:AttackPowerDamageMod()+g:AttackPowerDamageMod(true))*0.485*1.0*(1+g:VersatilityDmgPct()/100)end)local function as()return g:BuffRemains(R.MasterAssassinBuff)==9999 end;local function at()if as()then return g:GCDRemains()+3 end;return g:BuffRemains(R.MasterAssassinBuff)end;local function au()if g:BuffUp(R.ImprovedGarroteAura)then return g:GCDRemains()+3 end;return g:BuffRemains(R.ImprovedGarroteBuff)end;local function av()if g:BuffUp(R.IndiscriminateCarnageAura)then return g:GCDRemains()+10 end;return g:BuffRemains(R.IndiscriminateCarnageBuff)end;local function aw()if Z<2 then return false elseif Q.Commons.UsePriorityRotation=="Always"then return true elseif Q.Commons.UsePriorityRotation=="On Bosses"and h:IsInBossList()then return true elseif Q.Commons.UsePriorityRotation=="Auto"then if g:InstanceDifficulty()==16 and h:NPCID()==138967 then return true end end;return false end;local function ax()if h:DebuffUp(R.Deathmark)or h:DebuffUp(R.Kingsbane)or g:BuffUp(R.ShadowDanceBuff)or h:DebuffUp(R.ShivDebuff)or R.ThistleTea:FullRechargeTime()<20 or g:EnergyPercentage()>=80 or g:HasTier(31,4)and(g:BuffUp(R.Envenom)and g:BuffRemains(R.Envenom)<=2 or d.BossFilteredFightRemains("<=",90))then return true end;return false end;local function ay()if R.Deathmark:CooldownRemains()>R.Sepsis:CooldownRemains()and(d.BossFightRemainsIsNotValid()or d.BossFilteredFightRemains(">",R.Deathmark:CooldownRemains()))then return R.Deathmark:CooldownRemains()end;return R.Sepsis:CooldownRemains()end;local function az()if not R.ScentOfBlood:IsAvailable()then return true end;return g:BuffStack(R.ScentOfBloodBuff)>=L(20,R.ScentOfBlood:TalentRank()*2*Z)end;local function aA(aB,i,aC)local aC=aC or i:PandemicThreshold()return aB:DebuffRefreshable(i,aC)end;local function aD(aE,aF,aG,aH)local aI,aJ=nil,aG;local aK=h:GUID()for aL,aM in pairs(aH)do if aM:GUID()~=aK and O.UnitIsCycleValid(aM,aJ,-aM:DebuffRemains(aE))and aF(aM)then aI,aJ=aM,aM:TimeToDie()end end;if aI then if aI:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then if aE:ID()==703 then am=1703 elseif aE:ID()==1943 then am=11943 end elseif Q.Assassination.TargetSwap=="AutoSwap"and aI:GUID()~=h:GUID()and not x then am=9999 elseif aI:GUID()==h:GUID()then al=aE:ID()end;u(aI,aE)elseif Q.Commons.RangedMultiDoT then aI,aJ=nil,aG;for aL,aM in pairs(Y)do if aM:GUID()~=aK and O.UnitIsCycleValid(aM,aJ,-aM:DebuffRemains(aE))and aF(aM)then aI,aJ=aM,aM:TimeToDie()end end;if aI then if aI:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then if aE:ID()==703 then am=1703 elseif aE:ID()==1943 then am=11943 end elseif Q.Assassination.TargetSwap=="AutoSwap"and aI:GUID()~=h:GUID()and not x then am=9999 elseif aI:GUID()==h:GUID()then al=aE:ID()end;u(aI,aE)end end end;local function aN(aO,aP,aQ)local aR=aP(h)if aO=="first"and aR~=0 then return h end;local aI,aS=nil,0;local function aT(aH)for aL,aM in pairs(aH)do local aU=aP(aM)if not aI and aO=="first"then if aU~=0 then aI,aS=aM,aU end elseif aO=="min"then if not aI or aU<aS then aI,aS=aM,aU end elseif aO=="max"then if not aI or aU>aS then aI,aS=aM,aU end end;if aI and aU==aS and aM:TimeToDie()>aI:TimeToDie()then aI,aS=aM,aU end end end;aT(_)if Q.Commons.RangedMultiDoT then aT(Y)end;if aI and aS==aR and aQ(h)then return h end;if aI and aQ(aI)then return aI end;return nil end;local function aV(aW,aX,aY)local aZ=h:TimeToDie()if not d.BossFightRemainsIsNotValid()then aZ=d.BossFightRemains()elseif aZ<aY then return false end;if M((aZ-aY)/aW)>M((aZ-aY-aX)/aW)then return true end;return false end;local function a_(aB)if aB:DebuffUp(R.SerratedBoneSpikeDebuff)then return 1000000 end;return aB:TimeToDie()end;local function b0(aB)if not aB:DebuffUp(R.SerratedBoneSpikeDebuff)and aB:IsInMeleeRange(10)and aB:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then am=1328547;return true elseif not aB:DebuffUp(R.SerratedBoneSpikeDebuff)and aB:IsInMeleeRange(10)and Q.Assassination.TargetSwap=="AutoSwap"and aB:GUID()~=h:GUID()and not x then am=9999;return true elseif not aB:DebuffUp(R.SerratedBoneSpikeDebuff)and aB:IsInMeleeRange(10)and aB:GUID()==h:GUID()then al=328547;return true elseif not aB:DebuffUp(R.SerratedBoneSpikeDebuff)and aB:IsInMeleeRange(10)then return true end end;local function b1()if R.BloodFury:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.BloodFury,nil)then al=20572;return"Cast Blood Fury"end end;if R.Berserking:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.Berserking,nil)then al=26297;return"Cast Berserking"end end;if R.Fireblood:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.Fireblood,nil)then al=265221;return"Cast Fireblood"end end;if R.AncestralCall:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.AncestralCall,nil)then al=274738;return"Cast Ancestral Call"end end end;local function b2()if R.ShadowDance:IsCastable()and not R.Kingsbane:IsAvailable()and r()and not A and h:IsInMeleeRange(10)and not g:IsTanking(h)then if R.ImprovedGarrote:IsAvailable()and R.Garrote:CooldownUp()and(h:PMultiplier(R.Garrote)<=1 or aA(h,R.Garrote))and(R.Deathmark:AnyDebuffUp()or R.Deathmark:CooldownRemains()<12 or R.Deathmark:CooldownRemains()>60)and a4>=math.min(Z,4)then if Q.Commons.ShowPooling and g:EnergyPredicted()<45 then if s(R.PoolEnergy)then al=999999;return"Pool for Shadow Dance (Garrote)"end end;if s(R.ShadowDance,nil)then al=185313;return"Cast Shadow Dance (Garrote)"end end;if not R.ImprovedGarrote:IsAvailable()and R.MasterAssassin:IsAvailable()and not aA(h,R.Rupture)and h:DebuffRemains(R.Garrote)>3 and(h:DebuffUp(R.Deathmark)or R.Deathmark:CooldownRemains()>60)and(h:DebuffUp(R.ShivDebuff)or h:DebuffRemains(R.Deathmark)<4 or h:DebuffUp(R.Sepsis))and h:DebuffRemains(R.Sepsis)<3 then if s(R.ShadowDance,nil)then al=185313;return"Cast Shadow Dance (Master Assassin)"end end end;if R.Vanish:IsCastable()and not g:IsTanking(h)then if R.ImprovedGarrote:IsAvailable()and not R.MasterAssassin:IsAvailable()and R.Garrote:CooldownUp()and not P.Exsanguinated(h,R.Garrote)and(h:PMultiplier(R.Garrote)<=1 or aA(h,R.Garrote))then if not R.IndiscriminateCarnage:IsAvailable()and(R.Deathmark:AnyDebuffUp()or R.Deathmark:CooldownRemains()<4)and a4>=L(Z,4)then if Q.Commons.ShowPooling and g:EnergyPredicted()<45 then if s(R.PoolEnergy)then al=999999;return"Pool for Vanish (Garrote Deathmark)"end end;if s(R.Vanish,nil)then al=1856;return"Cast Vanish (Garrote Deathmark)"end end;if R.IndiscriminateCarnage:IsAvailable()and Z>2 then if Q.Commons.ShowPooling and g:EnergyPredicted()<45 then if s(R.PoolEnergy)then return"Pool for Vanish (Garrote Deathmark)"end end;if s(R.Vanish,nil)then al=1856;return"Cast Vanish (Garrote Cleave)"end end end;if R.MasterAssassin:IsAvailable()and R.Kingsbane:IsAvailable()and h:DebuffUp(R.Kingsbane)and h:DebuffRemains(R.Kingsbane)<=3 and h:DebuffUp(R.Deathmark)and h:DebuffRemains(R.Deathmark)<=3 then if s(R.Vanish,nil)then al=1856;return"Cast Vanish (Kingsbane)"end end;if not R.ImprovedGarrote:IsAvailable()and R.MasterAssassin:IsAvailable()and not aA(h,R.Rupture)and h:DebuffRemains(R.Garrote)>3 and h:DebuffUp(R.Deathmark)and(h:DebuffUp(R.ShivDebuff)or h:DebuffRemains(R.Deathmark)<4 or h:DebuffUp(R.Sepsis))and h:DebuffRemains(R.Sepsis)<3 then if s(R.Vanish,nil)then al=1856;return"Cast Vanish (Master Assassin)"end end end end;local function b3()if not TargetInAoERange then return end;if not p.CDsON()then return end;if R.Sepsis:IsReady()and h:DebuffRemains(R.Rupture)>20 and(not R.ImprovedGarrote:IsAvailable()and h:DebuffUp(R.Garrote)or R.ImprovedGarrote:IsAvailable()and R.Garrote:CooldownUp()and h:PMultiplier(R.Garrote)<=1)and(h:FilteredTimeToDie(">",10)or d.BossFilteredFightRemains("<=",10))then if s(R.Sepsis,nil,true)then al=328305;return"Cast Sepsis"end end;if not g:StealthUp(true,false)then if ao:IsReady()and not o(T,ao:ID())and(ak==1 and(R.Deathmark:AnyDebuffUp()or d.BossFilteredFightRemains("<",20))or ak==2 and(not ap:IsReady()or R.Deathmark:CooldownRemains()>20)or ak==0)then if p.Cast(ap,nil,nil)then if ao:ID()==TopTrinketID and Q.Commons.Enabled.TopTrinket then al=24;return"Generic use_items for "..ao:Name()elseif ao:ID()==BotTrinketID and Q.Commons.Enabled.BottomTrinket then al=25;return"Generic use_items for "..ao:Name()end end elseif ap:IsReady()and not o(T,ap:ID())and(ak==2 and(R.Deathmark:AnyDebuffUp()or d.BossFilteredFightRemains("<",20))or ak==1 and(not ao:IsReady()or R.Deathmark:CooldownRemains()>20)or ak==0)then if p.Cast(ap,nil,nil)then if ap:ID()==TopTrinketID and Q.Commons.Enabled.TopTrinket then al=24;return"Generic use_items for "..ap:Name()elseif ap:ID()==BotTrinketID and Q.Commons.Enabled.BottomTrinket then al=25;return"Generic use_items for "..ap:Name()end end end end;local b4=not g:StealthUp(true,false)and h:DebuffUp(R.Rupture)and g:BuffUp(R.Envenom)and not R.Deathmark:AnyDebuffUp()and(not R.MasterAssassin:IsAvailable()or h:DebuffUp(R.Garrote))and(not R.Kingsbane:IsAvailable()or R.Kingsbane:CooldownRemains()<=2)if R.Deathmark:IsCastable()and(b4 or d.BossFilteredFightRemains("<=",20))then if s(R.Deathmark,nil)then al=360194;return"Cast Deathmark"end end;if R.Shiv:IsReady()and not h:DebuffUp(R.ShivDebuff)and h:DebuffUp(R.Garrote)and h:DebuffUp(R.Rupture)then if d.BossFilteredFightRemains("<=",R.Shiv:Charges()*8)then if s(R.Shiv,nil)then al=5938;return"Cast Shiv (End of Fight)"end end;if R.Kingsbane:IsAvailable()then if not R.LightweightShiv:IsAvailable()and(h:DebuffUp(R.Kingsbane)and h:DebuffRemains(R.Kingsbane)<8 or R.Kingsbane:CooldownRemains()>=24)and(not R.CrimsonTempest:IsAvailable()or aj or h:DebuffUp(R.CrimsonTempest))then if s(R.Shiv,nil)then al=5938;return"Cast Shiv (Kingsbane)"end end;if R.LightweightShiv:IsAvailable()and(h:DebuffUp(R.Kingsbane)or R.Kingsbane:CooldownRemains()<=1)then if s(R.Shiv,nil)then al=5938;return"Cast Shiv (Kingsbane Lightweight)"end end end;if R.ArterialPrecision:IsAvailable()and R.Deathmark:AnyDebuffUp()then if s(R.Shiv,nil)then al=5938;return"Cast Shiv (Arterial Precision)"end end;if not R.Kingsbane:IsAvailable()and not R.ArterialPrecision:IsAvailable()then if R.Sepsis:IsAvailable()then if R.Shiv:ChargesFractional()>0.9+m(R.LightweightShiv:IsAvailable())and ae>5 or h:DebuffUp(R.Sepsis)or h:DebuffUp(R.Deathmark)then if s(R.Shiv,nil)then al=5938;return"Cast Shiv (Sepsis)"end end else if not R.CrimsonTempest:IsAvailable()or aj or h:DebuffUp(R.CrimsonTempest)then if s(R.Shiv,nil)then al=5938;return"Cast Shiv"end end end end end;if Q.Commons.Enabled.Potions and r()and y and((g:BloodlustUp()or d.BossFightRemains()<=30 or h:DebuffUp(R.Deathmark))and not p.GUISettings.General.HoldPotforBL or p.GUISettings.General.HoldPotforBL and g:BloodlustUp())then local b5=O.PotionSelected()if b5 and b5:IsReady()then if s(b5,nil,nil)then al=37;return"potion cooldowns 2"end end end;if R.ShadowDance:IsCastable()and R.Kingsbane:IsAvailable()and g:BuffUp(R.Envenom)and(R.Deathmark:CooldownRemains()>=50 or b4)then if s(R.ShadowDance,nil)then al=185313;return"Cast Shadow Dance (Kingsbane Sync)"end end;if R.Kingsbane:IsReady()and(h:DebuffUp(R.ShivDebuff)or R.Shiv:CooldownRemains()<6)and g:BuffUp(R.Envenom)and(R.Deathmark:CooldownRemains()>=50 or h:DebuffUp(R.Deathmark))then if s(R.Kingsbane,nil)then al=385627;return"Cast Kingsbane"end end;if R.ThistleTea:IsCastable()and not g:BuffUp(R.ThistleTea)and(g:EnergyDeficit()>=100+ag and(not R.Kingsbane:IsAvailable()or R.ThistleTea:Charges()>=2)or(h:DebuffUp(R.Kingsbane)and h:DebuffRemains(R.Kingsbane)<6 or not R.Kingsbane:IsAvailable()and R.Deathmark:AnyDebuffUp())or d.BossFilteredFightRemains("<",R.ThistleTea:Charges()*6))then if p.Cast(R.ThistleTea,nil)then al=381623;return"Cast Thistle Tea"end end;if R.Deathmark:AnyDebuffUp()and not a0 then if a0 then b1()else a0=b1()end end;if not g:StealthUp(true,true)and au()<=0 and at()<=0 then if a0 then b2()else a0=b2()end end;if R.ColdBlood:IsReady()and g:DebuffDown(R.ColdBlood)and a3>=4 and not a0 then if s(R.ColdBlood,nil)then al=382245;return"Cast Cold Blood"end end;return a0 end;local function b6()if R.Kingsbane:IsAvailable()and g:BuffUp(R.Envenom)then if R.Shiv:IsReady()and(h:DebuffUp(R.Kingsbane)or R.Kingsbane:CooldownUp())and h:DebuffDown(R.ShivDebuff)then if s(R.Shiv,nil)then al=5938;return"Cast Shiv (Stealth Kingsbane)"end end;if R.Kingsbane:IsReady()and g:BuffRemains(R.ShadowDanceBuff)>=2 then if s(R.Kingsbane,nil)then al=385627;return"Cast Kingsbane (Dance)"end end end;if a3>=4 then if h:DebuffUp(R.Kingsbane)and g:BuffRemains(R.Envenom)<=2 then if s(R.Envenom,nil,nil,not W)then al=32645;return"Cast Envenom (Stealth Kingsbane)"end end;if aj and as()and g:BuffDown(R.ShadowDanceBuff)then if s(R.Envenom,nil,nil,not W)then al=32645;return"Cast Envenom (Master Assassin)"end end end;if R.Garrote:IsCastable()and au()>0 then local function b7(aB)return aB:DebuffRemains(R.Garrote)end;local function b8(aB)if(aB:PMultiplier(R.Garrote)<=1 or aB:DebuffRemains(R.Garrote)<12/P.ExsanguinatedRate(aB,R.Garrote)or av()>0 and R.Garrote:AuraActiveCount()<Z)and not aj and(aB:FilteredTimeToDie(">",2,-aB:DebuffRemains(R.Garrote))or aB:TimeToDieIsNotValid())and P.CanDoTUnit(aB,a8)then if aB:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then am=1703;return true elseif Q.Assassination.TargetSwap=="AutoSwap"and aB:GUID()~=h:GUID()and not x then am=9999;return true elseif aB:GUID()==h:GUID()then al=703;return true else return true end end end;if p.AoEON()then local b9=aN("min",b7,b8)if b9 and b9:GUID()~=h:GUID()then u(b9,R.Garrote)end end;if b8(h)then if s(R.Garrote,nil,nil,not W)then al=703;return"Cast Garrote (Improved Garrote)"end end;if a4>=1+2*l(R.ShroudedSuffocation:IsAvailable())then if g:BuffDown(R.ShadowDanceBuff)and(h:PMultiplier(R.Garrote)<=1 or h:DebuffUp(R.Deathmark)and at()<3)then if s(R.Garrote,nil,nil,not W)then al=703;return"Cast Garrote (Improved Garrote Low CP)"end end;if h:PMultiplier(R.Garrote)<=1 or h:DebuffRemains(R.Garrote)<12 then if s(R.Garrote,nil,nil,not W)then al=703;return"Cast Garrote (Improved Garrote Low CP 2)"end end end end;if a3>=4 and h:PMultiplier(R.Rupture)<=1 and(g:BuffUp(R.ShadowDanceBuff)or h:DebuffUp(R.Deathmark))then if s(R.Rupture,nil,nil,not W)then al=1943;return"Cast Rupture (Nightstalker)"end end end;local function ba()if p.AoEON()and R.CrimsonTempest:IsReady()and Z>=2 and a3>=4 and ag>25 and not R.Deathmark:IsReady()then for aL,aM in pairs(Y)do if aA(aM,R.CrimsonTempest,a6)and aM:PMultiplier(R.CrimsonTempest)<=1 and aM:FilteredTimeToDie(">",6,-aM:DebuffRemains(R.CrimsonTempest))then if s(R.CrimsonTempest)then al=121411;return"Cast Crimson Tempest (AoE High Energy)"end end end end;if R.Garrote:IsCastable()and a4>=1 then local function bb(aB)return aA(aB,R.Garrote)and aB:PMultiplier(R.Garrote)<=1 end;if bb(h)and P.CanDoTUnit(h,a8)and(h:FilteredTimeToDie(">",12,-h:DebuffRemains(R.Garrote))or h:TimeToDieIsNotValid())then if t(R.Garrote,nil,not W)then al=703;return"Pool for Garrote (ST)"end end;if p.AoEON()and not ai and Z>=2 then aD(R.Garrote,bb,12,_)end end;if R.Rupture:IsReady()and a3>=4 then a9=4+m(R.DashingScoundrel:IsAvailable())*5+m(R.Doomblade:IsAvailable())*5+m(ai)*6;local function bc(aB)return aA(aB,R.Rupture,a5)and aB:PMultiplier(R.Rupture)<=1 and(aB:FilteredTimeToDie(">",a9,-aB:DebuffRemains(R.Rupture))or aB:TimeToDieIsNotValid())end;if bc(h)and P.CanDoTUnit(h,a7)then if s(R.Rupture,nil,nil,not W)then al=1943;return"Cast Rupture (Refresh)"end end;if p.AoEON()and(not ai or not ScentSaturated)then aD(R.Rupture,bc,a9,_)end end;if R.Garrote:IsCastable()and a4>=1 and at()<=0 and(h:PMultiplier(R.Garrote)<=1 or h:DebuffRemains(R.Garrote)<a1 and Z>=3)and(h:DebuffRemains(R.Garrote)<a1*2 and Z>=3)and(h:FilteredTimeToDie(">",4,-h:DebuffRemains(R.Garrote))or h:TimeToDieIsNotValid())then if s(R.Garrote,nil,nil,not W)then al=703;return"Garrote (Fallback)"end end;return false end;local function bd()if R.Envenom:IsReady()and a3>=4 and(ad or h:DebuffStack(R.AmplifyingPoisonDebuff)>=20 or a3>P.CPMaxSpend()or not aj)then if s(R.Envenom,nil,nil,not W)then al=32645;return"Cast Envenom"end end;if not(a4>1 or ad or not aj)then return false end;if not aj and R.CausticSpatter:IsAvailable()and h:DebuffUp(R.Rupture)and h:DebuffRemains(R.CausticSpatterDebuff)<=2 then if R.Mutilate:IsCastable()then if s(R.Mutilate,nil,nil,not W)then al=1329;return"Cast Mutilate (Casutic)"end end;if(R.Ambush:IsCastable()or R.AmbushOverride:IsCastable())and(g:StealthUp(true,true)or g:BuffUp(R.BlindsideBuff))then if s(R.Ambush,nil,nil,not W)then al=8676;return"Cast Ambush (Caustic)"end end end;if R.SerratedBoneSpike:IsReady()then if not h:DebuffUp(R.SerratedBoneSpikeDebuff)then if s(R.SerratedBoneSpike,nil,Q.Commons.CovenantDisplayStyle,not TargetInAoERange)then return"Cast Serrated Bone Spike"end else if p.AoEON()then if O.CastTargetIf(R.SerratedBoneSpike,X,"min",a_,b0)then return"Cast Serrated Bone (AoE)"end end;if at()<0.8 then if d.BossFightRemains()<=5 or R.SerratedBoneSpike:MaxCharges()-R.SerratedBoneSpike:ChargesFractional()<=0.25 then if s(R.SerratedBoneSpike,nil,true,not TargetInAoERange)then al=328547;return"Cast Serrated Bone Spike (Dump Charge)"end elseif not aj and h:DebuffUp(R.ShivDebuff)then if s(R.SerratedBoneSpike,nil,true,not TargetInAoERange)then al=328547;return"Cast Serrated Bone Spike (Shiv)"end end end end end;if r()and R.EchoingReprimand:IsReady()then if s(R.EchoingReprimand,nil,nil,not W)then al=323547;return"Cast Echoing Reprimand"end end;if R.FanofKnives:IsCastable()then if p.AoEON()and Z>=1 and(not ac and Z>=2+m(g:StealthUp(true,false))+m(R.DragonTemperedBlades:IsAvailable()))then if t(R.FanofKnives)then al=51723;return"Cast Fan of Knives"end end;if p.AoEON()and g:BuffUp(R.DeadlyPoison)and Z>=3 then for aL,aM in pairs(Y)do if not aM:DebuffUp(R.DeadlyPoisonDebuff,true)and(not ac or aM:DebuffUp(R.Garrote)or aM:DebuffUp(R.Rupture))then if t(R.FanofKnives)then al=5172;return"Cast Fan of Knives (DP Refresh)"end end end end end;if(R.Ambush:IsCastable()or R.AmbushOverride:IsCastable())and(g:StealthUp(true,true)or g:BuffUp(R.BlindsideBuff)or g:BuffUp(R.SepsisBuff))and(h:DebuffDown(R.Kingsbane)or h:DebuffDown(R.Deathmark)or g:BuffUp(R.BlindsideBuff))then if t(R.Ambush,nil,not W)then al=8676;return"Cast Ambush"end end;if R.Mutilate:IsCastable()and Z==2 and h:DebuffDown(R.DeadlyPoisonDebuff,true)and h:DebuffDown(R.AmplifyingPoisonDebuff,true)then local aK=h:GUID()for aL,aM in pairs(_)do if aM:GUID()~=aK and(aM:DebuffUp(R.Garrote)or aM:DebuffUp(R.Rupture))and not aM:DebuffUp(R.DeadlyPoisonDebuff,true)and not aM:DebuffUp(R.AmplifyingPoisonDebuff,true)then if aM:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then am=11329 elseif Q.Assassination.TargetSwap=="AutoSwap"and aM:GUID()~=h:GUID()and not x then am=9999 elseif aM:GUID()==h:GUID()then al=1329 end;u(aM,R.Mutilate)break end end end;if R.Mutilate:IsCastable()then if t(R.Mutilate,nil,not W)then al=1329;return"Cast Mutilate"end end;return false end;local function be()w=HeroRotationCharDB.Toggles[5]v=HeroRotationCharDB.Toggles[4]x=HeroRotationCharDB.Toggles[12]y=not HeroRotationCharDB.Toggles[15]z=HeroRotationCharDB.Toggles[20]A=HeroRotationCharDB.Toggles[21]B=HeroRotationCharDB.Toggles[22]C=HeroRotationCharDB.Toggles[23]D=HeroRotationCharDB.Toggles[24]E=HeroRotationCharDB.Toggles[25]F=HeroRotationCharDB.Toggles[26]G=HeroRotationCharDB.Toggles[27]H=HeroRotationCharDB.Toggles[28]I=HeroRotationCharDB.Toggles[29]J=HeroRotationCharDB.Toggles[30]K=HeroRotationCharDB.Toggles[54]TopTrinketID=GetInventoryItemID("player",13)BotTrinketID=GetInventoryItemID("player",14)if not Q.Commons.Enabled.TopTrinket and not Q.Commons.Enabled.BotTrinket then OnUseExcludes={TopTrinketID,BotTrinketID,S.CacheOfAcquiredTreasures:ID()}elseif not Q.Commons.Enabled.TopTrinket and Q.Commons.Enabled.BotTrinket then OnUseExcludes={TopTrinketID,S.CacheOfAcquiredTreasures:ID()}elseif not Q.Commons.Enabled.BotTrinket and Q.Commons.Enabled.TopTrinket then OnUseExcludes={BotTrinketID,S.CacheOfAcquiredTreasures:ID()}end end;local function bf()W=h:IsInMeleeRange(5)TargetInAoERange=h:IsInMeleeRange(10)if q()then X=g:GetEnemiesInRange(30)Y=g:GetEnemiesInMeleeRange(10)Z=#Y;_=g:GetEnemiesInMeleeRange(5)else X={}Y={}Z=1;_={}end;a1,a2=2*g:SpellHaste(),1*g:SpellHaste()a3=P.EffectiveComboPoints(g:ComboPoints())a4=g:ComboPointsMax()-a3;a5=(4+a3*4)*0.3;a6=(4+a3*2)*0.3;a7=R.Envenom:Damage()*Q.Assassination.EnvenomDMGOffset;a8=R.Mutilate:Damage()*Q.Assassination.MutilateDMGOffset;ac=aw()a0=be()if a0 then return a0 end;if am>0 then am=0 end;if al>0 then al=0 end;al=P.ReturnSpell()am=P.ReturnSpellMO()a0=P.CrimsonVial()if a0 then return a0 end;a0=P.Feint()if a0 then return a0 end;local bg=g:AffectingCombat()and 180 or 900;local bh;if i(8679):IsAvailable()and(Q.Assassination.LethalPoison1=="Wound Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Wound Poison")then bh=g:BuffRemains(i(8679))if bh<bg and not g:IsCasting(i(8679))then if p.Cast(i(8679))then al=203;return"Wound Poison Refresh"end end elseif i(2823):IsAvailable()and(Q.Assassination.LethalPoison1=="Deadly Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Deadly Poison")then bh=g:BuffRemains(i(2823))if bh<bg and not g:IsCasting(i(2823))then if p.Cast(i(2823))then al=208;return"Deadly Poison Refresh"end end elseif i(315584):IsAvailable()and(Q.Assassination.LethalPoison1=="Instant Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Instant Poison")then bh=g:BuffRemains(i(315584))if bh<bg and not g:IsCasting(i(315584))then if p.Cast(i(315584))then al=205;return"Instant Poison Refresh"end end elseif i(381664):IsAvailable()and(Q.Assassination.LethalPoison1=="Amplifying Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Amplifying Poison")then bh=g:BuffRemains(i(381664))if bh<bg and not g:IsCasting(i(381664))then if p.Cast(i(381664))then al=209;return"Amplifying Poison Refresh"end end end;if i(381637):IsAvailable()and(Q.Assassination.NonLethalPoison1=="Atrophic Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.NonLethalPoison2=="Atrophic Poison")then bh=g:BuffRemains(i(381637))if bh<bg and not g:IsCasting(i(381637))then if p.Cast(i(381637))then al=381637;return"Atropic Poison Refresh"end end elseif i(5761):IsAvailable()and(Q.Assassination.NonLethalPoison1=="Numbing Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.NonLethalPoison2=="Numbing Poison")then bh=g:BuffRemains(i(5761))if bh<bg and not g:IsCasting(NumbingPoison)then if p.Cast(i(5761))then al=204;return"Numbing Poison Refresh"end end end;if not g:AffectingCombat()and not g:IsDeadOrGhost()then if not g:BuffUp(P.VanishBuffSpell())then a0=P.Stealth(P.StealthSpell())if a0 then return a0 end end;if not g:BuffUp(R.SliceandDice)then if R.SliceandDice:IsReady()and a3>=2 then if s(R.SliceandDice)then al=5171;return"Cast Slice and Dice"end end end end;P.MfDSniping(R.MarkedforDeath)if O.TargetIsValid()and(g:AffectingCombat()or w)then if a0 then return a0 end;af=P.PoisonedBleeds()ag=g:EnergyRegen()+af*6/(2*g:SpellHaste())ah=g:EnergyDeficit()/ag;ai=ag>35;ad=ax()ae=ay()ScentSaturated=az()aj=Z<2;if g:StealthUp(true,false)or au()>0 or at()>0 then a0=b6()if a0 then return a0 .." (Stealthed)"end end;a0=b3()if a0 then return a0 end;if not g:BuffUp(R.SliceandDice)and h:IsInMeleeRange(10)then if R.SliceandDice:IsReady()and g:ComboPoints()>=2 and h:DebuffUp(R.Rupture)or not R.CutToTheChase:IsAvailable()and g:ComboPoints()>=4 and g:BuffRemains(R.SliceandDice)<(1+g:ComboPoints())*1.8 then if s(R.SliceandDice)then al=5171;return"Cast Slice and Dice"end end elseif TargetInAoERange and R.CutToTheChase:IsAvailable()then if R.Envenom:IsReady()and h:IsInMeleeRange(10)and g:BuffRemains(R.SliceandDice)<5 and g:ComboPoints()>=4 then if s(R.Envenom,nil,nil,not W)then al=32645;return"Cast Envenom (CttC)"end end else if R.PoisonedKnife:IsCastable()and h:IsInRange(30)and not g:StealthUp(true,true)and Z==0 and g:EnergyTimeToMax()<=g:GCD()*1.5 then if s(R.PoisonedKnife)then al=185565;return"Cast Poisoned Knife"end end end;a0=ba()if a0 then return a0 end;a0=bd()if a0 then return a0 end;if r()and Q.Commons.Enabled.Racials then if R.ArcaneTorrent:IsCastable()and W and g:EnergyDeficit()>15 then if s(R.ArcaneTorrent,nil)then al=155145;return"Cast Arcane Torrent"end end;if R.ArcanePulse:IsCastable()and W then if s(R.ArcanePulse,nil)then al=260364;return"Cast Arcane Pulse"end end;if R.LightsJudgment:IsCastable()and W then if s(R.LightsJudgment,nil)then al=255647;return"Cast Lights Judgment"end end;if R.BagofTricks:IsCastable()and W then if s(R.BagofTricks,nil)then al=312411;return"Cast Bag of Tricks"end end end;if(R.Mutilate:IsCastable()or R.Ambush:IsCastable()or R.AmbushOverride:IsCastable())and TargetInAoERange then if s(R.PoolEnergy)then al=99999;return"Normal Pooling"end end end end;local function bi()R.Deathmark:RegisterAuraTracking()R.Sepsis:RegisterAuraTracking()R.Garrote:RegisterAuraTracking()end;function ReturnSpellAss()if al==0 then return 0 else return al end end;function ReturnSpellMOAss()if am==0 then return 0 else return am end end;p.SetAPL(259,bf,bi)