local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=d.Spell;local j=d.MultiSpell;local k=d.Item;local l=d.Utils.num;local m=d.Utils.BoolToInt;local n=d.Utils.IntToBool;local o=d.Utils.ValueIsInArray;local p=HeroRotation;local q=p.AoEON;local r=p.CDsON;local s=p.Cast;local t=p.CastPooling;local u=p.CastLeftNameplate;local v=HeroRotationCharDB.Toggles[4]local w=HeroRotationCharDB.Toggles[5]local x=HeroRotationCharDB.Toggles[12]local y=not HeroRotationCharDB.Toggles[15]local z=HeroRotationCharDB.Toggles[20]local A=HeroRotationCharDB.Toggles[21]local B=HeroRotationCharDB.Toggles[22]local C=HeroRotationCharDB.Toggles[23]local D=HeroRotationCharDB.Toggles[24]local E=HeroRotationCharDB.Toggles[25]local F=HeroRotationCharDB.Toggles[26]local G=HeroRotationCharDB.Toggles[27]local H=HeroRotationCharDB.Toggles[28]local I=HeroRotationCharDB.Toggles[29]local J=HeroRotationCharDB.Toggles[30]local K=HeroRotationCharDB.Toggles[54]local L=math.min;local pairs=pairs;local M=math.floor;local N=math.max;local O=p.Commons.Everyone;local P=p.Commons.Rogue;local Q={General=p.GUISettings.General,Commons=p.GUISettings.APL.Rogue.Commons,Assassination=p.GUISettings.APL.Rogue.Assassination}local R=i.Rogue.Assassination;local S=k.Rogue.Assassination;local T={}local U,V,W=0,TargetInAoERange;local X,Y,Z,_;local a0;local a1,a2=2*g:SpellHaste(),1*g:SpellHaste()local a3,a4;local a5,a6,a7,a8,a9,aa,ab;local ac;local ad,ae,af,ag,ah,ai,aj,ak;local al=0;local am=P.ReturnSpell()local an=P.ReturnSpellMO()local ao=g:GetEquipment()local ap=ao[13]and k(ao[13])or k(0)local aq=ao[14]and k(ao[14])or k(0)local function ar()if ap:TrinketHasStatAnyDps()and(not aq:TrinketHasStatAnyDps()or ap:Cooldown()>=aq:Cooldown())then al=1 elseif aq:TrinketHasStatAnyDps()and(not ap:TrinketHasStatAnyDps()or aq:Cooldown()>ap:Cooldown())then al=2 else al=0 end end;ar()d:RegisterForEvent(function()ao=g:GetEquipment()ap=ao[13]and k(ao[13])or k(0)aq=ao[14]and k(ao[14])or k(0)ar()end,"PLAYER_EQUIPMENT_CHANGED")local function l(as)if as then return 1 else return 0 end end;R.Envenom:RegisterDamageFormula(function()return g:AttackPowerDamageMod()*a3*0.22*1.0*(h:DebuffUp(R.ShivDebuff)and 1.3 or 1)*(R.DeeperStratagem:IsAvailable()and 1.05 or 1)*(1+g:MasteryPct()/100)*(1+g:VersatilityDmgPct()/100)end)R.Mutilate:RegisterDamageFormula(function()return(g:AttackPowerDamageMod()+g:AttackPowerDamageMod(true))*0.485*1.0*(1+g:VersatilityDmgPct()/100)end)local function at()return g:BuffRemains(R.MasterAssassinBuff)==9999 end;local function au()if at()then return g:GCDRemains()+3 end;return g:BuffRemains(R.MasterAssassinBuff)end;local function av()if g:BuffUp(R.ImprovedGarroteAura)then return g:GCDRemains()+3 end;return g:BuffRemains(R.ImprovedGarroteBuff)end;local function aw()if g:BuffUp(R.IndiscriminateCarnageAura)then return g:GCDRemains()+10 end;return g:BuffRemains(R.IndiscriminateCarnageBuff)end;local function ax()if Z<2 then return false elseif Q.Commons.UsePriorityRotation=="Always"then return true elseif Q.Commons.UsePriorityRotation=="On Bosses"and h:IsInBossList()then return true elseif Q.Commons.UsePriorityRotation=="Auto"then if g:InstanceDifficulty()==16 and h:NPCID()==138967 then return true end end;return false end;local function ay()if h:DebuffUp(R.Deathmark)or h:DebuffUp(R.Kingsbane)or g:BuffUp(R.ShadowDanceBuff)or h:DebuffUp(R.ShivDebuff)or R.ThistleTea:FullRechargeTime()<20 or g:EnergyPercentage()>=12 or g:HasTier(31,4)and(g:BuffUp(R.Envenom)and g:BuffRemains(R.Envenom)<=2 or d.BossFilteredFightRemains("<=",90))then return true end;return false end;local function az()if R.Deathmark:CooldownRemains()>R.Sepsis:CooldownRemains()and(d.BossFightRemainsIsNotValid()or d.BossFilteredFightRemains(">",R.Deathmark:CooldownRemains()))then return R.Deathmark:CooldownRemains()end;return R.Sepsis:CooldownRemains()end;local function aA()if not R.ScentOfBlood:IsAvailable()then return true end;return g:BuffStack(R.ScentOfBloodBuff)>=L(20,R.ScentOfBlood:TalentRank()*2*Z)end;local function aB(aC,i,aD)local aD=aD or i:PandemicThreshold()return aC:DebuffRefreshable(i,aD)end;local function aE(aF,aG,aH,aI)local aJ,aK=nil,aH;local aL=h:GUID()for aM,aN in pairs(aI)do if aN:GUID()~=aL and O.UnitIsCycleValid(aN,aK,-aN:DebuffRemains(aF))and aG(aN)then aJ,aK=aN,aN:TimeToDie()end end;if aJ then if aJ:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then if aF:ID()==703 then an=1703 elseif aF:ID()==1943 then an=11943 end elseif Q.Assassination.TargetSwap=="AutoSwap"and aJ:GUID()~=h:GUID()and not x then an=9999 elseif aJ:GUID()==h:GUID()then am=aF:ID()end;u(aJ,aF)elseif Q.Commons.RangedMultiDoT then aJ,aK=nil,aH;for aM,aN in pairs(Y)do if aN:GUID()~=aL and O.UnitIsCycleValid(aN,aK,-aN:DebuffRemains(aF))and aG(aN)then aJ,aK=aN,aN:TimeToDie()end end;if aJ then if aJ:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then if aF:ID()==703 then an=1703 elseif aF:ID()==1943 then an=11943 end elseif Q.Assassination.TargetSwap=="AutoSwap"and aJ:GUID()~=h:GUID()and not x then an=9999 elseif aJ:GUID()==h:GUID()then am=aF:ID()end;u(aJ,aF)end end end;local function aO(aP,aQ,aR)local aS=aQ(h)if aP=="first"and aS~=0 then return h end;local aJ,aT=nil,0;local function aU(aI)for aM,aN in pairs(aI)do local aV=aQ(aN)if not aJ and aP=="first"then if aV~=0 then aJ,aT=aN,aV end elseif aP=="min"then if not aJ or aV<aT then aJ,aT=aN,aV end elseif aP=="max"then if not aJ or aV>aT then aJ,aT=aN,aV end end;if aJ and aV==aT and aN:TimeToDie()>aJ:TimeToDie()then aJ,aT=aN,aV end end end;aU(_)if Q.Commons.RangedMultiDoT then aU(Y)end;if aJ and aT==aS and aR(h)then return h end;if aJ and aR(aJ)then return aJ end;return nil end;local function aW(aX,aY,aZ)local a_=h:TimeToDie()if not d.BossFightRemainsIsNotValid()then a_=d.BossFightRemains()elseif a_<aZ then return false end;if M((a_-aZ)/aX)>M((a_-aZ-aY)/aX)then return true end;return false end;local function b0(aC)if aC:DebuffUp(R.SerratedBoneSpikeDebuff)then return 1000000 end;return aC:TimeToDie()end;local function b1(aC)if not aC:DebuffUp(R.SerratedBoneSpikeDebuff)and aC:IsInMeleeRange(10)and aC:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then an=1328547;return true elseif not aC:DebuffUp(R.SerratedBoneSpikeDebuff)and aC:IsInMeleeRange(10)and Q.Assassination.TargetSwap=="AutoSwap"and aC:GUID()~=h:GUID()and not x then an=9999;return true elseif not aC:DebuffUp(R.SerratedBoneSpikeDebuff)and aC:IsInMeleeRange(10)and aC:GUID()==h:GUID()then am=328547;return true elseif not aC:DebuffUp(R.SerratedBoneSpikeDebuff)and aC:IsInMeleeRange(10)then return true end end;local function b2()if R.BloodFury:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.BloodFury,nil)then am=20572;return"Cast Blood Fury"end end;if R.Berserking:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.Berserking,nil)then am=26297;return"Cast Berserking"end end;if R.Fireblood:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.Fireblood,nil)then am=265221;return"Cast Fireblood"end end;if R.AncestralCall:IsReady()and r()and Q.Commons.Enabled.Racials then if p.Cast(R.AncestralCall,nil)then am=274738;return"Cast Ancestral Call"end end end;local function b3()if R.ShadowDance:IsCastable()and not R.Kingsbane:IsAvailable()and r()and not A and h:IsInMeleeRange(10)and not g:IsTanking(h)then if R.ImprovedGarrote:IsAvailable()and R.Garrote:CooldownUp()and(h:PMultiplier(R.Garrote)<=1 or aB(h,R.Garrote))and(R.Deathmark:AnyDebuffUp()or R.Deathmark:CooldownRemains()<12 or R.Deathmark:CooldownRemains()>60)and a4>=math.min(Z,4)then if Q.Commons.ShowPooling and g:EnergyPredicted()<45 then if s(R.PoolEnergy)then am=999999;return"Pool for Shadow Dance (Garrote)"end end;if s(R.ShadowDance,nil)then am=185313;return"Cast Shadow Dance (Garrote)"end end;if not R.ImprovedGarrote:IsAvailable()and R.MasterAssassin:IsAvailable()and not aB(h,R.Rupture)and h:DebuffRemains(R.Garrote)>3 and(h:DebuffUp(R.Deathmark)or R.Deathmark:CooldownRemains()>60)and(h:DebuffUp(R.ShivDebuff)or h:DebuffRemains(R.Deathmark)<4 or h:DebuffUp(R.Sepsis))and h:DebuffRemains(R.Sepsis)<3 then if s(R.ShadowDance,nil)then am=185313;return"Cast Shadow Dance (Master Assassin)"end end end;if R.Vanish:IsCastable()and not g:IsTanking(h)then if R.ImprovedGarrote:IsAvailable()and not R.MasterAssassin:IsAvailable()and R.Garrote:CooldownUp()and(h:PMultiplier(R.Garrote)<=1 or aB(h,R.Garrote))then if not R.IndiscriminateCarnage:IsAvailable()and(R.Deathmark:AnyDebuffUp()or R.Deathmark:CooldownRemains()<4)and a4>=L(Z,4)then if Q.Commons.ShowPooling and g:EnergyPredicted()<45 then if s(R.PoolEnergy)then am=999999;return"Pool for Vanish (Garrote Deathmark)"end end;if s(R.Vanish,nil)then am=1856;return"Cast Vanish (Garrote Deathmark)"end end;if R.IndiscriminateCarnage:IsAvailable()and Z>2 then if Q.Commons.ShowPooling and g:EnergyPredicted()<45 then if s(R.PoolEnergy)then return"Pool for Vanish (Garrote Deathmark)"end end;if s(R.Vanish,nil)then am=1856;return"Cast Vanish (Garrote Cleave)"end end end;if R.MasterAssassin:IsAvailable()and R.Kingsbane:IsAvailable()and h:DebuffUp(R.Kingsbane)and h:DebuffRemains(R.Kingsbane)<=3 and h:DebuffUp(R.Deathmark)and h:DebuffRemains(R.Deathmark)<=3 then if s(R.Vanish,nil)then am=1856;return"Cast Vanish (Kingsbane)"end end;if not R.ImprovedGarrote:IsAvailable()and R.MasterAssassin:IsAvailable()and not aB(h,R.Rupture)and h:DebuffRemains(R.Garrote)>3 and h:DebuffUp(R.Deathmark)and(h:DebuffUp(R.ShivDebuff)or h:DebuffRemains(R.Deathmark)<4 or h:DebuffUp(R.Sepsis))and h:DebuffRemains(R.Sepsis)<3 then if s(R.Vanish,nil)then am=1856;return"Cast Vanish (Master Assassin)"end end end end;local function b4()if not TargetInAoERange then return end;if not p.CDsON()then return end;if R.Sepsis:IsReady()and h:DebuffRemains(R.Rupture)>20 and(not R.ImprovedGarrote:IsAvailable()and h:DebuffUp(R.Garrote)or R.ImprovedGarrote:IsAvailable()and R.Garrote:CooldownUp()and h:PMultiplier(R.Garrote)<=1)and(h:FilteredTimeToDie(">",10)or d.BossFilteredFightRemains("<=",10))then if s(R.Sepsis,nil,true)then am=328305;return"Cast Sepsis"end end;if not g:StealthUp(true,false)then if ap:IsReady()and not o(T,ap:ID())and(al==1 and(R.Deathmark:AnyDebuffUp()or d.BossFilteredFightRemains("<",20))or al==2 and(not aq:IsReady()or R.Deathmark:CooldownRemains()>20)or al==0)then if p.Cast(aq,nil,nil)then if ap:ID()==TopTrinketID and Q.Commons.Enabled.TopTrinket then am=24;return"Generic use_items for "..ap:Name()elseif ap:ID()==BotTrinketID and Q.Commons.Enabled.BottomTrinket then am=25;return"Generic use_items for "..ap:Name()end end elseif aq:IsReady()and not o(T,aq:ID())and(al==2 and(R.Deathmark:AnyDebuffUp()or d.BossFilteredFightRemains("<",20))or al==1 and(not ap:IsReady()or R.Deathmark:CooldownRemains()>20)or al==0)then if p.Cast(aq,nil,nil)then if aq:ID()==TopTrinketID and Q.Commons.Enabled.TopTrinket then am=24;return"Generic use_items for "..aq:Name()elseif aq:ID()==BotTrinketID and Q.Commons.Enabled.BottomTrinket then am=25;return"Generic use_items for "..aq:Name()end end end end;local b5=not g:StealthUp(true,false)and h:DebuffUp(R.Rupture)and g:BuffUp(R.Envenom)and not R.Deathmark:AnyDebuffUp()and(not R.MasterAssassin:IsAvailable()or h:DebuffUp(R.Garrote))and(not R.Kingsbane:IsAvailable()or R.Kingsbane:CooldownRemains()<=2)if R.Deathmark:IsCastable()and(b5 or d.BossFilteredFightRemains("<=",20))then if s(R.Deathmark,nil)then am=360194;return"Cast Deathmark"end end;if R.Shiv:IsReady()and not h:DebuffUp(R.ShivDebuff)and h:DebuffUp(R.Garrote)and h:DebuffUp(R.Rupture)then if d.BossFilteredFightRemains("<=",R.Shiv:Charges()*8)then if s(R.Shiv,nil)then am=5938;return"Cast Shiv (End of Fight)"end end;if R.Kingsbane:IsAvailable()then if not R.LightweightShiv:IsAvailable()and(h:DebuffUp(R.Kingsbane)and h:DebuffRemains(R.Kingsbane)<8 or R.Kingsbane:CooldownRemains()>=24)and(not R.CrimsonTempest:IsAvailable()or aj or h:DebuffUp(R.CrimsonTempest))then if s(R.Shiv,nil)then am=5938;return"Cast Shiv (Kingsbane)"end end;if R.LightweightShiv:IsAvailable()and(h:DebuffUp(R.Kingsbane)or R.Kingsbane:CooldownRemains()<=1)then if s(R.Shiv,nil)then am=5938;return"Cast Shiv (Kingsbane Lightweight)"end end end;if R.ArterialPrecision:IsAvailable()and R.Deathmark:AnyDebuffUp()then if s(R.Shiv,nil)then am=5938;return"Cast Shiv (Arterial Precision)"end end;if not R.Kingsbane:IsAvailable()and not R.ArterialPrecision:IsAvailable()then if R.Sepsis:IsAvailable()then if R.Shiv:ChargesFractional()>0.9+m(R.LightweightShiv:IsAvailable())and ae>5 or h:DebuffUp(R.Sepsis)or h:DebuffUp(R.Deathmark)then if s(R.Shiv,nil)then am=5938;return"Cast Shiv (Sepsis)"end end else if not R.CrimsonTempest:IsAvailable()or aj or h:DebuffUp(R.CrimsonTempest)then if s(R.Shiv,nil)then am=5938;return"Cast Shiv"end end end end end;if Q.Commons.Enabled.Potions and r()and y and((g:BloodlustUp()or d.BossFightRemains()<=30 or h:DebuffUp(R.Deathmark))and not p.GUISettings.General.HoldPotforBL or p.GUISettings.General.HoldPotforBL and g:BloodlustUp())then local b6=O.PotionSelected()if b6 and b6:IsReady()then if s(b6,nil,nil)then am=37;return"potion cooldowns 2"end end end;if R.ShadowDance:IsCastable()and R.Kingsbane:IsAvailable()and g:BuffUp(R.Envenom)and(R.Deathmark:CooldownRemains()>=50 or b5)then if s(R.ShadowDance,nil)then am=185313;return"Cast Shadow Dance (Kingsbane Sync)"end end;if R.Kingsbane:IsReady()and(h:DebuffUp(R.ShivDebuff)or R.Shiv:CooldownRemains()<6)and g:BuffUp(R.Envenom)and(R.Deathmark:CooldownRemains()>=50 or h:DebuffUp(R.Deathmark))then if s(R.Kingsbane,nil)then am=385627;return"Cast Kingsbane"end end;if R.ThistleTea:IsCastable()and not g:BuffUp(R.ThistleTea)and(g:EnergyDeficit()>=100+ag and(not R.Kingsbane:IsAvailable()or R.ThistleTea:Charges()>=2)or(h:DebuffUp(R.Kingsbane)and h:DebuffRemains(R.Kingsbane)<6 or not R.Kingsbane:IsAvailable()and R.Deathmark:AnyDebuffUp())or d.BossFilteredFightRemains("<",R.ThistleTea:Charges()*6))then if p.Cast(R.ThistleTea,nil)then am=381623;return"Cast Thistle Tea"end end;if R.Deathmark:AnyDebuffUp()and not a0 then if a0 then b2()else a0=b2()end end;if not g:StealthUp(true,true)and av()<=0 and au()<=0 then if a0 then b3()else a0=b3()end end;if R.ColdBlood:IsReady()and g:DebuffDown(R.ColdBlood)and a3>=4 and not a0 then if s(R.ColdBlood,nil)then am=382245;return"Cast Cold Blood"end end;return a0 end;local function b7()if R.Kingsbane:IsAvailable()and g:BuffUp(R.Envenom)then if R.Shiv:IsReady()and(h:DebuffUp(R.Kingsbane)or R.Kingsbane:CooldownUp())and h:DebuffDown(R.ShivDebuff)then if s(R.Shiv,nil)then am=5938;return"Cast Shiv (Stealth Kingsbane)"end end;if R.Kingsbane:IsReady()and g:BuffRemains(R.ShadowDanceBuff)>=2 then if s(R.Kingsbane,nil)then am=385627;return"Cast Kingsbane (Dance)"end end end;if a3>=4 then if h:DebuffUp(R.Kingsbane)and g:BuffRemains(R.Envenom)<=2 then if s(R.Envenom,nil,nil,not W)then am=32645;return"Cast Envenom (Stealth Kingsbane)"end end;if aj and at()and g:BuffDown(R.ShadowDanceBuff)then if s(R.Envenom,nil,nil,not W)then am=32645;return"Cast Envenom (Master Assassin)"end end end;if p.AoEON()and R.CrimsonTempest:IsReady()and R.Nightstalker:IsAvailable()and Z>=3 and a3>=4 and not R.Deathmark:IsReady()then for aM,aN in pairs(Y)do if aB(aN,R.CrimsonTempest,a6)and aN:FilteredTimeToDie(">",6,-aN:DebuffRemains(R.CrimsonTempest))then if s(R.CrimsonTempest)then am=121411;return"Cast Crimson Tempest (Stealth)"end end end end;if R.Garrote:IsCastable()and av()>0 then local function b8(aC)return aC:DebuffRemains(R.Garrote)end;local function b9(aC)if(aC:PMultiplier(R.Garrote)<=1 or aC:DebuffRemains(R.Garrote)<12/P.ExsanguinatedRate(aC,R.Garrote)or aw()>0 and R.Garrote:AuraActiveCount()<Z)and not aj and(aC:FilteredTimeToDie(">",2,-aC:DebuffRemains(R.Garrote))or aC:TimeToDieIsNotValid())and P.CanDoTUnit(aC,a8)then if aC:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then an=1703;return true elseif Q.Assassination.TargetSwap=="AutoSwap"and aC:GUID()~=h:GUID()and not x then an=9999;return true elseif aC:GUID()==h:GUID()then am=703;return true else return true end end end;if p.AoEON()then local ba=aO("min",b8,b9)if ba and ba:GUID()~=h:GUID()then u(ba,R.Garrote)end end;if b9(h)then if s(R.Garrote,nil,nil,not W)then am=703;return"Cast Garrote (Improved Garrote)"end end;if a4>=1+2*l(R.ShroudedSuffocation:IsAvailable())then if g:BuffDown(R.ShadowDanceBuff)and(h:PMultiplier(R.Garrote)<=1 or h:DebuffUp(R.Deathmark)and au()<3)then if s(R.Garrote,nil,nil,not W)then am=703;return"Cast Garrote (Improved Garrote Low CP)"end end;if h:PMultiplier(R.Garrote)<=1 or h:DebuffRemains(R.Garrote)<12 then if s(R.Garrote,nil,nil,not W)then am=703;return"Cast Garrote (Improved Garrote Low CP 2)"end end end end;if a3>=4 and h:PMultiplier(R.Rupture)<=1 and(g:BuffUp(R.ShadowDanceBuff)or h:DebuffUp(R.Deathmark))then if s(R.Rupture,nil,nil,not W)then am=1943;return"Cast Rupture (Nightstalker)"end end end;local function bb()if p.AoEON()and R.CrimsonTempest:IsReady()and Z>=2 and a3>=4 and ag>25 and not R.Deathmark:IsReady()then for aM,aN in pairs(Y)do if aB(aN,R.CrimsonTempest,a6)and aN:PMultiplier(R.CrimsonTempest)<=1 and aN:FilteredTimeToDie(">",6,-aN:DebuffRemains(R.CrimsonTempest))then if s(R.CrimsonTempest)then am=121411;return"Cast Crimson Tempest (AoE High Energy)"end end end end;if R.Garrote:IsCastable()and a4>=1 then local function bc(aC)return aB(aC,R.Garrote)and aC:PMultiplier(R.Garrote)<=1 end;if bc(h)and P.CanDoTUnit(h,a8)and(h:FilteredTimeToDie(">",12,-h:DebuffRemains(R.Garrote))or h:TimeToDieIsNotValid())then if t(R.Garrote,nil,not W)then am=703;return"Pool for Garrote (ST)"end end;if p.AoEON()and not ai and Z>=2 then aE(R.Garrote,bc,12,_)end end;if R.Rupture:IsReady()and a3>=4 then a9=4+m(R.DashingScoundrel:IsAvailable())*5+m(R.Doomblade:IsAvailable())*5+m(ai)*6;local function bd(aC)return aB(aC,R.Rupture,a5)and aC:PMultiplier(R.Rupture)<=1 and(aC:FilteredTimeToDie(">",a9,-aC:DebuffRemains(R.Rupture))or aC:TimeToDieIsNotValid())end;if bd(h)and P.CanDoTUnit(h,a7)then if s(R.Rupture,nil,nil,not W)then am=1943;return"Cast Rupture (Refresh)"end end;if p.AoEON()and(not ai or not ak)then aE(R.Rupture,bd,a9,_)end end;if R.Garrote:IsCastable()and a4>=1 and au()<=0 and(h:PMultiplier(R.Garrote)<=1 or h:DebuffRemains(R.Garrote)<a1 and Z>=3)and(h:DebuffRemains(R.Garrote)<a1*2 and Z>=3)and(h:FilteredTimeToDie(">",4,-h:DebuffRemains(R.Garrote))or h:TimeToDieIsNotValid())then if s(R.Garrote,nil,nil,not W)then am=703;return"Garrote (Fallback)"end end;return false end;local function be()if R.Envenom:IsReady()and a3>=4 and(ad or h:DebuffStack(R.AmplifyingPoisonDebuff)>=20 or a3>P.CPMaxSpend()or not aj)then if s(R.Envenom,nil,nil,not W)then am=32645;return"Cast Envenom"end end;if not(a4>1 or ad or not aj)then return false end;if not aj and R.CausticSpatter:IsAvailable()and h:DebuffUp(R.Rupture)and h:DebuffRemains(R.CausticSpatterDebuff)<=2 then if R.Mutilate:IsCastable()then if s(R.Mutilate,nil,nil,not W)then am=1329;return"Cast Mutilate (Casutic)"end end;if(R.Ambush:IsCastable()or R.AmbushOverride:IsCastable())and(g:StealthUp(true,true)or g:BuffUp(R.BlindsideBuff))then if s(R.Ambush,nil,nil,not W)then am=8676;return"Cast Ambush (Caustic)"end end end;if R.SerratedBoneSpike:IsReady()then if not h:DebuffUp(R.SerratedBoneSpikeDebuff)then if s(R.SerratedBoneSpike,nil,Q.Commons.CovenantDisplayStyle,not TargetInAoERange)then return"Cast Serrated Bone Spike"end else if p.AoEON()then if O.CastTargetIf(R.SerratedBoneSpike,X,"min",b0,b1)then return"Cast Serrated Bone (AoE)"end end;if au()<0.8 then if d.BossFightRemains()<=5 or R.SerratedBoneSpike:MaxCharges()-R.SerratedBoneSpike:ChargesFractional()<=0.25 then if s(R.SerratedBoneSpike,nil,true,not TargetInAoERange)then am=328547;return"Cast Serrated Bone Spike (Dump Charge)"end elseif not aj and h:DebuffUp(R.ShivDebuff)then if s(R.SerratedBoneSpike,nil,true,not TargetInAoERange)then am=328547;return"Cast Serrated Bone Spike (Shiv)"end end end end end;if r()and R.EchoingReprimand:IsReady()then if s(R.EchoingReprimand,nil,nil,not W)then am=323547;return"Cast Echoing Reprimand"end end;if R.FanofKnives:IsCastable()then if p.AoEON()and Z>=1 and(not ac and Z>=2+m(g:StealthUp(true,false))+m(R.DragonTemperedBlades:IsAvailable()))then if t(R.FanofKnives)then am=51723;return"Cast Fan of Knives"end end;if p.AoEON()and g:BuffUp(R.DeadlyPoison)and Z>=3 then for aM,aN in pairs(Y)do if not aN:DebuffUp(R.DeadlyPoisonDebuff,true)and(not ac or aN:DebuffUp(R.Garrote)or aN:DebuffUp(R.Rupture))then if t(R.FanofKnives)then am=5172;return"Cast Fan of Knives (DP Refresh)"end end end end end;if(R.Ambush:IsCastable()or R.AmbushOverride:IsCastable())and(g:StealthUp(true,true)or g:BuffUp(R.BlindsideBuff)or g:BuffUp(R.SepsisBuff))and(h:DebuffDown(R.Kingsbane)or h:DebuffDown(R.Deathmark)or g:BuffUp(R.BlindsideBuff))then if t(R.Ambush,nil,not W)then am=8676;return"Cast Ambush"end end;if R.Mutilate:IsCastable()and Z==2 and h:DebuffDown(R.DeadlyPoisonDebuff,true)and h:DebuffDown(R.AmplifyingPoisonDebuff,true)then local aL=h:GUID()for aM,aN in pairs(_)do if aN:GUID()~=aL and(aN:DebuffUp(R.Garrote)or aN:DebuffUp(R.Rupture))and not aN:DebuffUp(R.DeadlyPoisonDebuff,true)and not aN:DebuffUp(R.AmplifyingPoisonDebuff,true)then if aN:GUID()==f("mouseover"):GUID()and Q.Assassination.TargetSwap=="Mouseover"then an=11329 elseif Q.Assassination.TargetSwap=="AutoSwap"and aN:GUID()~=h:GUID()and not x then an=9999 elseif aN:GUID()==h:GUID()then am=1329 end;u(aN,R.Mutilate)break end end end;if R.Mutilate:IsCastable()then if t(R.Mutilate,nil,not W)then am=1329;return"Cast Mutilate"end end;return false end;local function bf()w=HeroRotationCharDB.Toggles[5]v=HeroRotationCharDB.Toggles[4]x=HeroRotationCharDB.Toggles[12]y=not HeroRotationCharDB.Toggles[15]z=HeroRotationCharDB.Toggles[20]A=HeroRotationCharDB.Toggles[21]B=HeroRotationCharDB.Toggles[22]C=HeroRotationCharDB.Toggles[23]D=HeroRotationCharDB.Toggles[24]E=HeroRotationCharDB.Toggles[25]F=HeroRotationCharDB.Toggles[26]G=HeroRotationCharDB.Toggles[27]H=HeroRotationCharDB.Toggles[28]I=HeroRotationCharDB.Toggles[29]J=HeroRotationCharDB.Toggles[30]K=HeroRotationCharDB.Toggles[54]TopTrinketID=GetInventoryItemID("player",13)BotTrinketID=GetInventoryItemID("player",14)if not Q.Commons.Enabled.TopTrinket and not Q.Commons.Enabled.BotTrinket then OnUseExcludes={TopTrinketID,BotTrinketID,S.CacheOfAcquiredTreasures:ID()}elseif not Q.Commons.Enabled.TopTrinket and Q.Commons.Enabled.BotTrinket then OnUseExcludes={TopTrinketID,S.CacheOfAcquiredTreasures:ID()}elseif not Q.Commons.Enabled.BotTrinket and Q.Commons.Enabled.TopTrinket then OnUseExcludes={BotTrinketID,S.CacheOfAcquiredTreasures:ID()}end end;local function bg()U=R.AcrobaticStrikes:IsAvailable()and 8 or 5;V=R.AcrobaticStrikes:IsAvailable()and 13 or 10;W=h:IsInMeleeRange(U)TargetInAoERange=h:IsInMeleeRange(V)if q()then X=g:GetEnemiesInRange(30)Y=g:GetEnemiesInMeleeRange(V)Z=#Y;_=g:GetEnemiesInMeleeRange(U)else X={}Y={}Z=1;_={}end;a1,a2=2*g:SpellHaste(),1*g:SpellHaste()a3=P.EffectiveComboPoints(g:ComboPoints())a4=g:ComboPointsMax()-a3;a5=(4+a3*4)*0.3;a6=(4+a3*2)*0.3;a7=R.Envenom:Damage()*Q.Assassination.EnvenomDMGOffset;a8=R.Mutilate:Damage()*Q.Assassination.MutilateDMGOffset;ac=ax()a0=bf()if a0 then return a0 end;if an>0 then an=0 end;if am>0 then am=0 end;am=P.ReturnSpell()an=P.ReturnSpellMO()a0=P.CrimsonVial()if a0 then return a0 end;a0=P.Feint()if a0 then return a0 end;local bh=g:AffectingCombat()and 180 or 900;local bi;if i(8679):IsAvailable()and(Q.Assassination.LethalPoison1=="Wound Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Wound Poison")then bi=g:BuffRemains(i(8679))if bi<bh and not g:IsCasting(i(8679))then if p.Cast(i(8679))then am=203;return"Wound Poison Refresh"end end elseif i(2823):IsAvailable()and(Q.Assassination.LethalPoison1=="Deadly Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Deadly Poison")then bi=g:BuffRemains(i(2823))if bi<bh and not g:IsCasting(i(2823))then if p.Cast(i(2823))then am=208;return"Deadly Poison Refresh"end end elseif i(315584):IsAvailable()and(Q.Assassination.LethalPoison1=="Instant Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Instant Poison")then bi=g:BuffRemains(i(315584))if bi<bh and not g:IsCasting(i(315584))then if p.Cast(i(315584))then am=205;return"Instant Poison Refresh"end end elseif i(381664):IsAvailable()and(Q.Assassination.LethalPoison1=="Amplifying Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.LethalPoison2=="Amplifying Poison")then bi=g:BuffRemains(i(381664))if bi<bh and not g:IsCasting(i(381664))then if p.Cast(i(381664))then am=209;return"Amplifying Poison Refresh"end end end;if i(381637):IsAvailable()and(Q.Assassination.NonLethalPoison1=="Atrophic Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.NonLethalPoison2=="Atrophic Poison")then bi=g:BuffRemains(i(381637))if bi<bh and not g:IsCasting(i(381637))then if p.Cast(i(381637))then am=381637;return"Atropic Poison Refresh"end end elseif i(5761):IsAvailable()and(Q.Assassination.NonLethalPoison1=="Numbing Poison"or R.DragonTemperedBlades:IsAvailable()and Q.Assassination.NonLethalPoison2=="Numbing Poison")then bi=g:BuffRemains(i(5761))if bi<bh and not g:IsCasting(NumbingPoison)then if p.Cast(i(5761))then am=204;return"Numbing Poison Refresh"end end end;if not g:AffectingCombat()and not g:IsDeadOrGhost()then if not g:BuffUp(P.VanishBuffSpell())then a0=P.Stealth(P.StealthSpell())if a0 then return a0 end end;if not g:BuffUp(R.SliceandDice)then if R.SliceandDice:IsReady()and a3>=2 then if s(R.SliceandDice)then am=5171;return"Cast Slice and Dice"end end end end;P.MfDSniping(R.MarkedforDeath)if O.TargetIsValid()and(g:AffectingCombat()or w)then if a0 then return a0 end;af=P.PoisonedBleeds()ag=g:EnergyRegen()+af*6/(2*g:SpellHaste())ah=g:EnergyDeficit()/ag;ai=ag>35;ad=ay()ae=az()ak=aA()aj=Z<2;if g:StealthUp(true,false)or av()>0 or au()>0 then a0=b7()if a0 then return a0 .." (Stealthed)"end end;a0=b4()if a0 then return a0 end;if not g:BuffUp(R.SliceandDice)and h:IsInMeleeRange(10)then if R.SliceandDice:IsReady()and g:ComboPoints()>=2 and h:DebuffUp(R.Rupture)or not R.CutToTheChase:IsAvailable()and g:ComboPoints()>=4 and g:BuffRemains(R.SliceandDice)<(1+g:ComboPoints())*1.8 then if s(R.SliceandDice)then am=5171;return"Cast Slice and Dice"end end elseif TargetInAoERange and R.CutToTheChase:IsAvailable()then if R.Envenom:IsReady()and h:IsInMeleeRange(10)and g:BuffRemains(R.SliceandDice)<5 and g:ComboPoints()>=4 then if s(R.Envenom,nil,nil,not W)then am=32645;return"Cast Envenom (CttC)"end end else if R.PoisonedKnife:IsCastable()and h:IsInRange(30)and not g:StealthUp(true,true)and Z==0 and g:EnergyTimeToMax()<=g:GCD()*1.5 then if s(R.PoisonedKnife)then am=185565;return"Cast Poisoned Knife"end end end;a0=bb()if a0 then return a0 end;a0=be()if a0 then return a0 end;if r()and Q.Commons.Enabled.Racials then if R.ArcaneTorrent:IsCastable()and W and g:EnergyDeficit()>15 then if s(R.ArcaneTorrent,nil)then am=155145;return"Cast Arcane Torrent"end end;if R.ArcanePulse:IsCastable()and W then if s(R.ArcanePulse,nil)then am=260364;return"Cast Arcane Pulse"end end;if R.LightsJudgment:IsCastable()and W then if s(R.LightsJudgment,nil)then am=255647;return"Cast Lights Judgment"end end;if R.BagofTricks:IsCastable()and W then if s(R.BagofTricks,nil)then am=312411;return"Cast Bag of Tricks"end end end;if(R.Mutilate:IsCastable()or R.Ambush:IsCastable()or R.AmbushOverride:IsCastable())and TargetInAoERange then if s(R.PoolEnergy)then am=99999;return"Normal Pooling"end end end end;local function bj()R.Deathmark:RegisterAuraTracking()R.Sepsis:RegisterAuraTracking()R.Garrote:RegisterAuraTracking()end;function ReturnSpellAss()if am==0 then return 0 else return am end end;function ReturnSpellMOAss()if an==0 then return 0 else return an end end;p.SetAPL(259,bg,bj)