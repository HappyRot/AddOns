local a,b=...local c=HeroDBC.DBC;local d=HeroLib;local e=HeroCache;local f=d.Unit;local g=f.Player;local h=f.Target;local i=d.Spell;local j=d.MultiSpell;local k=d.Item;local l=HeroRotation;local m=l.AoEON;local n=l.CDsON;local o=HeroRotationCharDB.Toggles[4]local p=HeroRotationCharDB.Toggles[5]local q=HeroRotationCharDB.Toggles[6]local r=HeroRotationCharDB.Toggles[12]local s=HeroRotationCharDB.Toggles[15]local t=HeroRotationCharDB.Toggles[21]local u=HeroRotationCharDB.Toggles[52]local v=HeroRotationCharDB.Toggles[22]local w=HeroRotationCharDB.Toggles[23]local x=HeroRotationCharDB.Toggles[24]local y=HeroRotationCharDB.Toggles[25]local z=HeroRotationCharDB.Toggles[27]local A=HeroRotationCharDB.Toggles[50]local B=HeroRotationCharDB.Toggles[51]local C=HeroRotationCharDB.Toggles[53]local D=math.min;local E=math.abs;local F=nil;local G=nil;local H=GetInventoryItemID("player",13)local I=GetInventoryItemID("player",14)local J=l.Commons.Everyone;local K=l.Commons.Rogue;local L={General=l.GUISettings.General,Commons=l.GUISettings.APL.Rogue.Commons,Commons2=l.GUISettings.APL.Rogue.Commons2,Outlaw=l.GUISettings.APL.Rogue.Outlaw}local M=i.Rogue.Outlaw;local N=k.Rogue.Outlaw;local O={N.ComputationDevice:ID(),N.VigorTrinket:ID(),N.FontOfPower:ID(),N.RazorCoral:ID(),N.MistcallerOcarina:ID()}M.Dispatch:RegisterDamageFormula(function()return g:AttackPowerDamageMod()*K.CPSpend()*0.35*1.13*(1+g:VersatilityDmgPct()/100)*(h:DebuffUp(M.GhostlyStrike)and 1.1 or 1)*(h:DebuffUp(M.SinfulRevelationDebuff)and 1.06 or 1)end)local P,Q,R;local S;local T=K.ReturnSpell()local U=K.ReturnSpellMO()local V=6;local W;local X={{M.Blind,"Cast Blind (Interrupt)",function()return true end}}local Y=g:HasLegendaryEquipped(116)local Z=g:HasLegendaryEquipped(117)d:RegisterForEvent(function()Y=g:HasLegendaryEquipped(116)Z=g:HasLegendaryEquipped(117)end,"PLAYER_EQUIPMENT_CHANGED")local function _(a0)if a0 then return 1 else return 0 end end;local a1,a2=0,0;local function a3()local a4=g:EnergyTimeToMaxPredicted()if E(a1-a4)>1 then a1=a4 end;return a1 end;local function a5()local a6=g:EnergyPredicted()if E(a2-a6)>9 then a2=a6 end;return a2 end;local function a7(a8)return a8:TimeToDie()end;local function a9(a8)if(a8:FilteredTimeToDie("<",g:ComboPointsDeficit()*1.5)or not g:StealthUp(true,false)and g:ComboPointsDeficit()>=K.CPMaxSpend()-1)and a8:GUID()==f("mouseover"):GUID()and L.Outlaw.TargetSwap=="Mouseover"then U=1376195;return true elseif(a8:FilteredTimeToDie("<",g:ComboPointsDeficit()*1.5)or not g:StealthUp(true,false)and g:ComboPointsDeficit()>=K.CPMaxSpend()-1)and L.Outlaw.TargetSwap=="AutoSwap"and a8:GUID()~=h:GUID()and not r then U=999;return true elseif(a8:FilteredTimeToDie("<",g:ComboPointsDeficit()*1.5)or not g:StealthUp(true,false)and g:ComboPointsDeficit()>=K.CPMaxSpend()-1)and a8:GUID()==h:GUID()then T=137619;return true elseif a8:FilteredTimeToDie("<",g:ComboPointsDeficit()*1.5)or not g:StealthUp(true,false)and g:ComboPointsDeficit()>=K.CPMaxSpend()-1 then return true end end;local aa={M.Broadside,M.BuriedTreasure,M.GrandMelee,M.RuthlessPrecision,M.SkullandCrossbones,M.TrueBearing}local function ab(ac,ad)if not e.APLVar.RtB_List then e.APLVar.RtB_List={}end;if not e.APLVar.RtB_List[ac]then e.APLVar.RtB_List[ac]={}end;local ae=table.concat(ad)if ac=="All"then if not e.APLVar.RtB_List[ac][ae]then local af=0;for ag=1,#ad do if g:BuffUp(aa[ad[ag]])then af=af+1 end end;e.APLVar.RtB_List[ac][ae]=af==#ad and true or false end else if not e.APLVar.RtB_List[ac][ae]then e.APLVar.RtB_List[ac][ae]=false;for ag=1,#ad do if g:BuffUp(aa[ad[ag]])then e.APLVar.RtB_List[ac][ae]=true;break end end end end;return e.APLVar.RtB_List[ac][ae]end;local function ah()if not e.APLVar.RtB_Buffs then e.APLVar.RtB_Buffs=0;for ag=1,#aa do if g:BuffUp(aa[ag])then e.APLVar.RtB_Buffs=e.APLVar.RtB_Buffs+1 end end end;return e.APLVar.RtB_Buffs end;local function ai()if not e.APLVar.RtB_Reroll then if L.Outlaw.RolltheBonesLogic=="1+ Buff"then e.APLVar.RtB_Reroll=ah()<=0 and true or false elseif L.Outlaw.RolltheBonesLogic=="Broadside"then e.APLVar.RtB_Reroll=not g:BuffUp(M.Broadside)and true or false elseif L.Outlaw.RolltheBonesLogic=="Buried Treasure"then e.APLVar.RtB_Reroll=not g:BuffUp(M.BuriedTreasure)and true or false elseif L.Outlaw.RolltheBonesLogic=="Grand Melee"then e.APLVar.RtB_Reroll=not g:BuffUp(M.GrandMelee)and true or false elseif L.Outlaw.RolltheBonesLogic=="Skull and Crossbones"then e.APLVar.RtB_Reroll=not g:BuffUp(M.SkullandCrossbones)and true or false elseif L.Outlaw.RolltheBonesLogic=="Ruthless Precision"then e.APLVar.RtB_Reroll=not g:BuffUp(M.RuthlessPrecision)and true or false elseif L.Outlaw.RolltheBonesLogic=="True Bearing"then e.APLVar.RtB_Reroll=not g:BuffUp(M.TrueBearing)and true or false else e.APLVar.RtB_Reroll=ah()<2 and(not g:BuffUp(M.TrueBearing)and not g:BuffUp(M.Broadside))and true or false end;if J.IsSoloMode()then if g:BuffUp(M.GrandMelee)then if g:IsTanking(h)or g:HealthPercentage()<D(L.Outlaw.RolltheBonesLeechKeepHP,L.Outlaw.RolltheBonesLeechRerollHP)then e.APLVar.RtB_Reroll=false end elseif g:HealthPercentage()<L.Outlaw.RolltheBonesLeechRerollHP then e.APLVar.RtB_Reroll=true end end end;return e.APLVar.RtB_Reroll end;local function aj()return g:ComboPoints()>=K.CPMaxSpend()-_(g:BuffUp(M.Broadside))-_(g:BuffUp(M.Opportunity))*_(M.QuickDraw:IsAvailable())or g:ComboPoints()==K.AnimachargedCP()end;local function ak()return g:ComboPointsDeficit()>=2+_(g:BuffUp(M.Broadside))and a5()>50 and(not M.CountTheOdds:ConduitEnabled()or K.RtBRemains()>10)end;local function al()return not m()or R<2 or g:BuffRemains(M.BladeFlurry)>1+_(M.KillingSpree:IsAvailable())end;local function am()return L.Commons.VanishOffensive and n()and not(J.IsSoloMode()and g:IsTanking(h))end;local function an()if M.BladeFlurry:IsReady()and m()and R>=2 and not g:BuffUp(M.BladeFlurry)then if l.Cast(M.BladeFlurry)then T=13877;return"Cast Blade Flurry"end end;if h:IsSpellInRange(M.SinisterStrike)then if M.Vanish:IsCastable()and am()and not g:StealthUp(true,true)then if not Z then if ak()and not t and not g:BuffUp(M.DeathlyShadowsBuff)and(not L.Outlaw.Enabled.VanishEchoingReprimand or not M.EchoingReprimand:IsAvailable()or M.EchoingReprimand:CooldownUp()or M.EchoingReprimand:CooldownRemains()>=35)then if l.Cast(M.Vanish,nil)then T=1856;return"Cast Vanish"end end else if K.MasterAssassinsMarkRemains()<=0 and not t and al()then if M.MarkedforDeath:IsAvailable()then if aj()then if l.Cast(M.Vanish,nil)then T=1856;return"Cast Vanish (MA+MfD)"end end else if not M.BetweentheEyes:CooldownUp()and aj()or M.BetweentheEyes:CooldownUp()and ak()then if l.Cast(M.Vanish,nil)then T=1856;return"Cast Vanish (MA)"end end end end end end;if n()and M.Flagellation:IsReady()and o and not h:DebuffUp(M.Flagellation)and(h:FilteredTimeToDie(">",12)or h:IsInBossList())then if l.Cast(M.Flagellation,nil,nil)then T=323654;return"Cast Flagellation"end end;if n()and M.AdrenalineRush:IsCastable()and not g:BuffUp(M.AdrenalineRush)then if l.Cast(M.AdrenalineRush,nil)then T=13750;return"Cast Adrenaline Rush"end end;if M.RolltheBones:IsReady()and K.MasterAssassinsMarkRemains()<=0 and(K.RtBRemains()<=3 or ai())then if l.Cast(M.RolltheBones)then T=315508;return"Cast Roll the Bones"end end end;if al()then if n()and not u and M.KillingSpree:IsCastable()and not g:BuffUp(M.Flagellation)and h:IsSpellInRange(M.KillingSpree)and not g:StealthUp(true,false)and(not Z or M.Vanish:CooldownRemains()>10 or K.MasterAssassinsMarkRemains()>2 or not am())and(h:DebuffUp(M.BetweentheEyes)and g:EnergyDeficitPredicted()>g:EnergyRegen()*2+10 or R>2-_(g:BuffUp(M.DeathlyShadowsBuff))or K.MasterAssassinsMarkRemains()>0)then if l.Cast(M.KillingSpree,nil,nil)then T=51690;return"Cast Killing Spree"end end;if M.BladeRush:IsCastable()and h:IsSpellInRange(M.BladeRush)and(h:IsInRange(5)or not B)and(a3()>2 or R>2)then if l.Cast(M.BladeRush,nil)then T=271877;return"Cast Blade Rush"end end end;if h:IsSpellInRange(M.SinisterStrike)then if n()then if L.Commons.VanishOffensive and M.Shadowmeld:IsCastable()and ak()then if l.Cast(M.Shadowmeld,nil)then T=58984;return"Cast Shadowmeld"end end;if M.Dreadblades:IsReady()and h:IsSpellInRange(M.Dreadblades)and not g:StealthUp(true,true)and g:ComboPoints()<2 then if l.Cast(M.Dreadblades,nil)then T=343142;return"Cast Dreadblades"end end;if L.Commons.Enabled.TopTrinket or L.Commons.Enabled.BottomTrinket then local ao=g:GetUseableTrinkets(O)if ao and(d.BossFilteredFightRemains("<",20)or K.MasterAssassinsMarkRemains()>0 or not Z and h:DebuffUp(M.BetweentheEyes)and(not M.GhostlyStrike:IsAvailable()or h:DebuffUp(M.GhostlyStrike)))then if ao then if l.Cast(ao,nil,nil)then if ao:ID()==GetInventoryItemID("player",13)then T=24;return"Generic use_items for "..ao:Name()elseif ao:ID()==GetInventoryItemID("player",14)then T=25;return"Generic use_items for "..ao:Name()end end end end end;if M.BloodFury:IsCastable()and L.Commons.Enabled.Racials then if l.Cast(M.BloodFury,nil)then T=20572;return"Cast Blood Fury"end end;if M.Berserking:IsCastable()and L.Commons.Enabled.Racials then if l.Cast(M.Berserking,nil)then T=26297;return"Cast Berserking"end end;if M.Fireblood:IsCastable()and L.Commons.Enabled.Racials then if l.Cast(M.Fireblood,nil)then T=265221;return"Cast Fireblood"end end;if M.AncestralCall:IsCastable()and L.Commons.Enabled.Racials then if l.Cast(M.AncestralCall,nil)then T=274738;return"Cast Ancestral Call"end end end end end;local function ap()if L.Outlaw.Enabled.VanishEchoingReprimand and n()and o and M.EchoingReprimand:IsReady()and h:IsSpellInRange(M.EchoingReprimand)then if l.Cast(M.EchoingReprimand,nil,nil)then T=323547;return"Cast Echoing Reprimand"end end;if M.Dispatch:IsCastable()and h:IsSpellInRange(M.Dispatch)and aj()then if l.CastPooling(M.Dispatch)then T=2098;return"Cast Dispatch"end end;if M.Ambush:IsCastable()and h:IsSpellInRange(M.Ambush)then if l.CastPooling(M.Ambush)then T=8676;return"Cast Ambush"end end end;local function aq()if M.SliceandDice:IsCastable()and(d.FilteredFightRemains(Q,">",g:BuffRemains(M.SliceandDice),true)or g:BuffRemains(M.SliceandDice)==0)and g:BuffRemains(M.SliceandDice)<(1+g:ComboPoints())*1.8 then if l.CastPooling(M.SliceandDice)then T=315496;return"Cast Slice and Dice"end end;if M.BetweentheEyes:IsCastable()and h:IsSpellInRange(M.BetweentheEyes)and(h:FilteredTimeToDie(">",4)or h:TimeToDieIsNotValid())and K.CanDoTUnit(h,W)then if l.CastPooling(M.BetweentheEyes)then T=315341;return"Cast Between the Eyes"end end;if M.Dispatch:IsCastable()and h:IsSpellInRange(M.Dispatch)then if l.CastPooling(M.Dispatch)then T=2098;return"Cast Dispatch"end end end;local function ar()if n()and M.Sepsis:IsReady()and o and h:IsSpellInRange(M.Sepsis)and K.MasterAssassinsMarkRemains()<=0 then if l.Cast(M.Sepsis,nil,nil)then T=328305;return"Cast Sepsis"end end;if M.GhostlyStrike:IsReady()and h:IsSpellInRange(M.GhostlyStrike)then if l.Cast(M.GhostlyStrike,nil)then T=196937;return"Cast Ghostly Strike"end end;if M.Shiv:IsReady()and Y then if l.Cast(M.Shiv)then T=5938;return"Cast Shiv (TTB)"end end;if n()and M.EchoingReprimand:IsReady()and(not L.Outlaw.Enabled.VanishEchoingReprimand or not L.Commons.VanishOffensive or M.Vanish:CooldownRemains()>=100 or g:IsTanking(h))and h:IsSpellInRange(M.EchoingReprimand)then if l.Cast(M.EchoingReprimand,nil,nil)then T=323547;return"Cast Echoing Reprimand"end end;if M.SerratedBoneSpike:IsReady()and o then if g:BuffUp(M.SliceandDice)and not h:DebuffUp(M.SerratedBoneSpikeDebuff)or L.Outlaw.DumpSpikes and d.BossFilteredFightRemains("<",5)then if l.Cast(M.SerratedBoneSpike,nil,nil)then T=328547;return"Cast Serrated Bone Spike"end end;if m()then local as,at=nil,4;local au=h:GUID()for av,aw in pairs(P)do if aw:GUID()~=au and J.UnitIsCycleValid(aw,at,-aw:DebuffRemains(M.SerratedBoneSpike))and not aw:DebuffUp(M.SerratedBoneSpikeDebuff)then as,at=aw,aw:TimeToDie()end end;if as and o then l.CastLeftNameplate(as,M.SerratedBoneSpike)if as:GUID()==f("mouseover"):GUID()and L.Outlaw.TargetSwap=="Mouseover"then U=3285415 elseif L.Outlaw.TargetSwap=="AutoSwap"and as:GUID()~=h:GUID()and not r then U=999 end end end;if M.SerratedBoneSpike:ChargesFractional()>2.75 and o then if l.Cast(M.SerratedBoneSpike,nil,nil)then T=328547;return"Cast Serrated Bone Spike Filler"end end end;if M.PistolShot:IsCastable()and h:IsSpellInRange(M.PistolShot)and g:BuffUp(M.Opportunity)then if g:EnergyDeficitPredicted()>g:EnergyRegen()+10 or g:ComboPointsDeficit()<=1+_(g:BuffUp(M.Broadside))or M.QuickDraw:IsAvailable()then if l.CastPooling(M.PistolShot)then T=185763;return"Cast Pistol Shot"end end;if g:BuffUp(M.GreenskinsWickers)or g:BuffUp(M.ConcealedBlunderbuss)then if l.CastPooling(M.PistolShot)then T=185763;return"Cast Pistol Shot (Buffed)"end end end;if M.SinisterStrike:IsCastable()and h:IsSpellInRange(M.SinisterStrike)then if l.CastPooling(M.SinisterStrike)then T=193315;return"Cast Sinister Strike"end end end;local function ax()q=HeroRotationCharDB.Toggles[6]o=HeroRotationCharDB.Toggles[4]p=HeroRotationCharDB.Toggles[5]r=HeroRotationCharDB.Toggles[12]s=HeroRotationCharDB.Toggles[15]t=HeroRotationCharDB.Toggles[21]v=HeroRotationCharDB.Toggles[22]w=HeroRotationCharDB.Toggles[23]x=HeroRotationCharDB.Toggles[24]y=HeroRotationCharDB.Toggles[25]z=HeroRotationCharDB.Toggles[27]A=HeroRotationCharDB.Toggles[50]B=HeroRotationCharDB.Toggles[51]u=HeroRotationCharDB.Toggles[52]C=HeroRotationCharDB.Toggles[53]if not L.Commons.Enabled.TopTrinket then H=GetInventoryItemID("player",13)else H=1 end;if not L.Commons.Enabled.BottomTrinket then I=GetInventoryItemID("player",14)else I=1 end;O={H,I}end;local function ay()V=M.AcrobaticStrikes:IsAvailable()and 9 or 6;W=M.Dispatch:Damage()*1.25;if m()then P=g:GetEnemiesInRange(30)Q=g:GetEnemiesInRange(V)R=#Q else R=1 end;S=ax()if S then return S end;if U>0 then U=0 end;if T>0 then T=0 end;T=K.ReturnSpell()U=K.ReturnSpellMO()if l.GUISettings.General.OpenerReset>0 and not HeroRotationCharDB.Toggles[6]then F=GetTime()G=F+l.GUISettings.General.OpenerReset elseif l.GUISettings.General.OpenerReset>0 and G~=nil and GetTime()>G and HeroRotationCharDB.Toggles[6]then HeroRotationCharDB.Toggles[6]=not HeroRotationCharDB.Toggles[6]l.ToggleIconFrame:UpdateButtonText(6)l.Print("Opener is now "..(HeroRotationCharDB.Toggles[6]and"|cff00ff00enabled|r."or"|cffff0000disabled|r."))end;if C and M.GrapplingHook:IsUsableP()and M.GrapplingHook:CooldownRemains(BypassRecovery)<=0 then if l.Cast(M.GrapplingHook,nil,nil,nil)then T=195457;return"queue Grappling Hook"end elseif(not M.GrapplingHook:IsUsableP()or M.GrapplingHook:CooldownRemains()>0)and C then HeroRotationCharDB.Toggles[53]=not HeroRotationCharDB.Toggles[53]l.Print("Gouge Queue is now "..(HeroRotationCharDB.Toggles[53]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if v and M.CheapShot:IsUsableP()and M.CheapShot:CooldownRemains(BypassRecovery)<=0 and g:StealthUp(true,true)and(h:IsInRange(8)or f("mouseover"):IsInRange(8))then if l.Cast(M.CheapShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(M.CheapShot)then U=18335;return"queue Cheap Shot MO"else T=1833;return"queue Cheap Shot"end end elseif(not M.CheapShot:IsUsableP()or M.CheapShot:CooldownRemains()>0)and v then HeroRotationCharDB.Toggles[22]=not HeroRotationCharDB.Toggles[22]l.Print("Cheap Shot Queue is now "..(HeroRotationCharDB.Toggles[22]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if w and M.KidneyShot:IsUsableP()and M.KidneyShot:CooldownRemains(BypassRecovery)<=0 and(h:IsInRange(8)or f("mouseover"):IsInRange(8))then if l.Cast(M.KidneyShot,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(M.KidneyShot)then U=4085;return"queue Kidney Shot MO"else T=408;return"queue Kidney Shot"end end elseif(not M.KidneyShot:IsUsableP()or M.KidneyShot:CooldownRemains()>0)and w then HeroRotationCharDB.Toggles[23]=not HeroRotationCharDB.Toggles[23]l.Print("Kidney Shot Queue is now "..(HeroRotationCharDB.Toggles[23]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if x and M.Blind:IsUsableP()and M.Blind:CooldownRemains(BypassRecovery)<=0 and(h:IsInRange(15)or f("mouseover"):IsInRange(15))then if l.Cast(M.Blind,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(M.Blind)then U=20945;return"queue Blind MO"end end elseif(not M.Blind:IsUsableP()or M.Blind:CooldownRemains()>0)and x then HeroRotationCharDB.Toggles[24]=not HeroRotationCharDB.Toggles[24]l.Print("Blind Queue is now "..(HeroRotationCharDB.Toggles[24]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if y and M.Sap:IsUsableP()and M.Sap:CooldownRemains(BypassRecovery)<=0 and g:StealthUp(true,true)and(h:IsInRange(10)or f("mouseover"):IsInRange(10))then if l.Cast(M.Sap,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(M.Sap)then U=67705;return"queue Sap MO"else T=6770;return"queue Sap"end end elseif(not M.Sap:IsUsableP()or M.Sap:CooldownRemains()>0 or not g:StealthUp(true,true))and y then HeroRotationCharDB.Toggles[25]=not HeroRotationCharDB.Toggles[25]l.Print("Sap Queue is now "..(HeroRotationCharDB.Toggles[25]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if z and M.Feint:IsUsableP()and M.Feint:CooldownRemains(BypassRecovery)<=0 and g:AffectingCombat()then if l.Cast(M.Feint,nil,nil,nil)then T=202;return"queue Shuriken Tornado"end elseif(not M.Feint:IsUsableP()or M.Feint:CooldownRemains()>0 or not g:AffectingCombat())and z then HeroRotationCharDB.Toggles[27]=not HeroRotationCharDB.Toggles[27]l.Print("Feint Queue is now "..(HeroRotationCharDB.Toggles[27]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if A and M.Gouge:IsUsableP()and M.Gouge:CooldownRemains(BypassRecovery)<=0 and(h:IsInRange(8)or f("mouseover"):IsInRange(8))then if l.Cast(M.Gouge,nil,nil,nil)then if f("mouseover"):GUID()~=nil and f("mouseover"):IsSpellInRange(M.Gouge)then U=17765;return"queue Gouge MO"else T=1776;return"queue Gouge"end end elseif(not M.Gouge:IsUsableP()or M.Gouge:CooldownRemains()>0 or not g:AffectingCombat())and A then HeroRotationCharDB.Toggles[50]=not HeroRotationCharDB.Toggles[50]l.Print("Gouge Queue is now "..(HeroRotationCharDB.Toggles[50]and"|cff00ff00on|r."or"|cffff0000off|r."))end;if g:IsChanneling(i(324631))then if l.Cast(M.PoolEnergy,nil,nil,nil)then T=99999;return"channeling Fleashcraft"end end;S=K.CrimsonVial()if S then return S end;S=K.Feint()if S then return S end;if g:HealthPercentage()<L.Commons.PhialHP and N.PhialofSerenity:IsReady()and N.PhialofSerenity:CooldownRemains()<=0 then if l.Cast(N.PhialofSerenity,nil)then T=55;return"PhialofSerenity HP"end end;if g:HealthPercentage()<L.Commons.HealthstoneHP and N.Healthstone:IsReady()and N.Healthstone:CooldownRemains()<=0 then if l.Cast(N.Healthstone,nil)then T=40;return"Healthstone HP"end end;if g:HealthPercentage()<L.Commons.HealPotHP and N.HealPot:IsReady()and N.HealPot:CooldownRemains()<=0 then if l.Cast(N.HealPot,nil)then T=41;return"HealPot HP"end end;WhiteList={228318,178658,333227,334800,334967,324737,326450,334470,326450,320703,320012,324085,333241,331510}if UnitExists("target")and M.Shiv:IsReady()then if UnitCanAttack("player","target")and UnitAffectingCombat("target")and UnitIsDead("target")~=true then for ag=0,40 do local av,av,az,aA,av,av,av,av,av,aB=UnitBuff("target",ag)for av,aC in pairs(WhiteList)do if aC==aB then if l.Cast(M.Shiv,nil)then T=5938;return"Shiv Enrage"end end end end end end;local aD=g:AffectingCombat()and 180 or 900;local aE;if i(8679):IsAvailable()and L.Commons.LethalPoison=="Wound Poison"then aE=g:BuffRemains(i(8679))if aE<aD and not g:IsCasting(i(8679))then if l.Cast(i(8679))then T=203;return"Wound Poison Refresh"end end elseif i(2823):IsAvailable()and L.Commons.LethalPoison=="Deadly Poison"then aE=g:BuffRemains(i(2823))if aE<aD and not g:IsCasting(i(2823))then if l.Cast(i(2823))then T=208;return"Deadly Poison Refresh"end end elseif i(315584):IsAvailable()and L.Commons.LethalPoison=="Instant Poison"then aE=g:BuffRemains(i(315584))if aE<aD and not g:IsCasting(i(315584))then if l.Cast(i(315584))then T=205;return"Instant Poison Refresh"end end end;aE=g:BuffRemains(i(3408))if i(3408):IsAvailable()and L.Commons.NonLethalPoison=="Crippling Poison"then if aE<aD and not g:IsCasting(i(3408))then if l.Cast(i(3408))then T=206;return"Crippling Poison Refresh"end end elseif i(5761):IsAvailable()and L.Commons.NonLethalPoison=="Numbing Poison"then aE=g:BuffRemains(i(5761))if aE<aD and not g:IsCasting(NumbingPoison)then if l.Cast(i(5761))then T=204;return"Numbing Poison Refresh"end end end;if not g:BuffUp(M.VanishBuff)and not g:AffectingCombat()and not g:StealthUp(true,true)then S=K.Stealth(M.Stealth)if S then return S end end;if not g:AffectingCombat()and q then if J.TargetIsValid()and(g:AffectingCombat()or q)then if n()and M.MarkedforDeath:IsCastable()and g:ComboPointsDeficit()>=K.CPMaxSpend()-1 then if L.Commons.STMfDAsDPSCD then if l.Cast(M.MarkedforDeath,nil)then T=137619;return"Cast Marked for Death (OOC)"end else if l.Cast(M.MarkedforDeath,nil)then T=137619;return"Cast Marked for Death (OOC)"end end end;if M.RolltheBones:IsReady()and(K.RtBRemains()<=3 or ai())then if l.Cast(M.RolltheBones)then T=315508;return"Cast Roll the Bones (Opener)"end end;if M.SliceandDice:IsReady()and g:BuffRemains(M.SliceandDice)<(1+g:ComboPoints())*1.8 then if l.CastPooling(M.SliceandDice)then T=315496;return"Cast Slice and Dice (Opener)"end end;if g:StealthUp(true,true)then S=ap()if S then return"Stealth (Opener): "..S end elseif aj()then S=aq()if S then return"Finish (Opener): "..S end elseif M.SinisterStrike:IsCastable()then if l.Cast(M.SinisterStrike)then T=193315;return"Cast Sinister Strike (Opener)"end end end;return end;if M.MarkedforDeath:IsCastable()and(g:AffectingCombat()or q or g:BuffUp(M.VanishBuff))then if R>1 and J.CastTargetIf(M.MarkedforDeath,P,"min",a7,a9,nil,nil)then return"Cast Marked for Death (Cycle)"elseif R==1 and not g:StealthUp(true,false)and g:ComboPointsDeficit()>=K.CPMaxSpend()-1 then if L.Commons.STMfDAsDPSCD then if l.Cast(M.MarkedforDeath,nil)then T=137619;return"Cast Marked for Death (ST)"end else if l.Cast(M.MarkedforDeath,nil)then T=137619;return"Cast Marked for Death (ST)"end end end end;if J.TargetIsValid()and(g:AffectingCombat()or q or g:BuffUp(M.VanishBuff))then if g:StealthUp(true,true)then S=ap()if S then return"Stealth: "..S end end;local aF,aG,av=GetSpellCooldown(57934)if L.Commons.AutoToT then if aF+aG-GetTime()<=0 and M.TricksoftheTrade:IsAvailable()and M.TricksoftheTrade:CooldownRemains(BypassRecovery)<=0 and UnitExists("focus")and(UnitInParty("focus")or UnitInRaid("focus"))and IsItemInRange(32698,"focus")then if l.Cast(M.TricksoftheTrade)then T=207;return"ToT Focus"end end end;S=an()if S then return"CDs: "..S end;if aj()then S=aq()if S then return"Finish: "..S end;l.Cast(M.PoolEnergy)return"Finish Pooling"end;S=ar()if S then return"Build: "..S end;if M.ArcaneTorrent:IsCastable()and L.Commons.Enabled.Racials and h:IsSpellInRange(M.SinisterStrike)and g:EnergyDeficitPredicted()>15+g:EnergyRegen()then if l.Cast(M.ArcaneTorrent,nil)then T=155145;return"Cast Arcane Torrent"end end;if M.ArcanePulse:IsCastable()and L.Commons.Enabled.Racials and h:IsSpellInRange(M.SinisterStrike)then if l.Cast(M.ArcanePulse)then T=260364;return"Cast Arcane Pulse"end end;if M.LightsJudgment:IsCastable()and L.Commons.Enabled.Racials and h:IsInMeleeRange(5)then if l.Cast(M.LightsJudgment,nil)then T=255647;return"Cast Lights Judgment"end end;if M.BagofTricks:IsCastable()and L.Commons.Enabled.Racials and h:IsInMeleeRange(5)then if l.Cast(M.BagofTricks,nil)then T=312411;return"Cast Bag of Tricks"end end;if M.PistolShot:IsCastable()and h:IsSpellInRange(M.PistolShot)and not h:IsInRange(V)and not g:StealthUp(true,true)and g:EnergyDeficitPredicted()<25 and(g:ComboPointsDeficit()>=1 or a3()<=1.2)then if l.Cast(M.PistolShot)then T=185763;return"Cast Pistol Shot (OOR)"end end end end;local function aH()end;function ReturnSpellOut()if T==0 then return 0 else return T end end;function ReturnSpellMOOut()if U==0 then return 0 else return U end end;l.SetAPL(260,ay,aH)